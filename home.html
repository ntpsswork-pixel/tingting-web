<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TTGPlus</title>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&family=IBM+Plex+Sans+Thai:wght@300;400;500;600&display=swap');
        :root {
            --sidebar-width: 268px;
            --primary-dark: #0f172a;
            --sidebar-mid: #1a2540;
            --accent-gold: #f0b429;
            --accent-gold-light: #fde68a;
            --bg-light: #f4f6fb;
            --success: #10b981;
            --danger: #ef4444;
            --info: #3b82f6;
            --card-shadow: 0 1px 3px rgba(0,0,0,0.06), 0 4px 16px rgba(0,0,0,0.04);
            --card-shadow-hover: 0 4px 12px rgba(0,0,0,0.1), 0 12px 32px rgba(0,0,0,0.06);
        }
        body { margin:0; display:flex; font-family:'IBM Plex Sans Thai','Prompt',sans-serif; background:var(--bg-light); min-height:100vh; overflow-x:hidden; color:#1e293b; }

        /* ‚îÄ‚îÄ SIDEBAR ‚îÄ‚îÄ */
        .sidebar { width:var(--sidebar-width); height:100vh; background:var(--primary-dark); color:white; position:fixed; left:0; top:0; z-index:1000; display:flex; flex-direction:column; box-shadow:4px 0 24px rgba(0,0,0,0.15); }
        .sidebar-brand { padding:0; border-bottom:1px solid rgba(255,255,255,0.07); }
        .sidebar-brand-inner { padding:22px 24px; display:flex; align-items:center; gap:12px; }
        .sidebar-logo { width:38px; height:38px; background:linear-gradient(135deg,var(--accent-gold),#d97706); border-radius:10px; display:flex; align-items:center; justify-content:center; font-size:18px; font-weight:900; color:#0f172a; letter-spacing:-1px; flex-shrink:0; box-shadow:0 4px 12px rgba(240,180,41,0.3); }
        .sidebar-brand h2 { margin:0; font-family:'Prompt',sans-serif; font-size:18px; font-weight:700; letter-spacing:0.5px; line-height:1; }
        .sidebar-brand h2 span { color:var(--accent-gold); }
        .sidebar-brand h2 small { display:block; font-size:10px; color:#64748b; font-weight:400; letter-spacing:1px; margin-top:2px; text-transform:uppercase; }

        .user-info { padding:14px 16px; margin:12px; background:rgba(255,255,255,0.04); border-radius:12px; border:1px solid rgba(255,255,255,0.06); font-size:13px; }
        .user-info-row { display:flex; align-items:center; gap:10px; }
        .user-avatar { width:36px; height:36px; border-radius:10px; background:linear-gradient(135deg,#334155,#475569); display:flex; align-items:center; justify-content:center; font-size:15px; flex-shrink:0; }
        .user-info b { color:var(--accent-gold); display:block; font-size:13px; font-weight:600; }
        .user-info .role-tag { display:inline-block; font-size:9px; background:rgba(240,180,41,0.15); color:var(--accent-gold); padding:2px 7px; border-radius:20px; margin-top:3px; letter-spacing:0.5px; font-weight:600; }

        .nav-links { flex:1; padding:8px 10px; overflow-y:auto; }
        .nav-links::-webkit-scrollbar { width:0; }
        .nav-item { padding:10px 14px; cursor:pointer; border-radius:9px; margin-bottom:2px; transition:all 0.2s; display:flex; align-items:center; gap:10px; color:#94a3b8; font-size:13px; font-weight:500; }
        .nav-item:hover { background:rgba(255,255,255,0.06); color:white; }
        .nav-item.active { background:linear-gradient(135deg,rgba(240,180,41,0.2),rgba(240,180,41,0.1)); color:var(--accent-gold); font-weight:600; border-left:3px solid var(--accent-gold); }
        .submenu { padding-left:14px; display:none; margin:2px 0 6px 10px; border-left:1px solid #1e3a5f; }
        .submenu div { padding:7px 12px; font-size:12px; color:#64748b; cursor:pointer; border-radius:7px; transition:all 0.15s; }
        .submenu div:hover { color:white; background:rgba(255,255,255,0.05); }

        /* ‚îÄ‚îÄ MAIN ‚îÄ‚îÄ */
        .main-content { margin-left:var(--sidebar-width); width:calc(100% - var(--sidebar-width)); flex:1; }
        .app-container { padding:28px 32px; animation:fadeIn 0.35s ease; }
        @keyframes fadeIn { from{opacity:0;transform:translateY(8px)} to{opacity:1;transform:translateY(0)} }

        /* ‚îÄ‚îÄ TOOL HEADER ‚îÄ‚îÄ */
        .tool-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:24px; padding-bottom:16px; border-bottom:1px solid #e2e8f0; }
        .tool-header h2 { margin:0; font-family:'Prompt',sans-serif; font-size:20px; font-weight:700; color:#0f172a; }

        /* ‚îÄ‚îÄ CARDS ‚îÄ‚îÄ */
        .user-card { background:white; border-radius:16px; padding:20px; box-shadow:var(--card-shadow); border:1px solid #e8ecf0; }

        /* ‚îÄ‚îÄ TABLES ‚îÄ‚îÄ */
        .stock-table { width:100%; border-collapse:separate; border-spacing:0 6px; }
        .stock-row { background:white; border-radius:12px; box-shadow:0 1px 3px rgba(0,0,0,0.04); transition:box-shadow 0.2s; }
        .stock-row:hover { box-shadow:var(--card-shadow-hover); }
        .stock-row td { padding:14px 16px; }

        .btn-action { width:38px; height:38px; border-radius:8px; border:none; color:white; cursor:pointer; transition:all 0.2s; font-weight:bold; }
        .hidden { display:none !important; }

        /* ‚îÄ‚îÄ INPUT GROUP ‚îÄ‚îÄ */
        .input-group { background:white; padding:12px 14px; border-radius:12px; border:1px solid #e8ecf0; box-shadow:0 1px 3px rgba(0,0,0,0.04); }
        .input-group label { display:block; font-size:10px; color:#94a3b8; margin-bottom:4px; font-weight:700; letter-spacing:0.6px; text-transform:uppercase; }
        .input-group select, .input-group input { font-family:'IBM Plex Sans Thai',sans-serif; }

        /* ‚îÄ‚îÄ MODAL ‚îÄ‚îÄ */
        .modal-overlay { position:fixed; inset:0; background:rgba(15,23,42,0.6); backdrop-filter:blur(4px); z-index:9999; display:flex; align-items:center; justify-content:center; animation:fadeIn 0.2s ease; }
        .modal-box { background:white; border-radius:20px; padding:32px; width:440px; box-shadow:0 32px 80px rgba(0,0,0,0.25); max-height:88vh; overflow-y:auto; }
        .modal-box h3 { margin:0 0 20px; color:#0f172a; font-family:'Prompt',sans-serif; font-size:18px; font-weight:700; }
        .modal-box input { width:100%; padding:11px 14px; border:1.5px solid #e2e8f0; border-radius:10px; font-size:14px; margin-bottom:12px; box-sizing:border-box; outline:none; transition:border 0.2s; font-family:'IBM Plex Sans Thai',sans-serif; }
        .modal-box input:focus { border-color:var(--info); box-shadow:0 0 0 3px rgba(59,130,246,0.1); }
        .modal-error { color:var(--danger); font-size:12px; margin-bottom:10px; display:none; }

        /* ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ */
        .toast { position:fixed; bottom:28px; right:28px; background:#0f172a; color:white; padding:13px 20px; border-radius:12px; font-size:13px; z-index:99999; animation:toastIn 0.3s ease; box-shadow:0 8px 32px rgba(0,0,0,0.25); max-width:320px; border-left:3px solid var(--accent-gold); }
        @keyframes toastIn { from{opacity:0;transform:translateY(16px)} to{opacity:1;transform:translateY(0)} }

        /* ‚îÄ‚îÄ FILTER BAR ‚îÄ‚îÄ */
        .filter-bar { background:white; padding:18px 20px; border-radius:14px; border:1px solid #e8ecf0; margin-bottom:20px; display:flex; gap:14px; flex-wrap:wrap; align-items:flex-end; box-shadow:var(--card-shadow); }
        .filter-bar label { font-size:10px; color:#94a3b8; font-weight:700; display:block; margin-bottom:4px; letter-spacing:0.5px; text-transform:uppercase; }
        .filter-bar select, .filter-bar input[type="date"] { padding:9px 12px; border:1.5px solid #e2e8f0; border-radius:9px; font-size:13px; outline:none; min-width:170px; font-family:'IBM Plex Sans Thai',sans-serif; }
        .filter-bar select:focus, .filter-bar input:focus { border-color:var(--info); }

        /* ‚îÄ‚îÄ HISTORY CARDS ‚îÄ‚îÄ */
        .history-card { background:white; border-radius:14px; border:1px solid #e8ecf0; margin-bottom:14px; overflow:hidden; box-shadow:var(--card-shadow); }
        .history-card-header { padding:14px 20px; background:#f8fafc; border-bottom:1px solid #e8ecf0; display:flex; justify-content:space-between; align-items:center; }

        .item-row { display:flex; align-items:center; gap:8px; padding:8px; border:1px solid #f1f5f9; border-radius:9px; margin-bottom:6px; background:#f8fafc; font-size:13px; }
        .item-row span { flex:1; }
        .btn-sm { padding:4px 10px; border-radius:6px; border:none; cursor:pointer; font-size:12px; font-weight:bold; }

        .online-dot { width:8px;height:8px;border-radius:50%;background:var(--success);display:inline-block;box-shadow:0 0 0 2px rgba(16,185,129,0.25);animation:pulse-green 2s infinite; }
        .offline-dot { width:8px;height:8px;border-radius:50%;background:#94a3b8;display:inline-block; }
        @keyframes pulse-green { 0%,100%{box-shadow:0 0 0 2px rgba(16,185,129,0.25);} 50%{box-shadow:0 0 0 5px rgba(16,185,129,0.08);} }
        .online-list { padding:10px 15px 0; }
        .online-item { display:flex;align-items:center;gap:8px;padding:6px 0;border-bottom:1px solid rgba(255,255,255,0.05);font-size:12px;color:#94a3b8; }
        .upload-progress { display:none; margin-top:10px; background:#f1f5f9; border-radius:8px; overflow:hidden; height:6px; }
        .upload-progress-bar { height:100%; background:var(--success); transition:width 0.3s; width:0%; }
        @media print {
            .sidebar, .no-print, button { display: none !important; }
            .main-content { margin-left: 0 !important; width: 100% !important; }
            .app-container { padding: 0 !important; }
            table { width: 100% !important; border: 1px solid #000 !important; }
            th, td { border: 1px solid #ddd !important; padding: 8px !important; }
            .history-card { break-inside: avoid; }
        }
        /* ---- MOBILE RESPONSIVE ---- */
        .hamburger { display:none; position:fixed; top:14px; left:14px; z-index:2000; background:var(--primary-dark); border:none; border-radius:10px; padding:10px 13px; cursor:pointer; flex-direction:column; gap:5px; }
        .hamburger span { display:block; width:22px; height:2px; background:var(--accent-gold); border-radius:2px; transition:0.3s; }
        .sidebar-overlay { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.5); z-index:999; }
        @media (max-width: 768px) {
            .hamburger { display:flex; }
            .sidebar { transform:translateX(-100%); transition:transform 0.3s ease; z-index:1000; }
            .sidebar.open { transform:translateX(0); }
            .sidebar-overlay.open { display:block; }
            .main-content { margin-left:0 !important; width:100% !important; }
            .app-container { padding:16px !important; }
            .tool-header { flex-direction:column; gap:10px; padding-top:50px; }
            .filter-bar { flex-direction:column; }
            .filter-bar select, .filter-bar input[type="date"] { min-width:unset; width:100%; }
            .stock-row td { padding:10px 8px; }
            .user-card { padding:14px; }
            #dashSummaryCards { grid-template-columns:1fr 1fr !important; }
            .history-card-header { flex-direction:column; gap:6px; }
        }
        @media (max-width: 480px) {
            #dashSummaryCards { grid-template-columns:1fr !important; }
        }
    </style>
</head>
<body>
    <!-- Mobile hamburger -->
    <button class="hamburger no-print" onclick="toggleSidebar()" aria-label="‡πÄ‡∏°‡∏ô‡∏π">
        <span></span><span></span><span></span>
    </button>
    <div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleSidebar()"></div>
    <div class="sidebar no-print" id="mainSidebar">
        <div class="sidebar-brand">
            <div class="sidebar-brand-inner">
                <div class="sidebar-logo">T+</div>
                <h2><span>TTG</span>Plus<small>Management System</small></h2>
            </div>
        </div>
        <div class="user-info">
            <div class="user-info-row">
                <div class="user-avatar">üë§</div>
                <div style="flex:1;min-width:0;">
                    <b id="roleDisplay">...</b>
                    <div id="roleStatusText" class="role-tag">-</div>
                </div>
            </div>
            <div id="timerDisplay" style="font-size:10px;color:#475569;margin-top:8px;"></div>
        </div>
        <div style="padding:0 10px 6px;">
            <button onclick="openChangePasswordModal()" style="width:100%;background:rgba(255,255,255,0.04);color:#64748b;border:1px solid #1e3a5f;padding:8px;border-radius:8px;cursor:pointer;font-size:11px;transition:all 0.2s;" onmouseover="this.style.background='rgba(255,255,255,0.08)';this.style.color='white'" onmouseout="this.style.background='rgba(255,255,255,0.04)';this.style.color='#64748b'">üîë ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô Password</button>
        </div>
        <div class="online-list" id="onlineListSidebar"></div>
        <div class="nav-links">
            <div class="nav-item active" onclick="location.reload()">üè† ‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å Dashboard</div>
            <div id="warehouseMenu" class="hidden">
                <div class="nav-item" onclick="toggleSub('subWH')">üì¶ ‡∏Ñ‡∏•‡∏±‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ ‚ñæ</div>
                <div id="subWH" class="submenu">
                    <div onclick="openStockSummary()" style="color:var(--accent-gold);">üìä ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ & Export ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</div>
                    <div onclick="openInventoryCheck()" style="color:#10b981;">üìã ‡πÉ‡∏ö‡∏ô‡∏±‡∏ö‡∏™‡∏ï‡πä‡∏≠‡∏Å‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</div>
                    <div onclick="openPurchaseOrder()" style="color:#ef4444;">üõí ‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</div>
                    <div onclick="openImportProducts()" style="color:#8b5cf6;">üì• Import ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏à‡∏≤‡∏Å Excel</div>
                </div>
            </div>
            <div id="requisitionMenu" class="hidden">
                <div class="nav-item" onclick="toggleSub('subReq')" style="color:#f59e0b;">üìã ‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏ö‡∏¥‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ ‚ñæ</div>
                <div id="subReq" class="submenu">
                    <div onclick="openCreateRequisition()" style="color:#f59e0b;">‚úèÔ∏è ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡πÄ‡∏ö‡∏¥‡∏Å‡πÉ‡∏´‡∏°‡πà</div>
                    <div onclick="openMyRequisitions()">üìÑ ‡πÉ‡∏ö‡πÄ‡∏ö‡∏¥‡∏Å‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</div>
                    <div id="reqApproveMenu" class="hidden" onclick="openPendingRequisitions()" style="color:#ef4444;">üîî ‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ <span id="reqBadge" style="background:#ef4444;color:white;border-radius:10px;padding:1px 7px;font-size:10px;margin-left:4px;"></span></div>
                    <div id="reqAllMenu" class="hidden" onclick="openAllRequisitions()">üìä ‡πÉ‡∏ö‡πÄ‡∏ö‡∏¥‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
                </div>
            </div>
            <div id="toolsMenu" class="hidden">
                <div class="nav-item" onclick="toggleSub('subTools')" style="color:var(--success);">üõ†Ô∏è ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô ‚ñæ</div>
                <div id="subTools" class="submenu">
                    <div onclick="tryOpenMonthlyCount()" id="monthlyCountMenuBtn">‚óè ‡∏ô‡∏±‡∏ö‡∏™‡∏ï‡πä‡∏≠‡∏Å‡∏™‡∏¥‡πâ‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô <span id="monthlyCountBadge" style="font-size:10px;padding:1px 6px;border-radius:10px;margin-left:4px;"></span></div>
                    <div onclick="openDailyStockCard()" style="color:#06b6d4;">‚óè Daily Stock Card</div>
                </div>
            </div>
            <div id="grMenu" class="hidden">
                <div class="nav-item" onclick="toggleSub('subGR')" style="color:#06b6d4;">üöö ‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ñ‡∏•‡∏±‡∏á ‚ñæ</div>
                <div id="subGR" class="submenu">
                    <div onclick="openCreateGR()" style="color:#06b6d4;">‚úèÔ∏è ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (GR)</div>
                    <div onclick="openGRHistory()">üìÑ ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</div>
                    <div onclick="openLotRegister()" style="color:#f59e0b;">üè∑Ô∏è ‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô Lot ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</div>
                </div>
            </div>
            <div id="qcMenu" class="hidden">
                <div class="nav-item" onclick="toggleSub('subQC')" style="color:#a855f7;">üîç QC ‡∏ï‡∏£‡∏ß‡∏à FIFO ‚ñæ</div>
                <div id="subQC" class="submenu">
                    <div onclick="openQCCheck()" style="color:#a855f7;">üìã ‡πÄ‡∏£‡∏¥‡πà‡∏° Spot Check</div>
                    <div onclick="openQCHistory()">üìä ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ QC Report</div>
                </div>
            </div>
            <div id="adminMenu" class="hidden">
                <div class="nav-item" onclick="toggleSub('subAdmin')" style="color:var(--accent-gold);">üë§ ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡∏ö‡∏ö ‚ñæ</div>
                <div id="subAdmin" class="submenu">
                    <div onclick="openUserManagement()">‚óè ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô & ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå</div>
                    <div onclick="openWarehouseManager()" style="color:var(--accent-gold);">‚óè ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏•‡∏±‡∏á‡πÅ‡∏•‡∏∞‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</div>
                    <div onclick="openRequisitionSettings()" style="color:#f59e0b;">‚óè ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÉ‡∏ö‡πÄ‡∏ö‡∏¥‡∏Å & ‡πÉ‡∏ö‡∏ô‡∏±‡∏ö</div>
                    <div onclick="toggleMonthlyCount()" id="monthlyCountToggleBtn" style="color:#06b6d4;">‚óè ‡πÄ‡∏õ‡∏¥‡∏î/‡∏õ‡∏¥‡∏î ‡∏ô‡∏±‡∏ö‡∏™‡∏ï‡πä‡∏≠‡∏Å‡∏™‡∏¥‡πâ‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</div>
                </div>
            </div>
            <div class="nav-item" onclick="openHelpGuide()" style="color:#7c3aed;border-top:1px solid rgba(255,255,255,0.05);padding:14px 20px;">üìñ ‡∏Ñ‡∏π‡πà‡∏°‡∏∑‡∏≠‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</div>
        </div>
        <div onclick="logout()" style="margin:8px 10px 12px;padding:11px 14px;border-radius:9px;cursor:pointer;color:#ef4444;font-size:13px;font-weight:500;background:rgba(239,68,68,0.06);border:1px solid rgba(239,68,68,0.15);text-align:center;transition:all 0.2s;" onmouseover="this.style.background='rgba(239,68,68,0.12)'" onmouseout="this.style.background='rgba(239,68,68,0.06)'">üö™ ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</div>
    </div>  <!-- end sidebar -->

    <div class="main-content">
        <div id="dashboardView" class="no-print">
            <!-- BANNER ADMIN (admin only, hidden by default) -->


            <!-- MAIN DASHBOARD -->
            <div class="app-container">
                <div id="viewOnlyAlert" class="hidden" style="background:#fff7ed;color:#c2410c;padding:15px;border-radius:10px;border:1px solid #fdba74;margin-bottom:20px;">
                    ‚ö†Ô∏è <b>‡πÇ‡∏´‡∏°‡∏î‡∏î‡∏π‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß:</b> ‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏´‡∏£‡∏∑‡∏≠‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏î‡πâ
                </div>

                <!-- alert banner -->
                <div id="dashAlertBanner"></div>
                <!-- greeting -->
                <div style="margin-bottom:24px;">
                    <h2 style="margin:0;color:var(--primary-dark);" id="greetingText">‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ...</h2>
                    <p style="margin:4px 0 0;color:#64748b;font-size:14px;" id="greetingDate"></p>
                </div>

                <!-- SUMMARY CARDS -->
                <div id="dashSummaryCards" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:16px;margin-bottom:28px;">
                    <div style="background:white;border-radius:14px;padding:20px;border:1px solid #e2e8f0;text-align:center;color:#94a3b8;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>
                </div>

                <!-- CHART + RECENT -->
                <div style="display:grid;grid-template-columns:1.4fr 1fr;gap:20px;">
                    <!-- trend chart -->
                    <div style="background:white;border-radius:14px;padding:24px;border:1px solid #e2e8f0;">
                        <h4 style="margin:0 0 16px;color:var(--primary-dark);">üìà Trend ‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡∏ö‡∏™‡∏ï‡πä‡∏≠‡∏Å 7 ‡∏ß‡∏±‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</h4>
                        <canvas id="trendChart" height="180"></canvas>
                    </div>
                    <!-- recent sessions -->
                    <div style="background:white;border-radius:14px;padding:24px;border:1px solid #e2e8f0;">
                        <h4 style="margin:0 0 16px;color:var(--primary-dark);">üïê ‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡∏ö‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</h4>
                        <div id="dashRecentList"><p style="color:#94a3b8;font-size:13px;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</p></div>
                    </div>
                </div>
            </div>
        </div>
        <div id="toolAppContainer" class="app-container hidden"></div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
        import { getFirestore, doc, getDoc, getDocs, setDoc, addDoc, deleteDoc, collection } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
        import { getDatabase, ref, set, onValue, onDisconnect, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDOduBfKHKwObxOk3MUMGxj1PGT23p_swM",
            authDomain: "tingting-3d57f.firebaseapp.com",
            projectId: "tingting-3d57f",
            storageBucket: "tingting-3d57f.firebasestorage.app",
            messagingSenderId: "998609441304",
            appId: "1:998609441304:web:0c7fbedf869fa2335d296d",
            databaseURL: "https://tingting-3d57f-default-rtdb.asia-southeast1.firebasedatabase.app"
        };


        const app  = initializeApp(firebaseConfig);
        const db   = getFirestore(app);
        const rtdb = getDatabase(app);

        let currentUser    = JSON.parse(localStorage.getItem("currentUser")) || null;
        let warehouseList  = ["‡∏Ñ‡∏•‡∏±‡∏á‡∏´‡∏•‡∏±‡∏Å"];
        let allProducts    = [];
        let zoneProductMap = {};
        let countData      = {};
        let roleSettings   = {
            admin:     { menus: ["warehouse","tools","admin","requisition","gr","qc"], viewOnly: false },
            warehouse: { menus: ["warehouse","tools","requisition","gr"],               viewOnly: false },
            qc:        { menus: ["gr","qc"],                                            viewOnly: false },
            staff:     { menus: ["tools","requisition"],                     viewOnly: false }
        };
        let tempCountData = {};
        let selectedStaff = "";
        let selectedDate = new Date().toISOString().split('T')[0];
        let productMinMax = {}; // { "zone__productId": { min, max } }
        let reqTemplates       = {}; // { templateId: { name, dept, zone, items:[{id,name,unit}], color } }
        let monthlyCountOpen   = false; // admin toggle: ‡πÄ‡∏õ‡∏¥‡∏î/‡∏õ‡∏¥‡∏î‡∏ô‡∏±‡∏ö‡∏™‡∏ï‡πä‡∏≠‡∏Å‡∏™‡∏¥‡πâ‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô
        let stockSheetTemplates = {}; // { templateId: { name, zone, groupBy, items:[{id,name,unit,group}], color } }

        // ---- UTILS ----
        async function hashPassword(p) {
            const buf = await crypto.subtle.digest('SHA-256', new TextEncoder().encode(p));
            return Array.from(new Uint8Array(buf)).map(b => b.toString(16).padStart(2,'0')).join('');
        }

        function toast(msg, color = '#1e293b') {
            document.querySelectorAll('.toast').forEach(t => t.remove());
            const t = document.createElement('div');
            t.className = 'toast'; t.style.background = color; t.innerText = msg;
            document.body.appendChild(t);
            setTimeout(() => t.remove(), 3000);
        }

        // ---- FIREBASE HELPERS ----
        async function loadConfig() {
            try {
                const snap = await getDoc(doc(db,'config','main'));
                if (snap.exists()) {
                    const d = snap.data();
                    if (d.warehouseList)  warehouseList  = d.warehouseList;
                    if (d.allProducts)    allProducts    = d.allProducts;
                    if (d.zoneProductMap) zoneProductMap = d.zoneProductMap;
                    if (d.roleSettings)   roleSettings   = d.roleSettings;
                    if (d.productMinMax)  productMinMax  = d.productMinMax;
                    if (d.reqTemplates)        reqTemplates        = d.reqTemplates;
                    if (d.monthlyCountOpen!=null) monthlyCountOpen = d.monthlyCountOpen;
                    if (d.stockSheetTemplates)  stockSheetTemplates = d.stockSheetTemplates;
                    // --- migrate: ‡πÄ‡∏û‡∏¥‡πà‡∏° requisition ‡πÉ‡∏´‡πâ‡∏ó‡∏∏‡∏Å role ‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ ---
                    let needSave = false;
                    const reqDefaults = {
                        admin:     ['warehouse','tools','admin','requisition','gr','qc'],
                        warehouse: ['warehouse','tools','requisition','gr'],
                        staff:     ['tools','requisition'],
                        qc:        ['gr','qc']
                    };
                    Object.keys(roleSettings).forEach(r => {
                        if (!roleSettings[r].menus) roleSettings[r].menus = [];
                        const needMenus = ['requisition','gr','qc'];
                        needMenus.forEach(m => {
                            if (!roleSettings[r].menus.includes(m)) {
                                if (reqDefaults[r]) roleSettings[r].menus = reqDefaults[r];
                                else if (['gr','qc'].includes(m)) {} // custom role ‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö
                                else roleSettings[r].menus.push(m);
                                needSave = true;
                            }
                        });
                    });
                    if (needSave) saveConfig();
                }
            } catch(e) { console.error(e); }
        }

        async function saveConfig() {
            try { await setDoc(doc(db,'config','main'), { warehouseList, allProducts, zoneProductMap, roleSettings, productMinMax, reqTemplates, monthlyCountOpen, stockSheetTemplates }, { merge:true }); }
            catch(e) { toast('‚ùå ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å config ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à','#c2410c'); }
        }

        async function loadCountData() {
            try { const s = await getDoc(doc(db,'stock','countData')); if (s.exists()) countData = s.data(); }
            catch(e) { console.error(e); }
        }

        async function saveCountData() {
            try { await setDoc(doc(db,'stock','countData'), countData); }
            catch(e) { toast('‚ùå ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏ï‡πä‡∏≠‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à','#c2410c'); }
        }

        function getVisibleWarehouses() {
            const u = currentUser;
            if (u.username && u.username.toUpperCase().startsWith('BT000')) {
                return u.assignedZones && u.assignedZones.length > 0 ? u.assignedZones : [];
            }
            return warehouseList;
        }

        // ---- ONLOAD ----
        window.onload = async function() {
            if (!currentUser) { window.location.href = 'login.html'; return; }
            document.getElementById('roleDisplay').innerText = currentUser.name;
            await loadConfig();
            await loadCountData();
            applyPermissions();
            setInterval(checkToolExpiry, 5000);
            setInterval(checkHardBanStatus, 10000);
            initPresence();
            listenOnlineUsers();
            initDashboard();
            resetSessionTimer();
            loadReqBadge();
        };

        // ---- DASHBOARD ----
        let trendChartInstance = null;

        async function initDashboard() {
            // greeting
            const hour = new Date().getHours();
            const greet = hour<12?'üåÖ ‡∏≠‡∏£‡∏∏‡∏ì‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏¥‡πå':hour<17?'‚òÄÔ∏è ‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏ï‡∏≠‡∏ô‡∏ö‡πà‡∏≤‡∏¢':'üåô ‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏ï‡∏≠‡∏ô‡πÄ‡∏¢‡πá‡∏ô';
            const el = document.getElementById('greetingText');
            const elDate = document.getElementById('greetingDate');
            if(el) el.innerText = greet+' ‡∏Ñ‡∏∏‡∏ì'+currentUser.name;
            if(elDate) {
                const now = new Date();
                elDate.innerText = now.toLocaleDateString('th-TH',{weekday:'long',year:'numeric',month:'long',day:'numeric'});
            }
            await loadCountData();
            renderSummaryCards();
            await loadDashHistory();
            renderStockAlerts();
        }

        function renderSummaryCards() {
            const c = document.getElementById('dashSummaryCards');
            if(!c) return;
            const colors = ['#3b82f6','#10b981','#f59e0b','#8b5cf6','#ef4444','#06b6d4'];
            const cards = warehouseList.map((zone, zi) => {
                const prods = allProducts.filter(p => (zoneProductMap[zone]||[]).includes(p.id));
                const totalItems = prods.length;
                const lastUpdate = prods.map(p => countData[p.id]?.lastUpdate||'').filter(Boolean).sort().reverse()[0] || '-';
                const color = colors[zi % colors.length];
                return `<div style="background:white;border-radius:14px;padding:20px;border:1px solid #e2e8f0;border-top:4px solid ${color};cursor:pointer;transition:box-shadow 0.2s;" onmouseover="this.style.boxShadow='0 8px 24px rgba(0,0,0,0.08)'" onmouseout="this.style.boxShadow='none'">
                    <div style="font-size:12px;color:#64748b;font-weight:bold;margin-bottom:8px;">üì¶ ${zone}</div>
                    <div style="font-size:28px;font-weight:bold;color:${color};">${totalItems}</div>
                    <div style="font-size:11px;color:#94a3b8;margin-top:4px;">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</div>
                    <div style="font-size:10px;color:#cbd5e1;margin-top:8px;border-top:1px solid #f1f5f9;padding-top:8px;">‡∏ô‡∏±‡∏ö‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: ${lastUpdate}</div>
                </div>`;
            });
            // total card
            const totalProds = allProducts.length;
            cards.unshift(`<div style="background:linear-gradient(135deg,var(--primary-dark),#334155);border-radius:14px;padding:20px;color:white;">
                <div style="font-size:12px;color:#94a3b8;font-weight:bold;margin-bottom:8px;">üè≠ ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
                <div style="font-size:28px;font-weight:bold;">${totalProds}</div>
                <div style="font-size:11px;color:#94a3b8;margin-top:4px;">‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
                <div style="font-size:10px;color:#64748b;margin-top:8px;border-top:1px solid #475569;padding-top:8px;">${warehouseList.length} ‡∏Ñ‡∏•‡∏±‡∏á</div>
            </div>`);
            c.innerHTML = cards.join('');
        }

        async function loadDashHistory() {
            try {
                const snap = await getDocs(collection(db,'stockHistory'));
                let sessions = [];
                snap.forEach(d => sessions.push({id:d.id,...d.data()}));
                sessions.sort((a,b) => b.timestamp - a.timestamp);

                // recent 5
                renderRecentSessions(sessions.slice(0,5));

                // trend chart: ‡∏ô‡∏±‡∏ö session ‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á 7 ‡∏ß‡∏±‡∏ô
                renderTrendChart(sessions);
            } catch(e) { console.error(e); }
        }

        function renderRecentSessions(sessions) {
            const c = document.getElementById('dashRecentList');
            if(!c) return;
            if(!sessions.length){c.innerHTML='<p style="color:#94a3b8;font-size:13px;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡∏ö</p>';return;}
            c.innerHTML = sessions.map(s => {
                const itemCount = (s.items||[]).length;
                return `<div style="display:flex;align-items:center;gap:12px;padding:10px 0;border-bottom:1px solid #f1f5f9;">
                    <div style="width:36px;height:36px;border-radius:50%;background:#f1f5f9;display:flex;align-items:center;justify-content:center;font-size:16px;flex-shrink:0;">üì¶</div>
                    <div style="flex:1;min-width:0;">
                        <div style="font-weight:bold;font-size:13px;color:var(--primary-dark);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${s.zone}</div>
                        <div style="font-size:11px;color:#64748b;">${s.date} ‚Ä¢ ${s.countedBy||'-'} ‚Ä¢ ${itemCount} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div>
                    </div>
                </div>`;
            }).join('');
        }

        function renderTrendChart(sessions) {
            const canvas = document.getElementById('trendChart');
            if(!canvas) return;

            // ‡∏™‡∏£‡πâ‡∏≤‡∏á label 7 ‡∏ß‡∏±‡∏ô‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á
            const days = [];
            const counts = [];
            for(let i=6;i>=0;i--) {
                const d = new Date();
                d.setDate(d.getDate()-i);
                const label = d.toLocaleDateString('th-TH',{day:'numeric',month:'short'});
                // ‡πÅ‡∏õ‡∏•‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô dd/mm/yyyy format ‡πÄ‡∏û‡∏∑‡πà‡∏≠ match ‡∏Å‡∏±‡∏ö s.date
                const dy = String(d.getDate()).padStart(2,'0');
                const mo = String(d.getMonth()+1).padStart(2,'0');
                const yr = d.getFullYear()+543;
                const dateKey = `${dy}/${mo}/${yr}`;
                const sessCount = sessions.filter(s => s.date === dateKey).length;
                days.push(label);
                counts.push(sessCount);
            }

            if(trendChartInstance) trendChartInstance.destroy();
            trendChartInstance = new Chart(canvas, {
                type: 'bar',
                data: {
                    labels: days,
                    datasets: [{
                        label: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô session ‡∏ó‡∏µ‡πà‡∏ô‡∏±‡∏ö',
                        data: counts,
                        backgroundColor: 'rgba(59,130,246,0.15)',
                        borderColor: '#3b82f6',
                        borderWidth: 2,
                        borderRadius: 8,
                        borderSkipped: false,
                    }]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { beginAtZero:true, ticks:{ stepSize:1 }, grid:{ color:'#f1f5f9' } },
                        x: { grid:{ display:false } }
                    }
                }
            });
        }

        // ---- ONLINE PRESENCE ----
        function initPresence() {
            const uid = currentUser.username;
            const name = currentUser.name;
            const presenceRef = ref(rtdb, `presence/${uid}`);
            // ‡πÄ‡∏°‡∏∑‡πà‡∏≠ disconnect ‡πÉ‡∏´‡πâ‡∏•‡∏ö‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á‡∏≠‡∏≠‡∏Å
            onDisconnect(presenceRef).remove();
            // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ß‡πà‡∏≤ online
            set(presenceRef, { name, username: uid, online: true, lastSeen: serverTimestamp() });
            // ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤/‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö
            window.addEventListener('beforeunload', () => set(presenceRef, null).catch(()=>{}));
        }

        function listenOnlineUsers() {
            const onlineRef = ref(rtdb, 'presence');
            onValue(onlineRef, (snapshot) => {
                const data = snapshot.val() || {};
                const users = Object.values(data).filter(u => u.online);
                renderOnlineList(users);
            });
        }

        function renderOnlineList(users) {
            const container = document.getElementById('onlineListSidebar');
            if (!container) return;
            if (users.length === 0) { container.innerHTML = ''; return; }
            container.innerHTML = `
                <div style="padding:8px 15px 4px;font-size:10px;color:#64748b;font-weight:bold;letter-spacing:1px;">
                    üü¢ ‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå (${users.length})
                </div>
                ${users.map(u => `
                <div class="online-item">
                    <span class="online-dot"></span>
                    <span style="${u.username===currentUser.username?'color:var(--accent-gold);font-weight:bold;':''}">${u.name}${u.username===currentUser.username?' (‡∏Ñ‡∏∏‡∏ì)':''}</span>
                </div>`).join('')}
                <div style="height:1px;background:rgba(255,255,255,0.05);margin:6px 15px;"></div>`;
        }

        // ---- PERMISSIONS ----
        window.applyPermissions = function() {
            const role       = currentUser.role || 'guest';
            const perms      = roleSettings[role]?.menus || [];
            const isViewOnly = roleSettings[role]?.viewOnly || false;
            const effectivePerms = isViewOnly ? ["warehouse","tools","admin","requisition"] : perms;

            document.getElementById('warehouseMenu').classList.toggle('hidden', !effectivePerms.includes('warehouse'));
            document.getElementById('toolsMenu').classList.toggle('hidden', !effectivePerms.includes('tools'));
            document.getElementById('adminMenu').classList.toggle('hidden', !effectivePerms.includes('admin'));
            // requisition menu
            const reqMenu = document.getElementById('requisitionMenu');
            if(reqMenu) reqMenu.classList.toggle('hidden', !effectivePerms.includes('requisition'));
            const grMenu = document.getElementById('grMenu');
            if(grMenu) grMenu.classList.toggle('hidden', !effectivePerms.includes('gr'));
            const qcMenu = document.getElementById('qcMenu');
            if(qcMenu) qcMenu.classList.toggle('hidden', !effectivePerms.includes('qc'));
            // monthly count badge
            const badge = document.getElementById('monthlyCountBadge');
            if(badge){
                badge.innerText = monthlyCountOpen ? 'üü¢ ‡πÄ‡∏õ‡∏¥‡∏î' : 'üî¥ ‡∏õ‡∏¥‡∏î';
                badge.style.background = monthlyCountOpen ? '#dcfce7' : '#fee2e2';
                badge.style.color = monthlyCountOpen ? '#059669' : '#ef4444';
            }
            // approve/all sub-items only for warehouse/admin
            const canApprove = ['admin','warehouse'].includes(role);
            const reqApprove = document.getElementById('reqApproveMenu');
            const reqAll = document.getElementById('reqAllMenu');
            if(reqApprove) reqApprove.classList.toggle('hidden', !canApprove);
            if(reqAll) reqAll.classList.toggle('hidden', !canApprove);

            document.getElementById('viewOnlyAlert').classList.toggle('hidden', !isViewOnly);

            let existingStyle = document.getElementById("viewOnlyStyle");
            if (isViewOnly) {
                if (!existingStyle) {
                    const st = document.createElement('style');
                    st.id = "viewOnlyStyle";
                    st.innerHTML = `
                        button[onclick*="finalSaveStock"], button[onclick*="addNewUser"],
                        button[onclick*="addWh"], button[onclick*="addPd"],
                        button[onclick*="grantAccess"], button[onclick*="revokeAccess"],
                        button[onclick*="unbanUser"], button[onclick*="requestDelete"],
                        button[onclick*="cancelDelete"], button[onclick*="adminResetPassword"],
                        button[onclick*="updateStockTemp"], button[onclick*="saveEdit"],
                        button[onclick*="saveAssignedZones"], .btn-action { display: none !important; }
                        .viewonly-input { pointer-events: none !important; opacity: 0.7 !important; }
                    `;
                    document.head.appendChild(st);
                }
            } else if (existingStyle) { existingStyle.remove(); }

            document.getElementById('roleStatusText').innerText = "‡∏ê‡∏≤‡∏ô‡∏∞: " + role.toUpperCase() + (isViewOnly ? " (‡∏î‡∏π‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß)" : "");
        };

        window.checkToolExpiry = async function() {
            const now=new Date().getTime(), role=currentUser.role||'guest';
            const perms=roleSettings[role]?.menus||[], isVO=roleSettings[role]?.viewOnly||false;
            const effP = isVO ? ["warehouse","tools","admin"] : perms;
            const menu = document.getElementById('toolsMenu');
            if (!effP.includes('tools')) { menu.classList.add('hidden'); return; }
            if (role==='admin') { menu.classList.remove('hidden'); document.getElementById('timerDisplay').innerText="‚è≥ ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå: ‡∏ñ‡∏≤‡∏ß‡∏£"; return; }
            try {
                const snap=await getDoc(doc(db,'users',currentUser.username));
                if (!snap.exists()) { menu.classList.add('hidden'); return; }
                const expiry=snap.data().toolExpiry||0;
                if (now<expiry) {
                    menu.classList.remove('hidden');
                    if (expiry>4000000000000) { document.getElementById('timerDisplay').innerText="‚è≥ ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå: ‡∏ñ‡∏≤‡∏ß‡∏£"; }
                    else { const d=Math.floor((expiry-now)/60000); document.getElementById('timerDisplay').innerText=`‚è≥ ‡πÄ‡∏´‡∏•‡∏∑‡∏≠: ${Math.floor(d/60)}‡∏ä‡∏°. ${d%60}‡∏ô.`; }
                } else { menu.classList.add('hidden'); }
            } catch(e) {}
        };

        window.checkHardBanStatus = async function() {
            if (!currentUser||currentUser.username==='admin') return;
            try {
                const snap=await getDoc(doc(db,'users',currentUser.username));
                if (snap.exists()&&snap.data().status==='suspended') { alert('üö´ ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ñ‡∏π‡∏Å‡∏£‡∏∞‡∏á‡∏±‡∏ö!'); logout(); }
            } catch(e) {}
        };

        // ---- CHANGE PASSWORD ----
        window.openChangePasswordModal = function() {
            if (currentUser.username==='admin'&&currentUser.role==='admin') { toast('‚ö†Ô∏è ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ Admin ‡∏´‡∏•‡∏±‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô Password ‡πÑ‡∏î‡πâ','#c2410c'); return; }
            const modal=document.createElement('div'); modal.className='modal-overlay'; modal.id='changePassModal';
            modal.innerHTML=`<div class="modal-box"><h3>üîë ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô Password</h3>
                <input type="password" id="oldPassInput" placeholder="Password ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô">
                <input type="password" id="newPassInput" placeholder="Password ‡πÉ‡∏´‡∏°‡πà">
                <input type="password" id="confirmPassInput" placeholder="‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô Password ‡πÉ‡∏´‡∏°‡πà">
                <div class="modal-error" id="passModalError"></div>
                <div style="display:flex;gap:10px;margin-top:8px;">
                    <button onclick="submitChangePassword()" style="flex:1;background:var(--info);color:white;border:none;padding:12px;border-radius:10px;cursor:pointer;font-weight:bold;">‚úÖ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</button>
                    <button onclick="closeModal()" style="flex:1;background:#f1f5f9;color:#475569;border:none;padding:12px;border-radius:10px;cursor:pointer;">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                </div></div>`;
            document.body.appendChild(modal);
        };

        window.submitChangePassword = async function() {
            const op=document.getElementById('oldPassInput').value, np=document.getElementById('newPassInput').value, cp=document.getElementById('confirmPassInput').value;
            const err=document.getElementById('passModalError'); err.style.display='none';
            if (!op||!np||!cp){err.innerText='‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö';err.style.display='block';return;}
            if (np!==cp){err.innerText='‚ùå Password ‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô';err.style.display='block';return;}
            if (np.length<4){err.innerText='‚ùå ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 4 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£';err.style.display='block';return;}
            try {
                const snap=await getDoc(doc(db,'users',currentUser.username));
                if (!snap.exists()){err.innerText='‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ';err.style.display='block';return;}
                const ho=await hashPassword(op), st=snap.data().password||await hashPassword('1234');
                if (ho!==st){err.innerText='‚ùå Password ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á';err.style.display='block';return;}
                await setDoc(doc(db,'users',currentUser.username),{password:await hashPassword(np)},{merge:true});
                closeModal(); toast('‚úÖ ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô Password ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!','#059669');
            } catch(e){err.innerText='‚ö†Ô∏è ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î';err.style.display='block';}
        };

        window.closeModal = function() { const m=document.getElementById('changePassModal'); if(m) m.remove(); };

        // ---- USER MANAGEMENT ----
        window.openUserManagement = function() {
            document.getElementById('dashboardView').classList.add('hidden');
            const c=document.getElementById('toolAppContainer'); c.classList.remove('hidden');
            c.innerHTML=`<div class="tool-header no-print"><h2>üë§ ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô & ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå Role</h2><button onclick="closeTool()">‚úï ‡∏õ‡∏¥‡∏î</button></div>
            <div style="display:grid;grid-template-columns:1fr 1.5fr;gap:25px;">
                <div style="background:white;padding:20px;border-radius:15px;border:1px solid #e2e8f0;">
                    <h4 style="margin-top:0;">üé≠ ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Role & ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå</h4>
                    <div style="display:flex;gap:8px;margin-bottom:15px;">
                        <input type="text" id="newRoleName" placeholder="‡∏ä‡∏∑‡πà‡∏≠ Role ‡πÉ‡∏´‡∏°‡πà" style="flex:1;padding:10px;border-radius:8px;border:1px solid #ddd;">
                        <button onclick="addNewRole()" style="background:var(--success);color:white;border:none;padding:10px;border-radius:8px;cursor:pointer;">‡πÄ‡∏û‡∏¥‡πà‡∏° Role</button>
                    </div>
                    <div id="rolePermissionsList"></div>
                </div>
                <div>
                    <div style="background:white;padding:20px;border-radius:15px;margin-bottom:20px;display:flex;gap:10px;flex-wrap:wrap;" class="no-print">
                        <input type="text" id="newUserName" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô" style="padding:10px;border-radius:8px;border:1px solid #ddd;flex:1;min-width:120px;">
                        <input type="text" id="newUserKey" placeholder="Username" style="padding:10px;border-radius:8px;border:1px solid #ddd;flex:1;min-width:120px;">
                        <input type="text" id="newUserPass" placeholder="Password (‡πÑ‡∏°‡πà‡∏Å‡∏£‡∏≠‡∏Å = 1234)" style="padding:10px;border-radius:8px;border:1px solid #ddd;flex:1;min-width:140px;">
                        <select id="newUserRole" style="padding:10px;border-radius:8px;flex:1;min-width:100px;"></select>
                        <button onclick="addNewUser()" style="background:var(--info);color:white;border:none;padding:10px 20px;border-radius:8px;cursor:pointer;">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</button>
                    </div>
                    <div id="userGrid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:15px;"></div>
                </div>
            </div>`;
            renderRoleSettings(); renderUserCards();
        };

        window.renderUserCards = async function() {
            const grid=document.getElementById('userGrid'); if(!grid) return;
            grid.innerHTML='<p style="color:#94a3b8;padding:20px;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</p>';
            const snap=await getDocs(collection(db,'users')), now=new Date().getTime(); let html="";
            snap.forEach(d=>{
                const k=d.id, u=d.data(), active=u.toolExpiry>now, isSusp=u.status==='suspended';
                const isPendDel=u.deleteAt!=null&&u.deleteAt!==undefined;
                const isBranch=k.toUpperCase().startsWith('BT000');
                let delInfo="";
                if(isPendDel){const dl=Math.ceil(((u.deleteAt+259200000)-now)/86400000);delInfo=`<div style="color:var(--danger);font-size:10px;margin-top:5px;font-weight:bold;">‚è≥ ‡∏•‡∏ö‡∏ñ‡∏≤‡∏ß‡∏£‡πÉ‡∏ô ${dl>0?dl:0} ‡∏ß‡∏±‡∏ô</div>`;}
                const assignedZones=u.assignedZones||[];
                const zoneInfo=isBranch?`<div style="font-size:11px;color:var(--info);margin-top:4px;">üìç ‡∏Ñ‡∏•‡∏±‡∏á: ${assignedZones.length>0?assignedZones.join(', '):'‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ú‡∏π‡∏Å‡∏Ñ‡∏•‡∏±‡∏á'}</div>`:'';
                html+=`<div class="user-card" style="${isSusp?'border:2px solid var(--danger);background:#fff5f5;':''} ${isPendDel?'opacity:0.6;':''}">
                    <div style="display:flex;justify-content:space-between;align-items:flex-start;">
                        <div>
                            <b id="uname_${k}">${u.name}</b>
                            <small style="color:#64748b;display:block;">ID: ${k}</small>
                        </div>
                        <div style="display:flex;gap:5px;align-items:center;">
                            ${isBranch?'<span style="font-size:10px;background:#dbeafe;color:#1d4ed8;padding:2px 6px;border-radius:4px;">‡∏™‡∏≤‡∏Ç‡∏≤</span>':''}
                            <span id="urole_${k}" style="font-size:10px;background:#eee;padding:2px 6px;border-radius:4px;">${u.role}</span>
                            <button onclick="openEditUserModal('${k}','${u.name}','${u.role}')" style="background:#f1f5f9;border:1px solid #e2e8f0;border-radius:5px;padding:3px 7px;cursor:pointer;font-size:11px;">‚úèÔ∏è</button>
                        </div>
                    </div>
                    ${delInfo}${zoneInfo}
                    <div style="margin:12px 0;font-size:12px;display:flex;align-items:center;gap:6px;">
                        <span id="onlineDot_${k}"></span>
                        ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ${isSusp?'<b style="color:var(--danger);">‚õî ‡∏ñ‡∏π‡∏Å‡∏£‡∏∞‡∏á‡∏±‡∏ö</b>':(active?'üü¢ ‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå':'‚ö™ ‡∏´‡∏°‡∏î‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå')}
                    </div>
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:5px;" class="no-print">
                        <button onclick="grantAccess('${k}',5)" style="background:var(--info);color:white;border:none;padding:8px;border-radius:5px;cursor:pointer;font-size:11px;">+5 ‡∏ä‡∏°.</button>
                        <button onclick="grantAccess('${k}',0)" style="background:var(--accent-gold);border:none;padding:8px;border-radius:5px;cursor:pointer;font-size:11px;">‡∏ñ‡∏≤‡∏ß‡∏£</button>
                        ${isSusp?`<button onclick="unbanUser('${k}')" style="background:#0ea5e9;color:white;border:none;padding:8px;border-radius:5px;cursor:pointer;font-size:11px;">üîì ‡∏õ‡∏•‡∏î‡∏£‡∏∞‡∏á‡∏±‡∏ö</button>`:`<button onclick="revokeAccess('${k}')" style="background:var(--danger);color:white;border:none;padding:8px;border-radius:5px;cursor:pointer;font-size:11px;">üö´ ‡∏£‡∏∞‡∏á‡∏±‡∏ö</button>`}
                        ${isPendDel
                            ? `<button onclick="cancelDelete('${k}')" style="background:#64748b;color:white;border:none;padding:8px;border-radius:5px;cursor:pointer;font-size:11px;">‚Ü©Ô∏è ‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô</button>`
                            : `<button onclick="requestDelete('${k}')" style="background:#374151;color:white;border:none;padding:8px;border-radius:5px;cursor:pointer;font-size:11px;" title="‡∏£‡∏≠ 3 ‡∏ß‡∏±‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏•‡∏ö‡∏ñ‡∏≤‡∏ß‡∏£">‚è≥ ‡∏•‡∏ö (3‡∏ß‡∏±‡∏ô)</button>`}
                        <button onclick="forceDeleteUser('${k}')" style="background:#ef4444;color:white;border:none;padding:8px;border-radius:5px;cursor:pointer;font-size:11px;font-weight:bold;" title="‡∏•‡∏ö‡∏ó‡∏±‡∏ô‡∏ó‡∏µ ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡πÑ‡∏î‡πâ">üóëÔ∏è ‡∏•‡∏ö‡∏ó‡∏±‡∏ô‡∏ó‡∏µ</button>
                        <button onclick="adminResetPassword('${k}')" style="grid-column:span 2;background:#7c3aed;color:white;border:none;padding:8px;border-radius:5px;cursor:pointer;font-size:11px;margin-top:2px;">üîë Reset Password ‚Üí 1234</button>
                        ${isBranch?`<button onclick="openAssignZoneModal('${k}')" style="grid-column:span 2;background:#0891b2;color:white;border:none;padding:8px;border-radius:5px;cursor:pointer;font-size:11px;margin-top:2px;">üìç ‡∏ú‡∏π‡∏Å‡∏Ñ‡∏•‡∏±‡∏á‡∏™‡∏≤‡∏Ç‡∏≤</button>`:''}
                    </div>
                </div>`;
            });
            grid.innerHTML=html||'<p style="color:#94a3b8;padding:20px;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</p>';
            // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï online dot ‡πÉ‡∏ô user cards
            const onlineRef2=ref(rtdb,'presence');
            onValue(onlineRef2,(snapshot)=>{
                const data=snapshot.val()||{};
                document.querySelectorAll('[id^="onlineDot_"]').forEach(el=>{
                    const uid=el.id.replace('onlineDot_','');
                    el.innerHTML=data[uid]?.online?'<span class="online-dot" title="‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå‡∏≠‡∏¢‡∏π‡πà"></span>':'<span class="offline-dot" title="‡∏≠‡∏≠‡∏ü‡πÑ‡∏•‡∏ô‡πå"></span>';
                });
            },{onlyOnce:true});
        };

        window.openAssignZoneModal = async function(username) {
            const snap=await getDoc(doc(db,'users',username));
            const userData=snap.exists()?snap.data():{};
            const assigned=userData.assignedZones||[];
            const modal=document.createElement('div'); modal.className='modal-overlay'; modal.id='assignZoneModal';
            modal.innerHTML=`<div class="modal-box"><h3>üìç ‡∏ú‡∏π‡∏Å‡∏Ñ‡∏•‡∏±‡∏á‡πÉ‡∏´‡πâ ${username}</h3>
                <p style="color:#64748b;font-size:13px;margin-bottom:15px;">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏•‡∏±‡∏á‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ user ‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á</p>
                <div id="zoneCheckList" style="display:flex;flex-direction:column;gap:10px;margin-bottom:20px;">
                    ${warehouseList.map(wh=>`<label style="display:flex;align-items:center;gap:10px;padding:12px;border:1px solid #e2e8f0;border-radius:10px;cursor:pointer;">
                        <input type="checkbox" value="${wh}" ${assigned.includes(wh)?'checked':''} style="width:18px;height:18px;">
                        <span>${wh}</span></label>`).join('')}
                </div>
                <div style="display:flex;gap:10px;">
                    <button onclick="saveAssignedZones('${username}')" style="flex:1;background:var(--success);color:white;border:none;padding:12px;border-radius:10px;cursor:pointer;font-weight:bold;">‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                    <button onclick="document.getElementById('assignZoneModal').remove()" style="flex:1;background:#f1f5f9;color:#475569;border:none;padding:12px;border-radius:10px;cursor:pointer;">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                </div></div>`;
            document.body.appendChild(modal);
        };

        window.saveAssignedZones = async function(username) {
            const checks=document.querySelectorAll('#zoneCheckList input:checked');
            const zones=Array.from(checks).map(c=>c.value);
            await setDoc(doc(db,'users',username),{assignedZones:zones},{merge:true});
            if (currentUser.username===username){currentUser.assignedZones=zones;localStorage.setItem('currentUser',JSON.stringify(currentUser));}
            document.getElementById('assignZoneModal').remove();
            toast('‚úÖ ‡∏ú‡∏π‡∏Å‡∏Ñ‡∏•‡∏±‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢','#059669'); renderUserCards();
        };

        window.adminResetPassword=async function(u){if(!confirm(`Reset Password ‡∏Ç‡∏≠‡∏á ${u} ‚Üí "1234"?`))return;await setDoc(doc(db,'users',u),{password:await hashPassword('1234')},{merge:true});toast('‚úÖ Reset ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ Password ‡πÉ‡∏´‡∏°‡πà: 1234','#059669');};

        window.openEditUserModal=function(uid,uname,urole){
            const existing=document.getElementById('editUserModal');if(existing)existing.remove();
            const roleOpts=Object.keys(roleSettings).map(r=>`<option value="${r}" ${r===urole?'selected':''}>${r}</option>`).join('');
            const modal=document.createElement('div');modal.className='modal-overlay';modal.id='editUserModal';
            modal.innerHTML=`<div class="modal-box"><h3>‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</h3>
                <div style="font-size:12px;color:#64748b;margin-bottom:12px;">ID: ${uid}</div>
                <label style="font-size:12px;font-weight:bold;color:#475569;display:block;margin-bottom:4px;">‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</label>
                <input type="text" id="editUserName" value="${uname}" style="width:100%;padding:10px;border:1px solid #e2e8f0;border-radius:8px;font-size:14px;box-sizing:border-box;margin-bottom:12px;">
                <label style="font-size:12px;font-weight:bold;color:#475569;display:block;margin-bottom:4px;">Role</label>
                <select id="editUserRole" style="width:100%;padding:10px;border:1px solid #e2e8f0;border-radius:8px;font-size:14px;margin-bottom:20px;">${roleOpts}</select>
                <div style="display:flex;gap:10px;">
                    <button onclick="saveEditUser('${uid}')" style="flex:1;background:var(--success);color:white;border:none;padding:12px;border-radius:10px;cursor:pointer;font-weight:bold;">‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                    <button onclick="document.getElementById('editUserModal').remove()" style="flex:1;background:#f1f5f9;color:#475569;border:none;padding:12px;border-radius:10px;cursor:pointer;">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                </div></div>`;
            document.body.appendChild(modal);
        };

        window.saveEditUser=async function(uid){
            const newName=document.getElementById('editUserName').value.trim();
            const newRole=document.getElementById('editUserRole').value;
            if(!newName){toast('‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠','#c2410c');return;}
            await setDoc(doc(db,'users',uid),{name:newName,role:newRole},{merge:true});
            document.getElementById('editUserModal').remove();
            toast('‚úÖ ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢','#059669');
            renderUserCards();
        };
        window.unbanUser=async function(u){await setDoc(doc(db,'users',u),{status:'active'},{merge:true});toast('üîì ‡∏õ‡∏•‡∏î‡∏£‡∏∞‡∏á‡∏±‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢','#059669');renderUserCards();};
        window.requestDelete=async function(u){if(!confirm(`‚è≥ ‡∏•‡∏ö‡∏ö‡∏±‡∏ç‡∏ä‡∏µ ${u}?\n‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏£‡∏≠ 3 ‡∏ß‡∏±‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏•‡∏ö‡∏ñ‡∏≤‡∏ß‡∏£ (‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡πÑ‡∏î‡πâ‡∏†‡∏≤‡∏¢‡πÉ‡∏ô 3 ‡∏ß‡∏±‡∏ô)`))return;await setDoc(doc(db,'users',u),{deleteAt:new Date().getTime()},{merge:true});toast('‚è≥ ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏•‡∏ö‡∏ö‡∏±‡∏ç‡∏ä‡∏µ '+u+' ‡∏†‡∏≤‡∏¢‡πÉ‡∏ô 3 ‡∏ß‡∏±‡∏ô','#c2410c');renderUserCards();};
        window.cancelDelete=async function(u){await setDoc(doc(db,'users',u),{deleteAt:null},{merge:true});toast('‚úÖ ‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢','#059669');renderUserCards();};
        window.grantAccess=async function(k,h){await setDoc(doc(db,'users',k),{toolExpiry:h===0?4070908800000:new Date().getTime()+(h*3600000),status:'active'},{merge:true});toast('‚úÖ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢','#059669');renderUserCards();};
        window.revokeAccess=async function(k){if(!confirm(`üö´ ‡∏£‡∏∞‡∏á‡∏±‡∏ö ${k}?`))return;await setDoc(doc(db,'users',k),{toolExpiry:0,status:'suspended'},{merge:true});toast('üîí ‡∏£‡∏∞‡∏á‡∏±‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢','#c2410c');renderUserCards();};
        window.forceDeleteUser=function(u){
            const existing=document.getElementById('forceDeleteModal');if(existing)existing.remove();
            const modal=document.createElement('div');modal.className='modal-overlay';modal.id='forceDeleteModal';
            modal.innerHTML=`<div class="modal-box" style="border-top:4px solid #ef4444;">
                <h3 style="color:#ef4444;">‚ö†Ô∏è ‡∏•‡∏ö‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ</h3>
                <div style="background:#fef2f2;border:1px solid #fca5a5;border-radius:10px;padding:14px;margin-bottom:16px;">
                    <div style="font-weight:700;color:#991b1b;margin-bottom:6px;">‡∏Ñ‡∏≥‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô: ‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡πÑ‡∏î‡πâ!</div>
                    <div style="font-size:13px;color:#7f1d1d;">‡∏ö‡∏±‡∏ç‡∏ä‡∏µ <b>${u}</b> ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏•‡∏ö‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡∏ó‡∏±‡∏ô‡∏ó‡∏µ ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏à‡∏∞‡∏´‡∏≤‡∏¢‡πÑ‡∏õ</div>
                </div>
                <div style="font-size:13px;color:#475569;margin-bottom:8px;font-weight:600;">‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ "<b>${u}</b>" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô:</div>
                <input type="text" id="confirmDeleteInput" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå ${u} ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô"
                    style="width:100%;padding:11px 14px;border:2px solid #fca5a5;border-radius:10px;font-size:14px;box-sizing:border-box;outline:none;margin-bottom:16px;"
                    onfocus="this.style.borderColor='#ef4444'" onblur="this.style.borderColor='#fca5a5'">
                <div id="confirmDeleteError" style="color:#ef4444;font-size:12px;margin-bottom:10px;display:none;">‚ùå ‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏û‡∏¥‡∏°‡∏û‡πå‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á</div>
                <div style="display:flex;gap:10px;">
                    <button onclick="confirmForceDelete('${u}')"
                        style="flex:1;background:#ef4444;color:white;border:none;padding:13px;border-radius:10px;cursor:pointer;font-weight:700;font-size:14px;">
                        üóëÔ∏è ‡∏•‡∏ö‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
                    </button>
                    <button onclick="document.getElementById('forceDeleteModal').remove()"
                        style="flex:1;background:#f1f5f9;color:#475569;border:none;padding:13px;border-radius:10px;cursor:pointer;font-weight:600;">
                        ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                    </button>
                </div>
            </div>`;
            document.body.appendChild(modal);
            document.getElementById('confirmDeleteInput').focus();
        };

        window.confirmForceDelete=async function(u){
            const input=document.getElementById('confirmDeleteInput').value.trim();
            const errEl=document.getElementById('confirmDeleteError');
            if(input!==u){
                errEl.style.display='block';
                document.getElementById('confirmDeleteInput').style.borderColor='#ef4444';
                return;
            }
            errEl.style.display='none';
            try {
                await deleteDoc(doc(db,'users',u));
                document.getElementById('forceDeleteModal').remove();
                toast(`üóëÔ∏è ‡∏•‡∏ö‡∏ö‡∏±‡∏ç‡∏ä‡∏µ ${u} ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß`,'#ef4444');
                renderUserCards();
            } catch(e) {
                toast('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: '+e.message,'#c2410c');
            }
        };

        window.addNewUser=async function(){
            const n=document.getElementById('newUserName').value.trim(),u=document.getElementById('newUserKey').value.trim(),r=document.getElementById('newUserRole').value,rp=document.getElementById('newUserPass').value.trim()||'1234';
            if(!n||!u)return;
            const ud={name:n,role:r,username:u,password:await hashPassword(rp),toolExpiry:0,status:'active'};
            if(u.toUpperCase().startsWith('BT000'))ud.assignedZones=[];
            await setDoc(doc(db,'users',u),ud);
            toast('‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢','#059669');
            document.getElementById('newUserName').value=document.getElementById('newUserKey').value=document.getElementById('newUserPass').value='';
            renderUserCards();
        };

        window.renderRoleSettings=function(){
            const list=document.getElementById('rolePermissionsList'),sel=document.getElementById('newUserRole');if(!list)return;
            let html='',opts='';
            Object.keys(roleSettings).forEach(role=>{
                const perms=roleSettings[role].menus,vo=roleSettings[role].viewOnly||false;
                html+=`<div style="padding:12px;border:1px solid #f1f5f9;border-radius:10px;margin-bottom:10px;background:#f8fafc;">
                    <div style="display:flex;justify-content:space-between;"><b style="text-transform:uppercase;">${role}</b>${role!=='admin'?`<small onclick="deleteRole('${role}')" style="color:red;cursor:pointer;">‡∏•‡∏ö Role</small>`:''}</div>
                    <div style="display:flex;gap:10px;font-size:11px;margin-top:10px;flex-wrap:wrap;align-items:center;">
                        <label style="display:flex;align-items:center;gap:4px;background:#f8fafc;border:1px solid #e2e8f0;padding:4px 10px;border-radius:20px;cursor:pointer;">
                            <input type="checkbox" ${perms.includes('warehouse')?'checked':''} onchange="togglePerm('${role}','warehouse')"> üì¶ ‡∏Ñ‡∏•‡∏±‡∏á</label>
                        <label style="display:flex;align-items:center;gap:4px;background:#f8fafc;border:1px solid #e2e8f0;padding:4px 10px;border-radius:20px;cursor:pointer;">
                            <input type="checkbox" ${perms.includes('requisition')?'checked':''} onchange="togglePerm('${role}','requisition')"> üìã ‡πÉ‡∏ö‡πÄ‡∏ö‡∏¥‡∏Å</label>
                        <label style="display:flex;align-items:center;gap:4px;background:#f8fafc;border:1px solid #e2e8f0;padding:4px 10px;border-radius:20px;cursor:pointer;">
                            <input type="checkbox" ${perms.includes('tools')?'checked':''} onchange="togglePerm('${role}','tools')"> üõ†Ô∏è ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠</label>
                        <label style="display:flex;align-items:center;gap:4px;background:#f0f9ff;border:1px solid #bae6fd;padding:4px 10px;border-radius:20px;cursor:pointer;">
                            <input type="checkbox" ${perms.includes('gr')?'checked':''} onchange="togglePerm('${role}','gr')" style="accent-color:#06b6d4;"> üöö GR</label>
                        <label style="display:flex;align-items:center;gap:4px;background:#faf5ff;border:1px solid #e9d5ff;padding:4px 10px;border-radius:20px;cursor:pointer;">
                            <input type="checkbox" ${perms.includes('qc')?'checked':''} onchange="togglePerm('${role}','qc')" style="accent-color:#7c3aed;"> üîç QC</label>
                        <label style="display:flex;align-items:center;gap:4px;background:#fef9f0;border:1px solid #fde68a;padding:4px 10px;border-radius:20px;cursor:pointer;">
                            <input type="checkbox" ${perms.includes('admin')?'checked':''} onchange="togglePerm('${role}','admin')" style="accent-color:#d97706;"> ‚öôÔ∏è ‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô</label>
                        <label style="display:flex;align-items:center;gap:4px;background:#eff6ff;border:1px solid #bfdbfe;padding:4px 10px;border-radius:20px;cursor:pointer;color:#1d4ed8;font-weight:bold;">
                            <input type="checkbox" ${vo?'checked':''} onchange="toggleViewOnly('${role}')" style="accent-color:#3b82f6;"> üëÅÔ∏è ‡∏î‡∏π‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß</label>
                    </div></div>`;
                opts+=`<option value="${role}">${role}</option>`;
            });
            list.innerHTML=html;if(sel)sel.innerHTML=opts;
        };

        window.toggleViewOnly=function(r){roleSettings[r].viewOnly=!roleSettings[r].viewOnly;saveConfig();renderRoleSettings();applyPermissions();};
        window.togglePerm=function(r,m){const i=roleSettings[r].menus.indexOf(m);if(i>-1)roleSettings[r].menus.splice(i,1);else roleSettings[r].menus.push(m);saveConfig();applyPermissions();renderRoleSettings();};
        window.addNewRole=function(){const n=document.getElementById('newRoleName').value.trim().toLowerCase();if(n&&!roleSettings[n]){roleSettings[n]={menus:[],viewOnly:false};saveConfig();renderRoleSettings();}};
        window.deleteRole=function(r){if(confirm(`‡∏•‡∏ö Role: ${r}?`)){delete roleSettings[r];saveConfig();renderRoleSettings();}};

        // ---- STOCK TOOL (‡πÅ‡∏Å‡πâ bug selectedStaff) ----
        window.openCentralStock=function(){
            document.getElementById('dashboardView').classList.add('hidden');
            document.getElementById('toolAppContainer').classList.remove('hidden');
            tempCountData={};
            const visibleZones=getVisibleWarehouses();
            renderStockTool(visibleZones[0]||warehouseList[0]);
        };

        window.renderStockTool=async function(zone){
            const c=document.getElementById('toolAppContainer');
            const visibleZones=getVisibleWarehouses();
            const zoneProds=allProducts.filter(p=>(zoneProductMap[zone]||[]).includes(p.id));
            const usSnap=await getDocs(collection(db,'users')); let staffOpts='';
            usSnap.forEach(d=>{const u=d.data();if(u.status!=='suspended')staffOpts+=`<option value="${u.name}" ${selectedStaff===u.name?'selected':''}>${u.name}</option>`;});

            c.innerHTML=`<div class="tool-header no-print"><h2>üì¶ ‡∏ô‡∏±‡∏ö‡∏™‡∏ï‡πä‡∏≠‡∏Å: ${zone}</h2><button onclick="closeTool()">‚úï ‡∏õ‡∏¥‡∏î</button></div>
            <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:15px;margin-bottom:20px;" class="no-print">
                <div class="input-group"><label>üì¶ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏ã‡∏ô</label>
                    <select onchange="renderStockTool(this.value)" style="width:100%;border:none;font-weight:bold;outline:none;">
                        ${visibleZones.map(w=>`<option ${w===zone?'selected':''}>${w}</option>`).join('')}
                    </select></div>
                <div class="input-group" style="border:2px solid var(--danger);"><label>üìÖ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ô‡∏±‡∏ö (‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÄ‡∏•‡∏∑‡∏≠‡∏Å)</label>
                    <input type="date" id="countDate" value="${selectedDate}" onchange="selectedDate=this.value" style="width:100%;border:none;font-weight:bold;outline:none;font-size:14px;">
                </div>
                <div class="input-group" style="border:2px solid var(--info);"><label>üë§ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏ô‡∏ô‡∏±‡∏ö</label>
                    <select id="staffSelect" onchange="selectedStaff=this.value" style="width:100%;border:none;font-weight:bold;outline:none;">
                        <option value="">-- ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å --</option>${staffOpts}
                    </select></div>
                <div class="input-group" style="background:#f1f5f9;"><label>üìù ‡∏ú‡∏π‡πâ‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏´‡∏•‡∏±‡∏Å</label><b>${currentUser.name}</b></div>
            </div>
            <table class="stock-table">${zoneProds.map(p=>{
                const units=p.units||[{name:p.unit||'',rate:0},{name:p.subUnit||'',rate:0}].filter(u=>u.name);
                const pending=tempCountData[p.id];
                const hasPending=pending&&units.some((_,ui)=>(pending['u'+ui]||0)>0);
                const lu=countData[p.id]?.lastUpdate||'-';
                const borderColors=['var(--info)','#a78bfa','#f59e0b'];
                return `<tr class="stock-row">
                <td><b style="font-size:16px;">${p.id}</b><br><span style="color:#475569;">${p.name}</span><br><small style="color:#94a3b8;font-size:10px;">‡∏ô‡∏±‡∏ö‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: ${lu}</small></td>
                <td style="text-align:right;">
                    <div style="display:flex;align-items:center;justify-content:flex-end;gap:12px;">
                        <div style="text-align:right;min-width:140px;">
                            ${hasPending
                                ? `<div style="font-size:13px;color:var(--info);font-weight:bold;">${units.map((_,ui)=>(pending['u'+ui]||0)>0?`<span>${pending['u'+ui]} ${units[ui].name}</span>`:'').filter(Boolean).join(' + ')}</div>
                                   <div style="font-size:11px;color:#94a3b8;">‡∏£‡∏≠‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô...</div>`
                                : `<div style="font-size:12px;color:#cbd5e1;">‚Äî</div>`
                            }
                        </div>
                        <div style="display:flex;flex-direction:column;gap:5px;">
                            ${units.map((u,ui)=>`
                            <div style="display:flex;align-items:center;gap:5px;">
                                <small style="color:${borderColors[ui]||'#64748b'};width:45px;text-align:right;font-weight:bold;">${u.name}:</small>
                                <input type="number" id="input_${p.id}_${ui}" min="0" class="no-print viewonly-input"
                                    style="width:75px;padding:7px;border-radius:8px;border:2px solid ${borderColors[ui]||'#cbd5e1'};text-align:center;font-weight:bold;font-size:14px;"
                                    onkeydown="if(event.key==='Enter') addStock('${p.id}','${p.name}','${zone}',${ui})">
                            </div>`).join('')}
                        </div>
                        <button onclick="addStockAll('${p.id}','${p.name}','${zone}')" class="btn-action no-print" style="background:var(--info);font-size:20px;">Ôºã</button>
                    </div>
                </td></tr>`;}).join('')}</table>
            <p style="color:#94a3b8;font-size:12px;text-align:center;margin-top:5px;" class="no-print">üí° ‡∏Å‡∏£‡∏≠‡∏Å‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î Enter ‡πÉ‡∏ô‡∏ä‡πà‡∏≠‡∏á‡∏ô‡∏±‡πâ‡∏ô ‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏î Ôºã ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ó‡∏∏‡∏Å‡∏ä‡πà‡∏≠‡∏á‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏±‡∏ô</p>
            <div class="no-print" style="margin-bottom:12px;">
                <input type="text" id="stockSearch" placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (‡∏£‡∏´‡∏±‡∏™ / ‡∏ä‡∏∑‡πà‡∏≠)..." oninput="filterStockRows(this.value)"
                    style="width:100%;padding:10px 16px;border:1px solid #e2e8f0;border-radius:10px;font-size:14px;box-sizing:border-box;outline:none;transition:border 0.2s;"
                    onfocus="this.style.borderColor='var(--info)'" onblur="this.style.borderColor='#e2e8f0'">
            </div>
            <div style="margin-top:25px;text-align:center;" class="no-print">
                <button onclick="finalSaveStock('${zone}')" style="background:var(--success);color:white;padding:18px 60px;border:none;border-radius:15px;font-size:20px;font-weight:bold;cursor:pointer;box-shadow:0 4px 15px rgba(16,185,129,0.4);">üíæ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÅ‡∏•‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
            </div>`;
        };

        // addStock: ‡∏Å‡∏£‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î Enter ‡πÉ‡∏ô‡∏ä‡πà‡∏≠‡∏á‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏ô‡∏±‡πâ‡∏ô
        window.addStock=function(id,name,zone,unitIndex){
            const staffEl=document.getElementById('staffSelect');
            if(staffEl&&staffEl.value) selectedStaff=staffEl.value;
            const el=document.getElementById(`input_${id}_${unitIndex}`);
            const val=parseFloat(el?.value)||0;
            if(val<=0){if(el){el.style.borderColor='var(--danger)';setTimeout(()=>el.style.borderColor='',800);}return;}
            if(!tempCountData[id])tempCountData[id]={name};
            tempCountData[id]['u'+unitIndex]=(tempCountData[id]['u'+unitIndex]||0)+val;
            if(el){el.value='';el.style.borderColor='var(--success)';setTimeout(()=>el.style.borderColor='',600);}
            setTimeout(()=>renderStockTool(zone),400);
        };

        // addStockAll: ‡∏Å‡∏î Ôºã ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ó‡∏∏‡∏Å‡∏ä‡πà‡∏≠‡∏á‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏±‡∏ô
        window.addStockAll=function(id,name,zone){
            const staffEl=document.getElementById('staffSelect');
            if(staffEl&&staffEl.value) selectedStaff=staffEl.value;
            const p=allProducts.find(pd=>pd.id===id);
            const units=p?.units||[{name:p?.unit||'',rate:0}];
            let anyVal=false;
            units.forEach((_,ui)=>{
                const el=document.getElementById(`input_${id}_${ui}`);
                const val=parseFloat(el?.value)||0;
                if(val>0){
                    if(!tempCountData[id])tempCountData[id]={name};
                    tempCountData[id]['u'+ui]=(tempCountData[id]['u'+ui]||0)+val;
                    if(el){el.value='';el.style.borderColor='var(--success)';setTimeout(()=>el.style.borderColor='',600);}
                    anyVal=true;
                }
            });
            if(!anyVal){toast('‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Å‡πà‡∏≠‡∏ô','#c2410c');return;}
            setTimeout(()=>renderStockTool(zone),400);
        };

        window.finalSaveStock=async function(zone){
            const staffEl=document.getElementById('staffSelect');
            if(staffEl&&staffEl.value) selectedStaff=staffEl.value;
            const dateEl=document.getElementById('countDate');
            if(dateEl&&dateEl.value) selectedDate=dateEl.value;

            if(!selectedDate){toast('‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ô‡∏±‡∏ö‡∏Å‡πà‡∏≠‡∏ô','#c2410c');return;}
            if(!selectedStaff){toast('‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏ô‡∏ô‡∏±‡∏ö‡∏Å‡πà‡∏≠‡∏ô','#c2410c');return;}
            const hasChanges=Object.keys(tempCountData).some(id=>{
                const td=tempCountData[id];
                return Object.keys(td).filter(k=>k.startsWith('u')).some(k=>(td[k]||0)>0);
            });
            if(!hasChanges){toast('‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÅ‡∏•‡∏∞‡∏Å‡∏î Ôºã ‡∏Å‡πà‡∏≠‡∏ô','#c2410c');return;}
            if(!confirm(`‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${selectedDate} ‡πÇ‡∏î‡∏¢‡∏Ñ‡∏∏‡∏ì ${selectedStaff}?`))return;

            // ‡πÅ‡∏õ‡∏•‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏≤‡∏Å yyyy-mm-dd ‡πÄ‡∏õ‡πá‡∏ô dd/mm/yyyy (‡πÑ‡∏ó‡∏¢)
            const [yr,mo,dy]=selectedDate.split('-');
            const dateStr=`${dy}/${mo}/${parseInt(yr)+543}`;
            const now=new Date();
            const timeStr=now.toLocaleTimeString('th-TH',{hour:'2-digit',minute:'2-digit'});
            const ts=dateStr+' '+timeStr;

            // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡πÉ‡∏ô countData (‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏´‡∏•‡∏±‡∏Å‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô)
            Object.keys(tempCountData).forEach(id=>{
                const td=tempCountData[id];
                const p=allProducts.find(pd=>pd.id===id);
                const units=p?.units||[{name:p?.unit||'',rate:0}];
                // ‡πÅ‡∏õ‡∏•‡∏á‡∏ó‡∏∏‡∏Å‡∏´‡∏ô‡πà‡∏ß‡∏¢‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏´‡∏•‡∏±‡∏Å
                let totalInUnit1=td['u0']||0;
                // u1 ‡πÅ‡∏õ‡∏•‡∏á‡πÇ‡∏î‡∏¢ rate[0] ‡∏Ç‡∏≠‡∏á unit[0]
                if((td['u1']||0)>0&&units[0]?.rate>0) totalInUnit1+=((td['u1']||0)/units[0].rate);
                if((td['u2']||0)>0&&units[0]?.rate>0&&units[1]?.rate>0) totalInUnit1+=((td['u2']||0)/(units[0].rate*units[1].rate));
                if(!countData[id])countData[id]={total:0,name:td.name};
                // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡πÄ‡∏õ‡πá‡∏ô 0 ‡πÅ‡∏•‡πâ‡∏ß‡πÉ‡∏™‡πà‡∏¢‡∏≠‡∏î‡∏ó‡∏µ‡πà‡∏ô‡∏±‡∏ö‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô (‡πÑ‡∏°‡πà‡∏™‡∏∞‡∏™‡∏°)
                countData[id].total=Math.round(totalInUnit1*1000)/1000;
                countData[id].lastUpdate=ts;
                countData[id].countedBy=selectedStaff;
            });
            await saveCountData();

            // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å history ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏∏‡∏Å‡∏´‡∏ô‡πà‡∏ß‡∏¢
            const sessionItems=Object.keys(tempCountData).map(id=>{
                const td=tempCountData[id];
                const p=allProducts.find(pd=>pd.id===id);
                const units=p?.units||[{name:p?.unit||'',rate:0}];
                const amounts=units.map((_,ui)=>({amount:td['u'+ui]||0,unit:units[ui]?.name||''}));
                return {id,name:td.name,amounts,units};
            });

            await addDoc(collection(db,'stockHistory'),{
                zone,date:dateStr,timestamp:now.getTime(),
                countedBy:selectedStaff,recordedBy:currentUser.name,items:sessionItems
            });

            tempCountData={};
            toast('‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡πÅ‡∏•‡πâ‡∏ß','#059669');
            renderStockTool(zone);
        };

        // ---- STOCK SUMMARY ----
        window.openStockSummary=async function(){
            document.getElementById('dashboardView').classList.add('hidden');
            const c=document.getElementById('toolAppContainer');c.classList.remove('hidden');
            const visibleZones=getVisibleWarehouses();
            c.innerHTML=`<div class="tool-header"><h2>üìä ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ & Export ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</h2><button onclick="closeTool()">‚úï ‡∏õ‡∏¥‡∏î</button></div>
            <div class="filter-bar no-print" style="flex-wrap:wrap;gap:12px;">
                <div>
                    <label>üìã ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</label>
                    <select id="reportMode" onchange="switchReportMode()" style="padding:10px 14px;border:2px solid var(--primary-dark);border-radius:10px;font-size:14px;font-weight:bold;min-width:220px;">
                        <option value="history">üìú ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡∏ö (‡∏ó‡∏∏‡∏Å session)</option>
                        <option value="snapshot">üì¶ ‡∏¢‡∏≠‡∏î‡∏™‡∏ï‡πä‡∏≠‡∏Å‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î (‡∏û‡∏£‡πâ‡∏≠‡∏° export)</option>
                    </select>
                </div>
                <div><label>üì¶ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏•‡∏±‡∏á</label>
                    <select id="filterZone" onchange="loadCurrentReport()">
                        <option value="">‚Äî ‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏•‡∏±‡∏á ‚Äî</option>
                        ${visibleZones.map(w=>`<option value="${w}">${w}</option>`).join('')}
                    </select></div>
                <div id="dateFromWrap"><label>üìÖ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô</label><input type="date" id="filterDateFrom" onchange="loadCurrentReport()"></div>
                <div id="dateToWrap"><label>üìÖ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î</label><input type="date" id="filterDateTo" onchange="loadCurrentReport()"></div>
                <div style="display:flex;gap:8px;align-items:flex-end;">
                    <button onclick="exportCurrentReport()" style="background:var(--success);color:white;border:none;padding:12px 20px;border-radius:10px;cursor:pointer;font-weight:bold;">üì• Export Excel</button>
                    <button onclick="window.print()" style="background:var(--danger);color:white;border:none;padding:12px 20px;border-radius:10px;cursor:pointer;font-weight:bold;">üñ®Ô∏è Print PDF</button>
                </div>
            </div>
            <div id="historyContainer"><p style="color:#94a3b8;text-align:center;padding:40px;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</p></div>`;
            await loadCurrentReport();
        };

        window.switchReportMode=function(){
            const mode=document.getElementById('reportMode').value;
            document.getElementById('dateFromWrap').style.display=mode==='history'?'':'none';
            document.getElementById('dateToWrap').style.display=mode==='history'?'':'none';
            loadCurrentReport();
        };

        window.loadCurrentReport=async function(){
            const mode=document.getElementById('reportMode')?.value||'history';
            if(mode==='snapshot') await loadSnapshot();
            else await loadHistory();
        };

        window.exportCurrentReport=function(){
            const mode=document.getElementById('reportMode')?.value||'history';
            if(mode==='snapshot') exportExcelSnapshot();
            else exportExcelHistory();
        };

        // ---- SNAPSHOT: ‡∏¢‡∏≠‡∏î‡∏™‡∏ï‡πä‡∏≠‡∏Å‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ ----
        window.loadSnapshot=async function(){
            const zone=document.getElementById('filterZone')?.value||'';
            const container=document.getElementById('historyContainer');
            if(!container)return;
            container.innerHTML='<p style="color:#94a3b8;text-align:center;padding:40px;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</p>';
            try{
                await loadCountData();
                const zones=zone?[zone]:getVisibleWarehouses();
                let html='';
                zones.forEach(z=>{
                    const prods=allProducts.filter(p=>(zoneProductMap[z]||[]).includes(p.id));
                    if(!prods.length)return;
                    html+=`<div class="history-card" style="margin-bottom:20px;">
                        <div class="history-card-header"><b>üì¶ ${z}</b></div>
                        <table style="width:100%;border-collapse:collapse;">
                            <thead><tr style="background:#f8fafc;">
                                <th style="padding:10px;text-align:left;font-size:12px;color:#64748b;">‡∏£‡∏´‡∏±‡∏™</th>
                                <th style="padding:10px;text-align:left;font-size:12px;color:#64748b;">‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th>
                                <th style="padding:10px;text-align:center;font-size:12px;color:#64748b;">‡∏¢‡∏≠‡∏î‡∏™‡∏ï‡πä‡∏≠‡∏Å</th>
                                <th style="padding:10px;text-align:center;font-size:12px;color:#64748b;">‡∏´‡∏ô‡πà‡∏ß‡∏¢</th>
                                <th style="padding:10px;text-align:center;font-size:12px;color:#64748b;">‡∏ô‡∏±‡∏ö‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</th>
                                <th style="padding:10px;text-align:center;font-size:12px;color:#64748b;">‡πÇ‡∏î‡∏¢</th>
                            </tr></thead>
                            <tbody>${prods.map(p=>{
                                const cd=countData[p.id]||{total:0};
                                const units=p.units||[{name:p.unit||''}];
                                return `<tr style="border-top:1px solid #f1f5f9;">
                                    <td style="padding:10px;font-weight:bold;">${p.id}</td>
                                    <td style="padding:10px;color:#475569;">${p.name}</td>
                                    <td style="padding:10px;text-align:center;font-weight:bold;color:var(--success);font-size:16px;">${cd.total||0}</td>
                                    <td style="padding:10px;text-align:center;color:#64748b;">${units[0]?.name||''}</td>
                                    <td style="padding:10px;text-align:center;font-size:12px;color:#94a3b8;">${cd.lastUpdate||'-'}</td>
                                    <td style="padding:10px;text-align:center;font-size:12px;color:#94a3b8;">${cd.countedBy||'-'}</td>
                                    <td style="padding:8px;text-align:center;">${currentUser.role==='admin'?`<button onclick="openEditStockModal('${p.id}')" style="background:#f1f5f9;border:1px solid #e2e8f0;border-radius:6px;padding:4px 10px;cursor:pointer;font-size:11px;color:#475569;">‚úèÔ∏è ‡πÅ‡∏Å‡πâ</button>`:''}</td>
                                </tr>`;}).join('')}
                            </tbody>
                        </table>
                    </div>`;
                });
                container.innerHTML=html||'<p style="color:#94a3b8;text-align:center;padding:40px;">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p>';
            }catch(e){console.error(e);container.innerHTML='<p style="color:var(--danger);text-align:center;padding:40px;">‚ùå ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</p>';}
        };

        window.exportExcelSnapshot=function(){
            const zone=document.getElementById('filterZone')?.value||'';
            const zones=zone?[zone]:getVisibleWarehouses();
            const rows=[['‡∏Ñ‡∏•‡∏±‡∏á','‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤','‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤','‡∏¢‡∏≠‡∏î‡∏™‡∏ï‡πä‡∏≠‡∏Å','‡∏´‡∏ô‡πà‡∏ß‡∏¢','‡∏ô‡∏±‡∏ö‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î','‡πÇ‡∏î‡∏¢']];
            zones.forEach(z=>{
                const prods=allProducts.filter(p=>(zoneProductMap[z]||[]).includes(p.id));
                prods.forEach(p=>{
                    const cd=countData[p.id]||{total:0};
                    const units=p.units||[{name:p.unit||''}];
                    rows.push([z,p.id,p.name,cd.total||0,units[0]?.name||'',cd.lastUpdate||'',cd.countedBy||'']);
                });
            });
            const ws=XLSX.utils.aoa_to_sheet(rows),wb=XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb,ws,'‡∏¢‡∏≠‡∏î‡∏™‡∏ï‡πä‡∏≠‡∏Å');
            XLSX.writeFile(wb,`Stock_Snapshot_${new Date().toLocaleDateString('th-TH')}.xlsx`);
        };

        let currentHistoryData=[];

        window.loadHistory=async function(){
            const zone=document.getElementById('filterZone')?.value||'';
            const dateFrom=document.getElementById('filterDateFrom')?.value||'';
            const dateTo=document.getElementById('filterDateTo')?.value||'';
            // ‡∏ñ‡πâ‡∏≤‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô snapshot mode ‡πÉ‡∏´‡πâ‡∏Ç‡πâ‡∏≤‡∏°‡πÑ‡∏õ
            if(document.getElementById('reportMode')?.value==='snapshot'){loadSnapshot();return;}
            const container=document.getElementById('historyContainer');
            if(!container)return;
            container.innerHTML='<p style="color:#94a3b8;text-align:center;padding:40px;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</p>';
            try {
                const snap=await getDocs(collection(db,'stockHistory'));
                let sessions=[];
                snap.forEach(d=>sessions.push({id:d.id,...d.data()}));
                if(zone)sessions=sessions.filter(s=>s.zone===zone);
                if(dateFrom){const from=new Date(dateFrom).getTime();sessions=sessions.filter(s=>s.timestamp>=from);}
                if(dateTo){const to=new Date(dateTo).getTime()+86399999;sessions=sessions.filter(s=>s.timestamp<=to);}
                sessions.sort((a,b)=>b.timestamp-a.timestamp);
                currentHistoryData=sessions;
                if(sessions.length===0){container.innerHTML='<p style="color:#94a3b8;text-align:center;padding:40px;">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏°‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</p>';return;}
                container.innerHTML=sessions.map(s=>`
                <div class="history-card">
                    <div class="history-card-header">
                        <div><b style="font-size:15px;">üì¶ ${s.zone}</b>
                        <span style="margin-left:12px;color:#64748b;font-size:13px;">üìÖ ${s.date} ${s.countedBy?'‚Ä¢ üë§ '+s.countedBy:''}</span></div>
                        <div style="display:flex;align-items:center;gap:10px;">
                            <span style="font-size:11px;color:#94a3b8;">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÇ‡∏î‡∏¢: ${s.recordedBy||'-'}</span>
                            ${currentUser.role==='admin'?`<button onclick="deleteHistorySession('${s.id}')" style="background:#fee2e2;color:#ef4444;border:none;padding:4px 10px;border-radius:6px;cursor:pointer;font-size:11px;font-weight:bold;">üóëÔ∏è ‡∏•‡∏ö</button>`:''}
                        </div>
                    </div>
                    <table style="width:100%;border-collapse:collapse;">
                        <thead><tr style="background:#f8fafc;">
                            <th style="padding:10px;text-align:left;font-size:12px;color:#64748b;">‡∏£‡∏´‡∏±‡∏™</th>
                            <th style="padding:10px;text-align:left;font-size:12px;color:#64748b;">‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th>
                            <th style="padding:10px;text-align:center;font-size:12px;color:#64748b;">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th>
                            <th style="padding:10px;text-align:center;font-size:12px;color:#64748b;">‡∏´‡∏ô‡πà‡∏ß‡∏¢</th>
                            <th style="padding:10px;text-align:center;font-size:12px;color:#64748b;">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th>
                            <th style="padding:10px;text-align:center;font-size:12px;color:#64748b;">‡∏´‡∏ô‡πà‡∏ß‡∏¢</th>
                            <th style="padding:10px;text-align:center;font-size:12px;color:#64748b;">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th>
                            <th style="padding:10px;text-align:center;font-size:12px;color:#64748b;">‡∏´‡∏ô‡πà‡∏ß‡∏¢</th>
                        </tr></thead>
                        <tbody>${(s.items||[]).map(it=>{
                            // support both old and new format
                            const amounts=it.amounts||[{amount:it.amountMain||it.amount||0,unit:it.unit||''},{amount:it.amountSub||0,unit:it.subUnit||''}].filter(a=>a.unit);
                            return `<tr style="border-top:1px solid #f1f5f9;">
                            <td style="padding:10px;font-weight:bold;">${it.id}</td>
                            <td style="padding:10px;color:#475569;">${it.name}</td>
                            ${amounts.map(a=>`<td style="padding:10px;text-align:center;font-weight:bold;color:var(--success);">${a.amount>0?a.amount:'-'}</td><td style="padding:10px;text-align:center;color:#64748b;">${a.unit}</td>`).join('')}
                        </tr>`;}).join('')}</tbody>
                    </table>
                </div>`).join('');
            } catch(e){console.error(e);container.innerHTML='<p style="color:var(--danger);text-align:center;padding:40px;">‚ùå ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</p>';}
        };

        window.exportExcelHistory=function(){
            if(!currentHistoryData||currentHistoryData.length===0){toast('‚ùå ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ export','#c2410c');return;}
            const rows=[["‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà","‡∏Ñ‡∏•‡∏±‡∏á","‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤","‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤","‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏´‡∏ô‡πà‡∏ß‡∏¢1","‡∏´‡∏ô‡πà‡∏ß‡∏¢1","‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏´‡∏ô‡πà‡∏ß‡∏¢2","‡∏´‡∏ô‡πà‡∏ß‡∏¢2","‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏´‡∏ô‡πà‡∏ß‡∏¢3","‡∏´‡∏ô‡πà‡∏ß‡∏¢3","‡∏Ñ‡∏ô‡∏ô‡∏±‡∏ö","‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÇ‡∏î‡∏¢"]];
            currentHistoryData.forEach(s=>{
                (s.items||[]).forEach(it=>{
                    const amounts=it.amounts||[{amount:it.amountMain||it.amount||0,unit:it.unit||''},{amount:it.amountSub||0,unit:it.subUnit||''}].filter(a=>a.unit);
                    // pad ‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö 3 ‡∏´‡∏ô‡πà‡∏ß‡∏¢‡πÄ‡∏™‡∏°‡∏≠ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ï‡∏£‡∏á
                    const padded=Array.from({length:3},(_,i)=>amounts[i]||{amount:0,unit:''});
                    const row=[s.date,s.zone,it.id,it.name,
                        padded[0].amount||0, padded[0].unit||'',
                        padded[1].amount||0, padded[1].unit||'',
                        padded[2].amount||0, padded[2].unit||'',
                        s.countedBy||'',s.recordedBy||''];
                    rows.push(row);
                });
            });
            const ws=XLSX.utils.aoa_to_sheet(rows),wb=XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb,ws,"StockHistory");
            const zone=document.getElementById('filterZone')?.value||'all';
            XLSX.writeFile(wb,`StockHistory_${zone}_${new Date().toLocaleDateString('th-TH')}.xlsx`);
        };

        // ---- WAREHOUSE MANAGER (‡πÄ‡∏û‡∏¥‡πà‡∏° edit + subUnit) ----
        window.openWarehouseManager=function(){
            document.getElementById('dashboardView').classList.add('hidden');
            const c=document.getElementById('toolAppContainer');c.classList.remove('hidden');
            c.innerHTML=`<div class="tool-header"><h2>‚öôÔ∏è ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏•‡∏±‡∏á‡πÅ‡∏•‡∏∞‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</h2><button onclick="closeTool()">‚úï ‡∏õ‡∏¥‡∏î</button></div>
            <div style="display:flex;gap:10px;margin-bottom:20px;">
                <button onclick="backupConfig()" style="background:#0f172a;color:white;border:none;padding:10px 20px;border-radius:10px;cursor:pointer;font-weight:bold;display:flex;align-items:center;gap:8px;">üíæ Backup Config</button>
                <label style="background:#0891b2;color:white;border:none;padding:10px 20px;border-radius:10px;cursor:pointer;font-weight:bold;display:flex;align-items:center;gap:8px;">
                    üìÇ Restore Config<input type="file" accept=".json" onchange="restoreConfig(this)" style="display:none;">
                </label>
                <small style="color:#94a3b8;align-self:center;font-size:11px;">‡∏™‡∏≥‡∏£‡∏≠‡∏á/‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô ‡∏Ñ‡∏•‡∏±‡∏á, ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤, mapping ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</small>
            </div>
            <div style="display:grid;grid-template-columns:1fr 1.2fr;gap:25px;">
                <div style="background:white;padding:20px;border-radius:15px;border:1px solid #e2e8f0;">
                    <h4>üì¶ ‡∏Ñ‡∏•‡∏±‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (Zones)</h4>
                    <div style="display:flex;gap:8px;margin-bottom:15px;">
                        <input type="text" id="newWhName" placeholder="‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏•‡∏±‡∏á/‡πÇ‡∏ã‡∏ô‡πÉ‡∏´‡∏°‡πà" style="flex:1;padding:10px;border-radius:8px;border:1px solid #ddd;">
                        <button onclick="addWh()" style="background:var(--success);color:white;padding:10px 20px;border:none;border-radius:8px;cursor:pointer;">‡πÄ‡∏û‡∏¥‡πà‡∏°</button>
                    </div>
                    <div id="whListContainer"></div>
                </div>
                <div style="background:white;padding:20px;border-radius:15px;border:1px solid #e2e8f0;">
                    <h4>üçé ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</h4>
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:10px;">
                        <input type="text" id="newPdId" placeholder="‡∏£‡∏´‡∏±‡∏™ SKU" style="padding:10px;border:1px solid #ddd;border-radius:8px;">
                        <input type="text" id="newPdName" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤" style="padding:10px;border:1px solid #ddd;border-radius:8px;grid-column:span 1;">
                    </div>
                    <div style="background:#f8fafc;border-radius:8px;padding:10px;margin-bottom:10px;border:1px solid #e2e8f0;">
                        <div style="font-size:11px;color:#64748b;font-weight:bold;margin-bottom:8px;">‡∏´‡∏ô‡πà‡∏ß‡∏¢‡πÅ‡∏•‡∏∞‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡πÅ‡∏õ‡∏•‡∏á (‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 3 ‡∏´‡∏ô‡πà‡∏ß‡∏¢)</div>
                        <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:6px;align-items:center;margin-bottom:6px;">
                            <input type="text" id="newPdUnit1" placeholder="‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏ó‡∏µ‡πà 1 (‡πÉ‡∏´‡∏ç‡πà‡∏™‡∏∏‡∏î) ‡πÄ‡∏ä‡πà‡∏ô ‡∏•‡∏±‡∏á" style="padding:8px;border:1px solid #ddd;border-radius:6px;font-size:12px;">
                            <input type="number" id="newPdRate1" placeholder="1 ‡∏•‡∏±‡∏á = ? ‡∏ñ‡∏∏‡∏á" min="1" style="padding:8px;border:1px solid #ddd;border-radius:6px;font-size:12px;">
                            <small style="color:#94a3b8;">√ó ‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏ó‡∏µ‡πà 2</small>
                        </div>
                        <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:6px;align-items:center;margin-bottom:6px;">
                            <input type="text" id="newPdUnit2" placeholder="‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏ó‡∏µ‡πà 2 (‡∏Å‡∏•‡∏≤‡∏á) ‡πÄ‡∏ä‡πà‡∏ô ‡∏ñ‡∏∏‡∏á" style="padding:8px;border:1px solid #ddd;border-radius:6px;font-size:12px;">
                            <input type="number" id="newPdRate2" placeholder="1 ‡∏ñ‡∏∏‡∏á = ? ‡∏Å‡∏£‡∏±‡∏°" min="1" style="padding:8px;border:1px solid #ddd;border-radius:6px;font-size:12px;">
                            <small style="color:#94a3b8;">√ó ‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏ó‡∏µ‡πà 3</small>
                        </div>
                        <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:6px;align-items:center;">
                            <input type="text" id="newPdUnit3" placeholder="‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏ó‡∏µ‡πà 3 (‡πÄ‡∏•‡πá‡∏Å‡∏™‡∏∏‡∏î) ‡πÄ‡∏ä‡πà‡∏ô ‡∏Å‡∏£‡∏±‡∏°" style="padding:8px;border:1px solid #ddd;border-radius:6px;font-size:12px;">
                            <div></div><small style="color:#94a3b8;">‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢</small>
                        </div>
                    </div>
                    <button onclick="addPd()" style="width:100%;background:var(--info);color:white;padding:12px;border-radius:8px;border:none;cursor:pointer;font-weight:bold;">+ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</button>
                    <div id="pdMasterContainer" style="max-height:250px;overflow-y:auto;border-top:1px solid #eee;padding-top:10px;"></div>
                </div>
            </div>
            <div style="margin-top:25px;background:white;padding:25px;border-radius:15px;border:1px solid #e2e8f0;">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
                    <h4 style="margin:0;">üîó ‡∏à‡∏±‡∏ö‡∏Ñ‡∏π‡πà‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡πÇ‡∏ã‡∏ô</h4>
                    <select id="selectZoneMap" onchange="renderMapping();renderMinMaxTable()" style="padding:12px;border-radius:8px;min-width:300px;border:2px solid var(--primary-dark);font-weight:bold;"></select>
                </div>
                <div id="mappingContainer" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:12px;"></div>
            </div>
            <div style="margin-top:25px;background:white;padding:25px;border-radius:15px;border:1px solid #e2e8f0;">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
                    <div>
                        <h4 style="margin:0;">üìä ‡∏Å‡∏≥‡∏´‡∏ô‡∏î Min / Max ‡∏™‡∏ï‡πä‡∏≠‡∏Å‡∏ï‡πà‡∏≠‡∏Ñ‡∏•‡∏±‡∏á</h4>
                        <small style="color:#94a3b8;">Min = ‡∏¢‡∏≠‡∏î‡∏ï‡πà‡∏≥‡∏™‡∏∏‡∏î‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ | Max = ‡∏¢‡∏≠‡∏î‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢ | <b style="color:var(--info);">‡∏Ñ‡πà‡∏≤‡πÅ‡∏ï‡∏Å‡∏ï‡πà‡∏≤‡∏á‡∏Å‡∏±‡∏ô‡πÑ‡∏î‡πâ‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏•‡∏±‡∏á ‚Äî ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏•‡∏±‡∏á‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏£‡∏≠‡∏Å ‡∏à‡∏≤‡∏Å‡∏ô‡∏±‡πâ‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Ñ‡∏•‡∏±‡∏á</b></small>
                    </div>
                    <button onclick="saveAllMinMax()" style="background:var(--success);color:white;border:none;padding:10px 24px;border-radius:10px;cursor:pointer;font-weight:bold;">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Min/Max ‡∏Ñ‡∏•‡∏±‡∏á‡∏ô‡∏µ‡πâ</button>
                </div>
                <!-- zone tabs -->
                <div id="minMaxZoneTabs" style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:16px;padding-bottom:12px;border-bottom:1px solid #f1f5f9;"></div>
                <div id="minMaxZoneLabel" style="font-size:13px;color:#64748b;margin-bottom:10px;"></div>
                <div id="minMaxContainer"></div>
            </div>`;
            renderWhList(); renderPdList();
            document.getElementById('selectZoneMap').innerHTML=warehouseList.map(w=>`<option value="${w}">${w}</option>`).join('');
            renderMapping();
            renderMinMaxTable();
        };

        window.renderWhList=function(){
            const c=document.getElementById('whListContainer');if(!c)return;
            c.innerHTML=warehouseList.map((wh,i)=>`
            <div style="display:flex;align-items:center;gap:8px;padding:10px;border-bottom:1px solid #f1f5f9;" id="whRow_${i}">
                <span style="flex:1;font-weight:bold;" id="whLabel_${i}">${wh}</span>
                <input id="whInput_${i}" value="${wh}" style="flex:1;display:none;padding:6px 10px;border:1px solid var(--info);border-radius:6px;">
                <button class="btn-sm" style="background:var(--info);color:white;" onclick="toggleEditWh(${i})">‚úèÔ∏è</button>
                <button class="btn-sm" style="background:var(--success);color:white;display:none;" id="whSaveBtn_${i}" onclick="saveEditWh(${i})">üíæ</button>
                <button class="btn-sm" style="background:var(--danger);color:white;" onclick="deleteWh(${i})">üóëÔ∏è</button>
            </div>`).join('');
        };

        window.toggleEditWh=function(i){
            document.getElementById(`whLabel_${i}`).style.display='none';
            document.getElementById(`whInput_${i}`).style.display='block';
            document.getElementById(`whSaveBtn_${i}`).style.display='inline';
        };

        window.saveEditWh=function(i){
            const newName=document.getElementById(`whInput_${i}`).value.trim();
            if(!newName)return;
            const oldName=warehouseList[i];
            warehouseList[i]=newName;
            // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï zoneProductMap ‡∏î‡πâ‡∏ß‡∏¢
            if(oldName!==newName&&zoneProductMap[oldName]){
                zoneProductMap[newName]=zoneProductMap[oldName];
                delete zoneProductMap[oldName];
            }
            saveConfig(); renderWhList();
            document.getElementById('selectZoneMap').innerHTML=warehouseList.map(w=>`<option value="${w}">${w}</option>`).join('');
            renderMapping();
            toast('‚úÖ ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏•‡∏±‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢','#059669');
        };

        window.renderPdList=function(){
            const c=document.getElementById('pdMasterContainer');if(!c)return;
            c.innerHTML=allProducts.map((p,i)=>{
                const units=p.units||[{name:p.unit,rate:0},{name:p.subUnit||'',rate:0}].filter(u=>u.name);
                const unitsStr=units.map((u,ui)=>u.name+(ui<units.length-1&&u.rate>0?' (√ó'+u.rate+')':'')).join(' ‚Üí ');
                const isFirst=i===0, isLast=i===allProducts.length-1;
                return `<div style="padding:8px;background:#f8fafc;margin-bottom:6px;border-radius:8px;border:1px solid #edf2f7;">
                <div style="display:flex;align-items:center;gap:6px;">
                    <div style="display:flex;flex-direction:column;gap:2px;margin-right:2px;">
                        <button onclick="movePd(${i},-1)" ${isFirst?'disabled':''} style="background:${isFirst?'#e2e8f0':'#64748b'};color:white;border:none;border-radius:4px;width:22px;height:18px;cursor:${isFirst?'default':'pointer'};font-size:10px;line-height:1;">‚ñ≤</button>
                        <button onclick="movePd(${i},1)" ${isLast?'disabled':''} style="background:${isLast?'#e2e8f0':'#64748b'};color:white;border:none;border-radius:4px;width:22px;height:18px;cursor:${isLast?'default':'pointer'};font-size:10px;line-height:1;">‚ñº</button>
                    </div>
                    <span style="font-size:10px;color:#cbd5e1;min-width:18px;text-align:center;">${i+1}</span>
                    <div style="flex:1;font-size:12px;"><b>${p.id}</b> - ${p.name}<br><span style="color:#94a3b8;font-size:11px;">${unitsStr}</span></div>
                    <button class="btn-sm" style="background:var(--info);color:white;" onclick="toggleEditPd(${i})">‚úèÔ∏è</button>
                    <button class="btn-sm" style="background:var(--danger);color:white;" onclick="deletePd(${i})">‚úï</button>
                </div>
                <div id="pdEditArea_${i}" style="display:none;margin-top:8px;">
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:6px;">
                        <input id="pdEditName_${i}" value="${p.name}" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤" style="padding:6px;border:1px solid #ddd;border-radius:6px;font-size:12px;grid-column:span 2;">
                        ${units.map((u,ui)=>`
                        <input id="pdEditUnit${ui}_${i}" value="${u.name}" placeholder="‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏ó‡∏µ‡πà ${ui+1}" style="padding:6px;border:1px solid #ddd;border-radius:6px;font-size:12px;">
                        ${ui<units.length-1?`<input id="pdEditRate${ui}_${i}" value="${u.rate||''}" placeholder="‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡πÅ‡∏õ‡∏•‡∏á √ó" type="number" min="1" style="padding:6px;border:1px solid #ddd;border-radius:6px;font-size:12px;">`:'<div></div>'}`).join('')}
                        <button onclick="saveEditPd(${i})" style="grid-column:span 2;background:var(--success);color:white;border:none;padding:6px;border-radius:6px;cursor:pointer;font-size:12px;font-weight:bold;">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                    </div>
                </div>
            </div>`;}).join('');
        };

        window.movePd=function(i, dir){
            const j=i+dir;
            if(j<0||j>=allProducts.length) return;
            // ‡∏™‡∏•‡∏±‡∏ö‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á
            [allProducts[i], allProducts[j]] = [allProducts[j], allProducts[i]];
            saveConfig();
            renderPdList();
            renderMapping();
        };

        window.toggleEditPd=function(i){
            const area=document.getElementById(`pdEditArea_${i}`);
            area.style.display=area.style.display==='none'?'block':'none';
        };

        window.saveEditPd=function(i){
            const name=document.getElementById(`pdEditName_${i}`)?.value.trim();
            if(!name)return;
            const existingUnits=allProducts[i].units||[{name:allProducts[i].unit,rate:0},{name:allProducts[i].subUnit||'',rate:0}].filter(u=>u.name);
            const newUnits=[];
            for(let ui=0;ui<existingUnits.length;ui++){
                const uName=document.getElementById(`pdEditUnit${ui}_${i}`)?.value.trim()||'';
                const uRate=parseFloat(document.getElementById(`pdEditRate${ui}_${i}`)?.value)||0;
                if(uName) newUnits.push({name:uName,rate:uRate});
            }
            if(!newUnits.length)return;
            allProducts[i].name=name;
            allProducts[i].units=newUnits;
            allProducts[i].unit=newUnits[0]?.name||'';
            allProducts[i].subUnit=newUnits[1]?.name||'';
            saveConfig(); renderPdList();
            toast('‚úÖ ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢','#059669');
        };

        window.renderMapping=function(){
            const zone=document.getElementById('selectZoneMap').value,c=document.getElementById('mappingContainer');
            if(!zone||!c)return;
            const mapped=zoneProductMap[zone]||[];
            c.innerHTML=allProducts.map(p=>`<label style="display:flex;align-items:center;gap:12px;padding:15px;border:1px solid #e2e8f0;border-radius:12px;cursor:pointer;background:white;">
                <input type="checkbox" style="width:18px;height:18px;" ${mapped.includes(p.id)?'checked':''} onchange="togglePdMapping('${zone}','${p.id}')">
                <div style="font-size:13px;"><b>${p.id}</b><br><span style="color:#64748b;">${p.name}</span>
                <br><span style="color:#94a3b8;font-size:11px;">${p.unit}${p.subUnit?' / '+p.subUnit:''}</span></div>
            </label>`).join('');
        };

        window.togglePdMapping=function(z,id){if(!zoneProductMap[z])zoneProductMap[z]=[];const i=zoneProductMap[z].indexOf(id);if(i>-1)zoneProductMap[z].splice(i,1);else zoneProductMap[z].push(id);saveConfig();};
        window.addWh=function(){const n=document.getElementById('newWhName').value.trim();if(n){warehouseList.push(n);saveConfig();openWarehouseManager();}};
        window.deleteWh=function(i){if(confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡∏ö‡πÇ‡∏ã‡∏ô?')){warehouseList.splice(i,1);saveConfig();openWarehouseManager();}};

        window.addPd=function(){
            const id=document.getElementById('newPdId').value.trim();
            const name=document.getElementById('newPdName').value.trim();
            const u1=document.getElementById('newPdUnit1').value.trim();
            const u2=document.getElementById('newPdUnit2').value.trim();
            const u3=document.getElementById('newPdUnit3').value.trim();
            const r1=parseFloat(document.getElementById('newPdRate1').value)||0;
            const r2=parseFloat(document.getElementById('newPdRate2').value)||0;
            if(!id||!name||!u1){toast('‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å ‡∏£‡∏´‡∏±‡∏™, ‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ ‡πÅ‡∏•‡∏∞‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏ó‡∏µ‡πà 1 ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢','#c2410c');return;}
            // ‡∏™‡∏£‡πâ‡∏≤‡∏á units array
            const units=[];
            if(u1) units.push({name:u1,rate:r1||0}); // rate = ‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡πÅ‡∏õ‡∏•‡∏á‡πÑ‡∏õ‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏ñ‡∏±‡∏î‡πÑ‡∏õ
            if(u2) units.push({name:u2,rate:r2||0});
            if(u3) units.push({name:u3,rate:0}); // ‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢‡πÑ‡∏°‡πà‡∏°‡∏µ rate
            allProducts.push({id,name,units,
                // backward compat
                unit:u1, subUnit:u2||''
            });
            saveConfig(); renderPdList(); renderMapping();
            ['newPdId','newPdName','newPdUnit1','newPdRate1','newPdUnit2','newPdRate2','newPdUnit3'].forEach(x=>{
                const el=document.getElementById(x); if(el) el.value='';
            });
            toast('‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢','#059669');
        };

        window.deletePd=function(i){if(confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤?')){allProducts.splice(i,1);saveConfig();renderPdList();renderMapping();}};

        // ---- MISC ----
        // ======== INVENTORY CHECK SYSTEM ========
        // Firestore collection: inventoryHistory
        // ‡πÅ‡∏ï‡πà‡∏•‡∏∞ doc = { zone, date, timestamp, countedBy, recordedBy, items:[{id,name,balance,unit,note}] }

        window.openInventoryCheck=async function(){
            document.getElementById('dashboardView').classList.add('hidden');
            const c=document.getElementById('toolAppContainer');c.classList.remove('hidden');
            const visibleZones=getVisibleWarehouses();
            const today=new Date().toISOString().slice(0,10);
            const usSnap=await getDocs(collection(db,'users'));
            let staffOpts='';
            usSnap.forEach(d=>{const u=d.data();if(u.status!=='suspended')staffOpts+=`<option value="${u.name}">${u.name}</option>`;});

            // build stock sheet template buttons
            const sstEntries = Object.entries(stockSheetTemplates);
            const sstBar = sstEntries.length ? `
            <div style="margin-bottom:16px;" class="no-print">
                <div style="font-size:12px;font-weight:bold;color:#64748b;margin-bottom:8px;">‚ö° ‡πÉ‡∏ä‡πâ Template ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡∏£‡∏π‡∏õ (‡∏à‡∏≤‡∏Å‡∏ó‡∏µ‡πà‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÑ‡∏ß‡πâ):</div>
                <div style="display:flex;gap:8px;flex-wrap:wrap;">
                    ${sstEntries.map(([id,t])=>`
                    <button onclick="applyInvTemplate('${id}')"
                        style="background:white;border:2px solid ${t.color||'#06b6d4'};color:${t.color||'#06b6d4'};padding:7px 16px;border-radius:20px;cursor:pointer;font-size:12px;font-weight:bold;"
                        onmouseover="this.style.background='${t.color||'#06b6d4'}';this.style.color='white'"
                        onmouseout="this.style.background='white';this.style.color='${t.color||'#06b6d4'}'">
                        üìÑ ${t.name}
                    </button>`).join('')}
                    <button onclick="printStockSheetTemplate(null,'pick')"
                        style="background:white;border:2px dashed #e2e8f0;color:#94a3b8;padding:7px 14px;border-radius:20px;cursor:pointer;font-size:12px;">
                        üñ®Ô∏è ‡∏û‡∏¥‡∏°‡∏û‡πå‡πÉ‡∏ö‡πÄ‡∏õ‡∏•‡πà‡∏≤
                    </button>
                </div>
            </div>` : '';

            c.innerHTML=`
            <div class="tool-header no-print">
                <h2>üìã ‡πÉ‡∏ö‡∏ô‡∏±‡∏ö‡∏™‡∏ï‡πä‡∏≠‡∏Å‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</h2>
                <div style="display:flex;gap:8px;">
                    <button onclick="openInventoryAnalysis()" style="background:#7c3aed;color:white;border:none;padding:8px 16px;border-radius:8px;cursor:pointer;font-weight:bold;">üìà ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå & ‡∏Å‡∏£‡∏≤‡∏ü</button>
                    <button onclick="closeTool()" style="background:#f1f5f9;color:#475569;border:none;padding:8px 16px;border-radius:8px;cursor:pointer;">‚úï ‡∏õ‡∏¥‡∏î</button>
                </div>
            </div>

            ${sstBar}

            <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:15px;margin-bottom:20px;" class="no-print">
                <div class="input-group"><label>üì¶ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏•‡∏±‡∏á</label>
                    <select id="invZone" onchange="renderInventoryRows()" style="width:100%;border:none;font-weight:bold;outline:none;">
                        ${visibleZones.map(z=>`<option value="${z}">${z}</option>`).join('')}
                    </select>
                </div>
                <div class="input-group" style="border:2px solid var(--danger);"><label>üìÖ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ô‡∏±‡∏ö (‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö)</label>
                    <input type="date" id="invDate" value="${today}" style="width:100%;border:none;font-weight:bold;outline:none;font-size:14px;">
                </div>
                <div class="input-group" style="border:2px solid var(--info);"><label>üë§ ‡∏ú‡∏π‡πâ‡∏ô‡∏±‡∏ö</label>
                    <select id="invStaff" style="width:100%;border:none;font-weight:bold;outline:none;">
                        <option value="">-- ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å --</option>${staffOpts}
                    </select>
                </div>
                <div class="input-group" style="background:#f1f5f9;"><label>üìù ‡∏ú‡∏π‡πâ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</label><b>${currentUser.name}</b></div>
            </div>

            <div style="margin-bottom:12px;" class="no-print">
                <input type="text" id="invSearch" placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤..." oninput="filterInvRows(this.value)"
                    style="width:100%;padding:10px 16px;border:1px solid #e2e8f0;border-radius:10px;font-size:14px;box-sizing:border-box;outline:none;">
            </div>

            <div id="invTableContainer"></div>

            <div style="margin-top:25px;text-align:center;" class="no-print">
                <button onclick="saveInventorySheet()" style="background:var(--success);color:white;padding:18px 60px;border:none;border-radius:15px;font-size:18px;font-weight:bold;cursor:pointer;box-shadow:0 4px 15px rgba(16,185,129,0.4);">
                    üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏ö‡∏ô‡∏±‡∏ö‡∏™‡∏ï‡πä‡∏≠‡∏Å‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠
                </button>
            </div>`;

            renderInventoryRows();
        };

        window.renderInventoryRows=async function(){
            const zone=document.getElementById('invZone')?.value||'';
            const zoneProds=allProducts.filter(p=>(zoneProductMap[zone]||[]).includes(p.id));
            const c=document.getElementById('invTableContainer');
            if(!c)return;

            // ‡πÇ‡∏´‡∏•‡∏î inventory ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
            const invSnap=await getDocs(collection(db,'inventoryHistory'));
            let prevSheet=null; let prevTs=0;
            invSnap.forEach(d=>{
                const data=d.data();
                if(data.zone===zone && data.timestamp>prevTs){prevTs=data.timestamp;prevSheet=data;}
            });

            // ‡∏´‡∏≤ template ‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö zone ‡∏ô‡∏µ‡πâ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
            const matchTmpl = Object.values(stockSheetTemplates).find(t=>t.zone===zone);

            // ‡∏™‡∏£‡πâ‡∏≤‡∏á render function ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏•‡∏∞ product row
            const renderRow = (p) => {
                const units=p.units||[{name:p.unit||'',rate:0}].filter(u=>u.name);
                const u0=units[0]?.name||'';
                const prevItem=prevSheet?.items?.find(it=>it.id===p.id);
                const prevBal=prevItem?.balance??'-';
                return `<tr class="stock-row inv-row" data-search="${p.id.toLowerCase()} ${p.name.toLowerCase()}">
                    <td style="padding:14px 16px;">
                        <div style="font-weight:700;font-size:13px;color:#1e293b;">${p.id}</div>
                        <div style="color:#475569;font-size:13px;margin-top:2px;">${p.name}</div>
                        ${prevSheet?`<div style="color:#94a3b8;font-size:10px;margin-top:2px;">‡∏ô‡∏±‡∏ö‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: ${prevSheet.date}</div>`:''}
                    </td>
                    <td style="padding:14px 16px;text-align:center;">
                        <span style="font-size:20px;font-weight:700;color:${prevBal!=='-'?'#64748b':'#cbd5e1'};">${prevBal}</span>
                        ${prevBal!=='-'?`<div style="color:#94a3b8;font-size:10px;">${u0}</div>`:''}
                    </td>
                    <td style="padding:14px 16px;text-align:center;">
                        <input type="number" id="inv_${p.id}" min="0" placeholder="0"
                            oninput="calcDiff('${p.id}',${typeof prevBal==='number'?prevBal:'null'})"
                            style="width:90px;padding:9px;border-radius:10px;border:2px solid #3b82f6;text-align:center;font-weight:700;font-size:16px;outline:none;transition:border 0.2s;"
                            onfocus="this.style.borderColor='#1d4ed8'" onblur="this.style.borderColor='#3b82f6'">
                        <div style="color:#64748b;font-size:10px;margin-top:3px;">${u0}</div>
                    </td>
                    <td style="padding:14px 16px;text-align:center;" id="diff_${p.id}">
                        <span style="color:#cbd5e1;font-size:18px;">‚Äî</span>
                    </td>
                    <td style="padding:14px 16px;">
                        <input type="text" id="note_${p.id}" placeholder="‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)"
                            style="width:100%;padding:7px 10px;border:1px solid #e2e8f0;border-radius:8px;font-size:12px;box-sizing:border-box;outline:none;"
                            onfocus="this.style.borderColor='#3b82f6'" onblur="this.style.borderColor='#e2e8f0'">
                    </td>
                </tr>`;
            };

            // build table rows ‚Äî ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ template ‡∏à‡∏±‡∏î‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ï‡∏≤‡∏° group
            let tbodyRows = '';
            if(matchTmpl && matchTmpl.items?.length) {
                const groups = [...new Set(matchTmpl.items.map(i=>i.group||'‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ'))];
                const tmplIds = new Set(matchTmpl.items.map(i=>i.id));
                // render ‡∏ï‡∏≤‡∏° group ‡∏à‡∏≤‡∏Å template
                groups.forEach(grp => {
                    const grpItemIds = matchTmpl.items.filter(i=>(i.group||'‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ')===grp).map(i=>i.id);
                    const grpProds = grpItemIds.map(id=>zoneProds.find(p=>p.id===id)).filter(Boolean);
                    if(!grpProds.length) return;
                    tbodyRows += `<tr><td colspan="5" style="padding:10px 16px;background:linear-gradient(90deg,#f0f9ff,#f8fafc);font-weight:700;font-size:12px;color:#0369a1;border-top:2px solid #bae6fd;border-bottom:1px solid #e0f2fe;letter-spacing:0.5px;">
                        ‚ñå ${grp.toUpperCase()}
                    </td></tr>`;
                    grpProds.forEach(p => { tbodyRows += renderRow(p); });
                });
                // ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô template
                const notInTmpl = zoneProds.filter(p=>!tmplIds.has(p.id));
                if(notInTmpl.length) {
                    tbodyRows += `<tr><td colspan="5" style="padding:10px 16px;background:#fafafa;font-weight:700;font-size:12px;color:#94a3b8;border-top:2px solid #e2e8f0;">‚ñå ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏∑‡πà‡∏ô‡πÜ</td></tr>`;
                    notInTmpl.forEach(p => { tbodyRows += renderRow(p); });
                }
            } else {
                zoneProds.forEach(p => { tbodyRows += renderRow(p); });
            }

            c.innerHTML=`
            <div style="background:white;border-radius:16px;border:1px solid #e2e8f0;overflow:hidden;">
            <table style="width:100%;border-collapse:collapse;" id="invTable">
                <thead><tr style="background:#f8fafc;border-bottom:2px solid #e2e8f0;">
                    <th style="padding:12px 16px;text-align:left;font-size:11px;color:#64748b;font-weight:700;letter-spacing:0.5px;width:35%;">‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th>
                    <th style="padding:12px 16px;text-align:center;font-size:11px;color:#64748b;font-weight:700;letter-spacing:0.5px;">‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏Å‡πà‡∏≠‡∏ô</th>
                    <th style="padding:12px 16px;text-align:center;font-size:11px;color:#3b82f6;font-weight:700;letter-spacing:0.5px;">‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏à‡∏£‡∏¥‡∏á‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</th>
                    <th style="padding:12px 16px;text-align:center;font-size:11px;color:#64748b;font-weight:700;letter-spacing:0.5px;">‡∏ú‡∏•‡∏ï‡πà‡∏≤‡∏á (‡πÉ‡∏ä‡πâ‡πÑ‡∏õ)</th>
                    <th style="padding:12px 16px;text-align:left;font-size:11px;color:#64748b;font-weight:700;letter-spacing:0.5px;">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</th>
                </tr></thead>
                <tbody>${tbodyRows}</tbody>
            </table></div>`;
        };

        window.calcDiff=function(id, prevBal){
            const val=parseFloat(document.getElementById(`inv_${id}`)?.value)||0;
            const diffEl=document.getElementById(`diff_${id}`);
            if(!diffEl)return;
            if(prevBal===null||prevBal===undefined||isNaN(prevBal)){
                diffEl.innerHTML='<span style="color:#94a3b8;font-size:12px;">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤</span>';return;
            }
            const diff=prevBal-val;
            const color=diff>0?'var(--danger)':diff<0?'var(--success)':'#64748b';
            const label=diff>0?`‡πÉ‡∏ä‡πâ‡πÑ‡∏õ ${diff}`:diff<0?`‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡∏∂‡πâ‡∏ô ${Math.abs(diff)}`:'‡∏Ñ‡∏á‡πÄ‡∏î‡∏¥‡∏°';
            diffEl.innerHTML=`<span style="font-size:15px;font-weight:bold;color:${color};">${diff>0?'-':''}${Math.abs(diff)}</span><br><small style="color:${color};font-size:10px;">${label}</small>`;
        };

        window.filterInvRows=function(q){
            q=q.toLowerCase().trim();
            document.querySelectorAll('.inv-row').forEach(row=>{
                row.style.display=(!q||row.dataset.search.includes(q))?'':'none';
            });
        };

        window.saveInventorySheet=async function(){
            const zone=document.getElementById('invZone')?.value;
            const date=document.getElementById('invDate')?.value;
            const staff=document.getElementById('invStaff')?.value;
            if(!zone||!date){toast('‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏•‡∏±‡∏á‡πÅ‡∏•‡∏∞‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà','#c2410c');return;}
            if(!staff){toast('‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ú‡∏π‡πâ‡∏ô‡∏±‡∏ö','#c2410c');return;}

            const zoneProds=allProducts.filter(p=>(zoneProductMap[zone]||[]).includes(p.id));
            const hasAny=zoneProds.some(p=>document.getElementById(`inv_${p.id}`)?.value!=='');
            if(!hasAny){toast('‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏¢‡∏≠‡∏î‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£','#c2410c');return;}

            if(!confirm(`‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏ö‡∏ô‡∏±‡∏ö‡∏™‡∏ï‡πä‡∏≠‡∏Å ${zone} ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${date}?`))return;

            const [yr,mo,dy]=date.split('-');
            const dateStr=`${dy}/${mo}/${parseInt(yr)+543}`;
            const items=zoneProds.map(p=>{
                const units=p.units||[{name:p.unit||''}];
                const val=document.getElementById(`inv_${p.id}`)?.value;
                const balance=val!==''?parseFloat(val):null;
                const note=document.getElementById(`note_${p.id}`)?.value||'';
                return {id:p.id,name:p.name,balance,unit:units[0]?.name||'',note};
            }).filter(it=>it.balance!==null);

            await addDoc(collection(db,'inventoryHistory'),{
                zone,date:dateStr,timestamp:Date.now(),
                countedBy:staff,recordedBy:currentUser.name,items
            });

            toast('‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏ö‡∏ô‡∏±‡∏ö‡∏™‡∏ï‡πä‡∏≠‡∏Å‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à','#059669');
            // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï input
            zoneProds.forEach(p=>{
                const el=document.getElementById(`inv_${p.id}`);
                const nl=document.getElementById(`note_${p.id}`);
                if(el)el.value='';
                if(nl)nl.value='';
                const diff=document.getElementById(`diff_${p.id}`);
                if(diff)diff.innerHTML='<span style="color:#cbd5e1;font-size:13px;">‚Äî</span>';
            });
            renderInventoryRows(); // reload ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏™‡∏î‡∏á prev ‡πÉ‡∏´‡∏°‡πà
        };

        // ======== INVENTORY ANALYSIS ========
        window.openInventoryAnalysis=async function(){
            document.getElementById('dashboardView').classList.add('hidden');
            const c=document.getElementById('toolAppContainer');c.classList.remove('hidden');
            const visibleZones=getVisibleWarehouses();

            c.innerHTML=`
            <div class="tool-header no-print">
                <h2>üìà ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏™‡∏ï‡πä‡∏≠‡∏Å‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</h2>
                <div style="display:flex;gap:8px;">
                    <button onclick="exportInventoryExcel()" style="background:var(--success);color:white;border:none;padding:8px 16px;border-radius:8px;cursor:pointer;font-weight:bold;">üì• Export Excel</button>
                    <button onclick="openInventoryCheck()" style="background:#7c3aed;color:white;border:none;padding:8px 16px;border-radius:8px;cursor:pointer;font-weight:bold;">üìã ‡πÉ‡∏ö‡∏ô‡∏±‡∏ö‡∏™‡∏ï‡πä‡∏≠‡∏Å</button>
                    <button onclick="closeTool()" style="background:#f1f5f9;color:#475569;border:none;padding:8px 16px;border-radius:8px;cursor:pointer;">‚úï ‡∏õ‡∏¥‡∏î</button>
                </div>
            </div>

            <div style="display:flex;gap:15px;margin-bottom:20px;flex-wrap:wrap;" class="no-print">
                <div class="input-group" style="min-width:220px;"><label>üì¶ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏•‡∏±‡∏á</label>
                    <select id="anaZone" onchange="loadInventoryAnalysis()" style="width:100%;border:none;font-weight:bold;outline:none;">
                        <option value="">‚Äî ‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏•‡∏±‡∏á ‚Äî</option>
                        ${visibleZones.map(z=>`<option value="${z}">${z}</option>`).join('')}
                    </select>
                </div>
                <div class="input-group" style="min-width:220px;"><label>üçé ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</label>
                    <select id="anaProd" onchange="loadInventoryAnalysis()" style="width:100%;border:none;font-weight:bold;outline:none;">
                        <option value="">‚Äî ‡∏ó‡∏∏‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ ‚Äî</option>
                        ${allProducts.map(p=>`<option value="${p.id}">${p.id} - ${p.name}</option>`).join('')}
                    </select>
                </div>
            </div>

            <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:24px;">
                <div style="background:white;border-radius:14px;padding:24px;border:1px solid #e2e8f0;">
                    <h4 style="margin:0 0 16px;color:var(--primary-dark);">üìä ‡∏¢‡∏≠‡∏î‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠ (Trend)</h4>
                    <canvas id="balanceChart" height="200"></canvas>
                </div>
                <div style="background:white;border-radius:14px;padding:24px;border:1px solid #e2e8f0;">
                    <h4 style="margin:0 0 16px;color:var(--primary-dark);">üìâ ‡∏¢‡∏≠‡∏î‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡πÑ‡∏õ‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏£‡∏≠‡∏ö</h4>
                    <canvas id="usageChart" height="200"></canvas>
                </div>
            </div>

            <div style="background:white;border-radius:14px;padding:24px;border:1px solid #e2e8f0;">
                <h4 style="margin:0 0 16px;color:var(--primary-dark);">üìã ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡∏ö‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</h4>
                <div id="invHistoryTable"><p style="color:#94a3b8;text-align:center;padding:20px;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</p></div>
            </div>`;

            await loadInventoryAnalysis();
        };

        let _invBalChart=null, _invUseChart=null;

        window.loadInventoryAnalysis=async function(){
            const zone=document.getElementById('anaZone')?.value||'';
            const prodId=document.getElementById('anaProd')?.value||'';

            const snap=await getDocs(collection(db,'inventoryHistory'));
            let sheets=[];
            snap.forEach(d=>sheets.push({id:d.id,...d.data()}));
            if(zone) sheets=sheets.filter(s=>s.zone===zone);
            sheets.sort((a,b)=>a.timestamp-b.timestamp);

            // ‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
            const filteredItems=[];
            sheets.forEach(s=>{
                (s.items||[]).forEach(it=>{
                    if(!prodId||it.id===prodId){
                        filteredItems.push({date:s.date,zone:s.zone,countedBy:s.countedBy,...it,sheetId:s.id});
                    }
                });
            });

            // ‡∏™‡∏£‡πâ‡∏≤‡∏á label-balance-usage arrays
            const labels=filteredItems.map(it=>`${it.date}
${it.zone}`);
            const balances=filteredItems.map(it=>it.balance||0);
            const usages=filteredItems.map((it,i)=>{
                if(i===0)return 0;
                const prev=filteredItems[i-1];
                if(prev.id!==it.id||prev.zone!==it.zone)return 0;
                return Math.max(0,(prev.balance||0)-(it.balance||0));
            });

            // render charts
            if(_invBalChart)_invBalChart.destroy();
            if(_invUseChart)_invUseChart.destroy();
            const bc=document.getElementById('balanceChart');
            const uc=document.getElementById('usageChart');
            if(bc&&labels.length){
                _invBalChart=new Chart(bc,{type:'line',data:{labels,datasets:[{
                    label:'‡∏¢‡∏≠‡∏î‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠',data:balances,
                    borderColor:'#3b82f6',backgroundColor:'rgba(59,130,246,0.08)',
                    borderWidth:2,tension:0.3,fill:true,pointRadius:4,
                }]},options:{responsive:true,plugins:{legend:{display:false}},scales:{y:{beginAtZero:true,grid:{color:'#f1f5f9'}},x:{grid:{display:false},ticks:{maxRotation:45}}}}});
            } else if(bc){bc.parentElement.innerHTML='<p style="color:#94a3b8;text-align:center;padding:40px;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p>';}

            if(uc&&labels.length){
                _invUseChart=new Chart(uc,{type:'bar',data:{labels,datasets:[{
                    label:'‡πÉ‡∏ä‡πâ‡πÑ‡∏õ',data:usages,
                    backgroundColor:'rgba(239,68,68,0.15)',borderColor:'#ef4444',
                    borderWidth:2,borderRadius:6,
                }]},options:{responsive:true,plugins:{legend:{display:false}},scales:{y:{beginAtZero:true,grid:{color:'#f1f5f9'}},x:{grid:{display:false},ticks:{maxRotation:45}}}}});
            } else if(uc){uc.parentElement.innerHTML='<p style="color:#94a3b8;text-align:center;padding:40px;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p>';}

            // render table
            const tbl=document.getElementById('invHistoryTable');
            if(!tbl)return;
            if(!filteredItems.length){tbl.innerHTML='<p style="color:#94a3b8;text-align:center;padding:40px;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‚Äî ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏ö‡∏ô‡∏±‡∏ö‡∏™‡∏ï‡πä‡∏≠‡∏Å‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏•‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö</p>';return;}
            tbl.innerHTML=`<table style="width:100%;border-collapse:collapse;">
                <thead><tr style="background:#f8fafc;">
                    <th style="padding:10px;text-align:left;font-size:12px;color:#64748b;">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
                    <th style="padding:10px;text-align:left;font-size:12px;color:#64748b;">‡∏Ñ‡∏•‡∏±‡∏á</th>
                    <th style="padding:10px;text-align:left;font-size:12px;color:#64748b;">‡∏£‡∏´‡∏±‡∏™</th>
                    <th style="padding:10px;text-align:left;font-size:12px;color:#64748b;">‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th>
                    <th style="padding:10px;text-align:center;font-size:12px;color:#64748b;">‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</th>
                    <th style="padding:10px;text-align:center;font-size:12px;color:#64748b;">‡∏´‡∏ô‡πà‡∏ß‡∏¢</th>
                    <th style="padding:10px;text-align:center;font-size:12px;color:#64748b;">‡πÉ‡∏ä‡πâ‡πÑ‡∏õ‡∏à‡∏≤‡∏Å‡∏£‡∏≠‡∏ö‡∏Å‡πà‡∏≠‡∏ô</th>
                    <th style="padding:10px;text-align:left;font-size:12px;color:#64748b;">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</th>
                    <th style="padding:10px;text-align:left;font-size:12px;color:#64748b;">‡∏ú‡∏π‡πâ‡∏ô‡∏±‡∏ö</th>
                </tr></thead>
                <tbody>${filteredItems.map((it,i)=>{
                    const usage=usages[i];
                    const usageColor=usage>0?'var(--danger)':usage<0?'var(--success)':'#94a3b8';
                    const usageText=usage>0?`-${usage}`:usage<0?`+${Math.abs(usage)}`:'‚Äî';
                    return `<tr style="border-top:1px solid #f1f5f9;">
                        <td style="padding:10px;font-size:13px;">${it.date}</td>
                        <td style="padding:10px;font-size:13px;color:#64748b;">${it.zone}</td>
                        <td style="padding:10px;font-weight:bold;">${it.id}</td>
                        <td style="padding:10px;color:#475569;font-size:13px;">${it.name}</td>
                        <td style="padding:10px;text-align:center;font-weight:bold;color:var(--success);font-size:15px;">${it.balance??'-'}</td>
                        <td style="padding:10px;text-align:center;color:#64748b;font-size:12px;">${it.unit||''}</td>
                        <td style="padding:10px;text-align:center;font-weight:bold;color:${usageColor};">${i===0?'‚Äî':usageText}</td>
                        <td style="padding:10px;color:#64748b;font-size:12px;">${it.note||'-'}</td>
                        <td style="padding:10px;color:#64748b;font-size:12px;">${it.countedBy||'-'}</td>
                    </tr>`;}).join('')}
                </tbody>
            </table>`;

            window._invExportData=filteredItems.map((it,i)=>({
                ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:it.date,‡∏Ñ‡∏•‡∏±‡∏á:it.zone,‡∏£‡∏´‡∏±‡∏™:it.id,‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤:it.name,
                ‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠:it.balance??'',‡∏´‡∏ô‡πà‡∏ß‡∏¢:it.unit||'',
                ‡πÉ‡∏ä‡πâ‡πÑ‡∏õ‡∏à‡∏≤‡∏Å‡∏£‡∏≠‡∏ö‡∏Å‡πà‡∏≠‡∏ô:i===0?'':usages[i],
                ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏:it.note||'',‡∏ú‡∏π‡πâ‡∏ô‡∏±‡∏ö:it.countedBy||'',
            }));
        };

        window.exportInventoryExcel=function(){
            if(!window._invExportData?.length){toast('‚ùå ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•','#c2410c');return;}
            const rows=[Object.keys(window._invExportData[0]),...window._invExportData.map(r=>Object.values(r))];
            const ws=XLSX.utils.aoa_to_sheet(rows),wb=XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb,ws,'InventoryHistory');
            XLSX.writeFile(wb,`Inventory_${new Date().toLocaleDateString('th-TH').replace(/\//g,'-')}.xlsx`);
        };

        // ======== MIN/MAX & PURCHASE ORDER ========

        window.renderMinMaxTable=function(forceZone){
            const zone=forceZone||document.getElementById('selectZoneMap')?.value||warehouseList[0]||'';
            const c=document.getElementById('minMaxContainer');
            const label=document.getElementById('minMaxZoneLabel');
            if(!c||!zone)return;

            // render zone tabs
            const tabs=document.getElementById('minMaxZoneTabs');
            if(tabs){
                tabs.innerHTML=warehouseList.map(z=>{
                    const hasData=allProducts.some(p=>{
                        const key=`${z}__${p.id}`;
                        const mm=productMinMax[key];
                        return mm&&(mm.min>0||mm.max>0);
                    });
                    const isActive=z===zone;
                    return `<button onclick="renderMinMaxTable('${z}')"
                        style="padding:7px 16px;border-radius:8px;border:2px solid ${isActive?'var(--primary-dark)':'#e2e8f0'};
                        background:${isActive?'var(--primary-dark)':'white'};color:${isActive?'white':'#475569'};
                        cursor:pointer;font-size:12px;font-weight:bold;position:relative;">
                        ${z}${hasData?'<span style="position:absolute;top:-4px;right:-4px;width:8px;height:8px;border-radius:50%;background:var(--success);"></span>':''}
                    </button>`;
                }).join('');
            }

            if(label) label.innerHTML=`<b style="color:var(--primary-dark);">üì¶ ${zone}</b> ‚Äî ‡∏Å‡∏£‡∏≠‡∏Å‡∏Ñ‡πà‡∏≤‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Min/Max ‡∏Ñ‡∏•‡∏±‡∏á‡∏ô‡∏µ‡πâ" ‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Ñ‡∏•‡∏±‡∏á`;

            const zoneProds=allProducts.filter(p=>(zoneProductMap[zone]||[]).includes(p.id));
            if(!zoneProds.length){c.innerHTML='<p style="color:#94a3b8;font-size:13px;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏Ñ‡∏•‡∏±‡∏á‡∏ô‡∏µ‡πâ ‚Äî ‡∏à‡∏±‡∏ö‡∏Ñ‡∏π‡πà‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡πÇ‡∏ã‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏ô‡∏∞‡∏Ñ‡∏£‡∏±‡∏ö</p>';return;}
            c.innerHTML=`<table style="width:100%;border-collapse:collapse;">
                <thead><tr style="background:#f8fafc;">
                    <th style="padding:10px;text-align:left;font-size:12px;color:#64748b;">‡∏£‡∏´‡∏±‡∏™</th>
                    <th style="padding:10px;text-align:left;font-size:12px;color:#64748b;">‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th>
                    <th style="padding:10px;text-align:left;font-size:12px;color:#64748b;">‡∏´‡∏ô‡πà‡∏ß‡∏¢</th>
                    <th style="padding:10px;text-align:center;font-size:12px;color:#ef4444;">üî¥ Min (‡∏ï‡πà‡∏≥‡∏™‡∏∏‡∏î)</th>
                    <th style="padding:10px;text-align:center;font-size:12px;color:#10b981;">üü¢ Max (‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢)</th>
                </tr></thead>
                <tbody>${zoneProds.map(p=>{
                    const key=`${zone}__${p.id}`;
                    const mm=productMinMax[key]||{min:'',max:''};
                    const u=(p.units||[{name:p.unit||''}])[0]?.name||'';
                    return `<tr style="border-top:1px solid #f1f5f9;">
                        <td style="padding:10px;font-weight:bold;font-size:13px;">${p.id}</td>
                        <td style="padding:10px;color:#475569;font-size:13px;">${p.name}</td>
                        <td style="padding:10px;color:#94a3b8;font-size:12px;">${u}</td>
                        <td style="padding:10px;text-align:center;">
                            <input type="number" id="mm_min_${p.id}" value="${mm.min||''}" min="0" placeholder="0"
                                style="width:80px;padding:8px;border:2px solid #fca5a5;border-radius:8px;text-align:center;font-weight:bold;font-size:14px;outline:none;">
                        </td>
                        <td style="padding:10px;text-align:center;">
                            <input type="number" id="mm_max_${p.id}" value="${mm.max||''}" min="0" placeholder="0"
                                style="width:80px;padding:8px;border:2px solid #6ee7b7;border-radius:8px;text-align:center;font-weight:bold;font-size:14px;outline:none;">
                        </td>
                    </tr>`;
                }).join('')}</tbody>
            </table>`;
            // store current zone for saveAllMinMax to use
            window._currentMinMaxZone=zone;
        };

        window.saveAllMinMax=function(){
            const zone=window._currentMinMaxZone||document.getElementById('selectZoneMap')?.value||'';
            if(!zone){toast('‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏•‡∏±‡∏á‡∏Å‡πà‡∏≠‡∏ô','#c2410c');return;}
            const zoneProds=allProducts.filter(p=>(zoneProductMap[zone]||[]).includes(p.id));
            let count=0;
            zoneProds.forEach(p=>{
                const minEl=document.getElementById(`mm_min_${p.id}`);
                const maxEl=document.getElementById(`mm_max_${p.id}`);
                const minV=parseFloat(minEl?.value)||0;
                const maxV=parseFloat(maxEl?.value)||0;
                if(minV>0||maxV>0){
                    const key=`${zone}__${p.id}`;
                    productMinMax[key]={min:minV,max:maxV,zone,productId:p.id};
                    count++;
                }
            });
            saveConfig();
            toast(`‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Min/Max ${count} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ (${zone}) ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à`,'#059669');
            renderMinMaxTable(zone); // refresh tabs + green dots
        };

        // ---- Purchase Order Page ----
        window.openPurchaseOrder=async function(){
            document.getElementById('dashboardView').classList.add('hidden');
            const c=document.getElementById('toolAppContainer');c.classList.remove('hidden');
            await loadCountData();
            // ‡πÇ‡∏´‡∏•‡∏î inventory ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏Ç‡∏≠‡∏á‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏Ñ‡∏•‡∏±‡∏á
            const invSnap=await getDocs(collection(db,'inventoryHistory'));
            const latestInv={};
            invSnap.forEach(d=>{
                const data=d.data();
                if(!latestInv[data.zone]||data.timestamp>latestInv[data.zone].timestamp) latestInv[data.zone]=data;
            });

            const visibleZones=getVisibleWarehouses();

            // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏™‡∏±‡πà‡∏á
            const orderItems=[];
            visibleZones.forEach(zone=>{
                const zoneProds=allProducts.filter(p=>(zoneProductMap[zone]||[]).includes(p.id));
                zoneProds.forEach(p=>{
                    const key=`${zone}__${p.id}`;
                    const mm=productMinMax[key];
                    if(!mm||(!mm.min&&!mm.max))return;
                    // ‡∏´‡∏≤‡∏¢‡∏≠‡∏î‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î (‡∏à‡∏≤‡∏Å inventoryHistory ‡∏Å‡πà‡∏≠‡∏ô ‡πÅ‡∏•‡πâ‡∏ß fallback countData)
                    const invItem=latestInv[zone]?.items?.find(it=>it.id===p.id);
                    const balance=invItem?.balance??countData[p.id]?.total??0;
                    const u=(p.units||[{name:p.unit||''}])[0]?.name||'';
                    const needOrder=mm.min>0&&balance<=mm.min;
                    const suggestQty=mm.max>0?Math.max(0,mm.max-balance):0;
                    const status=balance<=mm.min?'üî¥ ‡∏ï‡πà‡∏≥‡∏Å‡∏ß‡πà‡∏≤ Min':balance<=(mm.min*1.2)?'üü° ‡πÉ‡∏Å‡∏•‡πâ‡∏ñ‡∏∂‡∏á Min':'üü¢ ‡∏õ‡∏Å‡∏ï‡∏¥';
                    orderItems.push({zone,id:p.id,name:p.name,unit:u,balance,min:mm.min,max:mm.max,suggestQty,needOrder,status});
                });
            });

            const urgent=orderItems.filter(it=>it.needOrder);
            const warning=orderItems.filter(it=>!it.needOrder&&it.status.includes('üü°'));
            const normal=orderItems.filter(it=>it.status.includes('üü¢'));

            c.innerHTML=`
            <div class="tool-header no-print">
                <h2>üõí ‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</h2>
                <div style="display:flex;gap:8px;">
                    <button onclick="exportPurchasePDF()" style="background:#ef4444;color:white;border:none;padding:8px 16px;border-radius:8px;cursor:pointer;font-weight:bold;">üñ®Ô∏è PDF ‡πÉ‡∏ö‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</button>
                    <button onclick="exportPurchaseExcel()" style="background:var(--success);color:white;border:none;padding:8px 16px;border-radius:8px;cursor:pointer;font-weight:bold;">üì• Excel</button>
                    <button onclick="exportTRCloudFormat()" style="background:#7c3aed;color:white;border:none;padding:8px 16px;border-radius:8px;cursor:pointer;font-weight:bold;">üîó TRCloud Format</button>
                    <button onclick="closeTool()" style="background:#f1f5f9;color:#475569;border:none;padding:8px 16px;border-radius:8px;cursor:pointer;">‚úï ‡∏õ‡∏¥‡∏î</button>
                </div>
            </div>

            <!-- summary badges -->
            <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:16px;margin-bottom:24px;">
                <div style="background:#fef2f2;border:2px solid #fca5a5;border-radius:14px;padding:20px;text-align:center;">
                    <div style="font-size:32px;font-weight:bold;color:#ef4444;">${urgent.length}</div>
                    <div style="color:#ef4444;font-weight:bold;font-size:13px;">üî¥ ‡∏ï‡πâ‡∏≠‡∏á‡∏™‡∏±‡πà‡∏á‡∏î‡πà‡∏ß‡∏ô (‡∏ï‡πà‡∏≥‡∏Å‡∏ß‡πà‡∏≤ Min)</div>
                </div>
                <div style="background:#fffbeb;border:2px solid #fcd34d;border-radius:14px;padding:20px;text-align:center;">
                    <div style="font-size:32px;font-weight:bold;color:#f59e0b;">${warning.length}</div>
                    <div style="color:#f59e0b;font-weight:bold;font-size:13px;">üü° ‡πÉ‡∏Å‡∏•‡πâ‡∏ñ‡∏∂‡∏á Min (‡πÄ‡∏ù‡πâ‡∏≤‡∏£‡∏∞‡∏ß‡∏±‡∏á)</div>
                </div>
                <div style="background:#f0fdf4;border:2px solid #6ee7b7;border-radius:14px;padding:20px;text-align:center;">
                    <div style="font-size:32px;font-weight:bold;color:#10b981;">${normal.length}</div>
                    <div style="color:#10b981;font-weight:bold;font-size:13px;">üü¢ ‡∏™‡∏ï‡πä‡∏≠‡∏Å‡∏õ‡∏Å‡∏ï‡∏¥</div>
                </div>
            </div>

            <!-- order table -->
            <div style="background:white;border-radius:14px;border:1px solid #e2e8f0;overflow:hidden;">
                <div style="padding:16px 20px;border-bottom:1px solid #f1f5f9;display:flex;justify-content:space-between;align-items:center;">
                    <h4 style="margin:0;">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h4>
                    <div style="display:flex;gap:8px;">
                        <button onclick="filterOrder('all')" id="obtn_all" style="padding:6px 14px;border-radius:8px;border:2px solid var(--primary-dark);background:var(--primary-dark);color:white;cursor:pointer;font-size:12px;font-weight:bold;">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
                        <button onclick="filterOrder('urgent')" id="obtn_urgent" style="padding:6px 14px;border-radius:8px;border:2px solid #ef4444;background:white;color:#ef4444;cursor:pointer;font-size:12px;font-weight:bold;">‡∏ï‡πâ‡∏≠‡∏á‡∏™‡∏±‡πà‡∏á‡∏î‡πà‡∏ß‡∏ô</button>
                    </div>
                </div>
                <div style="overflow-x:auto;">
                    <table style="width:100%;border-collapse:collapse;" id="orderTable">
                        <thead><tr style="background:#f8fafc;">
                            <th style="padding:12px;text-align:left;font-size:12px;color:#64748b;">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                            <th style="padding:12px;text-align:left;font-size:12px;color:#64748b;">‡∏Ñ‡∏•‡∏±‡∏á</th>
                            <th style="padding:12px;text-align:left;font-size:12px;color:#64748b;">‡∏£‡∏´‡∏±‡∏™</th>
                            <th style="padding:12px;text-align:left;font-size:12px;color:#64748b;">‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th>
                            <th style="padding:12px;text-align:center;font-size:12px;color:#64748b;">‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</th>
                            <th style="padding:12px;text-align:center;font-size:12px;color:#ef4444;">Min</th>
                            <th style="padding:12px;text-align:center;font-size:12px;color:#10b981;">Max</th>
                            <th style="padding:12px;text-align:center;font-size:12px;color:#7c3aed;">‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏™‡∏±‡πà‡∏á</th>
                            <th style="padding:12px;text-align:center;font-size:12px;color:#64748b;">‡∏´‡∏ô‡πà‡∏ß‡∏¢</th>
                            <th style="padding:12px;text-align:center;font-size:12px;color:#64748b;">‡∏¢‡∏≠‡∏î‡∏™‡∏±‡πà‡∏á‡∏à‡∏£‡∏¥‡∏á</th>
                        </tr></thead>
                        <tbody>${[...urgent,...warning,...normal].map(it=>`
                        <tr class="order-row" data-urgent="${it.needOrder}" style="border-top:1px solid #f1f5f9;${it.needOrder?'background:#fff5f5;':''}">
                            <td style="padding:12px;">${it.status}</td>
                            <td style="padding:12px;font-size:12px;color:#64748b;">${it.zone}</td>
                            <td style="padding:12px;font-weight:bold;font-size:13px;">${it.id}</td>
                            <td style="padding:12px;color:#475569;font-size:13px;">${it.name}</td>
                            <td style="padding:12px;text-align:center;font-weight:bold;font-size:15px;color:${it.needOrder?'#ef4444':'var(--success)'};">${it.balance}</td>
                            <td style="padding:12px;text-align:center;color:#ef4444;font-weight:bold;">${it.min||'-'}</td>
                            <td style="padding:12px;text-align:center;color:#10b981;font-weight:bold;">${it.max||'-'}</td>
                            <td style="padding:12px;text-align:center;font-weight:bold;color:#7c3aed;font-size:15px;">${it.suggestQty||'-'}</td>
                            <td style="padding:12px;text-align:center;color:#64748b;font-size:12px;">${it.unit}</td>
                            <td style="padding:12px;text-align:center;">
                                <input type="number" id="order_${it.zone}_${it.id}" value="${it.suggestQty||''}" min="0" placeholder="0"
                                    style="width:80px;padding:7px;border:2px solid #e2e8f0;border-radius:8px;text-align:center;font-weight:bold;font-size:14px;outline:none;">
                            </td>
                        </tr>`).join('')}</tbody>
                    </table>
                </div>
            </div>`;

            window._orderItems=[...urgent,...warning,...normal];
        };

        window.filterOrder=function(mode){
            document.querySelectorAll('.order-row').forEach(r=>{
                r.style.display=(mode==='all'||r.dataset.urgent==='true')?'':'none';
            });
            document.getElementById('obtn_all').style.background=mode==='all'?'var(--primary-dark)':'white';
            document.getElementById('obtn_all').style.color=mode==='all'?'white':'var(--primary-dark)';
            document.getElementById('obtn_urgent').style.background=mode==='urgent'?'#ef4444':'white';
            document.getElementById('obtn_urgent').style.color=mode==='urgent'?'white':'#ef4444';
        };

        window.exportPurchaseExcel=function(){
            if(!window._orderItems?.length){toast('‚ùå ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•','#c2410c');return;}
            const rows=[['‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞','‡∏Ñ‡∏•‡∏±‡∏á','‡∏£‡∏´‡∏±‡∏™','‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤','‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠','Min','Max','‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏™‡∏±‡πà‡∏á','‡∏¢‡∏≠‡∏î‡∏™‡∏±‡πà‡∏á‡∏à‡∏£‡∏¥‡∏á','‡∏´‡∏ô‡πà‡∏ß‡∏¢']];
            window._orderItems.forEach(it=>{
                const actual=document.getElementById(`order_${it.zone}_${it.id}`)?.value||it.suggestQty||0;
                rows.push([it.status,it.zone,it.id,it.name,it.balance,it.min||'',it.max||'',it.suggestQty||'',actual,it.unit]);
            });
            const ws=XLSX.utils.aoa_to_sheet(rows),wb=XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb,ws,'PurchaseOrder');
            XLSX.writeFile(wb,`PurchaseOrder_${new Date().toLocaleDateString('th-TH').replace(/\//g,'-')}.xlsx`);
        };

        // ---- Dashboard alert badges ----
        window.renderStockAlerts=async function(){
            await loadCountData();
            const invSnap=await getDocs(collection(db,'inventoryHistory'));
            const latestInv={};
            invSnap.forEach(d=>{const data=d.data();if(!latestInv[data.zone]||data.timestamp>latestInv[data.zone].timestamp)latestInv[data.zone]=data;});
            let urgentCount=0;
            getVisibleWarehouses().forEach(zone=>{
                allProducts.filter(p=>(zoneProductMap[zone]||[]).includes(p.id)).forEach(p=>{
                    const key=`${zone}__${p.id}`;
                    const mm=productMinMax[key];
                    if(!mm||!mm.min)return;
                    const invItem=latestInv[zone]?.items?.find(it=>it.id===p.id);
                    const balance=invItem?.balance??countData[p.id]?.total??0;
                    if(balance<=mm.min)urgentCount++;
                });
            });
            const alertEl=document.getElementById('dashAlertBanner');
            if(!alertEl)return;
            if(urgentCount>0){
                alertEl.innerHTML=`<div style="background:#fef2f2;border:2px solid #fca5a5;border-radius:14px;padding:16px 24px;display:flex;align-items:center;justify-content:space-between;margin-bottom:20px;">
                    <div style="display:flex;align-items:center;gap:12px;">
                        <span style="font-size:24px;">üî¥</span>
                        <div><b style="color:#ef4444;font-size:15px;">‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ ${urgentCount} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ‡∏ï‡πà‡∏≥‡∏Å‡∏ß‡πà‡∏≤ Min!</b><br>
                        <span style="color:#64748b;font-size:13px;">‡∏Ñ‡∏ß‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÇ‡∏î‡∏¢‡∏î‡πà‡∏ß‡∏ô</span></div>
                    </div>
                    <button onclick="openPurchaseOrder()" style="background:#ef4444;color:white;border:none;padding:10px 20px;border-radius:10px;cursor:pointer;font-weight:bold;">üõí ‡∏î‡∏π‡πÉ‡∏ö‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</button>
                </div>`;
            } else {
                alertEl.innerHTML='';
            }
        };

        // ======== PDF PURCHASE ORDER ========
        window.exportPurchasePDF=function(){
            if(!window._orderItems?.length){toast('‚ùå ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•','#c2410c');return;}
            const urgentOnly=window._orderItems.filter(it=>it.needOrder||it.status.includes('üü°'));
            if(!urgentOnly.length){toast('‚úÖ ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏™‡∏±‡πà‡∏á','#059669');return;}

            const now=new Date();
            const dateStr=now.toLocaleDateString('th-TH',{year:'numeric',month:'long',day:'numeric'});
            const poNumber=`PO-${now.getFullYear()}${String(now.getMonth()+1).padStart(2,'0')}${String(now.getDate()).padStart(2,'0')}-${String(now.getHours()).padStart(2,'0')}${String(now.getMinutes()).padStart(2,'0')}`;

            const rows=urgentOnly.map((it,i)=>{
                const actual=document.getElementById(`order_${it.zone}_${it.id}`)?.value||it.suggestQty||0;
                return `<tr style="${i%2===0?'background:#f8fafc':''}">
                    <td style="padding:10px;text-align:center;color:#64748b;">${i+1}</td>
                    <td style="padding:10px;font-weight:bold;">${it.id}</td>
                    <td style="padding:10px;">${it.name}</td>
                    <td style="padding:10px;text-align:center;color:#64748b;">${it.zone}</td>
                    <td style="padding:10px;text-align:center;color:#ef4444;font-weight:bold;">${it.balance}</td>
                    <td style="padding:10px;text-align:center;color:#10b981;font-weight:bold;">${it.min||'-'}</td>
                    <td style="padding:10px;text-align:center;font-weight:bold;color:#7c3aed;font-size:16px;">${actual}</td>
                    <td style="padding:10px;text-align:center;color:#64748b;">${it.unit}</td>
                    <td style="padding:10px;"></td>
                </tr>`;
            }).join('');

            const html=`<!DOCTYPE html><html><head><meta charset="UTF-8">
            <style>
                body{font-family:'Sarabun',sans-serif;margin:0;padding:30px;color:#1e293b;font-size:13px;}
                .header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:30px;padding-bottom:20px;border-bottom:3px solid #1e293b;}
                .company{font-size:22px;font-weight:bold;color:#1e293b;}
                .po-badge{background:#1e293b;color:white;padding:10px 20px;border-radius:10px;text-align:right;}
                .po-badge .po-num{font-size:16px;font-weight:bold;}
                .po-badge .po-date{font-size:12px;color:#94a3b8;margin-top:4px;}
                table{width:100%;border-collapse:collapse;margin-top:20px;}
                thead tr{background:#1e293b;color:white;}
                th{padding:10px;text-align:left;font-size:12px;}
                td{border-bottom:1px solid #e2e8f0;vertical-align:middle;}
                .footer{margin-top:40px;display:grid;grid-template-columns:1fr 1fr 1fr;gap:30px;}
                .sign-box{text-align:center;padding-top:50px;border-top:1px solid #334155;}
                .sign-label{font-size:11px;color:#64748b;}
                @media print{body{padding:15px;}}
            </style>
            <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;700&display=swap" rel="stylesheet">
            </head><body>
            <div class="header">
                <div>
                    <div class="company">üè¢ TTGPlus</div>
                    <div style="color:#64748b;margin-top:4px;font-size:12px;">‡πÉ‡∏ö‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (Purchase Order)</div>
                </div>
                <div class="po-badge">
                    <div class="po-num">${poNumber}</div>
                    <div class="po-date">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: ${dateStr}</div>
                    <div class="po-date">‡∏à‡∏±‡∏î‡∏ó‡∏≥‡πÇ‡∏î‡∏¢: ${window.currentUser?.name||''}</div>
                </div>
            </div>
            <table>
                <thead><tr>
                    <th style="width:40px;text-align:center;">#</th>
                    <th style="width:100px;">‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th>
                    <th>‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th>
                    <th style="width:100px;text-align:center;">‡∏Ñ‡∏•‡∏±‡∏á</th>
                    <th style="width:70px;text-align:center;">‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</th>
                    <th style="width:60px;text-align:center;">Min</th>
                    <th style="width:80px;text-align:center;">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏±‡πà‡∏á</th>
                    <th style="width:60px;text-align:center;">‡∏´‡∏ô‡πà‡∏ß‡∏¢</th>
                    <th style="width:100px;">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</th>
                </tr></thead>
                <tbody>${rows}</tbody>
            </table>
            <div style="margin-top:20px;padding:15px;background:#f8fafc;border-radius:8px;font-size:12px;color:#64748b;">
                ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: <b>${urgentOnly.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</b> &nbsp;|&nbsp; ‡∏à‡∏±‡∏î‡∏ó‡∏≥‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö TTGPlus
            </div>
            <div class="footer">
                <div class="sign-box"><div class="sign-label">‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏ó‡∏≥ / Prepared by</div></div>
                <div class="sign-box"><div class="sign-label">‡∏ú‡∏π‡πâ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ / Approved by</div></div>
                <div class="sign-box"><div class="sign-label">‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ / Received by</div></div>
            </div>
            </body></html>`;

            const w=window.open('','_blank','width=900,height=700');
            w.document.write(html);
            w.document.close();
            setTimeout(()=>w.print(),800);
        };

        // ======== TRCLOUD PR FORMAT - OPEN MODAL FIRST ========
        window.exportTRCloudFormat=function(){
            if(!window._orderItems?.length){toast('‚ùå ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•','#c2410c');return;}
            const items=window._orderItems.filter(it=>it.needOrder||it.status.includes('üü°'));
            if(!items.length){toast('‚úÖ ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏™‡∏±‡πà‡∏á','#059669');return;}

            const existing=document.getElementById('trcloudModal');if(existing)existing.remove();
            const now=new Date();
            const todayISO=now.toISOString().slice(0,10);
            const modal=document.createElement('div');modal.className='modal-overlay';modal.id='trcloudModal';
            modal.innerHTML=`<div class="modal-box" style="max-width:560px;">
                <h3 style="margin-top:0;">üîó ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ PR ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö TRCloud</h3>
                <p style="color:#64748b;font-size:13px;margin-bottom:16px;">‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏±‡∏ß‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ PR ‡∏Å‡πà‡∏≠‡∏ô Export ‚Äî ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á Excel ‡∏ï‡∏£‡∏á format TRCloud</p>

                <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:12px;">
                    <div><label style="font-size:11px;font-weight:bold;color:#475569;display:block;margin-bottom:4px;">‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</label>
                        <input id="tr_cat" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö" style="width:100%;padding:8px;border:1px solid #e2e8f0;border-radius:8px;box-sizing:border-box;font-size:13px;"></div>
                    <div><label style="font-size:11px;font-weight:bold;color:#475569;display:block;margin-bottom:4px;">‡πÅ‡∏ú‡∏ô‡∏Å</label>
                        <input id="tr_dept" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏Ñ‡∏£‡∏±‡∏ß‡∏Å‡∏•‡∏≤‡∏á" style="width:100%;padding:8px;border:1px solid #e2e8f0;border-radius:8px;box-sizing:border-box;font-size:13px;"></div>
                    <div><label style="font-size:11px;font-weight:bold;color:#475569;display:block;margin-bottom:4px;">‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£</label>
                        <input id="tr_proj" placeholder="‡πÄ‡∏ä‡πà‡∏ô TingTing 2026" style="width:100%;padding:8px;border:1px solid #e2e8f0;border-radius:8px;box-sizing:border-box;font-size:13px;"></div>
                    <div><label style="font-size:11px;font-weight:bold;color:#475569;display:block;margin-bottom:4px;">‡∏Ñ‡∏•‡∏±‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (TRCloud)</label>
                        <input id="tr_wh" placeholder="‡πÄ‡∏ä‡πà‡∏ô Main Warehouse" style="width:100%;padding:8px;border:1px solid #e2e8f0;border-radius:8px;box-sizing:border-box;font-size:13px;"></div>
                    <div><label style="font-size:11px;font-weight:bold;color:#475569;display:block;margin-bottom:4px;">‡∏£‡∏´‡∏±‡∏™‡∏Ñ‡∏π‡πà‡∏Ñ‡πâ‡∏≤ (Supplier)</label>
                        <input id="tr_sup_code" placeholder="‡∏£‡∏´‡∏±‡∏™‡πÉ‡∏ô TRCloud" style="width:100%;padding:8px;border:1px solid #e2e8f0;border-radius:8px;box-sizing:border-box;font-size:13px;"></div>
                    <div><label style="font-size:11px;font-weight:bold;color:#475569;display:block;margin-bottom:4px;">‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏π‡πà‡∏Ñ‡πâ‡∏≤ / ‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó</label>
                        <input id="tr_sup_name" placeholder="‡∏ä‡∏∑‡πà‡∏≠ Supplier" style="width:100%;padding:8px;border:1px solid #e2e8f0;border-radius:8px;box-sizing:border-box;font-size:13px;"></div>
                    <div><label style="font-size:11px;font-weight:bold;color:#475569;display:block;margin-bottom:4px;">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£</label>
                        <input id="tr_doc_date" type="date" value="${todayISO}" style="width:100%;padding:8px;border:1px solid #e2e8f0;border-radius:8px;box-sizing:border-box;font-size:13px;"></div>
                    <div><label style="font-size:11px;font-weight:bold;color:#475569;display:block;margin-bottom:4px;">‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏™‡πà‡∏á‡∏Ç‡∏≠‡∏á</label>
                        <input id="tr_due_date" type="date" value="${todayISO}" style="width:100%;padding:8px;border:1px solid #e2e8f0;border-radius:8px;box-sizing:border-box;font-size:13px;"></div>
                </div>
                <div style="margin-bottom:16px;"><label style="font-size:11px;font-weight:bold;color:#475569;display:block;margin-bottom:4px;">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</label>
                    <textarea id="tr_note" placeholder="‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)" rows="2" style="width:100%;padding:8px;border:1px solid #e2e8f0;border-radius:8px;box-sizing:border-box;font-size:13px;resize:none;"></textarea>
                </div>
                <div style="background:#f0f9ff;border:1px solid #bae6fd;border-radius:8px;padding:10px 14px;margin-bottom:16px;font-size:12px;color:#0369a1;">
                    üí° ‡∏à‡∏∞ Export ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà <b>‡∏ï‡πâ‡∏≠‡∏á‡∏™‡∏±‡πà‡∏á ${items.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</b> ‚Äî ‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ PR ‡∏à‡∏∞‡∏≠‡∏≠‡∏Å AUTO ‡πÉ‡∏ô TRCloud
                </div>
                <div style="display:flex;gap:10px;">
                    <button onclick="doExportTRCloud()" style="flex:1;background:#7c3aed;color:white;border:none;padding:12px;border-radius:10px;cursor:pointer;font-weight:bold;">üì• Export TRCloud PR.xlsx</button>
                    <button onclick="document.getElementById('trcloudModal').remove()" style="flex:1;background:#f1f5f9;color:#475569;border:none;padding:12px;border-radius:10px;cursor:pointer;">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                </div>
            </div>`;
            document.body.appendChild(modal);
        };

        window.doExportTRCloud=function(){
            const items=window._orderItems.filter(it=>it.needOrder||it.status.includes('üü°'));
            const g=id=>document.getElementById(id)?.value||'';
            const docDateRaw=g('tr_doc_date');
            const dueDateRaw=g('tr_due_date');
            const fmtDate=s=>{if(!s)return '';const[y,m,d]=s.split('-');return `${d}/${m}/${parseInt(y)+543}`;};

            // Sheet 1: Header (‡∏´‡∏±‡∏ß‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ PR)
            const headerSheet=[
                ['=== TRCloud PR Import ‚Äî Header ==='],
                ['Field','Value','','Field','Value'],
                ['‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà',g('tr_cat'),'','‡∏Ñ‡∏π‡πà‡∏Ñ‡πâ‡∏≤ (‡∏£‡∏´‡∏±‡∏™)',g('tr_sup_code')],
                ['‡πÅ‡∏ú‡∏ô‡∏Å',g('tr_dept'),'','‡∏Ñ‡∏π‡πà‡∏Ñ‡πâ‡∏≤ (‡∏ä‡∏∑‡πà‡∏≠)',g('tr_sup_name')],
                ['‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£',g('tr_proj'),'','‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£',fmtDate(docDateRaw)],
                ['‡∏Ñ‡∏•‡∏±‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤',g('tr_wh'),'','‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏™‡πà‡∏á‡∏Ç‡∏≠‡∏á',fmtDate(dueDateRaw)],
                ['‡∏à‡∏±‡∏î‡∏ó‡∏≥‡πÇ‡∏î‡∏¢',window.currentUser?.name||'','','‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£','AUTO'],
                ['‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏',g('tr_note')],
            ];

            // Sheet 2: ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ PR format
            const itemHeader=[['#','‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤','‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤','‡∏à‡∏≥‡∏ô‡∏ß‡∏ô','‡∏´‡∏ô‡πà‡∏ß‡∏¢','‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡πà‡∏≠‡∏´‡∏ô‡πà‡∏ß‡∏¢','‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î(%)','VAT/GST','‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏Å‡πà‡∏≠‡∏ô‡∏†‡∏≤‡∏©‡∏µ','‡∏Ñ‡∏•‡∏±‡∏á/‡πÇ‡∏ã‡∏ô','‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏']];
            const itemRows=items.map((it,i)=>{
                const actual=parseFloat(document.getElementById(`order_${it.zone}_${it.id}`)?.value)||it.suggestQty||0;
                return [i+1, it.id, it.name, actual, it.unit, '', '0', '7%', '', it.zone, `‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠:${it.balance} Min:${it.min}`];
            });

            const wb=XLSX.utils.book_new();
            const ws1=XLSX.utils.aoa_to_sheet(headerSheet);
            const ws2=XLSX.utils.aoa_to_sheet([...itemHeader,...itemRows]);
            ws1['!cols']=[{wch:18},{wch:30},{wch:4},{wch:18},{wch:30}];
            ws2['!cols']=[{wch:4},{wch:15},{wch:35},{wch:10},{wch:10},{wch:15},{wch:12},{wch:8},{wch:18},{wch:20},{wch:30}];
            XLSX.utils.book_append_sheet(wb,ws1,'PR_Header');
            XLSX.utils.book_append_sheet(wb,ws2,'PR_Items');
            XLSX.writeFile(wb,`TRCloud_PR_${fmtDate(docDateRaw).replace(/\//g,'-')}.xlsx`);
            document.getElementById('trcloudModal').remove();
            toast('‚úÖ Export TRCloud PR ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à','#059669');
        };

        // ======== IMPORT PRODUCTS FROM EXCEL ========
        window.openImportProducts=function(){
            document.getElementById('dashboardView').classList.add('hidden');
            const c=document.getElementById('toolAppContainer');c.classList.remove('hidden');
            c.innerHTML=`
            <div class="tool-header no-print">
                <h2>üì• Import ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏à‡∏≤‡∏Å Excel</h2>
                <button onclick="closeTool()" style="background:#f1f5f9;color:#475569;border:none;padding:8px 16px;border-radius:8px;cursor:pointer;">‚úï ‡∏õ‡∏¥‡∏î</button>
            </div>

            <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:24px;">
                <!-- Step 1: Download Template -->
                <div style="background:white;border-radius:14px;padding:24px;border:2px solid #e2e8f0;">
                    <div style="font-size:18px;font-weight:bold;color:var(--primary-dark);margin-bottom:8px;">‚ë† ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î Template</div>
                    <p style="color:#64748b;font-size:13px;margin:0 0 16px;">‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î Excel template ‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ï‡∏≤‡∏°‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î</p>
                    <div style="background:#f8fafc;border-radius:8px;padding:12px;margin-bottom:16px;font-size:12px;color:#475569;">
                        <b>‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏£‡∏≠‡∏Å:</b><br>
                        <span style="color:#ef4444;">*</span> ProductCode ‚Äî ‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (‡πÄ‡∏ä‡πà‡∏ô SM000138)<br>
                        <span style="color:#ef4444;">*</span> ProductName ‚Äî ‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤<br>
                        Unit1 ‚Äî ‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏ó‡∏µ‡πà 1 (‡πÄ‡∏ä‡πà‡∏ô ‡∏•‡∏±‡∏á)<br>
                        Rate1 ‚Äî 1 ‡∏•‡∏±‡∏á = ‡∏Å‡∏µ‡πà ‡∏´‡∏ô‡πà‡∏ß‡∏¢2<br>
                        Unit2 ‚Äî ‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏ó‡∏µ‡πà 2 (‡πÄ‡∏ä‡πà‡∏ô ‡∏ñ‡∏∏‡∏á)<br>
                        Rate2 ‚Äî 1 ‡∏ñ‡∏∏‡∏á = ‡∏Å‡∏µ‡πà ‡∏´‡∏ô‡πà‡∏ß‡∏¢3<br>
                        Unit3 ‚Äî ‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏ó‡∏µ‡πà 3 (‡πÄ‡∏ä‡πà‡∏ô ‡∏Å‡∏£‡∏±‡∏°)
                    </div>
                    <button onclick="downloadImportTemplate()" style="width:100%;background:var(--primary-dark);color:white;border:none;padding:12px;border-radius:10px;cursor:pointer;font-weight:bold;">‚¨áÔ∏è ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î Template.xlsx</button>
                </div>

                <!-- Step 2: Upload -->
                <div style="background:white;border-radius:14px;padding:24px;border:2px solid #e2e8f0;">
                    <div style="font-size:18px;font-weight:bold;color:var(--primary-dark);margin-bottom:8px;">‚ë° ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î Excel</div>
                    <p style="color:#64748b;font-size:13px;margin:0 0 16px;">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå Excel ‡∏ó‡∏µ‡πà‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡πâ‡∏ß ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á Preview ‡∏Å‡πà‡∏≠‡∏ô import ‡∏à‡∏£‡∏¥‡∏á</p>
                    <div style="border:2px dashed #e2e8f0;border-radius:10px;padding:30px;text-align:center;margin-bottom:16px;cursor:pointer;transition:border 0.2s;"
                        onclick="document.getElementById('importFile').click()"
                        ondragover="event.preventDefault();this.style.borderColor='var(--info)'"
                        ondragleave="this.style.borderColor='#e2e8f0'"
                        ondrop="event.preventDefault();handleImportDrop(event)">
                        <div style="font-size:32px;margin-bottom:8px;">üìÇ</div>
                        <div style="color:#64748b;font-size:13px;">‡∏Ñ‡∏•‡∏¥‡∏Å‡∏´‡∏£‡∏∑‡∏≠‡∏•‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏°‡∏≤‡∏ß‡∏≤‡∏á‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà</div>
                        <input type="file" id="importFile" accept=".xlsx,.xls,.csv" style="display:none" onchange="handleImportFile(this)">
                    </div>
                    <div id="importFileLabel" style="font-size:12px;color:#94a3b8;text-align:center;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå</div>
                </div>
            </div>

            <!-- Preview table -->
            <div id="importPreview" style="display:none;background:white;border-radius:14px;padding:24px;border:1px solid #e2e8f0;">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
                    <h4 style="margin:0;">üîç Preview ‡∏Å‡πà‡∏≠‡∏ô Import</h4>
                    <div style="display:flex;gap:8px;">
                        <button onclick="confirmImportProducts()" id="confirmImportBtn" style="background:var(--success);color:white;border:none;padding:10px 24px;border-radius:10px;cursor:pointer;font-weight:bold;">‚úÖ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô Import</button>
                        <button onclick="document.getElementById('importPreview').style.display='none'" style="background:#f1f5f9;color:#475569;border:none;padding:10px 16px;border-radius:10px;cursor:pointer;">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                    </div>
                </div>
                <div id="importPreviewTable"></div>
            </div>`;
        };

        window.downloadImportTemplate=function(){
            const rows=[
                ['ProductCode','ProductName','Unit1','Rate1','Unit2','Rate2','Unit3'],
                ['SM000001','‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ A','‡∏•‡∏±‡∏á',12,'‡∏ñ‡∏∏‡∏á',500,'‡∏Å‡∏£‡∏±‡∏°'],
                ['SM000002','‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ B','‡∏Å‡∏•‡πà‡∏≠‡∏á',24,'‡∏ä‡∏¥‡πâ‡∏ô','',''],
                ['SM000003','‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ C (‡∏´‡∏ô‡πà‡∏ß‡∏¢‡πÄ‡∏î‡∏µ‡∏¢‡∏ß)','‡∏Å‡∏£‡∏∞‡∏õ‡πã‡∏≠‡∏á','','','',''],
            ];
            const ws=XLSX.utils.aoa_to_sheet(rows);
            ws['!cols']=[{wch:15},{wch:35},{wch:10},{wch:8},{wch:10},{wch:8},{wch:10}];
            const wb=XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb,ws,'Products');
            XLSX.writeFile(wb,'TingTing_Import_Template.xlsx');
        };

        window.handleImportDrop=function(e){
            const file=e.dataTransfer.files[0];
            if(file) processImportFile(file);
        };
        window.handleImportFile=function(input){
            if(input.files[0]) processImportFile(input.files[0]);
        };

        window._importData=[];
        window.processImportFile=function(file){
            document.getElementById('importFileLabel').innerText=`üìÑ ${file.name}`;
            const reader=new FileReader();
            reader.onload=function(e){
                const wb=XLSX.read(e.target.result,{type:'array'});
                const ws=wb.Sheets[wb.SheetNames[0]];
                const data=XLSX.utils.sheet_to_json(ws,{defval:''});
                if(!data.length){toast('‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•','#c2410c');return;}

                window._importData=data.map(row=>({
                    id:String(row.ProductCode||'').trim(),
                    name:String(row.ProductName||'').trim(),
                    units:[
                        row.Unit1?{name:String(row.Unit1).trim(),rate:parseFloat(row.Rate1)||0}:null,
                        row.Unit2?{name:String(row.Unit2).trim(),rate:parseFloat(row.Rate2)||0}:null,
                        row.Unit3?{name:String(row.Unit3).trim(),rate:0}:null,
                    ].filter(u=>u&&u.name)
                })).filter(p=>p.id&&p.name);

                renderImportPreview();
            };
            reader.readAsArrayBuffer(file);
        };

        window.renderImportPreview=function(){
            const data=window._importData;
            const existing=new Set(allProducts.map(p=>p.id));
            const preview=document.getElementById('importPreview');
            const table=document.getElementById('importPreviewTable');
            if(!preview||!table)return;

            preview.style.display='block';
            const newCount=data.filter(p=>!existing.has(p.id)).length;
            const dupCount=data.filter(p=>existing.has(p.id)).length;

            table.innerHTML=`
            <div style="display:flex;gap:12px;margin-bottom:16px;">
                <div style="background:#f0fdf4;border:1px solid #6ee7b7;border-radius:8px;padding:10px 16px;font-size:13px;color:#059669;font-weight:bold;">‚úÖ ‡πÉ‡∏´‡∏°‡πà ${newCount} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div>
                ${dupCount?`<div style="background:#fff7ed;border:1px solid #fdba74;border-radius:8px;padding:10px 16px;font-size:13px;color:#c2410c;font-weight:bold;">‚ö†Ô∏è ‡∏ã‡πâ‡∏≥ ${dupCount} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ (‡∏à‡∏∞‡∏Ç‡πâ‡∏≤‡∏°‡πÑ‡∏õ)</div>`:''}
            </div>
            <div style="max-height:300px;overflow-y:auto;">
            <table style="width:100%;border-collapse:collapse;">
                <thead><tr style="background:#f8fafc;">
                    <th style="padding:8px;font-size:11px;color:#64748b;text-align:left;">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                    <th style="padding:8px;font-size:11px;color:#64748b;text-align:left;">‡∏£‡∏´‡∏±‡∏™</th>
                    <th style="padding:8px;font-size:11px;color:#64748b;text-align:left;">‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th>
                    <th style="padding:8px;font-size:11px;color:#64748b;text-align:left;">‡∏´‡∏ô‡πà‡∏ß‡∏¢</th>
                </tr></thead>
                <tbody>${data.map(p=>{
                    const isDup=existing.has(p.id);
                    const unitStr=p.units.map(u=>u.name+(u.rate?`(√ó${u.rate})`:'') ).join(' ‚Üí ');
                    return `<tr style="border-top:1px solid #f1f5f9;${isDup?'opacity:0.5':''}">
                        <td style="padding:8px;">${isDup?'‚ö†Ô∏è ‡∏ã‡πâ‡∏≥':'üÜï ‡πÉ‡∏´‡∏°‡πà'}</td>
                        <td style="padding:8px;font-weight:bold;font-size:12px;">${p.id}</td>
                        <td style="padding:8px;font-size:12px;">${p.name}</td>
                        <td style="padding:8px;font-size:11px;color:#64748b;">${unitStr||'-'}</td>
                    </tr>`;
                }).join('')}</tbody>
            </table></div>`;
        };

        window.confirmImportProducts=async function(){
            const data=window._importData;
            if(!data?.length){toast('‚ùå ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•','#c2410c');return;}
            const existing=new Set(allProducts.map(p=>p.id));
            const toAdd=data.filter(p=>!existing.has(p.id));
            if(!toAdd.length){toast('‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏µ‡πà‡∏à‡∏∞ import','#c2410c');return;}
            if(!confirm(`‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô Import ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà ${toAdd.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£?`))return;

            allProducts.push(...toAdd);
            await saveConfig();
            toast(`‚úÖ Import ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ${toAdd.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`,'#059669');
            document.getElementById('importPreview').style.display='none';
            document.getElementById('importFileLabel').innerText='‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå';
            window._importData=[];
        };

        // ======== REQUISITION SYSTEM ========
        // Firestore: requisitions/{id} = {
        //   mrNumber, date, requestedBy, department, zone, purpose,
        //   items:[{id,name,unit,qtyRequested,qtyIssued}],
        //   status: 'pending'|'approved'|'issued'|'rejected',
        //   approvedBy, approvedAt, issuedBy, issuedAt, note,
        //   timestamp
        // }

        const MR_STATUS = {
            pending:  { label:'‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥',  color:'#f59e0b', bg:'#fffbeb' },
            approved: { label:'‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß', color:'#3b82f6', bg:'#eff6ff' },
            issued:   { label:'‡∏à‡πà‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß',   color:'#10b981', bg:'#f0fdf4' },
            rejected: { label:'‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥', color:'#ef4444', bg:'#fef2f2' },
        };

        async function genMRNumber() {
            const now = new Date();
            const prefix = `MR-${now.getFullYear()}${String(now.getMonth()+1).padStart(2,'0')}${String(now.getDate()).padStart(2,'0')}`;
            const snap = await getDocs(collection(db,'requisitions'));
            const todayDocs = [];
            snap.forEach(d=>{ if(d.id.startsWith(prefix)) todayDocs.push(d.id); });
            const seq = String(todayDocs.length+1).padStart(3,'0');
            return `${prefix}-${seq}`;
        }

        // ---- ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡πÄ‡∏ö‡∏¥‡∏Å‡πÉ‡∏´‡∏°‡πà ----
        window.openCreateRequisition = async function() {
            document.getElementById('dashboardView').classList.add('hidden');
            const c = document.getElementById('toolAppContainer'); c.classList.remove('hidden');
            const visibleZones = getVisibleWarehouses();
            const usSnap = await getDocs(collection(db,'users'));
            let staffOpts = '';
            usSnap.forEach(d=>{ const u=d.data(); if(u.status!=='suspended') staffOpts+=`<option value="${u.name}">${u.name}</option>`; });
            const today = new Date().toISOString().slice(0,10);

            // build template buttons
            const tmplEntries = Object.entries(reqTemplates);
            const tmplBar = tmplEntries.length ? `
            <div style="margin-bottom:16px;">
                <div style="font-size:12px;font-weight:bold;color:#64748b;margin-bottom:8px;">‚ö° ‡πÉ‡∏ä‡πâ Template ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡∏£‡∏π‡∏õ:</div>
                <div style="display:flex;gap:8px;flex-wrap:wrap;">
                    ${tmplEntries.map(([id,t])=>`
                    <button onclick="applyReqTemplate('${id}')" style="background:white;border:2px solid ${t.color};color:${t.color};padding:7px 16px;border-radius:20px;cursor:pointer;font-size:12px;font-weight:bold;transition:all 0.15s;"
                        onmouseover="this.style.background='${t.color}';this.style.color='white'"
                        onmouseout="this.style.background='white';this.style.color='${t.color}'">
                        ${t.name}
                    </button>`).join('')}
                    <button onclick="openRequisitionSettings()" style="background:white;border:2px dashed #e2e8f0;color:#94a3b8;padding:7px 14px;border-radius:20px;cursor:pointer;font-size:12px;">
                        + ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ Template
                    </button>
                </div>
            </div>` : '';

            c.innerHTML = `
            <div class="tool-header no-print">
                <h2>‚úèÔ∏è ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡πÄ‡∏ö‡∏¥‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (MR)</h2>
                <button onclick="closeTool()" style="background:#f1f5f9;color:#475569;border:none;padding:8px 16px;border-radius:8px;cursor:pointer;">‚úï ‡∏õ‡∏¥‡∏î</button>
            </div>

            ${tmplBar}

            <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:15px;margin-bottom:20px;">
                <div class="input-group" style="border:2px solid var(--danger);"><label>üìÖ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡∏≠‡πÄ‡∏ö‡∏¥‡∏Å (‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö)</label>
                    <input type="date" id="mr_date" value="${today}" style="width:100%;border:none;font-weight:bold;outline:none;font-size:14px;">
                </div>
                <div class="input-group" style="border:2px solid var(--info);"><label>üë§ ‡∏ú‡∏π‡πâ‡∏Ç‡∏≠‡πÄ‡∏ö‡∏¥‡∏Å</label>
                    <select id="mr_requester" style="width:100%;border:none;font-weight:bold;outline:none;">
                        <option value="${currentUser.name}">${currentUser.name} (‡∏Ñ‡∏∏‡∏ì)</option>${staffOpts}
                    </select>
                </div>
                <div class="input-group"><label>üè≠ ‡πÅ‡∏ú‡∏ô‡∏Å / ‡∏ù‡πà‡∏≤‡∏¢</label>
                    <input type="text" id="mr_dept" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏ù‡πà‡∏≤‡∏¢‡∏ú‡∏•‡∏¥‡∏ï" style="width:100%;border:none;font-weight:bold;outline:none;font-size:14px;">
                </div>
                <div class="input-group"><label>üì¶ ‡πÄ‡∏ö‡∏¥‡∏Å‡∏à‡∏≤‡∏Å‡∏Ñ‡∏•‡∏±‡∏á</label>
                    <select id="mr_zone" onchange="renderMRItems()" style="width:100%;border:none;font-weight:bold;outline:none;">
                        ${visibleZones.map(z=>`<option value="${z}">${z}</option>`).join('')}
                    </select>
                </div>
                <div class="input-group" style="grid-column:span 2;"><label>üìù ‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏õ‡∏£‡∏∞‡∏™‡∏á‡∏Ñ‡πå‡∏Å‡∏≤‡∏£‡πÄ‡∏ö‡∏¥‡∏Å</label>
                    <input type="text" id="mr_purpose" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏ú‡∏•‡∏¥‡∏ï‡πÄ‡∏°‡∏ô‡∏π Mochi ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà 21/02/2569" style="width:100%;border:none;font-weight:bold;outline:none;font-size:14px;">
                </div>
            </div>

            <div style="margin-bottom:12px;">
                <input type="text" id="mr_search" placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤..." oninput="filterMRRows(this.value)"
                    style="width:100%;padding:10px 16px;border:1px solid #e2e8f0;border-radius:10px;font-size:14px;box-sizing:border-box;outline:none;">
            </div>

            <div id="mrItemsContainer"></div>

            <div style="margin-top:24px;display:flex;gap:12px;justify-content:center;" class="no-print">
                <button onclick="submitRequisition()" style="background:var(--success);color:white;padding:16px 48px;border:none;border-radius:12px;font-size:17px;font-weight:bold;cursor:pointer;box-shadow:0 4px 15px rgba(16,185,129,0.3);">
                    üì§ ‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÄ‡∏ö‡∏¥‡∏Å
                </button>
            </div>`;

            renderMRItems();
        };

        window.renderMRItems = function() {
            const zone = document.getElementById('mr_zone')?.value || '';
            const zoneProds = allProducts.filter(p=>(zoneProductMap[zone]||[]).includes(p.id));
            const c = document.getElementById('mrItemsContainer'); if(!c) return;
            c.innerHTML = `
            <table class="stock-table" id="mrTable">
                <thead><tr style="background:#f8fafc;">
                    <th style="padding:12px;text-align:left;font-size:12px;color:#64748b;">‡∏£‡∏´‡∏±‡∏™ / ‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th>
                    <th style="padding:12px;text-align:center;font-size:12px;color:#64748b;">‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠ (‡∏£‡∏∞‡∏ö‡∏ö)</th>
                    <th style="padding:12px;text-align:center;font-size:12px;color:#64748b;">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡∏≠‡πÄ‡∏ö‡∏¥‡∏Å</th>
                    <th style="padding:12px;text-align:center;font-size:12px;color:#64748b;">‡∏´‡∏ô‡πà‡∏ß‡∏¢</th>
                    <th style="padding:12px;text-align:left;font-size:12px;color:#64748b;">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</th>
                </tr></thead>
                <tbody>${zoneProds.map(p=>{
                    const u = (p.units||[{name:p.unit||''}])[0]?.name||'';
                    const bal = countData[p.id]?.total??'-';
                    const balColor = typeof bal==='number'&&bal<=0?'#ef4444':typeof bal==='number'&&bal<10?'#f59e0b':'var(--success)';
                    return `<tr class="stock-row mr-row" data-id="${p.id}" data-name="${p.name.toLowerCase()} ${p.id.toLowerCase()}">
                        <td style="padding:12px;">
                            <b style="font-size:14px;">${p.id}</b><br>
                            <span style="color:#475569;font-size:13px;">${p.name}</span>
                        </td>
                        <td style="padding:12px;text-align:center;font-weight:bold;font-size:16px;color:${balColor};">${bal}</td>
                        <td style="padding:12px;text-align:center;">
                            <input type="number" id="mr_qty_${p.id}" min="0" placeholder="0"
                                style="width:80px;padding:8px;border:2px solid #e2e8f0;border-radius:8px;text-align:center;font-weight:bold;font-size:15px;outline:none;"
                                onfocus="this.style.borderColor='var(--info)'" onblur="this.style.borderColor='#e2e8f0'">
                        </td>
                        <td style="padding:12px;text-align:center;color:#64748b;">${u}</td>
                        <td style="padding:12px;">
                            <input type="text" id="mr_note_${p.id}" placeholder="‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏"
                                style="width:100%;padding:6px 10px;border:1px solid #e2e8f0;border-radius:6px;font-size:12px;box-sizing:border-box;">
                        </td>
                    </tr>`;
                }).join('')}</tbody>
            </table>`;
        };

        window.filterMRRows = function(q) {
            q = q.toLowerCase().trim();
            document.querySelectorAll('.mr-row').forEach(row=>{
                row.style.display = (!q||row.dataset.name.includes(q)) ? '' : 'none';
            });
        };

        window.applyReqTemplate = function(tid) {
            const t = reqTemplates[tid]; if(!t) return;
            // set zone
            const zoneEl = document.getElementById('mr_zone');
            if(zoneEl) { zoneEl.value = t.zone; renderMRItems(); }
            // set dept
            const deptEl = document.getElementById('mr_dept');
            if(deptEl) deptEl.value = t.dept||'';
            // wait for renderMRItems then check boxes
            setTimeout(()=>{
                (t.items||[]).forEach(it=>{
                    const input = document.getElementById(`mr_qty_${it.id}`);
                    if(input && !input.value) input.focus();
                });
                toast(`‚úÖ ‡πÉ‡∏ä‡πâ Template "${t.name}" ‡πÅ‡∏•‡πâ‡∏ß ‚Äî ‡∏Å‡∏£‡∏≠‡∏Å‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢`,'#059669');
            }, 200);
        };

        window.submitRequisition = async function() {
            const date  = document.getElementById('mr_date')?.value;
            const by    = document.getElementById('mr_requester')?.value;
            const dept  = document.getElementById('mr_dept')?.value||'';
            const zone  = document.getElementById('mr_zone')?.value;
            const purp  = document.getElementById('mr_purpose')?.value||'';
            if(!date||!zone){toast('‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö','#c2410c');return;}

            const zoneProds = allProducts.filter(p=>(zoneProductMap[zone]||[]).includes(p.id));
            const items = zoneProds.map(p=>{
                const qty = parseFloat(document.getElementById(`mr_qty_${p.id}`)?.value)||0;
                const note = document.getElementById(`mr_note_${p.id}`)?.value||'';
                const u = (p.units||[{name:p.unit||''}])[0]?.name||'';
                return qty>0 ? {id:p.id,name:p.name,unit:u,qtyRequested:qty,qtyIssued:0,note} : null;
            }).filter(Boolean);

            if(!items.length){toast('‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£','#c2410c');return;}
            if(!confirm(`‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏™‡πà‡∏á‡πÉ‡∏ö‡πÄ‡∏ö‡∏¥‡∏Å ${items.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ‡∏à‡∏≤‡∏Å‡∏Ñ‡∏•‡∏±‡∏á ${zone}?`))return;

            const [y,m,d] = date.split('-');
            const dateStr = `${d}/${m}/${parseInt(y)+543}`;
            const mrNumber = await genMRNumber();

            await addDoc(collection(db,'requisitions'),{
                mrNumber, date:dateStr, timestamp:Date.now(),
                requestedBy:by, department:dept, zone, purpose:purp,
                items, status:'pending',
                approvedBy:'', approvedAt:'', issuedBy:'', issuedAt:'', rejectReason:''
            });

            toast(`‚úÖ ‡∏™‡πà‡∏á‡πÉ‡∏ö‡πÄ‡∏ö‡∏¥‡∏Å ${mrNumber} ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß`,'#059669');
            loadReqBadge();
            openMyRequisitions();
        };

        // ---- ‡πÉ‡∏ö‡πÄ‡∏ö‡∏¥‡∏Å‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô ----
        window.openMyRequisitions = async function() {
            document.getElementById('dashboardView').classList.add('hidden');
            const c = document.getElementById('toolAppContainer'); c.classList.remove('hidden');
            c.innerHTML = `<div class="tool-header"><h2>üìÑ ‡πÉ‡∏ö‡πÄ‡∏ö‡∏¥‡∏Å‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</h2><div style="display:flex;gap:8px;">
                <button onclick="openCreateRequisition()" style="background:#f59e0b;color:white;border:none;padding:8px 16px;border-radius:8px;cursor:pointer;font-weight:bold;">‚úèÔ∏è ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡πÄ‡∏ö‡∏¥‡∏Å‡πÉ‡∏´‡∏°‡πà</button>
                <button onclick="closeTool()" style="background:#f1f5f9;color:#475569;border:none;padding:8px 16px;border-radius:8px;cursor:pointer;">‚úï ‡∏õ‡∏¥‡∏î</button>
            </div></div>
            <div id="myReqList"><p style="text-align:center;color:#94a3b8;padding:40px;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</p></div>`;

            const snap = await getDocs(collection(db,'requisitions'));
            let docs = [];
            snap.forEach(d=>docs.push({id:d.id,...d.data()}));
            docs = docs.filter(d=>d.requestedBy===currentUser.name || currentUser.role==='admin');
            docs.sort((a,b)=>b.timestamp-a.timestamp);
            renderReqList('myReqList', docs, false);
        };

        // ---- ‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ (warehouse/admin) ----
        window.openPendingRequisitions = async function() {
            document.getElementById('dashboardView').classList.add('hidden');
            const c = document.getElementById('toolAppContainer'); c.classList.remove('hidden');
            c.innerHTML = `<div class="tool-header"><h2>üîî ‡πÉ‡∏ö‡πÄ‡∏ö‡∏¥‡∏Å‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ / ‡∏à‡πà‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á</h2>
                <button onclick="closeTool()" style="background:#f1f5f9;color:#475569;border:none;padding:8px 16px;border-radius:8px;cursor:pointer;">‚úï ‡∏õ‡∏¥‡∏î</button>
            </div>
            <div style="display:flex;gap:8px;margin-bottom:16px;">
                <button onclick="filterReqStatus('pending')" id="rsbtn_pending" style="padding:7px 16px;border-radius:8px;border:2px solid #f59e0b;background:#f59e0b;color:white;cursor:pointer;font-size:12px;font-weight:bold;">‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</button>
                <button onclick="filterReqStatus('approved')" id="rsbtn_approved" style="padding:7px 16px;border-radius:8px;border:2px solid #3b82f6;background:white;color:#3b82f6;cursor:pointer;font-size:12px;font-weight:bold;">‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß ‡∏£‡∏≠‡∏à‡πà‡∏≤‡∏¢</button>
                <button onclick="filterReqStatus('all')" id="rsbtn_all" style="padding:7px 16px;border-radius:8px;border:2px solid #64748b;background:white;color:#64748b;cursor:pointer;font-size:12px;font-weight:bold;">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
            </div>
            <div id="pendingReqList"><p style="text-align:center;color:#94a3b8;padding:40px;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</p></div>`;

            const snap = await getDocs(collection(db,'requisitions'));
            let docs = [];
            snap.forEach(d=>docs.push({id:d.id,...d.data()}));
            docs.sort((a,b)=>b.timestamp-a.timestamp);
            window._allReqDocs = docs;
            filterReqStatus('pending');
        };

        window.filterReqStatus = function(status) {
            const docs = window._allReqDocs||[];
            const filtered = status==='all' ? docs : docs.filter(d=>d.status===status);
            renderReqList('pendingReqList', filtered, true);
            ['pending','approved','all'].forEach(s=>{
                const btn = document.getElementById(`rsbtn_${s}`);
                if(!btn) return;
                const colors = {pending:'#f59e0b',approved:'#3b82f6',all:'#64748b'};
                btn.style.background = s===status ? colors[s] : 'white';
                btn.style.color = s===status ? 'white' : colors[s];
            });
        };

        window.openAllRequisitions = async function() {
            document.getElementById('dashboardView').classList.add('hidden');
            const c = document.getElementById('toolAppContainer'); c.classList.remove('hidden');
            c.innerHTML = `<div class="tool-header"><h2>üìä ‡πÉ‡∏ö‡πÄ‡∏ö‡∏¥‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h2><div style="display:flex;gap:8px;">
                <button onclick="exportReqExcel()" style="background:var(--success);color:white;border:none;padding:8px 16px;border-radius:8px;cursor:pointer;font-weight:bold;">üì• Export Excel</button>
                <button onclick="closeTool()" style="background:#f1f5f9;color:#475569;border:none;padding:8px 16px;border-radius:8px;cursor:pointer;">‚úï ‡∏õ‡∏¥‡∏î</button>
            </div></div>
            <div id="allReqList"><p style="text-align:center;color:#94a3b8;padding:40px;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</p></div>`;

            const snap = await getDocs(collection(db,'requisitions'));
            let docs = [];
            snap.forEach(d=>docs.push({id:d.id,...d.data()}));
            docs.sort((a,b)=>b.timestamp-a.timestamp);
            window._allReqDocs = docs;
            renderReqList('allReqList', docs, true);
        };

        // ---- Render ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏ö‡πÄ‡∏ö‡∏¥‡∏Å ----
        function renderReqList(containerId, docs, showActions) {
            const c = document.getElementById(containerId); if(!c) return;
            if(!docs.length){c.innerHTML='<p style="text-align:center;color:#94a3b8;padding:40px;">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</p>';return;}
            c.innerHTML = docs.map(d=>{
                const st = MR_STATUS[d.status]||MR_STATUS.pending;
                const canApprove = showActions && d.status==='pending' && ['admin','warehouse'].includes(currentUser.role);
                const canIssue   = showActions && d.status==='approved' && ['admin','warehouse'].includes(currentUser.role);
                const canReject  = showActions && d.status==='pending' && ['admin','warehouse'].includes(currentUser.role);
                return `<div class="history-card" style="margin-bottom:16px;border-left:4px solid ${st.color};background:${st.bg};">
                    <div class="history-card-header">
                        <div style="display:flex;align-items:center;gap:12px;">
                            <span style="font-weight:bold;font-size:15px;color:var(--primary-dark);">${d.mrNumber}</span>
                            <span style="background:${st.color};color:white;padding:3px 10px;border-radius:20px;font-size:11px;font-weight:bold;">${st.label}</span>
                        </div>
                        <div style="display:flex;align-items:center;gap:8px;">
                            <span style="font-size:12px;color:#64748b;">üìÖ ${d.date} ‚Ä¢ üë§ ${d.requestedBy} ‚Ä¢ üì¶ ${d.zone}</span>
                            ${canApprove?`<button onclick="approveReq('${d.id}')" style="background:#3b82f6;color:white;border:none;padding:6px 14px;border-radius:6px;cursor:pointer;font-size:12px;font-weight:bold;">‚úÖ ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</button>`:''}
                            ${canReject?`<button onclick="rejectReq('${d.id}')" style="background:#ef4444;color:white;border:none;padding:6px 14px;border-radius:6px;cursor:pointer;font-size:12px;font-weight:bold;">‚ùå ‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</button>`:''}
                            ${canIssue?`<button onclick="issueReq('${d.id}')" style="background:#10b981;color:white;border:none;padding:6px 14px;border-radius:6px;cursor:pointer;font-size:12px;font-weight:bold;">üì¶ ‡∏à‡πà‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß</button>`:''}
                            <button onclick="printReq('${d.id}')" style="background:#f1f5f9;color:#475569;border:1px solid #e2e8f0;padding:6px 12px;border-radius:6px;cursor:pointer;font-size:12px;">üñ®Ô∏è ‡∏û‡∏¥‡∏°‡∏û‡πå</button>
                        </div>
                    </div>
                    ${d.purpose?`<div style="padding:8px 0;font-size:13px;color:#475569;">üìù ${d.purpose}</div>`:''}
                    <table style="width:100%;border-collapse:collapse;margin-top:8px;">
                        <thead><tr style="background:rgba(0,0,0,0.04);">
                            <th style="padding:8px;text-align:left;font-size:11px;color:#64748b;">‡∏£‡∏´‡∏±‡∏™</th>
                            <th style="padding:8px;text-align:left;font-size:11px;color:#64748b;">‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th>
                            <th style="padding:8px;text-align:center;font-size:11px;color:#64748b;">‡∏Ç‡∏≠‡πÄ‡∏ö‡∏¥‡∏Å</th>
                            <th style="padding:8px;text-align:center;font-size:11px;color:#64748b;">‡∏à‡πà‡∏≤‡∏¢‡∏à‡∏£‡∏¥‡∏á</th>
                            <th style="padding:8px;text-align:center;font-size:11px;color:#64748b;">‡∏´‡∏ô‡πà‡∏ß‡∏¢</th>
                            <th style="padding:8px;text-align:left;font-size:11px;color:#64748b;">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</th>
                        </tr></thead>
                        <tbody>${(d.items||[]).map(it=>`
                        <tr style="border-top:1px solid rgba(0,0,0,0.06);">
                            <td style="padding:8px;font-weight:bold;font-size:12px;">${it.id}</td>
                            <td style="padding:8px;font-size:12px;">${it.name}</td>
                            <td style="padding:8px;text-align:center;font-weight:bold;color:var(--info);">${it.qtyRequested}</td>
                            <td style="padding:8px;text-align:center;font-weight:bold;color:${it.qtyIssued>0?'var(--success)':'#94a3b8'};">${it.qtyIssued||'-'}</td>
                            <td style="padding:8px;text-align:center;color:#64748b;font-size:12px;">${it.unit}</td>
                            <td style="padding:8px;color:#64748b;font-size:11px;">${it.note||'-'}</td>
                        </tr>`).join('')}</tbody>
                    </table>
                    ${d.approvedBy?`<div style="margin-top:8px;font-size:11px;color:#64748b;">‚úÖ ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÇ‡∏î‡∏¢: ${d.approvedBy} ‡πÄ‡∏°‡∏∑‡πà‡∏≠ ${d.approvedAt}</div>`:''}
                    ${d.issuedBy?`<div style="font-size:11px;color:#64748b;">üì¶ ‡∏à‡πà‡∏≤‡∏¢‡πÇ‡∏î‡∏¢: ${d.issuedBy} ‡πÄ‡∏°‡∏∑‡πà‡∏≠ ${d.issuedAt}</div>`:''}
                    ${d.rejectReason?`<div style="font-size:11px;color:#ef4444;">‚ùå ‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•: ${d.rejectReason}</div>`:''}
                </div>`;
            }).join('');
        }

        // ---- Actions ----
        window.approveReq = async function(docId) {
            if(!confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÉ‡∏ö‡πÄ‡∏ö‡∏¥‡∏Å‡∏ô‡∏µ‡πâ?'))return;
            const {updateDoc} = await import("https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js");
            const now = new Date();
            await updateDoc(doc(db,'requisitions',docId),{
                status:'approved', approvedBy:currentUser.name,
                approvedAt:`${now.toLocaleDateString('th-TH')} ${now.toLocaleTimeString('th-TH',{hour:'2-digit',minute:'2-digit'})}`
            });
            toast('‚úÖ ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß','#059669');
            loadReqBadge();
            openPendingRequisitions();
        };

        window.rejectReq = async function(docId) {
            const reason = prompt('‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥:');
            if(reason===null)return;
            const {updateDoc} = await import("https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js");
            await updateDoc(doc(db,'requisitions',docId),{
                status:'rejected', approvedBy:currentUser.name, rejectReason:reason||'‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'
            });
            toast('‚ùå ‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß','#c2410c');
            loadReqBadge();
            openPendingRequisitions();
        };

        window.issueReq = async function(docId) {
            if(!confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏à‡πà‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏£‡∏ö‡πÅ‡∏•‡πâ‡∏ß?'))return;
            const {updateDoc} = await import("https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js");
            const snap = await getDoc(doc(db,'requisitions',docId));
            const data = snap.data();
            const now = new Date();
            // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
            await updateDoc(doc(db,'requisitions',docId),{
                status:'issued', issuedBy:currentUser.name,
                issuedAt:`${now.toLocaleDateString('th-TH')} ${now.toLocaleTimeString('th-TH',{hour:'2-digit',minute:'2-digit'})}`,
                'items': data.items.map(it=>({...it, qtyIssued:it.qtyRequested}))
            });
            toast('üì¶ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏à‡πà‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß','#059669');
            loadReqBadge();
            openPendingRequisitions();
        };

        // ---- Print PDF ----
        window.printReq = async function(docId) {
            const snap = await getDoc(doc(db,'requisitions',docId));
            if(!snap.exists())return;
            const d = snap.data();
            const st = MR_STATUS[d.status]||MR_STATUS.pending;
            const rows = (d.items||[]).map((it,i)=>`<tr style="${i%2===0?'background:#f8fafc':''}">
                <td style="padding:9px;text-align:center;color:#64748b;">${i+1}</td>
                <td style="padding:9px;font-weight:bold;">${it.id}</td>
                <td style="padding:9px;">${it.name}</td>
                <td style="padding:9px;text-align:center;font-weight:bold;color:#3b82f6;">${it.qtyRequested}</td>
                <td style="padding:9px;text-align:center;font-weight:bold;color:#10b981;">${it.qtyIssued||'-'}</td>
                <td style="padding:9px;text-align:center;color:#64748b;">${it.unit}</td>
                <td style="padding:9px;color:#64748b;">${it.note||''}</td>
            </tr>`).join('');

            const html=`<!DOCTYPE html><html><head><meta charset="UTF-8">
            <style>
                body{font-family:'Sarabun',sans-serif;margin:0;padding:30px;color:#1e293b;font-size:13px;}
                .header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:20px;padding-bottom:16px;border-bottom:3px solid #1e293b;}
                .badge{padding:6px 16px;border-radius:20px;font-weight:bold;font-size:13px;background:${st.color};color:white;}
                table{width:100%;border-collapse:collapse;margin-top:16px;}
                thead tr{background:#1e293b;color:white;}
                th{padding:10px;text-align:left;font-size:12px;}
                td{border-bottom:1px solid #e2e8f0;vertical-align:middle;}
                .meta{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;margin-bottom:16px;}
                .meta-box{background:#f8fafc;border-radius:8px;padding:12px;}
                .meta-label{font-size:10px;color:#94a3b8;font-weight:bold;}
                .meta-val{font-weight:bold;margin-top:2px;}
                .footer{margin-top:40px;display:grid;grid-template-columns:1fr 1fr 1fr;gap:30px;}
                .sign-box{text-align:center;padding-top:50px;border-top:1px solid #334155;}
                @media print{body{padding:15px;}}
            </style>
            <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;700&display=swap" rel="stylesheet">
            </head><body>
            <div class="header">
                <div>
                    <div style="font-size:20px;font-weight:bold;">üè¢ TTGPlus</div>
                    <div style="color:#64748b;font-size:13px;margin-top:4px;">‡πÉ‡∏ö‡∏Ç‡∏≠‡πÄ‡∏ö‡∏¥‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (Material Requisition)</div>
                </div>
                <div style="text-align:right;">
                    <div style="font-size:18px;font-weight:bold;">${d.mrNumber}</div>
                    <div class="badge">${st.label}</div>
                </div>
            </div>
            <div class="meta">
                <div class="meta-box"><div class="meta-label">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</div><div class="meta-val">${d.date}</div></div>
                <div class="meta-box"><div class="meta-label">‡∏ú‡∏π‡πâ‡∏Ç‡∏≠‡πÄ‡∏ö‡∏¥‡∏Å</div><div class="meta-val">${d.requestedBy}</div></div>
                <div class="meta-box"><div class="meta-label">‡πÅ‡∏ú‡∏ô‡∏Å</div><div class="meta-val">${d.department||'-'}</div></div>
                <div class="meta-box"><div class="meta-label">‡πÄ‡∏ö‡∏¥‡∏Å‡∏à‡∏≤‡∏Å‡∏Ñ‡∏•‡∏±‡∏á</div><div class="meta-val">${d.zone}</div></div>
                <div class="meta-box" style="grid-column:span 2;"><div class="meta-label">‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏õ‡∏£‡∏∞‡∏™‡∏á‡∏Ñ‡πå</div><div class="meta-val">${d.purpose||'-'}</div></div>
            </div>
            <table>
                <thead><tr>
                    <th style="width:35px;text-align:center;">#</th>
                    <th style="width:110px;">‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th>
                    <th>‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th>
                    <th style="width:80px;text-align:center;">‡∏Ç‡∏≠‡πÄ‡∏ö‡∏¥‡∏Å</th>
                    <th style="width:80px;text-align:center;">‡∏à‡πà‡∏≤‡∏¢‡∏à‡∏£‡∏¥‡∏á</th>
                    <th style="width:60px;text-align:center;">‡∏´‡∏ô‡πà‡∏ß‡∏¢</th>
                    <th>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</th>
                </tr></thead>
                <tbody>${rows}</tbody>
            </table>
            ${d.approvedBy?`<div style="margin-top:12px;padding:10px;background:#eff6ff;border-radius:8px;font-size:12px;">‚úÖ ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÇ‡∏î‡∏¢: <b>${d.approvedBy}</b> ‡πÄ‡∏°‡∏∑‡πà‡∏≠ ${d.approvedAt}</div>`:''}
            ${d.issuedBy?`<div style="margin-top:6px;padding:10px;background:#f0fdf4;border-radius:8px;font-size:12px;">üì¶ ‡∏à‡πà‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á‡πÇ‡∏î‡∏¢: <b>${d.issuedBy}</b> ‡πÄ‡∏°‡∏∑‡πà‡∏≠ ${d.issuedAt}</div>`:''}
            <div class="footer">
                <div class="sign-box"><div style="font-size:11px;color:#64748b;">‡∏ú‡∏π‡πâ‡∏Ç‡∏≠‡πÄ‡∏ö‡∏¥‡∏Å</div></div>
                <div class="sign-box"><div style="font-size:11px;color:#64748b;">‡∏ú‡∏π‡πâ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</div></div>
                <div class="sign-box"><div style="font-size:11px;color:#64748b;">‡∏ú‡∏π‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</div></div>
            </div>
            </body></html>`;

            const w=window.open('','_blank','width=900,height=700');
            w.document.write(html); w.document.close();
            setTimeout(()=>w.print(),800);
        };

        // ---- Export Excel ----
        window.exportReqExcel = function() {
            const docs = window._allReqDocs||[];
            if(!docs.length){toast('‚ùå ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•','#c2410c');return;}
            const rows=[['‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà MR','‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà','‡∏ú‡∏π‡πâ‡∏Ç‡∏≠‡πÄ‡∏ö‡∏¥‡∏Å','‡πÅ‡∏ú‡∏ô‡∏Å','‡∏Ñ‡∏•‡∏±‡∏á','‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏õ‡∏£‡∏∞‡∏™‡∏á‡∏Ñ‡πå','‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤','‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤','‡∏Ç‡∏≠‡πÄ‡∏ö‡∏¥‡∏Å','‡∏à‡πà‡∏≤‡∏¢‡∏à‡∏£‡∏¥‡∏á','‡∏´‡∏ô‡πà‡∏ß‡∏¢','‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞']];
            docs.forEach(d=>{
                const st=MR_STATUS[d.status]?.label||d.status;
                (d.items||[]).forEach(it=>{
                    rows.push([d.mrNumber,d.date,d.requestedBy,d.department||'',d.zone,d.purpose||'',it.id,it.name,it.qtyRequested,it.qtyIssued||0,it.unit,st]);
                });
            });
            const ws=XLSX.utils.aoa_to_sheet(rows),wb=XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb,ws,'Requisitions');
            XLSX.writeFile(wb,`MR_${new Date().toLocaleDateString('th-TH').replace(/\//g,'-')}.xlsx`);
        };

        // ---- Badge counter ----
        async function loadReqBadge() {
            try {
                const snap = await getDocs(collection(db,'requisitions'));
                let pending = 0;
                snap.forEach(d=>{ if(d.data().status==='pending') pending++; });
                const badge = document.getElementById('reqBadge');
                if(badge) { badge.innerText = pending>0?pending:''; badge.style.display=pending>0?'':'none'; }
            } catch(e){}
        }

        // ======== REQUISITION SETTINGS ========
        const TEMPLATE_COLORS = ['#f59e0b','#3b82f6','#10b981','#7c3aed','#ef4444','#ec4899','#06b6d4','#84cc16'];

        window.openRequisitionSettings = function() {
            document.getElementById('dashboardView').classList.add('hidden');
            const c = document.getElementById('toolAppContainer'); c.classList.remove('hidden');
            renderReqSettingsPage(c);
        };

        function renderReqSettingsPage(c) {
            const tmplList = Object.entries(reqTemplates);
            c.innerHTML = `
            <div class="tool-header">
                <h2>‚öôÔ∏è ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÉ‡∏ö‡πÄ‡∏ö‡∏¥‡∏Å (Template)</h2>
                <button onclick="closeTool()" style="background:#f1f5f9;color:#475569;border:none;padding:8px 16px;border-radius:8px;cursor:pointer;">‚úï ‡∏õ‡∏¥‡∏î</button>
            </div>
            <p style="color:#64748b;font-size:13px;margin-bottom:20px;">‡∏™‡∏£‡πâ‡∏≤‡∏á Template ‡πÉ‡∏ö‡πÄ‡∏ö‡∏¥‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡∏£‡∏π‡∏õ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏•‡∏∞‡πÅ‡∏ú‡∏ô‡∏Å ‡πÄ‡∏ä‡πà‡∏ô "‡πÉ‡∏ö‡πÄ‡∏ö‡∏¥‡∏Å‡πÅ‡∏ú‡∏ô‡∏Å‡∏ö‡∏¥‡∏á‡∏ã‡∏π" ‡∏ù‡πà‡∏≤‡∏¢‡∏ú‡∏•‡∏¥‡∏ï‡∏Å‡∏î‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏£‡∏≠‡∏Å‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á</p>

            <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:16px;margin-bottom:24px;">
                ${tmplList.map(([id,t])=>`
                <div style="background:white;border-radius:14px;border:3px solid ${t.color};padding:20px;position:relative;">
                    <div style="position:absolute;top:12px;right:12px;display:flex;gap:6px;">
                        <button onclick="editTemplate('${id}')" style="background:#f1f5f9;border:none;padding:5px 10px;border-radius:6px;cursor:pointer;font-size:12px;">‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
                        <button onclick="deleteTemplate('${id}')" style="background:#fef2f2;border:none;padding:5px 10px;border-radius:6px;cursor:pointer;font-size:12px;color:#ef4444;">üóëÔ∏è</button>
                    </div>
                    <div style="font-size:18px;font-weight:bold;color:${t.color};margin-bottom:4px;">${t.name}</div>
                    <div style="font-size:12px;color:#64748b;margin-bottom:8px;">üì¶ ${t.zone} ‚Ä¢ üè≠ ${t.dept||'‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡πÅ‡∏ú‡∏ô‡∏Å'}</div>
                    <div style="font-size:12px;color:#94a3b8;">${(t.items||[]).length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</div>
                    <div style="margin-top:10px;display:flex;flex-wrap:wrap;gap:4px;">
                        ${(t.items||[]).slice(0,4).map(it=>`<span style="background:#f8fafc;border:1px solid #e2e8f0;border-radius:20px;padding:2px 10px;font-size:11px;">${it.name}</span>`).join('')}
                        ${(t.items||[]).length>4?`<span style="color:#94a3b8;font-size:11px;">+${(t.items||[]).length-4} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</span>`:''}
                    </div>
                </div>`).join('')}

                <!-- Add new card -->
                <div onclick="openNewTemplateForm()" style="background:white;border-radius:14px;border:3px dashed #e2e8f0;padding:20px;cursor:pointer;display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:140px;transition:border 0.2s;"
                    onmouseover="this.style.borderColor='#7c3aed'" onmouseout="this.style.borderColor='#e2e8f0'">
                    <div style="font-size:36px;color:#cbd5e1;">+</div>
                    <div style="color:#94a3b8;font-size:13px;margin-top:4px;">‡∏™‡∏£‡πâ‡∏≤‡∏á Template ‡πÉ‡∏´‡∏°‡πà</div>
                </div>
            </div>

            <div id="templateFormArea"></div>`;
        }

        window.openNewTemplateForm = function(editId) {
            const c = document.getElementById('toolAppContainer');
            const existing = editId ? reqTemplates[editId] : null;
            const tid = editId || `tmpl_${Date.now()}`;
            const visibleZones = getVisibleWarehouses();

            document.getElementById('templateFormArea').innerHTML = `
            <div style="background:white;border-radius:14px;border:1px solid #e2e8f0;padding:24px;margin-top:8px;">
                <h4 style="margin-top:0;">${existing?'‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç Template':'‚ûï ‡∏™‡∏£‡πâ‡∏≤‡∏á Template ‡πÉ‡∏´‡∏°‡πà'}</h4>
                <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;margin-bottom:16px;">
                    <div><label style="font-size:11px;font-weight:bold;color:#475569;display:block;margin-bottom:4px;">‡∏ä‡∏∑‡πà‡∏≠ Template <span style="color:#ef4444;">*</span></label>
                        <input id="tf_name" value="${existing?.name||''}" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡πÉ‡∏ö‡πÄ‡∏ö‡∏¥‡∏Å‡πÅ‡∏ú‡∏ô‡∏Å‡∏ö‡∏¥‡∏á‡∏ã‡∏π"
                            style="width:100%;padding:9px;border:1px solid #e2e8f0;border-radius:8px;box-sizing:border-box;font-size:13px;font-weight:bold;"></div>
                    <div><label style="font-size:11px;font-weight:bold;color:#475569;display:block;margin-bottom:4px;">‡πÅ‡∏ú‡∏ô‡∏Å</label>
                        <input id="tf_dept" value="${existing?.dept||''}" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏ù‡πà‡∏≤‡∏¢‡∏ú‡∏•‡∏¥‡∏ï‡∏ö‡∏¥‡∏á‡∏ã‡∏π"
                            style="width:100%;padding:9px;border:1px solid #e2e8f0;border-radius:8px;box-sizing:border-box;font-size:13px;"></div>
                    <div><label style="font-size:11px;font-weight:bold;color:#475569;display:block;margin-bottom:4px;">‡πÄ‡∏ö‡∏¥‡∏Å‡∏à‡∏≤‡∏Å‡∏Ñ‡∏•‡∏±‡∏á <span style="color:#ef4444;">*</span></label>
                        <select id="tf_zone" onchange="renderTemplateItems()" style="width:100%;padding:9px;border:1px solid #e2e8f0;border-radius:8px;font-size:13px;font-weight:bold;">
                            ${visibleZones.map(z=>`<option value="${z}" ${existing?.zone===z?'selected':''}>${z}</option>`).join('')}
                        </select></div>
                </div>
                <div style="margin-bottom:12px;"><label style="font-size:11px;font-weight:bold;color:#475569;display:block;margin-bottom:6px;">‡∏™‡∏µ‡∏õ‡∏£‡∏∞‡∏à‡∏≥ Template</label>
                    <div style="display:flex;gap:8px;">
                        ${TEMPLATE_COLORS.map(col=>`<div onclick="selectTmplColor('${col}')" id="tcolor_${col.replace('#','')}"
                            style="width:28px;height:28px;border-radius:50%;background:${col};cursor:pointer;border:3px solid ${existing?.color===col?'#1e293b':'transparent'};transition:border 0.15s;"></div>`).join('')}
                    </div>
                    <input type="hidden" id="tf_color" value="${existing?.color||TEMPLATE_COLORS[0]}">
                </div>
                <div style="margin-bottom:12px;">
                    <label style="font-size:11px;font-weight:bold;color:#475569;display:block;margin-bottom:6px;">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏ö‡πà‡∏≠‡∏¢ (‡∏ï‡∏¥‡πä‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏™‡πà‡πÉ‡∏ô Template)</label>
                    <input type="text" placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤..." oninput="filterTmplItems(this.value)"
                        style="width:100%;padding:8px 14px;border:1px solid #e2e8f0;border-radius:8px;font-size:13px;box-sizing:border-box;margin-bottom:10px;outline:none;">
                    <div id="templateItemsList" style="max-height:280px;overflow-y:auto;border:1px solid #f1f5f9;border-radius:10px;"></div>
                </div>
                <div style="display:flex;gap:10px;justify-content:flex-end;">
                    <button onclick="saveTemplate('${tid}')" style="background:#7c3aed;color:white;border:none;padding:10px 28px;border-radius:10px;cursor:pointer;font-weight:bold;">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Template</button>
                    <button onclick="document.getElementById('templateFormArea').innerHTML=''" style="background:#f1f5f9;color:#475569;border:none;padding:10px 18px;border-radius:10px;cursor:pointer;">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                </div>
            </div>`;

            window._editingTemplateId = tid;
            window._editingTemplateExisting = existing;
            renderTemplateItems();
            document.getElementById('templateFormArea').scrollIntoView({behavior:'smooth'});
        };

        window.selectTmplColor = function(col) {
            document.getElementById('tf_color').value = col;
            TEMPLATE_COLORS.forEach(c=>{
                const el = document.getElementById(`tcolor_${c.replace('#','')}`);
                if(el) el.style.border = `3px solid ${c===col?'#1e293b':'transparent'}`;
            });
        };

        window.renderTemplateItems = function() {
            const zone = document.getElementById('tf_zone')?.value||'';
            const existing = window._editingTemplateExisting;
            const checkedIds = new Set((existing?.items||[]).map(i=>i.id));
            const zoneProds = allProducts.filter(p=>(zoneProductMap[zone]||[]).includes(p.id));
            const c = document.getElementById('templateItemsList'); if(!c) return;
            c.innerHTML = zoneProds.map(p=>{
                const u = (p.units||[{name:p.unit||''}])[0]?.name||'';
                return `<label class="tmpl-item-row" data-search="${p.id.toLowerCase()} ${p.name.toLowerCase()}"
                    style="display:flex;align-items:center;gap:10px;padding:9px 14px;border-bottom:1px solid #f8fafc;cursor:pointer;">
                    <input type="checkbox" id="titem_${p.id}" value="${p.id}" ${checkedIds.has(p.id)?'checked':''}
                        style="width:16px;height:16px;accent-color:#7c3aed;cursor:pointer;">
                    <span style="font-weight:bold;font-size:13px;min-width:90px;">${p.id}</span>
                    <span style="color:#475569;font-size:13px;flex:1;">${p.name}</span>
                    <span style="color:#94a3b8;font-size:11px;">${u}</span>
                </label>`;
            }).join('') || '<p style="color:#94a3b8;padding:16px;text-align:center;">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏Ñ‡∏•‡∏±‡∏á‡∏ô‡∏µ‡πâ</p>';
        };

        window.filterTmplItems = function(q) {
            q = q.toLowerCase().trim();
            document.querySelectorAll('.tmpl-item-row').forEach(row=>{
                row.style.display = (!q||row.dataset.search.includes(q)) ? '' : 'none';
            });
        };

        window.saveTemplate = function(tid) {
            const name = document.getElementById('tf_name')?.value.trim();
            const dept = document.getElementById('tf_dept')?.value.trim()||'';
            const zone = document.getElementById('tf_zone')?.value;
            const color = document.getElementById('tf_color')?.value||TEMPLATE_COLORS[0];
            if(!name){toast('‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠ Template','#c2410c');return;}

            const items = allProducts.filter(p=>{
                const cb = document.getElementById(`titem_${p.id}`);
                return cb?.checked && (zoneProductMap[zone]||[]).includes(p.id);
            }).map(p=>({id:p.id, name:p.name, unit:(p.units||[{name:p.unit||''}])[0]?.name||''}));

            reqTemplates[tid] = {name, dept, zone, color, items};
            saveConfig();
            toast(`‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Template "${name}" ‡πÅ‡∏•‡πâ‡∏ß`,'#059669');
            const c = document.getElementById('toolAppContainer');
            renderReqSettingsPage(c);
        };

        window.editTemplate = function(id) {
            window._editingTemplateExisting = reqTemplates[id];
            openNewTemplateForm(id);
        };

        window.deleteTemplate = function(id) {
            if(!confirm(`‡∏•‡∏ö Template "${reqTemplates[id]?.name}"?`))return;
            delete reqTemplates[id];
            saveConfig();
            const c = document.getElementById('toolAppContainer');
            renderReqSettingsPage(c);
            toast('üóëÔ∏è ‡∏•‡∏ö Template ‡πÅ‡∏•‡πâ‡∏ß','#64748b');
        };

        // ======== HELP GUIDE ========
        window.openHelpGuide = function() {
            document.getElementById('dashboardView').classList.add('hidden');
            const c = document.getElementById('toolAppContainer'); c.classList.remove('hidden');

            const roleGuides = [
                {
                    role:'admin', icon:'‚öôÔ∏è', label:'ADMIN', color:'#f0b429', bg:'#fffbeb', border:'#fde68a',
                    title:'‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡∏ö‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î',
                    steps:[
                        'üè† Dashboard ‚Äî ‡∏î‡∏π‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏™‡∏ï‡πä‡∏≠‡∏Å ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ï‡πà‡∏≥‡∏Å‡∏ß‡πà‡∏≤ Min',
                        'üë• ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô & ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå ‚Äî ‡πÄ‡∏û‡∏¥‡πà‡∏°/‡∏•‡∏ö User ‡∏Å‡∏≥‡∏´‡∏ô‡∏î Role ‡πÅ‡∏•‡∏∞ checkbox ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÅ‡∏ï‡πà‡∏•‡∏∞‡πÄ‡∏°‡∏ô‡∏π',
                        '‚è≥ ‡∏•‡∏ö (3‡∏ß‡∏±‡∏ô) = ‡∏£‡∏≠ 3 ‡∏ß‡∏±‡∏ô ‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡πÑ‡∏î‡πâ | üóëÔ∏è ‡∏•‡∏ö‡∏ó‡∏±‡∏ô‡∏ó‡∏µ = ‡∏û‡∏¥‡∏°‡∏û‡πå username ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô',
                        'üì¶ ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏•‡∏±‡∏á‡πÅ‡∏•‡∏∞‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ ‚Äî ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏•‡∏±‡∏á ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ ‡∏Å‡∏≥‡∏´‡∏ô‡∏î Min/Max Backup/Restore',
                        'üîí ‡πÄ‡∏õ‡∏¥‡∏î/‡∏õ‡∏¥‡∏î‡∏ô‡∏±‡∏ö‡∏™‡∏ï‡πä‡∏≠‡∏Å‡∏™‡∏¥‡πâ‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô ‚Äî Admin ‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏ô‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏ß‡πà‡∏≤‡∏ó‡∏µ‡∏°‡∏ô‡∏±‡∏ö‡πÑ‡∏î‡πâ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÑ‡∏´‡∏£‡πà',
                    ]
                },
                {
                    role:'boss', icon:'üëî', label:'BOSS', color:'#f59e0b', bg:'#fffbeb', border:'#fde68a',
                    title:'‡∏ú‡∏π‡πâ‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£ ‚Äî ‡∏î‡∏π‡πÅ‡∏•‡∏∞‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏ó‡∏∏‡∏Å‡∏≠‡∏¢‡πà‡∏≤‡∏á',
                    steps:[
                        'üè† Dashboard ‚Äî ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏™‡∏ï‡πä‡∏≠‡∏Å‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏•‡∏±‡∏á ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ß‡∏¥‡∏Å‡∏§‡∏ï',
                        'üìä QC Report ‚Äî ‡∏î‡∏π Pass Rate FIFO ‡∏£‡∏≤‡∏¢‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà Fail ‡∏ö‡πà‡∏≠‡∏¢‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î',
                        'üè∑Ô∏è Lot Register ‚Äî ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏Å‡∏•‡πâ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏ (EXP Alert 30 ‡∏ß‡∏±‡∏ô)',
                        'üìã ‡πÉ‡∏ö‡πÄ‡∏ö‡∏¥‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ‚Äî ‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏° workflow ‡∏Å‡∏≤‡∏£‡πÄ‡∏ö‡∏¥‡∏Å‡∏Ç‡∏≠‡∏á‡∏ó‡∏∏‡∏Å‡πÅ‡∏ú‡∏ô‡∏Å',
                        'üöö ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ GR ‚Äî ‡∏î‡∏π‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤ ‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏° Supplier',
                    ]
                },
                {
                    role:'warehouse', icon:'üè≠', label:'WAREHOUSE', color:'#06b6d4', bg:'#ecfeff', border:'#a5f3fc',
                    title:'‡∏ù‡πà‡∏≤‡∏¢‡∏Ñ‡∏•‡∏±‡∏á ‚Äî ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏Ñ‡∏•‡∏±‡∏á‡∏Ñ‡∏£‡∏ö‡∏ß‡∏á‡∏à‡∏£',
                    steps:[
                        'üöö ‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ñ‡∏•‡∏±‡∏á (GR) ‚Äî ‡∏™‡∏£‡πâ‡∏≤‡∏á GR ‚Üí ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ ‚Üí ‡∏Å‡∏£‡∏≠‡∏Å Lot + EXP ‚Üí ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å',
                        'üìã ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÉ‡∏ö‡πÄ‡∏ö‡∏¥‡∏Å ‚Äî ‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ ‚Üí ‡∏Å‡∏î‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ ‚Üí ‡∏à‡πà‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á ‚Üí ‡∏Å‡∏î "‡∏à‡πà‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß"',
                        'üì¶ ‡∏ô‡∏±‡∏ö‡∏™‡∏ï‡πä‡∏≠‡∏Å ‚Äî ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏ã‡∏ô ‚Üí ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ‚Üí ‡∏Å‡∏£‡∏≠‡∏Å‡∏¢‡∏≠‡∏î ‚Üí ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å',
                        'üìä Daily Stock Card ‚Äî ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏±‡∏ö-‡∏à‡πà‡∏≤‡∏¢-‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠ variance ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥',
                        'üìà Export ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô ‚Äî ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ & Export ‚Üí ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å format Excel / TRCloud',
                    ]
                },
                {
                    role:'staff', icon:'üë®‚Äçüç≥', label:'STAFF', color:'#10b981', bg:'#f0fdf4', border:'#bbf7d0',
                    title:'‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô ‚Äî ‡πÄ‡∏ö‡∏¥‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÅ‡∏•‡∏∞‡∏ô‡∏±‡∏ö‡∏™‡∏ï‡πä‡∏≠‡∏Å',
                    steps:[
                        'üìã ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡πÄ‡∏ö‡∏¥‡∏Å‡πÉ‡∏´‡∏°‡πà ‚Äî ‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏ö‡∏¥‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ ‚Üí ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡πÄ‡∏ö‡∏¥‡∏Å‡πÉ‡∏´‡∏°‡πà',
                        'üìÑ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Template ‚Äî ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Template ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡∏£‡∏π‡∏õ ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏≠‡∏á',
                        '‚úÖ ‡∏™‡πà‡∏á‡πÉ‡∏ö‡πÄ‡∏ö‡∏¥‡∏Å ‚Äî ‡∏Å‡∏£‡∏≠‡∏Å‡∏à‡∏≥‡∏ô‡∏ß‡∏ô ‚Üí ‡∏Å‡∏î "‡∏™‡πà‡∏á‡πÉ‡∏ö‡πÄ‡∏ö‡∏¥‡∏Å" ‚Üí ‡∏£‡∏≠‡∏ù‡πà‡∏≤‡∏¢‡∏Ñ‡∏•‡∏±‡∏á‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥',
                        'üëÅÔ∏è ‡∏î‡∏π‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ ‚Äî ‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏ö‡∏¥‡∏Å ‚Üí "‡πÉ‡∏ö‡πÄ‡∏ö‡∏¥‡∏Å‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô" ‡∏î‡∏π‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ ‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ / ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß / ‡∏à‡πà‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß',
                        'üõ†Ô∏è ‡∏ô‡∏±‡∏ö‡∏™‡∏ï‡πä‡∏≠‡∏Å‡∏™‡∏¥‡πâ‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô ‚Äî ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠ ‚Üí ‡∏ô‡∏±‡∏ö‡∏™‡∏ï‡πä‡∏≠‡∏Å‡∏™‡∏¥‡πâ‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (‡πÄ‡∏°‡∏∑‡πà‡∏≠ Admin ‡πÄ‡∏õ‡∏¥‡∏î)',
                    ]
                },
                {
                    role:'branch', icon:'üè™', label:'BRANCH', color:'#3b82f6', bg:'#eff6ff', border:'#bfdbfe',
                    title:'‡∏™‡∏≤‡∏Ç‡∏≤ ‚Äî ‡πÄ‡∏ö‡∏¥‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß',
                    steps:[
                        'üìã ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡πÄ‡∏ö‡∏¥‡∏Å ‚Äî ‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏ö‡∏¥‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ ‚Üí ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡πÄ‡∏ö‡∏¥‡∏Å‡πÉ‡∏´‡∏°‡πà',
                        'üì¶ ‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏Ñ‡∏•‡∏±‡∏á‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ú‡∏π‡∏Å‡πÑ‡∏ß‡πâ‡∏Å‡∏±‡∏ö‡∏™‡∏≤‡∏Ç‡∏≤‡∏ô‡∏±‡πâ‡∏ô',
                        '‚úÖ ‡∏™‡πà‡∏á‡πÉ‡∏ö‡πÄ‡∏ö‡∏¥‡∏Å ‚Äî ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ ‡∏Å‡∏£‡∏≠‡∏Å‡∏à‡∏≥‡∏ô‡∏ß‡∏ô ‚Üí ‡∏Å‡∏î "‡∏™‡πà‡∏á‡πÉ‡∏ö‡πÄ‡∏ö‡∏¥‡∏Å"',
                        'üëÅÔ∏è ‡∏î‡∏π‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ ‚Äî üü° ‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ ‚Üí üü¢ ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß ‚Üí üì¶ ‡∏à‡πà‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß',
                        '‚õî ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏î‡∏π‡∏Ñ‡∏•‡∏±‡∏á/‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠/GR/QC ‚Äî ‡πÄ‡∏´‡πá‡∏ô‡πÅ‡∏Ñ‡πà‡πÄ‡∏°‡∏ô‡∏π‡πÉ‡∏ö‡πÄ‡∏ö‡∏¥‡∏Å',
                    ]
                },
                {
                    role:'qc', icon:'üîç', label:'QC', color:'#7c3aed', bg:'#faf5ff', border:'#e9d5ff',
                    title:'QC ‚Äî ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö FIFO',
                    steps:[
                        'üöö ‡∏î‡∏π GR ‚Äî ‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ñ‡∏•‡∏±‡∏á ‚Üí ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ GR ‚Üí ‡∏î‡∏π Lot ‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ',
                        'üîç ‡πÄ‡∏£‡∏¥‡πà‡∏° Spot Check ‚Äî QC FIFO ‚Üí ‡πÄ‡∏£‡∏¥‡πà‡∏° Spot Check ‚Üí ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏ï‡∏£‡∏ß‡∏à',
                        'üìå ‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏™‡∏î‡∏á "‡∏Ñ‡∏ß‡∏£‡∏´‡∏¢‡∏¥‡∏ö Lot ‡πÑ‡∏´‡∏ô" ‡∏ï‡∏≤‡∏° FIFO ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥',
                        'üè≠ ‡πÑ‡∏õ‡∏î‡∏π‡∏´‡∏ô‡πâ‡∏≤‡∏á‡∏≤‡∏ô ‚Üí ‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡∏Å‡∏£‡∏≠‡∏Å Lot ‡∏ó‡∏µ‡πà‡πÄ‡∏´‡πá‡∏ô‡∏à‡∏£‡∏¥‡∏á + ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏à‡∏±‡∏î‡πÄ‡∏Å‡πá‡∏ö',
                        '‚úÖ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ú‡∏•: ‚úÖ ‡∏ú‡πà‡∏≤‡∏ô / ‚ö†Ô∏è ‡∏ô‡πà‡∏≤‡∏™‡∏á‡∏™‡∏±‡∏¢ / ‚ùå ‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô ‚Üí ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å ‚Üí ‡∏î‡∏π Report',
                    ]
                },
            ];

            const sections = [
                {
                    icon:'üè†', title:'Dashboard & ‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ',
                    color:'#3b82f6',
                    items:[
                        {q:'Dashboard ‡πÅ‡∏™‡∏î‡∏á‡∏≠‡∏∞‡πÑ‡∏£‡∏ö‡πâ‡∏≤‡∏á?', a:'‡πÅ‡∏™‡∏î‡∏á‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏™‡∏ï‡πä‡∏≠‡∏Å‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏•‡∏±‡∏á ‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡∏ö 7 ‡∏ß‡∏±‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î session ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î ‡πÅ‡∏•‡∏∞‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ï‡πà‡∏≥‡∏Å‡∏ß‡πà‡∏≤ Min ‡∏à‡∏∞‡∏Ç‡∏∂‡πâ‡∏ô‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏™‡∏µ‡πÅ‡∏î‡∏á‡∏ó‡∏±‡∏ô‡∏ó‡∏µ'},
                        {q:'‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô Password ‡πÑ‡∏î‡πâ‡∏ó‡∏µ‡πà‡πÑ‡∏´‡∏ô?', a:'‡∏î‡πâ‡∏≤‡∏ô‡∏ã‡πâ‡∏≤‡∏¢‡∏ö‡∏ô ‡πÉ‡∏ï‡πâ‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ ‡∏°‡∏µ‡∏õ‡∏∏‡πà‡∏° üîë ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô Password ‡∏Å‡∏£‡∏≠‡∏Å Password ‡πÄ‡∏Å‡πà‡∏≤‡πÅ‡∏•‡∏∞‡πÉ‡∏´‡∏°‡πà‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô'},
                        {q:'‡∏£‡∏∞‡∏ö‡∏ö logout ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÑ‡∏´‡∏£‡πà?', a:'‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô 30 ‡∏ô‡∏≤‡∏ó‡∏µ ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏Å‡πà‡∏≠‡∏ô 2 ‡∏ô‡∏≤‡∏ó‡∏µ ‡∏Å‡∏î "‡∏â‡∏±‡∏ô‡∏¢‡∏±‡∏á‡∏≠‡∏¢‡∏π‡πà" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ï‡πà‡∏≠‡∏≠‡∏≤‡∏¢‡∏∏ Session'},
                        {q:'Role ‡∏Ñ‡∏∑‡∏≠‡∏≠‡∏∞‡πÑ‡∏£ ‡πÅ‡∏ï‡πà‡∏•‡∏∞ Role ‡πÄ‡∏´‡πá‡∏ô‡∏≠‡∏∞‡πÑ‡∏£?', a:'Role ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ß‡πà‡∏≤‡πÉ‡∏Ñ‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡πÄ‡∏°‡∏ô‡∏π‡πÑ‡∏´‡∏ô‡πÑ‡∏î‡πâ‡∏ö‡πâ‡∏≤‡∏á: admin=‡∏ó‡∏∏‡∏Å‡∏≠‡∏¢‡πà‡∏≤‡∏á, boss=‡∏ó‡∏∏‡∏Å‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏¢‡∏Å‡πÄ‡∏ß‡πâ‡∏ô‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡∏ö‡∏ö, warehouse=‡∏Ñ‡∏•‡∏±‡∏á+‡πÉ‡∏ö‡πÄ‡∏ö‡∏¥‡∏Å+GR, staff=‡πÉ‡∏ö‡πÄ‡∏ö‡∏¥‡∏Å+‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠, branch=‡πÉ‡∏ö‡πÄ‡∏ö‡∏¥‡∏Å‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß, qc=GR+QC FIFO'},
                    ]
                },
                {
                    icon:'üöö', title:'‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ñ‡∏•‡∏±‡∏á (GR)',
                    color:'#06b6d4',
                    items:[
                        {q:'‡∏ß‡∏¥‡∏ò‡∏µ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ GR?', a:'‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ñ‡∏•‡∏±‡∏á ‚Üí ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (GR) ‚Üí ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏•‡∏±‡∏á ‚Üí ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ ‚Üí ‡∏Å‡∏£‡∏≠‡∏Å‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏±‡∏ö Lot Number MFD EXP ‚Üí ‡∏Å‡∏î‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å'},
                        {q:'Lot Number ‡∏Ñ‡∏∑‡∏≠‡∏≠‡∏∞‡πÑ‡∏£ ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏≠‡∏á‡πÑ‡∏´‡∏°?', a:'Lot Number ‡∏Ñ‡∏∑‡∏≠‡∏£‡∏´‡∏±‡∏™‡∏£‡∏∞‡∏ö‡∏∏ batch ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ ‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏´‡πâ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÑ‡∏î‡πâ) ‡∏Ñ‡∏ß‡∏£‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏ó‡∏µ‡πà‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ö‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏à‡∏£‡∏¥‡∏á ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ QC ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÑ‡∏î‡πâ'},
                        {q:'‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏°‡∏µ‡∏≠‡∏∞‡πÑ‡∏£‡∏ö‡πâ‡∏≤‡∏á?', a:'‚úÖ ‡∏Ñ‡∏£‡∏ö = ‡∏£‡∏±‡∏ö‡∏Ñ‡∏£‡∏ö‡∏ï‡∏≤‡∏°‡πÅ‡∏ú‡∏ô | ‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö = ‡∏£‡∏±‡∏ö‡πÑ‡∏î‡πâ‡∏ö‡∏≤‡∏á‡∏™‡πà‡∏ß‡∏ô | ‚ûï ‡∏Ç‡∏≠‡∏á‡πÅ‡∏ó‡∏£‡∏Å = ‡∏Ç‡∏≠‡∏á‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏™‡∏±‡πà‡∏á‡∏°‡∏≤‡∏î‡πâ‡∏ß‡∏¢ | ‚ùå ‡πÄ‡∏™‡∏µ‡∏¢‡∏´‡∏≤‡∏¢ = ‡∏Ç‡∏≠‡∏á‡πÄ‡∏™‡∏µ‡∏¢‡∏´‡∏≤‡∏¢‡∏£‡∏±‡∏ö‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ'},
                        {q:'‡∏´‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å GR ‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏Å‡∏¥‡∏î‡∏≠‡∏∞‡πÑ‡∏£‡∏Ç‡∏∂‡πâ‡∏ô?', a:'‡∏£‡∏∞‡∏ö‡∏ö‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï Lot Register ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ ‡πÄ‡∏£‡∏µ‡∏¢‡∏á Lot ‡∏ï‡∏≤‡∏°‡∏ß‡∏±‡∏ô‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏ (EXP ‡πÄ‡∏Å‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏Å‡πà‡∏≠‡∏ô) QC ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏´‡πá‡∏ô GR ‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ'},
                    ]
                },
                {
                    icon:'üè∑Ô∏è', title:'Lot Register & FIFO',
                    color:'#1e3a5f',
                    items:[
                        {q:'Lot Register ‡∏Ñ‡∏∑‡∏≠‡∏≠‡∏∞‡πÑ‡∏£?', a:'‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ó‡∏∏‡∏Å Lot ‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤ ‡πÅ‡∏™‡∏î‡∏á‡∏ß‡πà‡∏≤‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏°‡∏µ Lot ‡∏≠‡∏∞‡πÑ‡∏£‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏≠‡∏¢‡∏π‡πà‡∏ö‡πâ‡∏≤‡∏á ‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏° EXP ‡πÄ‡∏Å‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏Å‡πà‡∏≠‡∏ô ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏´‡∏¢‡∏¥‡∏ö‡∏ñ‡∏π‡∏Å FIFO'},
                        {q:'FIFO ‡∏Ñ‡∏∑‡∏≠‡∏≠‡∏∞‡πÑ‡∏£ ‡∏ó‡∏≥‡πÑ‡∏°‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç?', a:'First In First Out = ‡∏Ç‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤‡∏Å‡πà‡∏≠‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ‡∏Å‡πà‡∏≠‡∏ô ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Ç‡∏≠‡∏á‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏‡πÉ‡∏ô‡∏Ñ‡∏•‡∏±‡∏á ‡∏•‡∏î‡∏Ç‡∏≠‡∏á‡πÄ‡∏™‡∏µ‡∏¢ ‡πÅ‡∏•‡∏∞‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô Food Safety'},
                        {q:'‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏Å‡∏•‡πâ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÑ‡∏£?', a:'Lot Register ‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á banner ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà EXP ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏ô‡πâ‡∏≠‡∏¢‡∏Å‡∏ß‡πà‡∏≤ 30 ‡∏ß‡∏±‡∏ô ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏à‡∏≤‡∏Å‡∏ß‡∏¥‡∏Å‡∏§‡∏ï‡∏™‡∏∏‡∏î‡∏Å‡πà‡∏≠‡∏ô'},
                    ]
                },
                {
                    icon:'üîç', title:'QC FIFO Spot Check',
                    color:'#7c3aed',
                    items:[
                        {q:'‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô QC Spot Check ‡πÄ‡∏õ‡πá‡∏ô‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÑ‡∏£?', a:'QC FIFO ‚Üí ‡πÄ‡∏£‡∏¥‡πà‡∏° Spot Check ‚Üí ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏ï‡∏£‡∏ß‡∏à ‚Üí ‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏™‡∏î‡∏á Lot ‡∏ó‡∏µ‡πà‡∏Ñ‡∏ß‡∏£‡∏´‡∏¢‡∏¥‡∏ö ‚Üí ‡πÑ‡∏õ‡∏î‡∏π‡∏´‡∏ô‡πâ‡∏≤‡∏á‡∏≤‡∏ô ‚Üí ‡∏Å‡∏£‡∏≠‡∏Å Lot ‡∏ó‡∏µ‡πà‡πÄ‡∏´‡πá‡∏ô‡∏à‡∏£‡∏¥‡∏á ‚Üí ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ú‡∏• (‡∏ú‡πà‡∏≤‡∏ô/‡∏ô‡πà‡∏≤‡∏™‡∏á‡∏™‡∏±‡∏¢/‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô) ‚Üí ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å'},
                        {q:'‡∏ú‡∏• QC ‡∏°‡∏µ 3 ‡πÅ‡∏ö‡∏ö ‡∏ï‡πà‡∏≤‡∏á‡∏Å‡∏±‡∏ô‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÑ‡∏£?', a:'‚úÖ ‡∏ú‡πà‡∏≤‡∏ô = ‡∏´‡∏¢‡∏¥‡∏ö‡∏ñ‡∏π‡∏Å FIFO ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏ó‡∏µ‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥ | ‚ö†Ô∏è ‡∏ô‡πà‡∏≤‡∏™‡∏á‡∏™‡∏±‡∏¢ = ‡πÑ‡∏°‡πà‡πÅ‡∏ô‡πà‡πÉ‡∏à ‡∏≠‡∏≤‡∏à‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î | ‚ùå ‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô = ‡∏´‡∏¢‡∏¥‡∏ö Lot ‡∏ú‡∏¥‡∏î ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ó‡∏≥‡∏ï‡∏≤‡∏° FIFO'},
                        {q:'QC Report ‡∏î‡∏π‡πÑ‡∏î‡πâ‡∏ó‡∏µ‡πà‡πÑ‡∏´‡∏ô?', a:'QC FIFO ‚Üí ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ QC Report ‚Üí ‡πÄ‡∏´‡πá‡∏ô Pass Rate ‡∏£‡∏ß‡∏° ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà Fail ‡∏ö‡πà‡∏≠‡∏¢‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î ‡πÅ‡∏•‡∏∞‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ó‡∏∏‡∏Å session'},
                    ]
                },
                {
                    icon:'üì¶', title:'‡∏Ñ‡∏•‡∏±‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤',
                    color:'#f59e0b',
                    items:[
                        {q:'‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ & Export ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô ‡∏Ñ‡∏∑‡∏≠‡∏≠‡∏∞‡πÑ‡∏£?', a:'‡∏î‡∏π‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡∏ö‡∏™‡∏ï‡πä‡∏≠‡∏Å‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á Export ‡πÄ‡∏õ‡πá‡∏ô Excel ‡πÑ‡∏î‡πâ 2 ‡πÅ‡∏ö‡∏ö: (1) ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á (2) ‡∏¢‡∏≠‡∏î‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î Snapshot'},
                        {q:'‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÑ‡∏£?', a:'‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡∏¢‡∏≠‡∏î‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏Å‡∏±‡∏ö Min/Max ‡∏ó‡∏µ‡πà‡∏ï‡∏±‡πâ‡∏á‡πÑ‡∏ß‡πâ ‡∏ñ‡πâ‡∏≤‡∏ï‡πà‡∏≥‡∏Å‡∏ß‡πà‡∏≤ Min ‡∏à‡∏∞‡∏Ç‡∏∂‡πâ‡∏ô üî¥ ‡∏ï‡πâ‡∏≠‡∏á‡∏™‡∏±‡πà‡∏á‡∏î‡πà‡∏ß‡∏ô ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏±‡πà‡∏á = Max - ‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠'},
                        {q:'Export TRCloud Format ‡πÉ‡∏ä‡πâ‡∏ó‡∏≥‡∏≠‡∏∞‡πÑ‡∏£?', a:'Export Excel format ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡πÉ‡∏ö PR ‡∏Ç‡∏≠‡∏á TRCloud ‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏±‡∏ß‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÅ‡∏•‡πâ‡∏ß‡∏ô‡∏≥‡πÑ‡∏õ‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á‡∏ï‡∏≠‡∏ô‡∏Ñ‡∏µ‡∏¢‡πå‡πÉ‡∏ô TRCloud ‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢'},
                    ]
                },
                {
                    icon:'üìã', title:'‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏ö‡∏¥‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤',
                    color:'#f59e0b',
                    items:[
                        {q:'‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ö‡∏¥‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÑ‡∏£?', a:'(1) Staff/Branch ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡πÄ‡∏ö‡∏¥‡∏Å ‚Üí (2) Warehouse ‡∏Å‡∏î "‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥" ‚Üí (3) ‡∏à‡πà‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î "‡∏à‡πà‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß" ‚Üí (4) ‡∏û‡∏¥‡∏°‡∏û‡πå PDF ‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢'},
                        {q:'Template ‡πÉ‡∏ö‡πÄ‡∏ö‡∏¥‡∏Å‡∏Ñ‡∏∑‡∏≠‡∏≠‡∏∞‡πÑ‡∏£?', a:'‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏ö‡∏¥‡∏Å‡∏ö‡πà‡∏≠‡∏¢ ‡πÄ‡∏ä‡πà‡∏ô "‡πÉ‡∏ö‡πÄ‡∏ö‡∏¥‡∏Å‡πÅ‡∏ú‡∏ô‡∏Å‡∏ö‡∏¥‡∏á‡∏ã‡∏π" ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ñ‡∏±‡∏î‡πÑ‡∏õ‡∏Å‡∏î‡πÉ‡∏ä‡πâ Template ‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢ ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á'},
                        {q:'‡πÉ‡∏Ñ‡∏£‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÉ‡∏ö‡πÄ‡∏ö‡∏¥‡∏Å‡πÑ‡∏î‡πâ?', a:'Role warehouse, boss ‡πÅ‡∏•‡∏∞ admin ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô Staff/Branch ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏•‡∏∞‡∏î‡∏π‡πÉ‡∏ö‡πÄ‡∏ö‡∏¥‡∏Å‡∏Ç‡∏≠‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á‡πÑ‡∏î‡πâ ‡πÅ‡∏ï‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ'},
                        {q:'‡∏ñ‡πâ‡∏≤‡∏™‡∏±‡πà‡∏á‡∏ú‡∏¥‡∏î‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÑ‡∏î‡πâ‡πÑ‡∏´‡∏°?', a:'‡πÉ‡∏ö‡πÄ‡∏ö‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÄ‡∏õ‡πá‡∏ô "‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥" ‡∏ù‡πà‡∏≤‡∏¢‡∏Ñ‡∏•‡∏±‡∏á‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ "‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥" ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏• ‡πÅ‡∏•‡πâ‡∏ß‡πÉ‡∏´‡πâ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡πÄ‡∏ö‡∏¥‡∏Å‡πÉ‡∏´‡∏°‡πà'},
                    ]
                },
                {
                    icon:'üõ†Ô∏è', title:'‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠',
                    color:'#10b981',
                    items:[
                        {q:'‡∏ß‡∏¥‡∏ò‡∏µ‡∏ô‡∏±‡∏ö‡∏™‡∏ï‡πä‡∏≠‡∏Å?', a:'‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏ã‡∏ô ‚Üí ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà (‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö) ‚Üí ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏ô‡∏ô‡∏±‡∏ö ‚Üí ‡∏Å‡∏£‡∏≠‡∏Å‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î Enter ‡∏´‡∏£‡∏∑‡∏≠‡∏õ‡∏∏‡πà‡∏° + ‚Üí ‡∏Å‡∏î "‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÅ‡∏•‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å"'},
                        {q:'Daily Stock Card ‡∏Ñ‡∏∑‡∏≠‡∏≠‡∏∞‡πÑ‡∏£?', a:'‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô: ‡∏¢‡∏≠‡∏î‡∏¢‡∏Å‡∏°‡∏≤ + ‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤ - ‡∏à‡πà‡∏≤‡∏¢‡∏≠‡∏≠‡∏Å = ‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì Variance (‡∏ú‡∏•‡∏ï‡πà‡∏≤‡∏á) ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ ‡πÅ‡∏ó‡∏ô‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏© Stock Card ‡πÄ‡∏î‡∏¥‡∏°'},
                        {q:'‡∏ñ‡πâ‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ú‡∏¥‡∏î‡πÅ‡∏Å‡πâ‡πÑ‡∏î‡πâ‡πÑ‡∏´‡∏°?', a:'Admin ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏Å‡πâ‡∏¢‡∏≠‡∏î‡∏™‡∏ï‡πä‡∏≠‡∏Å‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å‡∏´‡∏ô‡πâ‡∏≤ Export ‚Üí ‡∏¢‡∏≠‡∏î‡∏™‡∏ï‡πä‡∏≠‡∏Å‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î ‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° ‚úèÔ∏è ‡πÅ‡∏•‡πâ‡∏ß‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏• ‡∏ó‡∏∏‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏ô Audit Log'},
                    ]
                },
                {
                    icon:'‚öôÔ∏è', title:'‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡∏ö‡∏ö (Admin)',
                    color:'#7c3aed',
                    items:[
                        {q:'‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏≥‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÑ‡∏£?', a:'‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡∏ö‡∏ö ‚Üí ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô & ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå ‚Üí ‡∏Å‡∏î + ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô ‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠ Username Password Role'},
                        {q:'‡∏•‡∏ö‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏°‡∏µ 2 ‡πÅ‡∏ö‡∏ö‡∏ï‡πà‡∏≤‡∏á‡∏Å‡∏±‡∏ô‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÑ‡∏£?', a:'‚è≥ ‡∏•‡∏ö (3‡∏ß‡∏±‡∏ô) = ‡∏£‡∏≠ 3 ‡∏ß‡∏±‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏•‡∏ö‡∏ñ‡∏≤‡∏ß‡∏£ ‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡πÑ‡∏î‡πâ‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏ô‡∏±‡πâ‡∏ô | üóëÔ∏è ‡∏•‡∏ö‡∏ó‡∏±‡∏ô‡∏ó‡∏µ = ‡∏ï‡πâ‡∏≠‡∏á‡∏û‡∏¥‡∏°‡∏û‡πå username ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô ‡∏•‡∏ö‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ'},
                        {q:'‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå Role ‡∏ó‡∏≥‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÑ‡∏£?', a:'‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Role & ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå ‚Üí ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Role ‚Üí tick checkbox ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£: üì¶‡∏Ñ‡∏•‡∏±‡∏á üìã‡πÉ‡∏ö‡πÄ‡∏ö‡∏¥‡∏Å üõ†Ô∏è‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠ üööGR üîçQC ‚öôÔ∏è‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô üëÅÔ∏è‡∏î‡∏π‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß'},
                        {q:'‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Min/Max ‡∏ó‡∏≥‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÑ‡∏£?', a:'‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏•‡∏±‡∏á‡πÅ‡∏•‡∏∞‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ ‚Üí ‡∏Å‡∏≥‡∏´‡∏ô‡∏î Min/Max ‡∏™‡∏ï‡πä‡∏≠‡∏Å‡∏ï‡πà‡∏≠‡∏Ñ‡∏•‡∏±‡∏á ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏•‡∏±‡∏á‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏£‡∏≠‡∏Å ‡∏Å‡∏î "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Min/Max ‡∏Ñ‡∏•‡∏±‡∏á‡∏ô‡∏µ‡πâ"'},
                        {q:'Backup/Restore ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏≥‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÑ‡∏£?', a:'‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏•‡∏±‡∏á‡πÅ‡∏•‡∏∞‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ ‚Üí ‡∏õ‡∏∏‡πà‡∏° üíæ Backup Config / üìÇ Restore Config ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏õ‡πá‡∏ô JSON ‡πÑ‡∏ß‡πâ‡πÉ‡∏ä‡πâ‡∏Å‡∏£‡∏ì‡∏µ‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô'},
                    ]
                },
            ];

            c.innerHTML = `
            <div class="tool-header no-print">
                <h2>üìñ ‡∏Ñ‡∏π‡πà‡∏°‡∏∑‡∏≠‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô TTGPlus</h2>
                <button onclick="closeTool()" style="background:#f1f5f9;color:#475569;border:none;padding:8px 16px;border-radius:8px;cursor:pointer;">‚úï ‡∏õ‡∏¥‡∏î</button>
            </div>

            <!-- HERO BANNER -->
            <div style="background:linear-gradient(135deg,#0b1629,#1e3a5f);border-radius:16px;padding:24px;margin-bottom:20px;color:white;">
                <div style="font-size:18px;font-weight:bold;margin-bottom:6px;">üìñ ‡∏Ñ‡∏π‡πà‡∏°‡∏∑‡∏≠‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô TTGPlus v2.0</div>
                <div style="color:#94a3b8;font-size:13px;line-height:1.6;margin-bottom:16px;">‡∏Ñ‡∏π‡πà‡∏°‡∏∑‡∏≠‡πÅ‡∏ö‡πà‡∏á‡πÄ‡∏õ‡πá‡∏ô 2 ‡∏™‡πà‡∏ß‡∏ô: <b style="color:#f0b429;">‡∏Ñ‡∏π‡πà‡∏°‡∏∑‡∏≠‡∏ï‡∏≤‡∏°‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á</b> (‡πÄ‡∏´‡πá‡∏ô‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡∏ß‡πà‡∏≤‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥‡∏≠‡∏∞‡πÑ‡∏£) ‡πÅ‡∏•‡∏∞ <b style="color:#06b6d4;">FAQ</b> (‡∏ï‡∏≠‡∏ö‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏û‡∏ö‡∏ö‡πà‡∏≠‡∏¢)</div>
                <div style="display:flex;gap:8px;flex-wrap:wrap;">
                    <button onclick="document.getElementById('roleGuideSection').scrollIntoView({behavior:'smooth'})"
                        style="background:#f0b429;color:#0b1629;border:none;padding:7px 16px;border-radius:20px;cursor:pointer;font-size:12px;font-weight:bold;">
                        üë§ ‡∏Ñ‡∏π‡πà‡∏°‡∏∑‡∏≠‡∏ï‡∏≤‡∏°‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á
                    </button>
                    ${sections.map(s=>`<button onclick="scrollToSection('help_${s.title}')"
                        style="background:rgba(255,255,255,0.1);color:white;border:1px solid rgba(255,255,255,0.2);padding:7px 14px;border-radius:20px;cursor:pointer;font-size:12px;">
                        ${s.icon} ${s.title}</button>`).join('')}
                </div>
            </div>

            <!-- ROLE GUIDE SECTION -->
            <div id="roleGuideSection">
                <div style="display:flex;align-items:center;gap:10px;margin-bottom:14px;">
                    <div style="width:4px;height:24px;background:#f0b429;border-radius:2px;"></div>
                    <h3 style="margin:0;font-size:16px;color:#1e293b;">üë§ ‡∏Ñ‡∏π‡πà‡∏°‡∏∑‡∏≠‡∏ï‡∏≤‡∏°‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á ‚Äî ‡∏â‡∏±‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥‡∏≠‡∏∞‡πÑ‡∏£?</h3>
                </div>
                <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:14px;margin-bottom:28px;">
                    ${roleGuides.map(rg=>`
                    <div style="background:${rg.bg};border:1.5px solid ${rg.border};border-radius:14px;overflow:hidden;">
                        <div style="background:${rg.color};padding:12px 16px;display:flex;align-items:center;gap:10px;">
                            <span style="font-size:20px;">${rg.icon}</span>
                            <div>
                                <div style="font-weight:800;color:${rg.role==='boss'||rg.role==='warehouse'?'#0b1629':'white'};font-size:14px;letter-spacing:0.5px;">${rg.label}</div>
                                <div style="font-size:11px;color:${rg.role==='boss'||rg.role==='warehouse'?'rgba(0,0,0,0.5)':'rgba(255,255,255,0.8)'};">${rg.title}</div>
                            </div>
                        </div>
                        <div style="padding:14px 16px;">
                            ${rg.steps.map((step,si)=>`
                            <div style="display:flex;gap:10px;align-items:flex-start;margin-bottom:${si<rg.steps.length-1?'10px':'0'};">
                                <div style="min-width:22px;height:22px;background:${rg.color};border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:10px;font-weight:bold;color:${rg.role==='boss'||rg.role==='warehouse'?'#0b1629':'white'};flex-shrink:0;margin-top:1px;">${si+1}</div>
                                <div style="font-size:12.5px;color:#334155;line-height:1.55;">${step}</div>
                            </div>`).join('')}
                        </div>
                    </div>`).join('')}
                </div>
            </div>

            <!-- FAQ SECTION -->
            <div style="display:flex;align-items:center;gap:10px;margin-bottom:14px;">
                <div style="width:4px;height:24px;background:#06b6d4;border-radius:2px;"></div>
                <h3 style="margin:0;font-size:16px;color:#1e293b;">‚ùì FAQ ‚Äî ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏û‡∏ö‡∏ö‡πà‡∏≠‡∏¢</h3>
            </div>
            ${sections.map(s=>`
            <div id="help_${s.title}" style="background:white;border-radius:14px;border:1px solid #e2e8f0;margin-bottom:12px;overflow:hidden;box-shadow:0 1px 4px rgba(0,0,0,0.06);">
                <div style="background:${s.color};padding:12px 18px;display:flex;align-items:center;gap:10px;">
                    <span style="font-size:18px;">${s.icon}</span>
                    <span style="font-weight:bold;color:white;font-size:14px;">${s.title}</span>
                </div>
                <div style="padding:2px 0;">
                    ${s.items.map((item,i)=>`
                    <div style="border-bottom:1px solid #f1f5f9;">
                        <button onclick="toggleHelp('h${s.title}${i}')"
                            style="width:100%;text-align:left;padding:13px 18px;background:none;border:none;cursor:pointer;display:flex;justify-content:space-between;align-items:center;font-size:13px;font-weight:600;color:#1e293b;gap:10px;">
                            <span>${item.q}</span>
                            <span id="harrow_h${s.title}${i}" style="color:#94a3b8;font-size:14px;transition:transform 0.25s;flex-shrink:0;">‚ñº</span>
                        </button>
                        <div id="h${s.title}${i}" style="display:none;padding:4px 18px 14px 18px;font-size:13px;color:#475569;line-height:1.75;background:#f8fafc;border-top:1px solid #e2e8f0;">
                            <div style="display:flex;gap:8px;align-items:flex-start;">
                                <span style="font-size:15px;margin-top:1px;">üí°</span>
                                <span>${item.a}</span>
                            </div>
                        </div>
                    </div>`).join('')}
                </div>
            </div>`).join('')}

            <div style="text-align:center;padding:24px;color:#94a3b8;font-size:12px;border-top:1px solid #f1f5f9;margin-top:8px;">
                TTGPlus v2.0 ‚Ä¢ ‡∏û‡∏±‡∏í‡∏ô‡∏≤‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö TTG Food
            </div>`;
        };

        window.toggleHelp = function(id) {
            const el = document.getElementById(id);
            const arrow = document.getElementById('harrow_'+id);
            if(!el) return;
            const open = el.style.display === 'none';
            el.style.display = open ? 'block' : 'none';
            if(arrow) arrow.style.transform = open ? 'rotate(180deg)' : '';
        };

        window.scrollToSection = function(id) {
            document.getElementById(id)?.scrollIntoView({behavior:'smooth'});
        };

        // ---- Use template in Create Requisition ----
        window.openCreateRequisitionWithTemplate = function(tid) {
            window._useTemplate = reqTemplates[tid];
            openCreateRequisition();
        };

        // ======== DAILY STOCK CARD ========
        // Firestore: dailyStockCards/{id} = {
        //   date, zone, recordedBy, timestamp,
        //   items:[{ id, name, unit,
        //     openingBalance,   // ‡∏¢‡∏≠‡∏î‡∏¢‡∏Å‡∏°‡∏≤ (‡∏à‡∏≤‡∏Å‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ß‡∏≤‡∏ô)
        //     received,         // ‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ
        //     issued,           // ‡∏à‡πà‡∏≤‡∏¢‡∏≠‡∏≠‡∏Å (‡∏à‡∏≤‡∏Å‡πÉ‡∏ö‡πÄ‡∏ö‡∏¥‡∏Å + manual)
        //     closingBalance,   // ‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÄ‡∏¢‡πá‡∏ô (‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏≠‡∏á)
        //     variance,         // ‡∏ú‡∏•‡∏ï‡πà‡∏≤‡∏á (‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥)
        //     note
        //   }]
        // }

        window.openDailyStockCard = async function() {
            document.getElementById('dashboardView').classList.add('hidden');
            const c = document.getElementById('toolAppContainer'); c.classList.remove('hidden');
            const visibleZones = getVisibleWarehouses();
            const today = new Date().toISOString().slice(0,10);

            // ‡πÇ‡∏´‡∏•‡∏î issued ‡∏à‡∏≤‡∏Å‡πÉ‡∏ö‡πÄ‡∏ö‡∏¥‡∏Å‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ
            const reqSnap = await getDocs(collection(db,'requisitions'));
            const todayIssued = {}; // { productId: totalIssued }
            const [ty,tm,td] = today.split('-');
            const todayTH = `${td}/${tm}/${parseInt(ty)+543}`;
            reqSnap.forEach(d=>{
                const r = d.data();
                if(r.status==='issued' && r.date===todayTH) {
                    (r.items||[]).forEach(it=>{
                        todayIssued[it.id] = (todayIssued[it.id]||0) + (it.qtyIssued||0);
                    });
                }
            });

            c.innerHTML = `
            <div class="tool-header no-print">
                <h2>üìã Daily Stock Card</h2>
                <div style="display:flex;gap:8px;">
                    <button onclick="viewDailyHistory()" style="background:#7c3aed;color:white;border:none;padding:8px 16px;border-radius:8px;cursor:pointer;font-weight:bold;">üìä ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á</button>
                    <button onclick="closeTool()" style="background:#f1f5f9;color:#475569;border:none;padding:8px 16px;border-radius:8px;cursor:pointer;">‚úï ‡∏õ‡∏¥‡∏î</button>
                </div>
            </div>

            <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:15px;margin-bottom:20px;">
                <div class="input-group" style="border:2px solid var(--danger);"><label>üìÖ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</label>
                    <input type="date" id="dsc_date" value="${today}" onchange="loadDSCOpening()"
                        style="width:100%;border:none;font-weight:bold;outline:none;font-size:14px;">
                </div>
                <div class="input-group"><label>üì¶ ‡∏Ñ‡∏•‡∏±‡∏á/‡πÇ‡∏ã‡∏ô</label>
                    <select id="dsc_zone" onchange="renderDSCItems()" style="width:100%;border:none;font-weight:bold;outline:none;">
                        ${visibleZones.map(z=>`<option value="${z}">${z}</option>`).join('')}
                    </select>
                </div>
                <div class="input-group" style="background:#f1f5f9;"><label>üìù ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÇ‡∏î‡∏¢</label><b>${currentUser.name}</b></div>
            </div>

            <div style="background:#eff6ff;border:1px solid #bae6fd;border-radius:10px;padding:12px 16px;margin-bottom:16px;font-size:13px;color:#0369a1;">
                üí° <b>‡∏ß‡∏¥‡∏ò‡∏µ‡πÉ‡∏ä‡πâ:</b> ‡∏¢‡∏≠‡∏î‡∏¢‡∏Å‡∏°‡∏≤ = ‡∏î‡∏∂‡∏á‡∏à‡∏≤‡∏Å‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ß‡∏≤‡∏ô‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ | ‡∏à‡πà‡∏≤‡∏¢‡∏≠‡∏≠‡∏Å = ‡∏î‡∏∂‡∏á‡∏à‡∏≤‡∏Å‡πÉ‡∏ö‡πÄ‡∏ö‡∏¥‡∏Å‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ | ‡∏Å‡∏£‡∏≠‡∏Å‡πÅ‡∏Ñ‡πà "‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤" ‡πÅ‡∏•‡∏∞ "‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÄ‡∏¢‡πá‡∏ô" ‡πÅ‡∏•‡πâ‡∏ß‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
            </div>

            <div style="margin-bottom:12px;">
                <input type="text" placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤..." oninput="filterDSCRows(this.value)"
                    style="width:100%;padding:10px 16px;border:1px solid #e2e8f0;border-radius:10px;font-size:14px;box-sizing:border-box;outline:none;">
            </div>

            <div id="dscTableContainer"></div>

            <div style="margin-top:24px;text-align:center;" class="no-print">
                <button onclick="saveDailyStockCard()" style="background:var(--success);color:white;padding:16px 60px;border:none;border-radius:14px;font-size:18px;font-weight:bold;cursor:pointer;box-shadow:0 4px 15px rgba(16,185,129,0.3);">
                    üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Stock Card ‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô
                </button>
            </div>`;

            window._dscTodayIssued = todayIssued;
            await renderDSCItems();
        };

        window.renderDSCItems = async function() {
            const zone = document.getElementById('dsc_zone')?.value||'';
            const date = document.getElementById('dsc_date')?.value||'';
            const zoneProds = allProducts.filter(p=>(zoneProductMap[zone]||[]).includes(p.id));
            const c = document.getElementById('dscTableContainer'); if(!c) return;

            // ‡πÇ‡∏´‡∏•‡∏î‡∏¢‡∏≠‡∏î‡∏õ‡∏¥‡∏î‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ß‡∏≤‡∏ô‡∏°‡∏≤‡πÄ‡∏õ‡πá‡∏ô opening
            const prevDate = new Date(date);
            prevDate.setDate(prevDate.getDate()-1);
            const prevDateISO = prevDate.toISOString().slice(0,10);
            const [py,pm,pd2] = prevDateISO.split('-');
            const prevDateTH = `${pd2}/${pm}/${parseInt(py)+543}`;

            const histSnap = await getDocs(collection(db,'dailyStockCards'));
            let prevCard = null;
            histSnap.forEach(d=>{
                const data = d.data();
                if(data.zone===zone && data.date===prevDateTH) prevCard = data;
            });

            // ‡πÇ‡∏´‡∏•‡∏î card ‡∏Ç‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß (‡∏Å‡∏£‡∏ì‡∏µ edit)
            const [cy,cm,cd] = date.split('-');
            const dateTH = `${cd}/${cm}/${parseInt(cy)+543}`;
            let todayCard = null;
            histSnap.forEach(d=>{
                const data = d.data();
                if(data.zone===zone && data.date===dateTH) { todayCard = data; window._dscEditId = d.id; }
            });
            if(!todayCard) window._dscEditId = null;

            const issued = window._dscTodayIssued||{};
            c.innerHTML = `
            <div style="overflow-x:auto;">
            <table style="width:100%;border-collapse:collapse;min-width:800px;" id="dscTable">
                <thead>
                    <tr style="background:#1e293b;color:white;">
                        <th style="padding:12px;text-align:left;font-size:12px;" rowspan="2">‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th>
                        <th style="padding:12px;text-align:center;font-size:12px;border-left:1px solid rgba(255,255,255,0.1);" colspan="1">‡∏¢‡∏Å‡∏°‡∏≤</th>
                        <th style="padding:12px;text-align:center;font-size:12px;border-left:1px solid rgba(255,255,255,0.1);background:#166534;" colspan="1">‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤</th>
                        <th style="padding:12px;text-align:center;font-size:12px;border-left:1px solid rgba(255,255,255,0.1);background:#7f1d1d;" colspan="1">‡∏à‡πà‡∏≤‡∏¢‡∏≠‡∏≠‡∏Å</th>
                        <th style="padding:12px;text-align:center;font-size:12px;border-left:1px solid rgba(255,255,255,0.1);background:#1e3a5f;" colspan="1">‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÄ‡∏¢‡πá‡∏ô</th>
                        <th style="padding:12px;text-align:center;font-size:12px;border-left:1px solid rgba(255,255,255,0.1);" colspan="1">‡∏ú‡∏•‡∏ï‡πà‡∏≤‡∏á</th>
                        <th style="padding:12px;text-align:left;font-size:12px;border-left:1px solid rgba(255,255,255,0.1);">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</th>
                    </tr>
                    <tr style="background:#334155;color:#94a3b8;font-size:10px;">
                        <th style="padding:6px 12px;border-left:1px solid rgba(255,255,255,0.1);">‡∏à‡∏≤‡∏Å‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ß‡∏≤‡∏ô</th>
                        <th style="padding:6px 12px;border-left:1px solid rgba(255,255,255,0.1);background:#14532d;">‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏≠‡∏á</th>
                        <th style="padding:6px 12px;border-left:1px solid rgba(255,255,255,0.1);background:#450a0a;">‡∏à‡∏≤‡∏Å‡πÉ‡∏ö‡πÄ‡∏ö‡∏¥‡∏Å+manual</th>
                        <th style="padding:6px 12px;border-left:1px solid rgba(255,255,255,0.1);background:#172554;">‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏≠‡∏á</th>
                        <th style="padding:6px 12px;border-left:1px solid rgba(255,255,255,0.1);">‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</th>
                        <th style="padding:6px 12px;border-left:1px solid rgba(255,255,255,0.1);"></th>
                    </tr>
                </thead>
                <tbody>${zoneProds.map(p=>{
                    const u = (p.units||[{name:p.unit||''}])[0]?.name||'';
                    const prevItem = prevCard?.items?.find(it=>it.id===p.id);
                    const todayItem = todayCard?.items?.find(it=>it.id===p.id);
                    const opening = todayItem?.openingBalance ?? prevItem?.closingBalance ?? '';
                    const recv = todayItem?.received ?? '';
                    const iss = issued[p.id]||0;
                    const issManual = todayItem?.issuedManual ?? 0;
                    const closing = todayItem?.closingBalance ?? '';
                    const note = todayItem?.note||'';
                    return `<tr class="stock-row dsc-row" data-id="${p.id}" data-name="${p.name.toLowerCase()} ${p.id.toLowerCase()}"
                        style="border-bottom:1px solid #f1f5f9;">
                        <td style="padding:10px 12px;">
                            <b style="font-size:13px;">${p.id}</b><br>
                            <span style="color:#475569;font-size:12px;">${p.name}</span><br>
                            <small style="color:#94a3b8;font-size:10px;">${u}</small>
                        </td>
                        <td style="padding:10px;text-align:center;border-left:2px solid #f1f5f9;">
                            <span id="dsc_open_${p.id}" style="font-size:16px;font-weight:bold;color:#64748b;">${opening!==''?opening:'‚Äî'}</span>
                            <input type="hidden" id="dsc_opening_${p.id}" value="${opening}">
                        </td>
                        <td style="padding:10px;text-align:center;border-left:2px solid #dcfce7;background:#f0fdf4;">
                            <input type="number" id="dsc_recv_${p.id}" value="${recv}" min="0" placeholder="0"
                                oninput="calcDSCVariance('${p.id}')"
                                style="width:75px;padding:7px;border:2px solid #6ee7b7;border-radius:8px;text-align:center;font-weight:bold;font-size:14px;outline:none;">
                        </td>
                        <td style="padding:10px;text-align:center;border-left:2px solid #fee2e2;background:#fff5f5;">
                            <div style="font-size:14px;font-weight:bold;color:#ef4444;" id="dsc_iss_auto_${p.id}">${iss}</div>
                            <small style="color:#94a3b8;font-size:10px;">(‡πÉ‡∏ö‡πÄ‡∏ö‡∏¥‡∏Å)</small><br>
                            <input type="number" id="dsc_iss_manual_${p.id}" value="${issManual||''}" min="0" placeholder="+‡πÄ‡∏û‡∏¥‡πà‡∏°"
                                oninput="calcDSCVariance('${p.id}')"
                                style="width:65px;padding:5px;border:1px dashed #fca5a5;border-radius:6px;text-align:center;font-size:12px;outline:none;margin-top:4px;">
                        </td>
                        <td style="padding:10px;text-align:center;border-left:2px solid #dbeafe;background:#eff6ff;">
                            <input type="number" id="dsc_close_${p.id}" value="${closing}" min="0" placeholder="0"
                                oninput="calcDSCVariance('${p.id}')"
                                style="width:75px;padding:7px;border:2px solid #93c5fd;border-radius:8px;text-align:center;font-weight:bold;font-size:14px;outline:none;">
                        </td>
                        <td style="padding:10px;text-align:center;border-left:2px solid #f1f5f9;" id="dsc_var_${p.id}">
                            <span style="color:#94a3b8;">‚Äî</span>
                        </td>
                        <td style="padding:10px;border-left:2px solid #f1f5f9;">
                            <input type="text" id="dsc_note_${p.id}" value="${note}" placeholder="‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏"
                                style="width:100%;padding:5px 8px;border:1px solid #e2e8f0;border-radius:6px;font-size:11px;box-sizing:border-box;">
                        </td>
                    </tr>`;
                }).join('')}</tbody>
            </table></div>`;

            // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì variance ‡∏Ç‡∏≠‡∏á‡∏ó‡∏∏‡∏Å‡πÅ‡∏ñ‡∏ß‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
            zoneProds.forEach(p=>calcDSCVariance(p.id));
        };

        window.calcDSCVariance = function(id) {
            const opening = parseFloat(document.getElementById(`dsc_opening_${id}`)?.value)||0;
            const recv    = parseFloat(document.getElementById(`dsc_recv_${id}`)?.value)||0;
            const issAuto = parseFloat(document.getElementById(`dsc_iss_auto_${id}`)?.innerText)||0;
            const issMan  = parseFloat(document.getElementById(`dsc_iss_manual_${id}`)?.value)||0;
            const closing = document.getElementById(`dsc_close_${id}`)?.value;
            const varEl   = document.getElementById(`dsc_var_${id}`);
            if(!varEl) return;

            if(closing==='') { varEl.innerHTML='<span style="color:#94a3b8;">‚Äî</span>'; return; }
            const closingNum = parseFloat(closing)||0;
            // expected = opening + recv - issued
            const totalIssued = issAuto + issMan;
            const expected = opening + recv - totalIssued;
            const variance = closingNum - expected;
            const abs = Math.abs(variance).toFixed(1);
            if(variance===0) {
                varEl.innerHTML='<span style="color:#10b981;font-weight:bold;">‚úÖ ‡∏ï‡∏£‡∏á</span>';
            } else if(variance>0) {
                varEl.innerHTML=`<span style="font-weight:bold;color:#3b82f6;">+${abs}</span><br><small style="font-size:10px;color:#3b82f6;">‡πÄ‡∏Å‡∏¥‡∏ô‡∏Å‡∏ß‡πà‡∏≤‡∏Ñ‡∏≤‡∏î</small>`;
            } else {
                varEl.innerHTML=`<span style="font-weight:bold;color:#ef4444;">-${abs}</span><br><small style="font-size:10px;color:#ef4444;">‡∏Ç‡∏≤‡∏î‡∏Å‡∏ß‡πà‡∏≤‡∏Ñ‡∏≤‡∏î</small>`;
            }
        };

        window.filterDSCRows = function(q) {
            q = q.toLowerCase().trim();
            document.querySelectorAll('.dsc-row').forEach(r=>{
                r.style.display = (!q||r.dataset.name.includes(q)) ? '' : 'none';
            });
        };

        window.saveDailyStockCard = async function() {
            const date = document.getElementById('dsc_date')?.value;
            const zone = document.getElementById('dsc_zone')?.value;
            if(!date||!zone){toast('‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡∏∞‡∏Ñ‡∏•‡∏±‡∏á','#c2410c');return;}

            const [y,m,d] = date.split('-');
            const dateTH = `${d}/${m}/${parseInt(y)+543}`;
            const zoneProds = allProducts.filter(p=>(zoneProductMap[zone]||[]).includes(p.id));

            const items = zoneProds.map(p=>{
                const opening  = parseFloat(document.getElementById(`dsc_opening_${p.id}`)?.value)||0;
                const recv     = parseFloat(document.getElementById(`dsc_recv_${p.id}`)?.value)||0;
                const issAuto  = parseFloat(document.getElementById(`dsc_iss_auto_${p.id}`)?.innerText)||0;
                const issMan   = parseFloat(document.getElementById(`dsc_iss_manual_${p.id}`)?.value)||0;
                const closing  = document.getElementById(`dsc_close_${p.id}`)?.value;
                const note     = document.getElementById(`dsc_note_${p.id}`)?.value||'';
                const u        = (p.units||[{name:p.unit||''}])[0]?.name||'';
                if(closing==='' && recv===0 && issMan===0) return null;
                const closingNum = parseFloat(closing)||0;
                const totalIssued = issAuto + issMan;
                const expected = opening + recv - totalIssued;
                const variance = closingNum - expected;
                return {id:p.id, name:p.name, unit:u,
                    openingBalance:opening, received:recv,
                    issuedAuto:issAuto, issuedManual:issMan,
                    closingBalance:closingNum, variance:parseFloat(variance.toFixed(2)), note};
            }).filter(Boolean);

            if(!items.length){toast('‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£','#c2410c');return;}
            if(!confirm(`‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Stock Card ${zone} ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${dateTH}?`))return;

            const payload = {date:dateTH, zone, timestamp:Date.now(), recordedBy:currentUser.name, items};
            if(window._dscEditId) {
                const {updateDoc} = await import("https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js");
                await updateDoc(doc(db,'dailyStockCards',window._dscEditId), payload);
            } else {
                await addDoc(collection(db,'dailyStockCards'), payload);
            }
            toast('‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Stock Card ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à','#059669');
            renderDSCItems();
        };

        // ---- ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á ----
        window.viewDailyHistory = async function() {
            document.getElementById('dashboardView').classList.add('hidden');
            const c = document.getElementById('toolAppContainer'); c.classList.remove('hidden');
            c.innerHTML = `
            <div class="tool-header">
                <h2>üìä ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ Daily Stock Card</h2>
                <div style="display:flex;gap:8px;">
                    <button onclick="exportDSCExcel()" style="background:var(--success);color:white;border:none;padding:8px 16px;border-radius:8px;cursor:pointer;font-weight:bold;">üì• Export Excel</button>
                    <button onclick="openDailyStockCard()" style="background:#06b6d4;color:white;border:none;padding:8px 16px;border-radius:8px;cursor:pointer;font-weight:bold;">üìã ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</button>
                    <button onclick="closeTool()" style="background:#f1f5f9;color:#475569;border:none;padding:8px 16px;border-radius:8px;cursor:pointer;">‚úï ‡∏õ‡∏¥‡∏î</button>
                </div>
            </div>
            <div style="display:flex;gap:12px;margin-bottom:16px;flex-wrap:wrap;">
                <div class="input-group" style="min-width:200px;"><label>üì¶ ‡∏Ñ‡∏•‡∏±‡∏á</label>
                    <select id="dsch_zone" onchange="loadDSCHistory()" style="width:100%;border:none;font-weight:bold;outline:none;">
                        <option value="">‚Äî ‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏•‡∏±‡∏á ‚Äî</option>
                        ${getVisibleWarehouses().map(z=>`<option value="${z}">${z}</option>`).join('')}
                    </select></div>
                <div class="input-group" style="min-width:200px;"><label>üçé ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</label>
                    <select id="dsch_prod" onchange="loadDSCHistory()" style="width:100%;border:none;font-weight:bold;outline:none;">
                        <option value="">‚Äî ‡∏ó‡∏∏‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ ‚Äî</option>
                        ${allProducts.map(p=>`<option value="${p.id}">${p.id} - ${p.name}</option>`).join('')}
                    </select></div>
            </div>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:20px;">
                <div style="background:white;border-radius:14px;padding:20px;border:1px solid #e2e8f0;">
                    <h4 style="margin:0 0 12px;">üìà ‡∏¢‡∏≠‡∏î‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÄ‡∏¢‡πá‡∏ô (Trend)</h4>
                    <canvas id="dscClosingChart" height="180"></canvas>
                </div>
                <div style="background:white;border-radius:14px;padding:20px;border:1px solid #e2e8f0;">
                    <h4 style="margin:0 0 12px;">üìâ ‡∏à‡πà‡∏≤‡∏¢‡∏≠‡∏≠‡∏Å‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏ß‡∏±‡∏ô</h4>
                    <canvas id="dscIssuedChart" height="180"></canvas>
                </div>
            </div>
            <div style="background:white;border-radius:14px;border:1px solid #e2e8f0;overflow:hidden;" id="dscHistoryTable">
                <p style="text-align:center;color:#94a3b8;padding:30px;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</p>
            </div>`;
            await loadDSCHistory();
        };

        let _dscChart1=null,_dscChart2=null;
        window.loadDSCHistory = async function() {
            const zone = document.getElementById('dsch_zone')?.value||'';
            const prodId = document.getElementById('dsch_prod')?.value||'';
            const snap = await getDocs(collection(db,'dailyStockCards'));
            let cards = [];
            snap.forEach(d=>cards.push({id:d.id,...d.data()}));
            if(zone) cards = cards.filter(c=>c.zone===zone);
            cards.sort((a,b)=>a.timestamp-b.timestamp);

            // flatten items
            const rows = [];
            cards.forEach(card=>{
                (card.items||[]).forEach(it=>{
                    if(!prodId||it.id===prodId) rows.push({date:card.date,zone:card.zone,recordedBy:card.recordedBy,...it});
                });
            });

            // charts
            const labels = rows.map(r=>`${r.date}
${r.zone}`);
            const closing = rows.map(r=>r.closingBalance||0);
            const issued  = rows.map(r=>(r.issuedAuto||0)+(r.issuedManual||0));

            if(_dscChart1)_dscChart1.destroy();
            if(_dscChart2)_dscChart2.destroy();
            const c1=document.getElementById('dscClosingChart');
            const c2=document.getElementById('dscIssuedChart');
            if(c1&&rows.length){_dscChart1=new Chart(c1,{type:'line',data:{labels,datasets:[{label:'‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÄ‡∏¢‡πá‡∏ô',data:closing,borderColor:'#06b6d4',backgroundColor:'rgba(6,182,212,0.08)',borderWidth:2,tension:0.3,fill:true,pointRadius:4}]},options:{responsive:true,plugins:{legend:{display:false}},scales:{y:{beginAtZero:true},x:{ticks:{maxRotation:45}}}}});}
            if(c2&&rows.length){_dscChart2=new Chart(c2,{type:'bar',data:{labels,datasets:[{label:'‡∏à‡πà‡∏≤‡∏¢‡∏≠‡∏≠‡∏Å',data:issued,backgroundColor:'rgba(239,68,68,0.15)',borderColor:'#ef4444',borderWidth:2,borderRadius:6}]},options:{responsive:true,plugins:{legend:{display:false}},scales:{y:{beginAtZero:true},x:{ticks:{maxRotation:45}}}}});}

            const tbl=document.getElementById('dscHistoryTable');
            if(!tbl)return;
            if(!rows.length){tbl.innerHTML='<p style="text-align:center;color:#94a3b8;padding:30px;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‚Äî ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Stock Card ‡∏ß‡∏±‡∏ô‡πÅ‡∏£‡∏Å‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö</p>';return;}
            tbl.innerHTML=`<table style="width:100%;border-collapse:collapse;">
                <thead><tr style="background:#f8fafc;">
                    <th style="padding:10px;font-size:11px;color:#64748b;text-align:left;">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
                    <th style="padding:10px;font-size:11px;color:#64748b;text-align:left;">‡∏Ñ‡∏•‡∏±‡∏á</th>
                    <th style="padding:10px;font-size:11px;color:#64748b;text-align:left;">‡∏£‡∏´‡∏±‡∏™</th>
                    <th style="padding:10px;font-size:11px;color:#64748b;text-align:left;">‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th>
                    <th style="padding:10px;font-size:11px;color:#64748b;text-align:center;">‡∏¢‡∏Å‡∏°‡∏≤</th>
                    <th style="padding:10px;font-size:11px;color:#10b981;text-align:center;">‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤</th>
                    <th style="padding:10px;font-size:11px;color:#ef4444;text-align:center;">‡∏à‡πà‡∏≤‡∏¢‡∏≠‡∏≠‡∏Å</th>
                    <th style="padding:10px;font-size:11px;color:#3b82f6;text-align:center;">‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÄ‡∏¢‡πá‡∏ô</th>
                    <th style="padding:10px;font-size:11px;color:#64748b;text-align:center;">‡∏ú‡∏•‡∏ï‡πà‡∏≤‡∏á</th>
                    <th style="padding:10px;font-size:11px;color:#64748b;text-align:center;">‡∏´‡∏ô‡πà‡∏ß‡∏¢</th>
                    <th style="padding:10px;font-size:11px;color:#64748b;text-align:left;">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</th>
                </tr></thead>
                <tbody>${rows.map(r=>{
                    const varColor=r.variance>0?'#3b82f6':r.variance<0?'#ef4444':'#10b981';
                    const varText=r.variance===0?'‚úÖ':r.variance>0?`+${r.variance}`:`${r.variance}`;
                    return `<tr style="border-top:1px solid #f1f5f9;">
                        <td style="padding:9px;font-size:12px;">${r.date}</td>
                        <td style="padding:9px;font-size:12px;color:#64748b;">${r.zone}</td>
                        <td style="padding:9px;font-weight:bold;font-size:12px;">${r.id}</td>
                        <td style="padding:9px;font-size:12px;color:#475569;">${r.name}</td>
                        <td style="padding:9px;text-align:center;color:#64748b;">${r.openingBalance??'-'}</td>
                        <td style="padding:9px;text-align:center;font-weight:bold;color:#10b981;">${r.received||0}</td>
                        <td style="padding:9px;text-align:center;font-weight:bold;color:#ef4444;">${(r.issuedAuto||0)+(r.issuedManual||0)}</td>
                        <td style="padding:9px;text-align:center;font-weight:bold;color:#3b82f6;font-size:14px;">${r.closingBalance??'-'}</td>
                        <td style="padding:9px;text-align:center;font-weight:bold;color:${varColor};">${varText}</td>
                        <td style="padding:9px;text-align:center;color:#64748b;font-size:11px;">${r.unit}</td>
                        <td style="padding:9px;font-size:11px;color:#64748b;">${r.note||'-'}</td>
                    </tr>`;
                }).join('')}</tbody>
            </table>`;
            window._dscExportRows = rows;
        };

        window.exportDSCExcel = function() {
            const rows = window._dscExportRows||[];
            if(!rows.length){toast('‚ùå ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•','#c2410c');return;}
            const header=[['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà','‡∏Ñ‡∏•‡∏±‡∏á','‡∏£‡∏´‡∏±‡∏™','‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤','‡∏¢‡∏Å‡∏°‡∏≤','‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤','‡∏à‡πà‡∏≤‡∏¢‡∏≠‡∏≠‡∏Å(‡πÉ‡∏ö‡πÄ‡∏ö‡∏¥‡∏Å)','‡∏à‡πà‡∏≤‡∏¢‡∏≠‡∏≠‡∏Å(manual)','‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÄ‡∏¢‡πá‡∏ô','‡∏ú‡∏•‡∏ï‡πà‡∏≤‡∏á','‡∏´‡∏ô‡πà‡∏ß‡∏¢','‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏','‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÇ‡∏î‡∏¢']];
            const data=rows.map(r=>[r.date,r.zone,r.id,r.name,r.openingBalance??'',r.received||0,r.issuedAuto||0,r.issuedManual||0,r.closingBalance??'',r.variance??'',r.unit,r.note||'',r.recordedBy||'']);
            const ws=XLSX.utils.aoa_to_sheet([...header,...data]),wb=XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb,ws,'DailyStockCard');
            XLSX.writeFile(wb,`DailyStockCard_${new Date().toLocaleDateString('th-TH').replace(/\//g,'-')}.xlsx`);
        };

        // ======== MONTHLY COUNT LOCK ========
        window.tryOpenMonthlyCount = function() {
            if(!monthlyCountOpen) {
                // show locked modal
                const existing = document.getElementById('lockedModal'); if(existing) existing.remove();
                const m = document.createElement('div'); m.className='modal-overlay'; m.id='lockedModal';
                m.innerHTML=`<div class="modal-box" style="max-width:400px;text-align:center;">
                    <div style="font-size:48px;margin-bottom:12px;">üîí</div>
                    <h3 style="margin:0 0 8px;">‡∏£‡∏∞‡∏ö‡∏ö‡∏ô‡∏±‡∏ö‡∏™‡∏ï‡πä‡∏≠‡∏Å‡∏™‡∏¥‡πâ‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏õ‡∏¥‡∏î‡∏≠‡∏¢‡∏π‡πà</h3>
                    <p style="color:#64748b;font-size:13px;margin-bottom:20px;">Admin ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏õ‡∏¥‡∏î‡∏£‡∏∞‡∏ö‡∏ö‡∏ô‡∏±‡∏ö‡∏™‡∏ï‡πä‡∏≠‡∏Å‡∏™‡∏¥‡πâ‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô<br>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö</p>
                    <button onclick="document.getElementById('lockedModal').remove()" style="background:#1e293b;color:white;border:none;padding:10px 30px;border-radius:10px;cursor:pointer;font-weight:bold;">‡∏ï‡∏Å‡∏•‡∏á</button>
                </div>`;
                document.body.appendChild(m);
                return;
            }
            openCentralStock();
        };

        window.toggleMonthlyCount = function() {
            const action = monthlyCountOpen ? '‡∏õ‡∏¥‡∏î' : '‡πÄ‡∏õ‡∏¥‡∏î';
            if(!confirm(`‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô${action}‡∏£‡∏∞‡∏ö‡∏ö‡∏ô‡∏±‡∏ö‡∏™‡∏ï‡πä‡∏≠‡∏Å‡∏™‡∏¥‡πâ‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô?\n${monthlyCountOpen?'‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ô‡∏±‡∏ö‡∏™‡∏ï‡πä‡∏≠‡∏Å‡πÑ‡∏î‡πâ‡∏à‡∏ô‡∏Å‡∏ß‡πà‡∏≤ Admin ‡∏à‡∏∞‡πÄ‡∏õ‡∏¥‡∏î‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á':'‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô‡∏à‡∏∞‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡∏∞‡∏ö‡∏ö‡∏ô‡∏±‡∏ö‡∏™‡∏ï‡πä‡∏≠‡∏Å‡πÑ‡∏î‡πâ'}`)) return;
            monthlyCountOpen = !monthlyCountOpen;
            saveConfig();
            applyPermissions();
            toast(`${monthlyCountOpen?'üü¢ ‡πÄ‡∏õ‡∏¥‡∏î':'üî¥ ‡∏õ‡∏¥‡∏î'}‡∏£‡∏∞‡∏ö‡∏ö‡∏ô‡∏±‡∏ö‡∏™‡∏ï‡πä‡∏≠‡∏Å‡∏™‡∏¥‡πâ‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡πÅ‡∏•‡πâ‡∏ß`, monthlyCountOpen?'#059669':'#c2410c');
        };

        // ======== STOCK SHEET TEMPLATES (‡πÉ‡∏ö‡∏ô‡∏±‡∏ö‡∏™‡∏ï‡πä‡∏≠‡∏Å‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠) ========
        window.openRequisitionSettings = function() {
            document.getElementById('dashboardView').classList.add('hidden');
            const c = document.getElementById('toolAppContainer'); c.classList.remove('hidden');
            renderTemplateSettingsPage(c);
        };

        function renderTemplateSettingsPage(c) {
            c.innerHTML = `
            <div class="tool-header">
                <h2>‚öôÔ∏è ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Template</h2>
                <button onclick="closeTool()" style="background:#f1f5f9;color:#475569;border:none;padding:8px 16px;border-radius:8px;cursor:pointer;">‚úï ‡∏õ‡∏¥‡∏î</button>
            </div>
            <!-- Tabs -->
            <div style="display:flex;gap:0;margin-bottom:24px;border-bottom:2px solid #e2e8f0;">
                <button onclick="switchTmplTab('req')" id="tab_req"
                    style="padding:12px 28px;border:none;background:none;cursor:pointer;font-size:14px;font-weight:bold;color:#7c3aed;border-bottom:3px solid #7c3aed;margin-bottom:-2px;">
                    üìã ‡πÉ‡∏ö‡πÄ‡∏ö‡∏¥‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</button>
                <button onclick="switchTmplTab('sheet')" id="tab_sheet"
                    style="padding:12px 28px;border:none;background:none;cursor:pointer;font-size:14px;font-weight:bold;color:#94a3b8;border-bottom:3px solid transparent;margin-bottom:-2px;">
                    üìÑ ‡πÉ‡∏ö‡∏ô‡∏±‡∏ö‡∏™‡∏ï‡πä‡∏≠‡∏Å‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</button>
            </div>
            <div id="tmplTabContent"></div>`;
            switchTmplTab('req');
        }

        window.switchTmplTab = function(tab) {
            ['req','sheet'].forEach(t => {
                const btn = document.getElementById(`tab_${t}`);
                if(btn) {
                    btn.style.color = t===tab ? (t==='req'?'#7c3aed':'#06b6d4') : '#94a3b8';
                    btn.style.borderBottom = t===tab ? `3px solid ${t==='req'?'#7c3aed':'#06b6d4'}` : '3px solid transparent';
                }
            });
            const c = document.getElementById('tmplTabContent'); if(!c) return;
            if(tab==='req') renderReqTemplateTab(c);
            else renderSheetTemplateTab(c);
        };

        // ---- Tab: ‡πÉ‡∏ö‡πÄ‡∏ö‡∏¥‡∏Å (existing logic wrapped) ----
        function renderReqTemplateTab(c) {
            const tmplList = Object.entries(reqTemplates);
            c.innerHTML = `
            <p style="color:#64748b;font-size:13px;margin-bottom:20px;">‡∏™‡∏£‡πâ‡∏≤‡∏á Template ‡πÉ‡∏ö‡πÄ‡∏ö‡∏¥‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡∏£‡∏π‡∏õ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏•‡∏∞‡πÅ‡∏ú‡∏ô‡∏Å ‡∏Å‡∏î‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏£‡∏≠‡∏Å‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á</p>
            <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:16px;margin-bottom:24px;">
                ${tmplList.map(([id,t])=>`
                <div style="background:white;border-radius:14px;border:3px solid ${t.color};padding:20px;position:relative;">
                    <div style="position:absolute;top:12px;right:12px;display:flex;gap:6px;">
                        <button onclick="editTemplate('${id}')" style="background:#f1f5f9;border:none;padding:5px 10px;border-radius:6px;cursor:pointer;font-size:12px;">‚úèÔ∏è</button>
                        <button onclick="deleteTemplate('${id}')" style="background:#fef2f2;border:none;padding:5px 10px;border-radius:6px;cursor:pointer;font-size:12px;color:#ef4444;">üóëÔ∏è</button>
                    </div>
                    <div style="font-size:16px;font-weight:bold;color:${t.color};">${t.name}</div>
                    <div style="font-size:12px;color:#64748b;margin:4px 0 8px;">üì¶ ${t.zone} ‚Ä¢ üè≠ ${t.dept||'-'}</div>
                    <div style="font-size:12px;color:#94a3b8;">${(t.items||[]).length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</div>
                </div>`).join('')}
                <div onclick="openNewTemplateForm()" style="background:white;border-radius:14px;border:3px dashed #e2e8f0;padding:20px;cursor:pointer;display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:120px;"
                    onmouseover="this.style.borderColor='#7c3aed'" onmouseout="this.style.borderColor='#e2e8f0'">
                    <div style="font-size:32px;color:#cbd5e1;">+</div>
                    <div style="color:#94a3b8;font-size:13px;">‡∏™‡∏£‡πâ‡∏≤‡∏á Template ‡πÉ‡∏´‡∏°‡πà</div>
                </div>
            </div>
            <div id="templateFormArea"></div>`;
        }

        // ---- Tab: ‡πÉ‡∏ö‡∏ô‡∏±‡∏ö‡∏™‡∏ï‡πä‡∏≠‡∏Å‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ----
        function renderSheetTemplateTab(c) {
            const tmplList = Object.entries(stockSheetTemplates);
            // ‡∏Å‡∏£‡∏≠‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏™‡∏≤‡∏Ç‡∏≤ BT
            const btZones = warehouseList.filter(z=>z.toUpperCase().includes('BT'));
            c.innerHTML = `
            <p style="color:#64748b;font-size:13px;margin-bottom:20px;">‡∏™‡∏£‡πâ‡∏≤‡∏á Template ‡πÉ‡∏ö‡∏ô‡∏±‡∏ö‡∏™‡∏ï‡πä‡∏≠‡∏Å‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏™‡∏≤‡∏Ç‡∏≤ (BT000...) ‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÄ‡∏õ‡∏¥‡∏î‡πÅ‡∏•‡πâ‡∏ß‡∏û‡∏¥‡∏°‡∏û‡πå‡∏´‡∏£‡∏∑‡∏≠‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢</p>
            <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:16px;margin-bottom:24px;">
                ${tmplList.map(([id,t])=>`
                <div style="background:white;border-radius:14px;border:3px solid ${t.color||'#06b6d4'};padding:20px;position:relative;">
                    <div style="position:absolute;top:12px;right:12px;display:flex;gap:6px;">
                        <button onclick="printStockSheetTemplate('${id}')" style="background:#f0fdf4;border:none;padding:5px 10px;border-radius:6px;cursor:pointer;font-size:12px;color:#059669;">üñ®Ô∏è ‡∏û‡∏¥‡∏°‡∏û‡πå</button>
                        <button onclick="editSheetTemplate('${id}')" style="background:#f1f5f9;border:none;padding:5px 10px;border-radius:6px;cursor:pointer;font-size:12px;">‚úèÔ∏è</button>
                        <button onclick="deleteSheetTemplate('${id}')" style="background:#fef2f2;border:none;padding:5px 10px;border-radius:6px;cursor:pointer;font-size:12px;color:#ef4444;">üóëÔ∏è</button>
                    </div>
                    <div style="font-size:16px;font-weight:bold;color:${t.color||'#06b6d4'};">${t.name}</div>
                    <div style="font-size:12px;color:#64748b;margin:4px 0 8px;">üìç ${t.zone}</div>
                    <div style="font-size:12px;color:#94a3b8;">${(t.items||[]).length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ‚Ä¢ ${[...new Set((t.items||[]).map(i=>i.group).filter(Boolean))].length} ‡∏´‡∏°‡∏ß‡∏î</div>
                </div>`).join('')}
                <div onclick="openNewSheetTemplateForm()" style="background:white;border-radius:14px;border:3px dashed #e2e8f0;padding:20px;cursor:pointer;display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:120px;"
                    onmouseover="this.style.borderColor='#06b6d4'" onmouseout="this.style.borderColor='#e2e8f0'">
                    <div style="font-size:32px;color:#cbd5e1;">+</div>
                    <div style="color:#94a3b8;font-size:13px;">‡∏™‡∏£‡πâ‡∏≤‡∏á Template ‡∏™‡∏≤‡∏Ç‡∏≤‡πÉ‡∏´‡∏°‡πà</div>
                </div>
            </div>
            <div id="sheetTemplateFormArea"></div>`;
        }

        // ---- Form: ‡∏™‡∏£‡πâ‡∏≤‡∏á/‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç Stock Sheet Template ----
        window.openNewSheetTemplateForm = function(editId) {
            const existing = editId ? stockSheetTemplates[editId] : null;
            const tid = editId || `sst_${Date.now()}`;
            const btZones = warehouseList.filter(z=>z.toUpperCase().includes('BT'));
            const allZones = warehouseList;
            const firstZone = existing?.zone || btZones[0] || allZones[0] || '';

            document.getElementById('sheetTemplateFormArea').innerHTML = `
            <div style="background:white;border-radius:14px;border:1px solid #e2e8f0;padding:24px;margin-top:8px;">
                <h4 style="margin-top:0;">${existing?'‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç':'‚ûï ‡∏™‡∏£‡πâ‡∏≤‡∏á'} Template ‡πÉ‡∏ö‡∏ô‡∏±‡∏ö‡∏™‡∏ï‡πä‡∏≠‡∏Å‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</h4>
                <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;margin-bottom:16px;">
                    <div><label style="font-size:11px;font-weight:bold;color:#475569;display:block;margin-bottom:4px;">‡∏ä‡∏∑‡πà‡∏≠ Template <span style="color:red;">*</span></label>
                        <input id="sst_name" value="${existing?.name||''}" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡πÉ‡∏ö‡∏ô‡∏±‡∏ö‡∏™‡∏ï‡πä‡∏≠‡∏Å‡∏™‡∏≤‡∏Ç‡∏≤‡∏≠‡∏∏‡∏î‡∏°‡∏™‡∏∏‡∏Ç"
                            style="width:100%;padding:9px;border:1px solid #e2e8f0;border-radius:8px;box-sizing:border-box;font-size:13px;font-weight:bold;"></div>
                    <div><label style="font-size:11px;font-weight:bold;color:#475569;display:block;margin-bottom:4px;">‡∏™‡∏≤‡∏Ç‡∏≤/‡∏Ñ‡∏•‡∏±‡∏á <span style="color:red;">*</span></label>
                        <select id="sst_zone" onchange="renderSSTItems()" style="width:100%;padding:9px;border:1px solid #e2e8f0;border-radius:8px;font-size:13px;font-weight:bold;">
                            ${allZones.map(z=>`<option value="${z}" ${existing?.zone===z?'selected':''}>${z}</option>`).join('')}
                        </select></div>
                    <div><label style="font-size:11px;font-weight:bold;color:#475569;display:block;margin-bottom:4px;">‡∏™‡∏µ‡∏õ‡∏£‡∏∞‡∏à‡∏≥ Template</label>
                        <div style="display:flex;gap:6px;flex-wrap:wrap;margin-top:4px;">
                            ${TEMPLATE_COLORS.map(col=>`<div onclick="selectSSTColor('${col}')" id="sstcolor_${col.replace('#','')}"
                                style="width:24px;height:24px;border-radius:50%;background:${col};cursor:pointer;border:3px solid ${existing?.color===col||(!existing?.color&&col===TEMPLATE_COLORS[2])?'#1e293b':'transparent'};"></div>`).join('')}
                        </div>
                        <input type="hidden" id="sst_color" value="${existing?.color||TEMPLATE_COLORS[2]}">
                    </div>
                </div>
                <div style="margin-bottom:16px;">
                    <label style="font-size:11px;font-weight:bold;color:#475569;display:block;margin-bottom:6px;">
                        ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÅ‡∏•‡∏∞‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà <small style="color:#94a3b8;">(‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏°‡∏ß‡∏î‡πÉ‡∏ô‡∏ä‡πà‡∏≠‡∏á‡∏Ç‡∏ß‡∏≤‡∏Ç‡∏≠‡∏á‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)</small>
                    </label>
                    <input type="text" placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤..." oninput="filterSSTItems(this.value)"
                        style="width:100%;padding:8px 14px;border:1px solid #e2e8f0;border-radius:8px;font-size:13px;box-sizing:border-box;margin-bottom:10px;outline:none;">
                    <div id="sstItemsList" style="max-height:300px;overflow-y:auto;border:1px solid #f1f5f9;border-radius:10px;"></div>
                </div>
                <div style="display:flex;gap:10px;justify-content:flex-end;">
                    <button onclick="saveSheetTemplate('${tid}')" style="background:#06b6d4;color:white;border:none;padding:10px 28px;border-radius:10px;cursor:pointer;font-weight:bold;">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Template</button>
                    <button onclick="document.getElementById('sheetTemplateFormArea').innerHTML=''" style="background:#f1f5f9;color:#475569;border:none;padding:10px 18px;border-radius:10px;cursor:pointer;">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                </div>
            </div>`;
            window._editingSSTId = tid;
            window._editingSSTExisting = existing;
            renderSSTItems();
            document.getElementById('sheetTemplateFormArea').scrollIntoView({behavior:'smooth'});
        };

        window.selectSSTColor = function(col) {
            document.getElementById('sst_color').value = col;
            TEMPLATE_COLORS.forEach(c=>{
                const el = document.getElementById(`sstcolor_${c.replace('#','')}`);
                if(el) el.style.border = `3px solid ${c===col?'#1e293b':'transparent'}`;
            });
        };

        window.renderSSTItems = function() {
            const zone = document.getElementById('sst_zone')?.value||'';
            const existing = window._editingSSTExisting;
            const existingMap = {};
            (existing?.items||[]).forEach(it=>{ existingMap[it.id]={checked:true,group:it.group||''}; });
            const zoneProds = allProducts.filter(p=>(zoneProductMap[zone]||[]).includes(p.id));
            const c = document.getElementById('sstItemsList'); if(!c) return;
            c.innerHTML = zoneProds.length ? zoneProds.map(p=>{
                const u = (p.units||[{name:p.unit||''}])[0]?.name||'';
                const ex = existingMap[p.id]||{};
                return `<div class="sst-item-row" data-search="${p.id.toLowerCase()} ${p.name.toLowerCase()}"
                    style="display:flex;align-items:center;gap:8px;padding:8px 14px;border-bottom:1px solid #f8fafc;">
                    <input type="checkbox" id="sstitem_${p.id}" ${ex.checked?'checked':''}
                        style="width:15px;height:15px;accent-color:#06b6d4;cursor:pointer;flex-shrink:0;">
                    <span style="font-weight:bold;font-size:12px;min-width:85px;color:#1e293b;">${p.id}</span>
                    <span style="color:#475569;font-size:12px;flex:1;">${p.name}</span>
                    <span style="color:#94a3b8;font-size:11px;min-width:40px;">${u}</span>
                    <input type="text" id="sstgroup_${p.id}" value="${ex.group||''}" placeholder="‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà"
                        style="width:110px;padding:4px 8px;border:1px solid #e2e8f0;border-radius:6px;font-size:11px;outline:none;"
                        onfocus="document.getElementById('sstitem_${p.id}').checked=true">
                </div>`;
            }).join('') : '<p style="color:#94a3b8;padding:16px;text-align:center;">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏Ñ‡∏•‡∏±‡∏á‡∏ô‡∏µ‡πâ</p>';
        };

        window.filterSSTItems = function(q) {
            q = q.toLowerCase().trim();
            document.querySelectorAll('.sst-item-row').forEach(r=>{
                r.style.display = (!q||r.dataset.search.includes(q)) ? '' : 'none';
            });
        };

        window.saveSheetTemplate = function(tid) {
            const name  = document.getElementById('sst_name')?.value.trim();
            const zone  = document.getElementById('sst_zone')?.value;
            const color = document.getElementById('sst_color')?.value||TEMPLATE_COLORS[2];
            if(!name){toast('‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠ Template','#c2410c');return;}
            const zoneProds = allProducts.filter(p=>(zoneProductMap[zone]||[]).includes(p.id));
            const items = zoneProds.filter(p=>document.getElementById(`sstitem_${p.id}`)?.checked)
                .map(p=>({
                    id:p.id, name:p.name,
                    unit:(p.units||[{name:p.unit||''}])[0]?.name||'',
                    group:document.getElementById(`sstgroup_${p.id}`)?.value.trim()||''
                }));
            if(!items.length){toast('‚ö†Ô∏è ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£','#c2410c');return;}
            stockSheetTemplates[tid] = {name,zone,color,items};
            saveConfig();
            toast(`‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å "${name}" ‡πÅ‡∏•‡πâ‡∏ß`,'#059669');
            const c = document.getElementById('toolAppContainer');
            renderTemplateSettingsPage(c);
            setTimeout(()=>switchTmplTab('sheet'),100);
        };

        window.editSheetTemplate = function(id) {
            window._editingSSTExisting = stockSheetTemplates[id];
            openNewSheetTemplateForm(id);
        };

        window.deleteSheetTemplate = function(id) {
            if(!confirm(`‡∏•‡∏ö Template "${stockSheetTemplates[id]?.name}"?`))return;
            delete stockSheetTemplates[id];
            saveConfig();
            const c = document.getElementById('toolAppContainer');
            renderTemplateSettingsPage(c);
            setTimeout(()=>switchTmplTab('sheet'),100);
            toast('üóëÔ∏è ‡∏•‡∏ö‡πÅ‡∏•‡πâ‡∏ß','#64748b');
        };

        // ---- Print Stock Sheet Template ----
        window.printStockSheetTemplate = function(id) {
            const t = stockSheetTemplates[id]; if(!t) return;
            const now = new Date();
            const dateStr = now.toLocaleDateString('th-TH',{year:'numeric',month:'long',day:'numeric'});
            const groups = [...new Set(t.items.map(i=>i.group||'‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ'))];

            const tableRows = groups.map(grp=>{
                const grpItems = t.items.filter(i=>(i.group||'‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ')===grp);
                return `
                <tr><td colspan="5" style="background:#f1f5f9;padding:8px 12px;font-weight:bold;font-size:13px;color:#334155;border-top:2px solid #cbd5e1;">
                    ${grp}
                </td></tr>
                ${grpItems.map((it,i)=>`
                <tr style="${i%2===0?'':'background:#fafafa'}">
                    <td style="padding:9px 12px;font-weight:bold;font-size:12px;border-bottom:1px solid #e2e8f0;">${it.id}</td>
                    <td style="padding:9px 12px;font-size:12px;border-bottom:1px solid #e2e8f0;">${it.name}</td>
                    <td style="padding:9px 12px;border-bottom:1px solid #e2e8f0;"></td>
                    <td style="padding:9px 12px;text-align:center;font-size:12px;border-bottom:1px solid #e2e8f0;color:#64748b;">${it.unit}</td>
                    <td style="padding:9px 12px;border-bottom:1px solid #e2e8f0;"></td>
                </tr>`).join('')}`;
            }).join('');

            const html = `<!DOCTYPE html><html><head><meta charset="UTF-8">
            <style>
                @page{size:A4;margin:15mm}
                body{font-family:'Sarabun',sans-serif;margin:0;color:#1e293b;font-size:13px;}
                .header-box{border:2px solid #1e293b;border-radius:8px;padding:16px 20px;margin-bottom:16px;}
                .header-title{font-size:20px;font-weight:bold;text-align:center;margin-bottom:12px;}
                .header-meta{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;}
                .meta-field{border:1px solid #94a3b8;border-radius:4px;padding:6px 10px;}
                .meta-label{font-size:10px;color:#64748b;font-weight:bold;}
                .meta-val{font-size:13px;min-height:20px;margin-top:2px;}
                table{width:100%;border-collapse:collapse;margin-top:12px;}
                thead tr{background:#1e293b;color:white;}
                th{padding:9px 12px;text-align:left;font-size:12px;}
                .footer{margin-top:32px;display:grid;grid-template-columns:1fr 1fr 1fr;gap:20px;}
                .sign{border-top:1px solid #334155;padding-top:6px;text-align:center;font-size:11px;color:#64748b;padding:40px 0 6px;}
            </style>
            <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;700&display=swap" rel="stylesheet">
            </head><body>
            <div class="header-box">
                <div class="header-title">‡πÉ‡∏ö‡∏ô‡∏±‡∏ö‡∏™‡∏ï‡πä‡∏≠‡∏Å‡∏™‡∏≤‡∏Ç‡∏≤</div>
                <div class="header-meta">
                    <div class="meta-field"><div class="meta-label">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</div><div class="meta-val">&nbsp;</div></div>
                    <div class="meta-field"><div class="meta-label">‡∏™‡∏≤‡∏Ç‡∏≤</div><div class="meta-val">${t.zone}</div></div>
                    <div class="meta-field"><div class="meta-label">‡∏ú‡∏π‡πâ‡∏ï‡∏£‡∏ß‡∏à‡∏ô‡∏±‡∏ö</div><div class="meta-val">&nbsp;</div></div>
                </div>
            </div>
            <table>
                <thead><tr>
                    <th style="width:110px;">‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th>
                    <th>‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th>
                    <th style="width:120px;">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ô‡∏±‡∏ö</th>
                    <th style="width:70px;text-align:center;">‡∏´‡∏ô‡πà‡∏ß‡∏¢</th>
                    <th style="width:130px;">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</th>
                </tr></thead>
                <tbody>${tableRows}</tbody>
            </table>
            <div style="margin-top:12px;font-size:11px;color:#94a3b8;text-align:right;">${t.name} ‚Ä¢ ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏à‡∏≤‡∏Å TTGPlus ‚Ä¢ ${dateStr}</div>
            <div class="footer">
                <div class="sign">‡∏ú‡∏π‡πâ‡∏ï‡∏£‡∏ß‡∏à‡∏ô‡∏±‡∏ö</div>
                <div class="sign">‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡∏™‡∏≤‡∏Ç‡∏≤</div>
                <div class="sign">‡∏ú‡∏π‡πâ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö</div>
            </div>
            </body></html>`;

            const w = window.open('','_blank','width=900,height=700');
            w.document.write(html); w.document.close();
            setTimeout(()=>w.print(),800);
        };

        // ======== APPLY STOCK SHEET TEMPLATE TO INV CHECK ========
        window.applyInvTemplate = function(id) {
            const t = stockSheetTemplates[id]; if(!t) return;
            // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô zone dropdown
            const zoneEl = document.getElementById('invZone');
            if(zoneEl) {
                zoneEl.value = t.zone;
                renderInventoryRows();
            }
            toast(`‚úÖ ‡πÉ‡∏ä‡πâ Template "${t.name}" ‡πÅ‡∏•‡πâ‡∏ß`,'#059669');
        };

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // GR ‚Äî GOODS RECEIPT MODULE
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        function genGRNumber() {
            const now = new Date();
            const d = now.toISOString().slice(0,10).replace(/-/g,'');
            return `GR-${d}-${String(Math.floor(Math.random()*900)+100)}`;
        }

        function genLotNumber(productId, date) {
            const d = date.replace(/-/g,'');
            const suffix = String(Math.floor(Math.random()*90)+10);
            return `LOT-${productId}-${d}-${suffix}`;
        }

        window.openCreateGR = async function() {
            document.getElementById('dashboardView').classList.add('hidden');
            const c = document.getElementById('toolAppContainer'); c.classList.remove('hidden');
            const today = new Date().toISOString().slice(0,10);
            const usersSnap = await getDocs(collection(db,'users'));
            let staffOpts = '';
            usersSnap.forEach(d=>{ const u=d.data(); if(u.status!=='suspended') staffOpts+=`<option value="${u.name}">${u.name}</option>`; });

            c.innerHTML = `
            <div class="tool-header no-print">
                <div>
                    <h2>üöö ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (GR)</h2>
                    <p style="margin:4px 0 0;font-size:12px;color:#64748b;">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ñ‡∏•‡∏±‡∏á ‡∏û‡∏£‡πâ‡∏≠‡∏° Lot ‡πÅ‡∏•‡∏∞‡∏ß‡∏±‡∏ô‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏</p>
                </div>
                <div style="display:flex;gap:8px;">
                    <button onclick="openGRHistory()" style="background:#f1f5f9;color:#475569;border:none;padding:8px 16px;border-radius:8px;cursor:pointer;">üìÑ ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ GR</button>
                    <button onclick="closeTool()" style="background:#f1f5f9;color:#475569;border:none;padding:8px 16px;border-radius:8px;cursor:pointer;">‚úï ‡∏õ‡∏¥‡∏î</button>
                </div>
            </div>

            <!-- Header Info -->
            <div style="background:white;border-radius:14px;border:1px solid #e2e8f0;padding:20px;margin-bottom:20px;box-shadow:0 1px 4px rgba(0,0,0,0.05);">
                <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:14px;">
                    <div class="input-group" style="border:2px solid #06b6d4;">
                        <label>üìã GR Number</label>
                        <b id="grNumber" style="font-size:13px;color:#06b6d4;">${genGRNumber()}</b>
                    </div>
                    <div class="input-group" style="border:2px solid var(--danger);">
                        <label>üìÖ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</label>
                        <input type="date" id="gr_date" value="${today}" style="width:100%;border:none;font-weight:bold;outline:none;font-size:13px;">
                    </div>
                    <div class="input-group">
                        <label>üè¢ Supplier / ‡∏ú‡∏π‡πâ‡∏™‡πà‡∏á</label>
                        <input type="text" id="gr_supplier" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó/‡∏ú‡∏π‡πâ‡∏™‡πà‡∏á" style="width:100%;border:none;outline:none;font-size:13px;font-weight:bold;">
                    </div>
                    <div class="input-group">
                        <label>üë§ ‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</label>
                        <select id="gr_receiver" style="width:100%;border:none;font-weight:bold;outline:none;font-size:13px;">
                            <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å --</option>${staffOpts}
                        </select>
                    </div>
                </div>
                <div style="margin-top:12px;">
                    <div class="input-group">
                        <label>üìù ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ</label>
                        <input type="text" id="gr_note" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏£‡∏ñ‡∏™‡πà‡∏á‡∏ä‡πâ‡∏≤, ‡∏Ç‡∏≠‡∏á‡∏°‡∏≤‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö‡∏ö‡∏≤‡∏á‡∏™‡πà‡∏ß‡∏ô" style="width:100%;border:none;outline:none;font-size:13px;">
                    </div>
                </div>
            </div>

            <!-- Zone + Product Search -->
            <div style="background:white;border-radius:14px;border:1px solid #e2e8f0;padding:20px;margin-bottom:20px;">
                <div style="display:flex;gap:12px;margin-bottom:14px;flex-wrap:wrap;">
                    <div class="input-group" style="flex:1;min-width:180px;">
                        <label>üì¶ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏•‡∏±‡∏á</label>
                        <select id="gr_zone" onchange="renderGRProductSearch()" style="width:100%;border:none;font-weight:bold;outline:none;">
                            ${getVisibleWarehouses().map(z=>`<option value="${z}">${z}</option>`).join('')}
                        </select>
                    </div>
                    <div style="flex:2;min-width:240px;">
                        <div style="font-size:10px;color:#94a3b8;font-weight:700;letter-spacing:0.5px;text-transform:uppercase;margin-bottom:4px;">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏°</div>
                        <input type="text" id="gr_search" placeholder="üîç ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏£‡∏´‡∏±‡∏™‡∏´‡∏£‡∏∑‡∏≠‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤..." oninput="renderGRProductSearch()"
                            style="width:100%;padding:10px 14px;border:1.5px solid #e2e8f0;border-radius:10px;font-size:13px;box-sizing:border-box;outline:none;"
                            onfocus="this.style.borderColor='#06b6d4'" onblur="this.style.borderColor='#e2e8f0'">
                        <div id="grSearchResults" style="max-height:200px;overflow-y:auto;border:1px solid #e2e8f0;border-radius:10px;margin-top:6px;display:none;background:white;box-shadow:0 4px 16px rgba(0,0,0,0.1);z-index:10;position:relative;"></div>
                    </div>
                </div>
            </div>

            <!-- GR Items Table -->
            <div style="background:white;border-radius:14px;border:1px solid #e2e8f0;overflow:hidden;margin-bottom:24px;">
                <div style="padding:14px 20px;background:#f8fafc;border-bottom:1px solid #e2e8f0;display:flex;justify-content:space-between;align-items:center;">
                    <span style="font-weight:700;font-size:14px;">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤</span>
                    <span id="grItemCount" style="font-size:12px;color:#64748b;">0 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</span>
                </div>
                <div id="grItemsContainer">
                    <div style="padding:40px;text-align:center;color:#94a3b8;">
                        <div style="font-size:36px;margin-bottom:8px;">üì¶</div>
                        <div>‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div>
                    </div>
                </div>
            </div>

            <div style="text-align:center;" class="no-print">
                <button onclick="saveGR()" style="background:linear-gradient(135deg,#06b6d4,#0891b2);color:white;padding:16px 60px;border:none;border-radius:14px;font-size:17px;font-weight:700;cursor:pointer;box-shadow:0 4px 20px rgba(6,182,212,0.35);">
                    üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏ö‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (GR)
                </button>
            </div>`;

            window._grItems = [];
            renderGRProductSearch();
        };

        window.renderGRProductSearch = function() {
            const zone = document.getElementById('gr_zone')?.value||'';
            const q = (document.getElementById('gr_search')?.value||'').toLowerCase().trim();
            const resultsEl = document.getElementById('grSearchResults');
            if(!resultsEl) return;
            if(!q) { resultsEl.style.display='none'; return; }
            const zoneProds = allProducts.filter(p=>(zoneProductMap[zone]||[]).includes(p.id));
            const filtered = zoneProds.filter(p=>p.id.toLowerCase().includes(q)||p.name.toLowerCase().includes(q)).slice(0,8);
            if(!filtered.length) { resultsEl.style.display='none'; return; }
            resultsEl.style.display='block';
            resultsEl.innerHTML = filtered.map(p=>{
                const u=(p.units||[{name:p.unit||''}])[0]?.name||'';
                const already = window._grItems?.find(i=>i.id===p.id);
                return `<div onclick="addGRItem('${p.id}')" style="padding:10px 14px;cursor:pointer;border-bottom:1px solid #f8fafc;display:flex;align-items:center;gap:10px;${already?'background:#f0fdf4;':''}"
                    onmouseover="this.style.background='#f0f9ff'" onmouseout="this.style.background='${already?'#f0fdf4':'white'}'">
                    <div>
                        <div style="font-weight:700;font-size:12px;color:#0f172a;">${p.id} ${already?'‚úÖ':''}</div>
                        <div style="font-size:12px;color:#64748b;">${p.name} <span style="color:#94a3b8;">(${u})</span></div>
                    </div>
                </div>`;
            }).join('');
        };

        window.addGRItem = function(productId) {
            if(!window._grItems) window._grItems=[];
            if(window._grItems.find(i=>i.id===productId)) { toast('‚ö†Ô∏è ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ô‡∏µ‡πâ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡πâ‡∏ß','#c2410c'); return; }
            const p = allProducts.find(x=>x.id===productId); if(!p) return;
            const u = (p.units||[{name:p.unit||''}])[0]?.name||'';
            const grDate = document.getElementById('gr_date')?.value||new Date().toISOString().slice(0,10);
            window._grItems.push({id:p.id, name:p.name, unit:u, lotNumber:genLotNumber(p.id,grDate)});
            document.getElementById('gr_search').value='';
            document.getElementById('grSearchResults').style.display='none';
            renderGRItemsTable();
        };

        window.removeGRItem = function(id) {
            window._grItems = window._grItems.filter(i=>i.id!==id);
            renderGRItemsTable();
        };

        function renderGRItemsTable() {
            const c = document.getElementById('grItemsContainer'); if(!c) return;
            const items = window._grItems||[];
            document.getElementById('grItemCount').innerText = `${items.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`;
            if(!items.length) {
                c.innerHTML=`<div style="padding:40px;text-align:center;color:#94a3b8;"><div style="font-size:36px;margin-bottom:8px;">üì¶</div><div>‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div></div>`;
                return;
            }
            c.innerHTML=`<table style="width:100%;border-collapse:collapse;">
                <thead><tr style="background:#f8fafc;">
                    <th style="padding:10px 14px;text-align:left;font-size:11px;color:#64748b;font-weight:700;">‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th>
                    <th style="padding:10px 14px;text-align:center;font-size:11px;color:#059669;font-weight:700;">‡∏£‡∏±‡∏ö‡∏à‡∏£‡∏¥‡∏á (‡∏à‡∏≥‡∏ô‡∏ß‡∏ô)</th>
                    <th style="padding:10px 14px;text-align:center;font-size:11px;color:#64748b;font-weight:700;">Lot Number</th>
                    <th style="padding:10px 14px;text-align:center;font-size:11px;color:#dc2626;font-weight:700;">‡∏ß‡∏±‡∏ô‡∏ú‡∏•‡∏¥‡∏ï (MFD)</th>
                    <th style="padding:10px 14px;text-align:center;font-size:11px;color:#b45309;font-weight:700;">‡∏ß‡∏±‡∏ô‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏ (EXP)</th>
                    <th style="padding:10px 14px;text-align:center;font-size:11px;color:#64748b;font-weight:700;">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                    <th style="padding:10px 14px;text-align:left;font-size:11px;color:#64748b;font-weight:700;">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</th>
                    <th style="padding:10px;"></th>
                </tr></thead>
                <tbody>${items.map((it,i)=>`
                <tr style="border-top:1px solid #f1f5f9;${i%2===0?'':'background:#fafafa'}">
                    <td style="padding:12px 14px;">
                        <div style="font-weight:700;font-size:13px;">${it.id}</div>
                        <div style="font-size:12px;color:#64748b;">${it.name}</div>
                        <div style="font-size:10px;color:#94a3b8;">${it.unit}</div>
                    </td>
                    <td style="padding:12px 14px;text-align:center;">
                        <input type="number" id="gr_qty_${it.id}" min="0" placeholder="0"
                            style="width:80px;padding:8px;border:2px solid #10b981;border-radius:8px;text-align:center;font-weight:700;font-size:15px;outline:none;"
                            onfocus="this.style.borderColor='#059669'" onblur="this.style.borderColor='#10b981'">
                        <div style="font-size:10px;color:#64748b;margin-top:2px;">${it.unit}</div>
                    </td>
                    <td style="padding:12px 14px;text-align:center;">
                        <input type="text" id="gr_lot_${it.id}" value="${it.lotNumber}"
                            style="width:160px;padding:6px 8px;border:1px solid #e2e8f0;border-radius:7px;font-size:11px;font-family:monospace;text-align:center;outline:none;"
                            onfocus="this.style.borderColor='#06b6d4'" onblur="this.style.borderColor='#e2e8f0'">
                    </td>
                    <td style="padding:12px 14px;text-align:center;">
                        <input type="date" id="gr_mfd_${it.id}"
                            style="padding:6px 8px;border:1px solid #e2e8f0;border-radius:7px;font-size:12px;outline:none;"
                            onfocus="this.style.borderColor='#dc2626'" onblur="this.style.borderColor='#e2e8f0'">
                    </td>
                    <td style="padding:12px 14px;text-align:center;">
                        <input type="date" id="gr_exp_${it.id}" onchange="checkExpWarning('${it.id}')"
                            style="padding:6px 8px;border:2px solid #f59e0b;border-radius:7px;font-size:12px;outline:none;font-weight:bold;"
                            onfocus="this.style.borderColor='#d97706'" onblur="this.style.borderColor='#f59e0b'">
                        <div id="exp_warn_${it.id}" style="font-size:9px;margin-top:2px;"></div>
                    </td>
                    <td style="padding:12px 14px;text-align:center;">
                        <select id="gr_status_${it.id}" style="padding:6px 10px;border:1px solid #e2e8f0;border-radius:7px;font-size:12px;outline:none;">
                            <option value="complete">‚úÖ ‡∏Ñ‡∏£‡∏ö</option>
                            <option value="partial">‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö</option>
                            <option value="extra">‚ûï ‡∏Ç‡∏≠‡∏á‡πÅ‡∏ó‡∏£‡∏Å</option>
                            <option value="damaged">‚ùå ‡πÄ‡∏™‡∏µ‡∏¢‡∏´‡∏≤‡∏¢</option>
                        </select>
                    </td>
                    <td style="padding:12px 14px;">
                        <input type="text" id="gr_itemnote_${it.id}" placeholder="‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏"
                            style="width:100%;padding:6px 8px;border:1px solid #e2e8f0;border-radius:7px;font-size:11px;box-sizing:border-box;outline:none;">
                    </td>
                    <td style="padding:12px;text-align:center;">
                        <button onclick="removeGRItem('${it.id}')" style="background:#fef2f2;color:#ef4444;border:none;width:28px;height:28px;border-radius:6px;cursor:pointer;font-size:14px;">‚úï</button>
                    </td>
                </tr>`).join('')}</tbody>
            </table>`;
        }

        window.checkExpWarning = function(id) {
            const val = document.getElementById(`gr_exp_${id}`)?.value;
            const warnEl = document.getElementById(`exp_warn_${id}`);
            if(!val||!warnEl) return;
            const diff = Math.floor((new Date(val)-new Date())/(1000*60*60*24));
            if(diff<0) warnEl.innerHTML='<span style="color:#ef4444;font-weight:bold;">‚ö†Ô∏è ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏‡πÅ‡∏•‡πâ‡∏ß!</span>';
            else if(diff<=30) warnEl.innerHTML=`<span style="color:#f59e0b;font-weight:bold;">‚ö†Ô∏è ‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ${diff} ‡∏ß‡∏±‡∏ô</span>`;
            else warnEl.innerHTML=`<span style="color:#10b981;">‚úì ‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ${diff} ‡∏ß‡∏±‡∏ô</span>`;
        };

        window.saveGR = async function() {
            const grNumber = document.getElementById('grNumber')?.innerText||genGRNumber();
            const grDate   = document.getElementById('gr_date')?.value;
            const supplier = document.getElementById('gr_supplier')?.value.trim()||'';
            const receiver = document.getElementById('gr_receiver')?.value;
            const note     = document.getElementById('gr_note')?.value.trim()||'';
            const zone     = document.getElementById('gr_zone')?.value;
            const items    = window._grItems||[];

            if(!grDate) { toast('‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà','#c2410c'); return; }
            if(!receiver) { toast('‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤','#c2410c'); return; }
            if(!items.length) { toast('‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£','#c2410c'); return; }

            const [y,m,d] = grDate.split('-');
            const dateTH = `${d}/${m}/${parseInt(y)+543}`;

            const grItems = items.map(it=>({
                id:it.id, name:it.name, unit:it.unit,
                lotNumber: document.getElementById(`gr_lot_${it.id}`)?.value||it.lotNumber,
                qtyReceived: parseFloat(document.getElementById(`gr_qty_${it.id}`)?.value)||0,
                mfd: document.getElementById(`gr_mfd_${it.id}`)?.value||'',
                exp: document.getElementById(`gr_exp_${it.id}`)?.value||'',
                status: document.getElementById(`gr_status_${it.id}`)?.value||'complete',
                note: document.getElementById(`gr_itemnote_${it.id}`)?.value||''
            }));

            const missingQty = grItems.filter(i=>i.qtyReceived<=0 && i.status!=='damaged');
            if(missingQty.length) { toast(`‚ö†Ô∏è ‡∏Å‡∏£‡∏≠‡∏Å‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö (${missingQty.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)`,'#c2410c'); return; }
            const missingExp = grItems.filter(i=>!i.exp && i.status!=='damaged');
            if(missingExp.length && !confirm(`‚ö†Ô∏è ‡∏°‡∏µ ${missingExp.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏Å‡∏£‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏\n‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ï‡πà‡∏≠‡πÑ‡∏´‡∏°?`)) return;

            if(!confirm(`‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å GR ${grNumber}\n${items.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ | ${dateTH} | ${zone}`)) return;

            const payload = {
                grNumber, date:dateTH, grDate, zone, supplier, receiver,
                note, timestamp:Date.now(), createdBy:currentUser.name,
                items:grItems, status:'completed'
            };

            await addDoc(collection(db,'goodsReceipts'), payload);

            // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï Lot Register ‡πÉ‡∏ô Firestore
            const lotRef = doc(db,'config','lotRegister');
            const lotSnap = await getDoc(lotRef);
            const lotData = lotSnap.exists() ? (lotSnap.data().lots||{}) : {};
            grItems.forEach(it=>{
                if(!lotData[it.id]) lotData[it.id]=[];
                lotData[it.id].push({
                    lotNumber:it.lotNumber, qtyReceived:it.qtyReceived,
                    qtyRemaining:it.qtyReceived, mfd:it.mfd, exp:it.exp,
                    grNumber, grDate, zone, status:'active'
                });
                // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏° exp (FIFO = EXP ‡πÄ‡∏Å‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏Å‡πà‡∏≠‡∏ô)
                lotData[it.id].sort((a,b)=>{
                    if(!a.exp) return 1; if(!b.exp) return -1;
                    return new Date(a.exp)-new Date(b.exp);
                });
            });
            await setDoc(lotRef, {lots:lotData}, {merge:true});

            toast(`‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å ${grNumber} ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‚Äî ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï Lot Register ‡πÅ‡∏•‡πâ‡∏ß`,'#059669');
            setTimeout(()=>openGRHistory(), 800);
        };

        // ‚ïê‚ïê‚ïê‚ïê GR HISTORY ‚ïê‚ïê‚ïê‚ïê
        window.openGRHistory = async function() {
            document.getElementById('dashboardView').classList.add('hidden');
            const c = document.getElementById('toolAppContainer'); c.classList.remove('hidden');
            c.innerHTML=`
            <div class="tool-header">
                <h2>üìÑ ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h2>
                <div style="display:flex;gap:8px;">
                    <button onclick="openCreateGR()" style="background:#06b6d4;color:white;border:none;padding:8px 16px;border-radius:8px;cursor:pointer;font-weight:bold;">+ ‡∏™‡∏£‡πâ‡∏≤‡∏á GR ‡πÉ‡∏´‡∏°‡πà</button>
                    <button onclick="closeTool()" style="background:#f1f5f9;color:#475569;border:none;padding:8px 16px;border-radius:8px;cursor:pointer;">‚úï ‡∏õ‡∏¥‡∏î</button>
                </div>
            </div>
            <p style="text-align:center;color:#94a3b8;padding:30px;">‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</p>`;

            const snap = await getDocs(collection(db,'goodsReceipts'));
            let docs = [];
            snap.forEach(d=>docs.push({id:d.id,...d.data()}));
            docs.sort((a,b)=>b.timestamp-a.timestamp);

            const listHtml = docs.length ? docs.map(gr=>{
                const statusColors={complete:'#10b981',partial:'#f59e0b',extra:'#3b82f6',damaged:'#ef4444'};
                const statusLabels={complete:'‡∏Ñ‡∏£‡∏ö',partial:'‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö',extra:'‡∏Ç‡∏≠‡∏á‡πÅ‡∏ó‡∏£‡∏Å',damaged:'‡πÄ‡∏™‡∏µ‡∏¢‡∏´‡∏≤‡∏¢'};
                const hasIssue = gr.items?.some(i=>i.status!=='complete');
                return `<div class="history-card" style="${hasIssue?'border-left:4px solid #f59e0b;':''}">
                    <div class="history-card-header" style="cursor:pointer;" onclick="toggleDetail('grdet_${gr.id}')">
                        <div>
                            <div style="display:flex;align-items:center;gap:10px;">
                                <span style="font-weight:700;font-size:14px;color:#06b6d4;">${gr.grNumber}</span>
                                ${hasIssue?'<span style="background:#fff7ed;color:#c2410c;font-size:10px;padding:2px 8px;border-radius:10px;font-weight:bold;">‚ö†Ô∏è ‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥</span>':'<span style="background:#f0fdf4;color:#059669;font-size:10px;padding:2px 8px;border-radius:10px;font-weight:bold;">‚úÖ ‡∏õ‡∏Å‡∏ï‡∏¥</span>'}
                            </div>
                            <div style="font-size:12px;color:#64748b;margin-top:3px;">
                                üìÖ ${gr.date} ‚Ä¢ üì¶ ${gr.zone} ‚Ä¢ üè¢ ${gr.supplier||'‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'} ‚Ä¢ üë§ ${gr.receiver}
                            </div>
                        </div>
                        <div style="font-size:12px;color:#94a3b8;">${gr.items?.length||0} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ‚ñº</div>
                    </div>
                    <div id="grdet_${gr.id}" style="display:none;padding:16px 20px;">
                        <table style="width:100%;border-collapse:collapse;font-size:12px;">
                            <thead><tr style="background:#f8fafc;">
                                <th style="padding:8px;text-align:left;">‡∏£‡∏´‡∏±‡∏™/‡∏ä‡∏∑‡πà‡∏≠</th>
                                <th style="padding:8px;text-align:center;">Lot</th>
                                <th style="padding:8px;text-align:center;">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏±‡∏ö</th>
                                <th style="padding:8px;text-align:center;">MFD</th>
                                <th style="padding:8px;text-align:center;">EXP</th>
                                <th style="padding:8px;text-align:center;">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                            </tr></thead>
                            <tbody>${(gr.items||[]).map(it=>`
                            <tr style="border-top:1px solid #f1f5f9;">
                                <td style="padding:8px;"><b>${it.id}</b><br><span style="color:#64748b;">${it.name}</span></td>
                                <td style="padding:8px;text-align:center;font-family:monospace;font-size:11px;color:#06b6d4;">${it.lotNumber}</td>
                                <td style="padding:8px;text-align:center;font-weight:bold;">${it.qtyReceived} ${it.unit}</td>
                                <td style="padding:8px;text-align:center;">${it.mfd||'-'}</td>
                                <td style="padding:8px;text-align:center;${it.exp&&new Date(it.exp)<new Date()?'color:#ef4444;font-weight:bold;':''}">${it.exp||'-'}</td>
                                <td style="padding:8px;text-align:center;"><span style="background:${(statusColors[it.status]||'#64748b')}20;color:${statusColors[it.status]||'#64748b'};padding:2px 8px;border-radius:8px;font-size:11px;font-weight:bold;">${statusLabels[it.status]||it.status}</span></td>
                            </tr>`).join('')}</tbody>
                        </table>
                        ${gr.note?`<div style="margin-top:8px;font-size:12px;color:#64748b;">üìù ${gr.note}</div>`:''}
                    </div>
                </div>`;
            }).join('') : '<p style="text-align:center;color:#94a3b8;padding:40px;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</p>';

            c.innerHTML=`
            <div class="tool-header">
                <h2>üìÑ ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h2>
                <div style="display:flex;gap:8px;">
                    <button onclick="openCreateGR()" style="background:#06b6d4;color:white;border:none;padding:8px 16px;border-radius:8px;cursor:pointer;font-weight:bold;">+ ‡∏™‡∏£‡πâ‡∏≤‡∏á GR ‡πÉ‡∏´‡∏°‡πà</button>
                    <button onclick="closeTool()" style="background:#f1f5f9;color:#475569;border:none;padding:8px 16px;border-radius:8px;cursor:pointer;">‚úï ‡∏õ‡∏¥‡∏î</button>
                </div>
            </div>
            ${listHtml}`;
        };

        window.toggleDetail = function(id) {
            const el=document.getElementById(id); if(!el) return;
            el.style.display=el.style.display==='none'?'block':'none';
        };

        // ‚ïê‚ïê‚ïê‚ïê LOT REGISTER ‚ïê‚ïê‚ïê‚ïê
        window.openLotRegister = async function() {
            document.getElementById('dashboardView').classList.add('hidden');
            const c = document.getElementById('toolAppContainer'); c.classList.remove('hidden');
            c.innerHTML=`<div class="tool-header"><h2>üè∑Ô∏è ‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô Lot ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h2><button onclick="closeTool()" style="background:#f1f5f9;color:#475569;border:none;padding:8px 16px;border-radius:8px;cursor:pointer;">‚úï ‡∏õ‡∏¥‡∏î</button></div>
            <p style="text-align:center;color:#94a3b8;padding:30px;">‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</p>`;

            const lotSnap = await getDoc(doc(db,'config','lotRegister'));
            const lots = lotSnap.exists() ? (lotSnap.data().lots||{}) : {};
            const today = new Date();

            const rows = Object.entries(lots).map(([productId, lotList])=>{
                const p = allProducts.find(x=>x.id===productId);
                const activeLots = lotList.filter(l=>l.qtyRemaining>0);
                if(!activeLots.length) return '';
                const oldest = activeLots[0]; // FIFO = index 0
                const expDate = oldest.exp ? new Date(oldest.exp) : null;
                const daysLeft = expDate ? Math.floor((expDate-today)/(1000*60*60*24)) : null;
                const expColor = daysLeft===null?'#64748b':daysLeft<0?'#ef4444':daysLeft<=30?'#f59e0b':'#10b981';
                return `<tr style="border-top:1px solid #f1f5f9;">
                    <td style="padding:12px 16px;"><b style="font-size:13px;">${productId}</b><br><span style="font-size:12px;color:#64748b;">${p?.name||'-'}</span></td>
                    <td style="padding:12px 16px;text-align:center;">
                        <span style="font-family:monospace;font-size:12px;color:#06b6d4;background:#f0f9ff;padding:3px 8px;border-radius:6px;">${oldest.lotNumber}</span>
                        <div style="font-size:10px;color:#94a3b8;margin-top:2px;">FIFO ‡∏ï‡πâ‡∏≠‡∏á‡∏´‡∏¢‡∏¥‡∏ö‡∏Å‡πà‡∏≠‡∏ô</div>
                    </td>
                    <td style="padding:12px 16px;text-align:center;font-weight:700;font-size:16px;">${oldest.qtyRemaining}<span style="font-size:10px;color:#64748b;font-weight:400;"> ${oldest.unit||''}</span></td>
                    <td style="padding:12px 16px;text-align:center;">
                        <span style="font-weight:bold;color:${expColor};">${oldest.exp||'-'}</span>
                        ${daysLeft!==null?`<div style="font-size:10px;color:${expColor};">${daysLeft<0?'‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏‡πÅ‡∏•‡πâ‡∏ß!':daysLeft===0?'‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ!':daysLeft+'‡∏ß‡∏±‡∏ô'}</div>`:''}
                    </td>
                    <td style="padding:12px 16px;text-align:center;">
                        <span style="background:#f1f5f9;border-radius:10px;padding:3px 10px;font-size:12px;font-weight:bold;">${activeLots.length} Lot</span>
                    </td>
                    <td style="padding:12px 16px;text-align:center;">
                        <button onclick="showAllLots('${productId}')" style="background:#eff6ff;color:#3b82f6;border:none;padding:5px 12px;border-radius:7px;cursor:pointer;font-size:11px;font-weight:bold;">‡∏î‡∏π‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
                    </td>
                </tr>
                <tr id="allLots_${productId}" style="display:none;background:#f8fafc;">
                    <td colspan="6" style="padding:12px 20px;">
                        <div style="font-size:11px;font-weight:bold;color:#64748b;margin-bottom:6px;">Lot ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏Ç‡∏≠‡∏á ${productId}:</div>
                        ${activeLots.map((l,i)=>`<span style="display:inline-block;margin:3px;background:${i===0?'#dbeafe':'white'};border:1px solid ${i===0?'#93c5fd':'#e2e8f0'};border-radius:8px;padding:4px 10px;font-size:11px;font-family:monospace;">
                            ${i===0?'‚≠ê ':''}<b>${l.lotNumber}</b> ‚Ä¢ ‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ${l.qtyRemaining} ‚Ä¢ EXP: ${l.exp||'-'}
                        </span>`).join('')}
                    </td>
                </tr>`;
            }).join('');

            // ‡∏´‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏Å‡∏•‡πâ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏
            const expWarnings = [];
            Object.entries(lots).forEach(([pid,lotList])=>{
                lotList.filter(l=>l.qtyRemaining>0&&l.exp).forEach(l=>{
                    const d=Math.floor((new Date(l.exp)-today)/(1000*60*60*24));
                    if(d<=30) expWarnings.push({pid,lotNumber:l.lotNumber,exp:l.exp,daysLeft:d,qty:l.qtyRemaining,unit:l.unit});
                });
            });
            expWarnings.sort((a,b)=>a.daysLeft-b.daysLeft);

            c.innerHTML=`
            <div class="tool-header">
                <h2>üè∑Ô∏è ‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô Lot ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h2>
                <div style="display:flex;gap:8px;">
                    <button onclick="openCreateGR()" style="background:#06b6d4;color:white;border:none;padding:8px 16px;border-radius:8px;cursor:pointer;font-weight:bold;">+ ‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà</button>
                    <button onclick="closeTool()" style="background:#f1f5f9;color:#475569;border:none;padding:8px 16px;border-radius:8px;cursor:pointer;">‚úï ‡∏õ‡∏¥‡∏î</button>
                </div>
            </div>
            ${expWarnings.length?`
            <div style="background:linear-gradient(135deg,#fff7ed,#fef3c7);border:1.5px solid #fbbf24;border-radius:14px;padding:16px 20px;margin-bottom:20px;">
                <div style="font-weight:700;font-size:14px;color:#b45309;margin-bottom:8px;">‚ö†Ô∏è ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏Å‡∏•‡πâ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏ (‡∏†‡∏≤‡∏¢‡πÉ‡∏ô 30 ‡∏ß‡∏±‡∏ô) ‚Äî ${expWarnings.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div>
                <div style="display:flex;gap:8px;flex-wrap:wrap;">
                    ${expWarnings.map(w=>`<span style="background:white;border:1px solid #fbbf24;border-radius:8px;padding:5px 12px;font-size:11px;color:${w.daysLeft<0?'#ef4444':w.daysLeft<=7?'#dc2626':'#b45309'};font-weight:bold;">
                        ${w.pid} ‚Ä¢ ${w.lotNumber} ‚Ä¢ EXP: ${w.exp} (${w.daysLeft<0?'‡∏´‡∏°‡∏î‡πÅ‡∏•‡πâ‡∏ß!':w.daysLeft+'‡∏ß‡∏±‡∏ô'})
                    </span>`).join('')}
                </div>
            </div>`:''}
            <div style="background:white;border-radius:14px;border:1px solid #e2e8f0;overflow:hidden;">
                <table style="width:100%;border-collapse:collapse;">
                    <thead><tr style="background:#0f172a;color:white;">
                        <th style="padding:12px 16px;text-align:left;font-size:11px;font-weight:700;">‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th>
                        <th style="padding:12px 16px;text-align:center;font-size:11px;font-weight:700;">Lot ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏´‡∏¢‡∏¥‡∏ö‡∏Å‡πà‡∏≠‡∏ô (FIFO)</th>
                        <th style="padding:12px 16px;text-align:center;font-size:11px;font-weight:700;">‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠ Lot ‡∏ô‡∏µ‡πâ</th>
                        <th style="padding:12px 16px;text-align:center;font-size:11px;font-weight:700;">‡∏ß‡∏±‡∏ô‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏</th>
                        <th style="padding:12px 16px;text-align:center;font-size:11px;font-weight:700;">Lot ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</th>
                        <th style="padding:12px 16px;text-align:center;font-size:11px;font-weight:700;"></th>
                    </tr></thead>
                    <tbody>${rows||'<tr><td colspan="6" style="padding:40px;text-align:center;color:#94a3b8;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Lot ‚Äî ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á Lot Register</td></tr>'}</tbody>
                </table>
            </div>`;
        };

        window.showAllLots = function(pid) {
            const el = document.getElementById(`allLots_${pid}`); if(!el) return;
            el.style.display = el.style.display==='none' ? 'table-row' : 'none';
        };

        // ‚ïê‚ïê‚ïê‚ïê QC FIFO SPOT CHECK ‚ïê‚ïê‚ïê‚ïê
        window.openQCCheck = async function() {
            document.getElementById('dashboardView').classList.add('hidden');
            const c = document.getElementById('toolAppContainer'); c.classList.remove('hidden');

            const lotSnap = await getDoc(doc(db,'config','lotRegister'));
            const lots = lotSnap.exists() ? (lotSnap.data().lots||{}) : {};
            const today = new Date().toISOString().slice(0,10);
            const checkNo = `QC-${today.replace(/-/g,'')}-${String(Math.floor(Math.random()*900)+100)}`;

            const productsWithLots = Object.keys(lots).filter(id=>lots[id].some(l=>l.qtyRemaining>0));

            c.innerHTML=`
            <div class="tool-header no-print">
                <div>
                    <h2>üîç FIFO Spot Check</h2>
                    <p style="margin:4px 0 0;font-size:12px;color:#64748b;">‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏´‡∏¢‡∏¥‡∏ö‡∏Ç‡∏≠‡∏á‡∏ï‡∏≤‡∏° FIFO ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà</p>
                </div>
                <div style="display:flex;gap:8px;">
                    <button onclick="openQCHistory()" style="background:#f1f5f9;color:#475569;border:none;padding:8px 16px;border-radius:8px;cursor:pointer;">üìä ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ QC</button>
                    <button onclick="closeTool()" style="background:#f1f5f9;color:#475569;border:none;padding:8px 16px;border-radius:8px;cursor:pointer;">‚úï ‡∏õ‡∏¥‡∏î</button>
                </div>
            </div>

            <div style="background:linear-gradient(135deg,#faf5ff,#f3e8ff);border:1.5px solid #c4b5fd;border-radius:14px;padding:16px 20px;margin-bottom:20px;">
                <div style="display:flex;gap:16px;flex-wrap:wrap;">
                    <div><span style="font-size:10px;color:#7c3aed;font-weight:700;display:block;">QC Check No.</span><b style="color:#7c3aed;">${checkNo}</b></div>
                    <div><span style="font-size:10px;color:#7c3aed;font-weight:700;display:block;">‡∏ú‡∏π‡πâ‡∏ï‡∏£‡∏ß‡∏à</span><b>${currentUser.name}</b></div>
                    <div><span style="font-size:10px;color:#7c3aed;font-weight:700;display:block;">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</span><b>${today}</b></div>
                </div>
            </div>

            <div style="background:white;border-radius:14px;border:1px solid #e2e8f0;padding:20px;margin-bottom:20px;">
                <div style="font-weight:700;margin-bottom:12px;">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏™‡∏∏‡πà‡∏°‡∏ï‡∏£‡∏ß‡∏à</div>
                <input type="text" placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤..." oninput="filterQCProducts(this.value)"
                    style="width:100%;padding:10px 14px;border:1.5px solid #e2e8f0;border-radius:10px;font-size:13px;box-sizing:border-box;outline:none;margin-bottom:12px;">
                <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:8px;" id="qcProductGrid">
                    ${productsWithLots.map(pid=>{
                        const p=allProducts.find(x=>x.id===pid);
                        const activeLots=lots[pid].filter(l=>l.qtyRemaining>0);
                        const oldest=activeLots[0];
                        return `<div class="qc-prod-card" data-search="${pid.toLowerCase()} ${(p?.name||'').toLowerCase()}"
                            onclick="selectQCProduct('${pid}')" id="qccard_${pid}"
                            style="padding:12px;border:2px solid #e2e8f0;border-radius:12px;cursor:pointer;transition:all 0.15s;"
                            onmouseover="this.style.borderColor='#a855f7'" onmouseout="if(!this.classList.contains('selected'))this.style.borderColor='#e2e8f0'">
                            <div style="font-weight:700;font-size:12px;">${pid}</div>
                            <div style="font-size:11px;color:#64748b;margin:2px 0;">${p?.name||''}</div>
                            <div style="font-size:10px;font-family:monospace;color:#06b6d4;background:#f0f9ff;padding:2px 6px;border-radius:4px;display:inline-block;margin-top:4px;">${oldest?.lotNumber||'-'}</div>
                        </div>`;
                    }).join('')}
                    ${!productsWithLots.length?'<p style="color:#94a3b8;font-size:13px;grid-column:1/-1;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ Lot ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö ‚Äî ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ñ‡∏•‡∏±‡∏á‡∏Å‡πà‡∏≠‡∏ô</p>':''}
                </div>
            </div>

            <div id="qcCheckItems"></div>

            <div id="qcSaveBtn" style="display:none;text-align:center;margin-top:24px;" class="no-print">
                <button onclick="saveQCCheck('${checkNo}')" style="background:linear-gradient(135deg,#7c3aed,#6d28d9);color:white;padding:16px 60px;border:none;border-radius:14px;font-size:17px;font-weight:700;cursor:pointer;box-shadow:0 4px 20px rgba(124,58,237,0.35);">
                    üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å QC Spot Check
                </button>
            </div>`;
            window._qcItems = {};
            window._qcLots = lots;
        };

        window.filterQCProducts = function(q) {
            q = q.toLowerCase().trim();
            document.querySelectorAll('.qc-prod-card').forEach(el=>{
                el.style.display = (!q||el.dataset.search.includes(q)) ? '' : 'none';
            });
        };

        window.selectQCProduct = function(pid) {
            const card = document.getElementById(`qccard_${pid}`);
            if(card.classList.contains('selected')) {
                card.classList.remove('selected');
                card.style.borderColor='#e2e8f0';
                card.style.background='white';
                delete window._qcItems[pid];
            } else {
                card.classList.add('selected');
                card.style.borderColor='#a855f7';
                card.style.background='#faf5ff';
                window._qcItems[pid]={result:'',foundLot:'',location:'',note:''};
            }
            renderQCCheckForm();
        };

        function renderQCCheckForm() {
            const c = document.getElementById('qcCheckItems'); if(!c) return;
            const selected = Object.keys(window._qcItems);
            if(!selected.length) { c.innerHTML=''; document.getElementById('qcSaveBtn').style.display='none'; return; }
            document.getElementById('qcSaveBtn').style.display='block';
            const lots = window._qcLots||{};

            c.innerHTML=`
            <div style="background:white;border-radius:14px;border:1px solid #e2e8f0;overflow:hidden;">
                <div style="padding:14px 20px;background:#faf5ff;border-bottom:1px solid #e8d5ff;">
                    <span style="font-weight:700;color:#7c3aed;">üìã ‡∏Å‡∏£‡∏≠‡∏Å‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à (${selected.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)</span>
                </div>
                ${selected.map(pid=>{
                    const p=allProducts.find(x=>x.id===pid);
                    const activeLots=(lots[pid]||[]).filter(l=>l.qtyRemaining>0);
                    const expectedLot=activeLots[0];
                    return `
                    <div style="padding:20px;border-bottom:1px solid #f1f5f9;">
                        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:14px;">
                            <div>
                                <span style="font-weight:700;font-size:14px;">${pid}</span>
                                <span style="color:#64748b;font-size:13px;margin-left:8px;">${p?.name||''}</span>
                            </div>
                            <button onclick="selectQCProduct('${pid}')" style="background:#fef2f2;color:#ef4444;border:none;padding:4px 10px;border-radius:6px;cursor:pointer;font-size:11px;">‚úï ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                        </div>

                        <div style="background:#f0f9ff;border:1px solid #bae6fd;border-radius:10px;padding:12px 16px;margin-bottom:14px;">
                            <div style="font-size:11px;font-weight:700;color:#0369a1;margin-bottom:4px;">üìå FIFO ‚Äî ‡∏Ñ‡∏ß‡∏£‡∏´‡∏¢‡∏¥‡∏ö Lot ‡∏ô‡∏µ‡πâ‡∏Å‡πà‡∏≠‡∏ô:</div>
                            <div style="font-family:monospace;font-size:13px;color:#06b6d4;font-weight:bold;">${expectedLot?.lotNumber||'‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Lot'}</div>
                            <div style="font-size:11px;color:#64748b;margin-top:2px;">EXP: ${expectedLot?.exp||'-'} ‚Ä¢ ‡πÄ‡∏´‡∏•‡∏∑‡∏≠: ${expectedLot?.qtyRemaining||0} ${expectedLot?.unit||''}</div>
                        </div>

                        <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:12px;">
                            <div>
                                <label style="font-size:11px;font-weight:700;color:#475569;display:block;margin-bottom:4px;">üìç ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏à‡∏±‡∏î‡πÄ‡∏Å‡πá‡∏ö‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏ß‡∏à</label>
                                <input type="text" id="qc_loc_${pid}" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏ï‡∏π‡πâ‡πÄ‡∏¢‡πá‡∏ô A ‡∏ä‡∏±‡πâ‡∏ô 2"
                                    style="width:100%;padding:8px 12px;border:1.5px solid #e2e8f0;border-radius:8px;font-size:13px;box-sizing:border-box;outline:none;">
                            </div>
                            <div>
                                <label style="font-size:11px;font-weight:700;color:#475569;display:block;margin-bottom:4px;">üè∑Ô∏è Lot ‡∏ó‡∏µ‡πà‡πÄ‡∏´‡πá‡∏ô‡∏à‡∏£‡∏¥‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏á‡∏≤‡∏ô</label>
                                <input type="text" id="qc_found_${pid}" placeholder="‡∏Å‡∏£‡∏≠‡∏Å Lot ‡∏ó‡∏µ‡πà‡πÄ‡∏´‡πá‡∏ô / EXP ‡∏ó‡∏µ‡πà‡πÄ‡∏´‡πá‡∏ô"
                                    style="width:100%;padding:8px 12px;border:1.5px solid #e2e8f0;border-radius:8px;font-size:13px;box-sizing:border-box;outline:none;">
                            </div>
                        </div>

                        <div style="margin-bottom:12px;">
                            <label style="font-size:11px;font-weight:700;color:#475569;display:block;margin-bottom:6px;">‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à FIFO</label>
                            <div style="display:flex;gap:8px;">
                                <label style="flex:1;cursor:pointer;">
                                    <input type="radio" name="qcres_${pid}" value="pass" style="accent-color:#10b981;">
                                    <span style="display:inline-block;padding:8px 0;font-size:13px;color:#059669;font-weight:600;"> ‚úÖ ‡∏ú‡πà‡∏≤‡∏ô ‚Äî ‡∏´‡∏¢‡∏¥‡∏ö‡∏ñ‡∏π‡∏Å FIFO</span>
                                </label>
                                <label style="flex:1;cursor:pointer;">
                                    <input type="radio" name="qcres_${pid}" value="warning" style="accent-color:#f59e0b;">
                                    <span style="display:inline-block;padding:8px 0;font-size:13px;color:#b45309;font-weight:600;"> ‚ö†Ô∏è ‡∏ô‡πà‡∏≤‡∏™‡∏á‡∏™‡∏±‡∏¢</span>
                                </label>
                                <label style="flex:1;cursor:pointer;">
                                    <input type="radio" name="qcres_${pid}" value="fail" style="accent-color:#ef4444;">
                                    <span style="display:inline-block;padding:8px 0;font-size:13px;color:#dc2626;font-weight:600;"> ‚ùå ‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô</span>
                                </label>
                            </div>
                        </div>

                        <div>
                            <label style="font-size:11px;font-weight:700;color:#475569;display:block;margin-bottom:4px;">üìù ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏ / ‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏û‡∏ö</label>
                            <textarea id="qc_note_${pid}" placeholder="‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏û‡∏ö ‡πÄ‡∏ä‡πà‡∏ô ‡∏û‡∏ö Lot ‡πÄ‡∏Å‡πà‡∏≤‡∏Å‡∏ß‡πà‡∏≤‡∏ñ‡∏π‡∏Å‡∏ã‡πà‡∏≠‡∏ô‡∏≠‡∏¢‡∏π‡πà‡∏î‡πâ‡∏≤‡∏ô‡∏´‡∏•‡∏±‡∏á..."
                                style="width:100%;padding:8px 12px;border:1.5px solid #e2e8f0;border-radius:8px;font-size:13px;box-sizing:border-box;outline:none;resize:vertical;min-height:60px;font-family:inherit;"></textarea>
                        </div>
                    </div>`;
                }).join('')}
            </div>`;
        }

        window.saveQCCheck = async function(checkNo) {
            const selected = Object.keys(window._qcItems);
            const lots = window._qcLots||{};
            const items = selected.map(pid=>{
                const p=allProducts.find(x=>x.id===pid);
                const activeLots=(lots[pid]||[]).filter(l=>l.qtyRemaining>0);
                const expectedLot=activeLots[0];
                const result=document.querySelector(`input[name="qcres_${pid}"]:checked`)?.value||'';
                return {
                    productId:pid, productName:p?.name||'',
                    expectedLot:expectedLot?.lotNumber||'',
                    expectedExp:expectedLot?.exp||'',
                    foundLot:document.getElementById(`qc_found_${pid}`)?.value||'',
                    location:document.getElementById(`qc_loc_${pid}`)?.value||'',
                    result, note:document.getElementById(`qc_note_${pid}`)?.value||''
                };
            });
            const noResult=items.filter(i=>!i.result);
            if(noResult.length){toast(`‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö (${noResult.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)`,'#c2410c');return;}

            const passCount=items.filter(i=>i.result==='pass').length;
            const failCount=items.filter(i=>i.result==='fail').length;
            const warnCount=items.filter(i=>i.result==='warning').length;
            const overall=failCount>0?'fail':warnCount>0?'warning':'pass';

            const today=new Date().toISOString().slice(0,10);
            const [y,m,d]=today.split('-');
            const dateTH=`${d}/${m}/${parseInt(y)+543}`;

            await addDoc(collection(db,'qcChecks'),{
                checkNo, date:dateTH, checkDate:today,
                inspector:currentUser.name, timestamp:Date.now(),
                items, passCount, failCount, warnCount, overall,
                totalChecked:items.length
            });

            toast(`‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å QC Check ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‚Äî ‡∏ú‡πà‡∏≤‡∏ô ${passCount}/${items.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`, overall==='pass'?'#059669':'#c2410c');
            setTimeout(()=>openQCHistory(),800);
        };

        // ‚ïê‚ïê‚ïê‚ïê QC HISTORY REPORT ‚ïê‚ïê‚ïê‚ïê
        window.openQCHistory = async function() {
            document.getElementById('dashboardView').classList.add('hidden');
            const c = document.getElementById('toolAppContainer'); c.classList.remove('hidden');
            c.innerHTML=`<div class="tool-header"><h2>üìä QC Report</h2><button onclick="closeTool()" style="background:#f1f5f9;color:#475569;border:none;padding:8px 16px;border-radius:8px;cursor:pointer;">‚úï ‡∏õ‡∏¥‡∏î</button></div><p style="text-align:center;color:#94a3b8;padding:30px;">‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</p>`;

            const snap = await getDocs(collection(db,'qcChecks'));
            let checks=[]; snap.forEach(d=>checks.push({id:d.id,...d.data()}));
            checks.sort((a,b)=>b.timestamp-a.timestamp);

            const totalChecks=checks.length;
            const totalItems=checks.reduce((s,c)=>s+c.totalChecked,0);
            const totalPass=checks.reduce((s,c)=>s+c.passCount,0);
            const totalFail=checks.reduce((s,c)=>s+c.failCount,0);
            const passRate=totalItems>0?Math.round(totalPass/totalItems*100):0;

            // top fail products
            const failMap={};
            checks.forEach(chk=>{ chk.items?.filter(i=>i.result==='fail').forEach(i=>{ failMap[i.productId]=(failMap[i.productId]||0)+1; }); });
            const topFails=Object.entries(failMap).sort((a,b)=>b[1]-a[1]).slice(0,5);

            const overallColors={pass:'#10b981',warning:'#f59e0b',fail:'#ef4444'};
            const overallLabels={pass:'‚úÖ ‡∏ú‡πà‡∏≤‡∏ô',warning:'‚ö†Ô∏è ‡∏ô‡πà‡∏≤‡∏™‡∏á‡∏™‡∏±‡∏¢',fail:'‚ùå ‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô'};

            c.innerHTML=`
            <div class="tool-header">
                <h2>üìä QC FIFO Report</h2>
                <div style="display:flex;gap:8px;">
                    <button onclick="openQCCheck()" style="background:#7c3aed;color:white;border:none;padding:8px 16px;border-radius:8px;cursor:pointer;font-weight:bold;">+ Spot Check ‡πÉ‡∏´‡∏°‡πà</button>
                    <button onclick="closeTool()" style="background:#f1f5f9;color:#475569;border:none;padding:8px 16px;border-radius:8px;cursor:pointer;">‚úï ‡∏õ‡∏¥‡∏î</button>
                </div>
            </div>

            <!-- Summary Cards -->
            <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:16px;margin-bottom:24px;">
                <div style="background:linear-gradient(135deg,#0f172a,#1e293b);border-radius:14px;padding:20px;color:white;">
                    <div style="font-size:11px;color:#64748b;text-transform:uppercase;letter-spacing:0.5px;">QC Sessions</div>
                    <div style="font-size:32px;font-weight:700;margin:4px 0;">${totalChecks}</div>
                    <div style="font-size:11px;color:#94a3b8;">‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏ß‡∏à‡πÅ‡∏•‡πâ‡∏ß</div>
                </div>
                <div style="background:white;border-radius:14px;padding:20px;border:1px solid #e2e8f0;border-top:4px solid #10b981;">
                    <div style="font-size:11px;color:#64748b;text-transform:uppercase;">Pass Rate</div>
                    <div style="font-size:32px;font-weight:700;color:#10b981;margin:4px 0;">${passRate}%</div>
                    <div style="font-size:11px;color:#94a3b8;">${totalPass}/${totalItems} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div>
                </div>
                <div style="background:white;border-radius:14px;padding:20px;border:1px solid #e2e8f0;border-top:4px solid #ef4444;">
                    <div style="font-size:11px;color:#64748b;text-transform:uppercase;">‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô FIFO</div>
                    <div style="font-size:32px;font-weight:700;color:#ef4444;margin:4px 0;">${totalFail}</div>
                    <div style="font-size:11px;color:#94a3b8;">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ú‡∏¥‡∏î FIFO</div>
                </div>
                <div style="background:white;border-radius:14px;padding:20px;border:1px solid #e2e8f0;border-top:4px solid #f59e0b;">
                    <div style="font-size:11px;color:#64748b;text-transform:uppercase;">Fail ‡∏ö‡πà‡∏≠‡∏¢‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î</div>
                    <div style="font-size:16px;font-weight:700;color:#b45309;margin:4px 0;">${topFails[0]?topFails[0][0]:'‚Äî'}</div>
                    <div style="font-size:11px;color:#94a3b8;">${topFails[0]?topFails[0][1]+' ‡∏Ñ‡∏£‡∏±‡πâ‡∏á':'‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•'}</div>
                </div>
            </div>

            <!-- Top Fails -->
            ${topFails.length?`
            <div style="background:white;border-radius:14px;border:1px solid #e2e8f0;padding:20px;margin-bottom:20px;">
                <div style="font-weight:700;margin-bottom:12px;color:#dc2626;">‚ö†Ô∏è ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà Fail FIFO ‡∏ö‡πà‡∏≠‡∏¢‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î</div>
                <div style="display:flex;gap:8px;flex-wrap:wrap;">
                    ${topFails.map(([pid,cnt])=>{const p=allProducts.find(x=>x.id===pid);return `<div style="background:#fef2f2;border:1px solid #fca5a5;border-radius:10px;padding:8px 14px;">
                        <div style="font-weight:700;font-size:13px;">${pid}</div>
                        <div style="font-size:11px;color:#64748b;">${p?.name||''}</div>
                        <div style="font-size:12px;color:#ef4444;font-weight:bold;margin-top:2px;">Fail ${cnt} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á</div>
                    </div>`;}).join('')}
                </div>
            </div>`:''}

            <!-- Check History -->
            <div>
                ${checks.map(chk=>`
                <div class="history-card" style="border-left:4px solid ${overallColors[chk.overall]||'#64748b'};">
                    <div class="history-card-header" style="cursor:pointer;" onclick="toggleDetail('qcdet_${chk.id}')">
                        <div>
                            <div style="display:flex;align-items:center;gap:10px;">
                                <span style="font-weight:700;color:#7c3aed;">${chk.checkNo}</span>
                                <span style="background:${overallColors[chk.overall]}20;color:${overallColors[chk.overall]};font-size:11px;padding:2px 8px;border-radius:8px;font-weight:bold;">${overallLabels[chk.overall]||'-'}</span>
                            </div>
                            <div style="font-size:12px;color:#64748b;margin-top:3px;">üìÖ ${chk.date} ‚Ä¢ üë§ ${chk.inspector} ‚Ä¢ ‚úÖ ${chk.passCount}/${chk.totalChecked} ‡∏ú‡πà‡∏≤‡∏ô</div>
                        </div>
                        <span style="color:#94a3b8;font-size:12px;">‚ñº</span>
                    </div>
                    <div id="qcdet_${chk.id}" style="display:none;padding:16px 20px;">
                        ${chk.items?.map(it=>`
                        <div style="display:flex;align-items:center;gap:12px;padding:10px 0;border-bottom:1px solid #f8fafc;">
                            <div style="width:14px;height:14px;border-radius:50%;background:${overallColors[it.result]||'#64748b'};flex-shrink:0;"></div>
                            <div style="flex:1;">
                                <b style="font-size:13px;">${it.productId}</b> <span style="color:#64748b;font-size:12px;">${it.productName}</span>
                                <div style="font-size:11px;color:#94a3b8;margin-top:2px;">
                                    ‡∏Ñ‡∏≤‡∏î: <span style="font-family:monospace;color:#06b6d4;">${it.expectedLot||'-'}</span> ‚Üí
                                    ‡∏û‡∏ö: <span style="font-family:monospace;color:${it.result==='pass'?'#10b981':'#ef4444'}">${it.foundLot||'-'}</span>
                                    ${it.location?`‚Ä¢ üìç ${it.location}`:''}
                                </div>
                                ${it.note?`<div style="font-size:11px;color:#475569;margin-top:2px;">üìù ${it.note}</div>`:''}
                            </div>
                        </div>`).join('')||''}
                    </div>
                </div>`).join('')||'<p style="text-align:center;color:#94a3b8;padding:40px;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ QC</p>'}
            </div>`;
        };

        window.logout=function(){
            try { const uid=currentUser?.username; if(uid){ set(ref(rtdb,`presence/${uid}`),null).catch(()=>{}); } } catch(e){}
            localStorage.removeItem("currentUser");
            clearTimeout(window._sessionTimer);
            clearTimeout(window._sessionWarnTimer);
            window.location.href="login.html";
        };

        // ---- MOBILE SIDEBAR ----
        window.toggleSidebar=function(){
            document.getElementById('mainSidebar').classList.toggle('open');
            document.getElementById('sidebarOverlay').classList.toggle('open');
        };

        // ---- BACKUP & RESTORE CONFIG ----
        window.backupConfig=function(){
            const data={warehouseList,allProducts,zoneProductMap,roleSettings,_backup:{date:new Date().toISOString(),by:currentUser.name}};
            const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'});
            const a=document.createElement('a');
            a.href=URL.createObjectURL(blob);
            a.download=`tingting_config_${new Date().toLocaleDateString('th-TH').replace(/\//g,'-')}.json`;
            a.click();
            toast('‚úÖ Backup ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à','#059669');
        };

        window.restoreConfig=async function(input){
            const file=input.files[0]; if(!file)return;
            if(!confirm('‚ö†Ô∏è Restore ‡∏à‡∏∞‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏ó‡∏±‡∏ö Config ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô?'))return;
            try{
                const text=await file.text();
                const data=JSON.parse(text);
                if(data.warehouseList) warehouseList=data.warehouseList;
                if(data.allProducts)   allProducts=data.allProducts;
                if(data.zoneProductMap)zoneProductMap=data.zoneProductMap;
                if(data.roleSettings)  roleSettings=data.roleSettings;
                await saveConfig();
                toast(`‚úÖ Restore ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (Backup ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${data._backup?.date?.slice(0,10)||'?'})`, '#059669');
                openWarehouseManager();
            }catch(e){toast('‚ùå ‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á','#c2410c');console.error(e);}
            input.value='';
        };

        // ---- EDIT STOCK (‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á) ----
        window.openEditStockModal=function(productId){
            if(currentUser.role!=='admin'){toast('‚õî ‡πÄ‡∏â‡∏û‡∏≤‡∏∞ Admin','#c2410c');return;}
            const p=allProducts.find(pd=>pd.id===productId);
            const cd=countData[productId]||{total:0};
            const units=p?.units||[{name:p?.unit||''}];
            const existing=document.getElementById('editStockModal');if(existing)existing.remove();
            const modal=document.createElement('div');modal.className='modal-overlay';modal.id='editStockModal';
            modal.innerHTML=`<div class="modal-box">
                <h3>‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏¢‡∏≠‡∏î‡∏™‡∏ï‡πä‡∏≠‡∏Å</h3>
                <div style="background:#fff7ed;border:1px solid #fdba74;border-radius:8px;padding:12px;margin-bottom:16px;font-size:13px;color:#c2410c;">
                    ‚ö†Ô∏è ‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏¢‡∏≠‡∏î‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Audit Log ‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á
                </div>
                <div style="font-size:13px;color:#64748b;margin-bottom:16px;"><b>${productId}</b> ‚Äî ${p?.name||''}<br>‡∏¢‡∏≠‡∏î‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô: <b style="color:var(--success)">${cd.total||0} ${units[0]?.name||''}</b></div>
                <label style="font-size:12px;font-weight:bold;color:#475569;display:block;margin-bottom:4px;">‡∏¢‡∏≠‡∏î‡πÉ‡∏´‡∏°‡πà (${units[0]?.name||'‡∏´‡∏ô‡πà‡∏ß‡∏¢'})</label>
                <input type="number" id="editStockNewVal" value="${cd.total||0}" min="0" style="width:100%;padding:10px;border:1px solid #e2e8f0;border-radius:8px;font-size:16px;font-weight:bold;box-sizing:border-box;margin-bottom:12px;">
                <label style="font-size:12px;font-weight:bold;color:#475569;display:block;margin-bottom:4px;">‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç <span style="color:var(--danger)">*</span></label>
                <input type="text" id="editStockReason" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏ô‡∏±‡∏ö‡∏ú‡∏¥‡∏î / ‡∏õ‡∏£‡∏±‡∏ö‡∏¢‡∏≠‡∏î‡∏´‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö" style="width:100%;padding:10px;border:1px solid #e2e8f0;border-radius:8px;font-size:14px;box-sizing:border-box;margin-bottom:20px;">
                <div style="display:flex;gap:10px;">
                    <button onclick="saveEditStock('${productId}')" style="flex:1;background:var(--success);color:white;border:none;padding:12px;border-radius:10px;cursor:pointer;font-weight:bold;">‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                    <button onclick="document.getElementById('editStockModal').remove()" style="flex:1;background:#f1f5f9;color:#475569;border:none;padding:12px;border-radius:10px;cursor:pointer;">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                </div>
            </div>`;
            document.body.appendChild(modal);
        };

        window.saveEditStock=async function(productId){
            const newVal=parseFloat(document.getElementById('editStockNewVal').value);
            const reason=document.getElementById('editStockReason').value.trim();
            if(isNaN(newVal)||newVal<0){toast('‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏¢‡∏≠‡∏î‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á','#c2410c');return;}
            if(!reason){toast('‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•','#c2410c');return;}
            const oldVal=countData[productId]?.total||0;
            if(!countData[productId])countData[productId]={total:0,name:productId};
            countData[productId].total=newVal;
            countData[productId].lastUpdate=new Date().toLocaleDateString('th-TH')+' '+new Date().toLocaleTimeString('th-TH',{hour:'2-digit',minute:'2-digit'});
            countData[productId].countedBy=currentUser.name;
            await saveCountData();
            // Audit log
            await addDoc(collection(db,'auditLog'),{
                type:'editStock', productId, oldVal, newVal, reason,
                by:currentUser.name, at:new Date().toISOString()
            });
            document.getElementById('editStockModal').remove();
            toast(`‚úÖ ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏¢‡∏≠‡∏î ${productId}: ${oldVal} ‚Üí ${newVal}`, '#059669');
        };

        // ---- SEARCH IN STOCK TOOL ----
        window.filterStockRows=function(q){
            q=q.toLowerCase().trim();
            document.querySelectorAll('.stock-row').forEach(row=>{
                const text=row.innerText.toLowerCase();
                row.style.display=(!q||text.includes(q))?'':'none';
            });
        };

        // ---- DELETE HISTORY (Admin only) ----
        window.deleteHistorySession=async function(sessionId){
            if(currentUser.role!=='admin'){toast('‚õî ‡πÄ‡∏â‡∏û‡∏≤‡∏∞ Admin ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô','#c2410c');return;}
            if(!confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡∏ö‡∏ô‡∏µ‡πâ? ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡πÑ‡∏î‡πâ'))return;
            try{
                const {deleteDoc}=await import("https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js");
                await deleteDoc(doc(db,'stockHistory',sessionId));
                toast('‚úÖ ‡∏•‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢','#059669');
                loadHistory();
                loadDashHistory();
            }catch(e){toast('‚ùå ‡∏•‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à','#c2410c');console.error(e);}
        };

        // ---- SESSION TIMEOUT ----
        let _lastActivity = Date.now();
        const SESSION_TIMEOUT = 30 * 60 * 1000;  // 30 ‡∏ô‡∏≤‡∏ó‡∏µ
        const SESSION_WARN   =  2 * 60 * 1000;   // ‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏Å‡πà‡∏≠‡∏ô 2 ‡∏ô‡∏≤‡∏ó‡∏µ

        function resetSessionTimer(){
            _lastActivity = Date.now();
            clearTimeout(window._sessionTimer);
            clearTimeout(window._sessionWarnTimer);
            // ‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏Å‡πà‡∏≠‡∏ô 2 ‡∏ô‡∏≤‡∏ó‡∏µ
            window._sessionWarnTimer = setTimeout(()=>{
                const existing = document.getElementById('sessionWarnBanner');
                if(existing) return;
                const banner = document.createElement('div');
                banner.id = 'sessionWarnBanner';
                banner.innerHTML = `<div style="position:fixed;bottom:80px;right:30px;background:#f59e0b;color:white;padding:16px 24px;border-radius:14px;z-index:99999;box-shadow:0 8px 24px rgba(0,0,0,0.2);display:flex;align-items:center;gap:12px;">
                    <span style="font-size:20px;">‚ö†Ô∏è</span>
                    <div><b>‡πÉ‡∏Å‡∏•‡πâ‡∏´‡∏°‡∏î Session</b><br><span style="font-size:12px;">‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞ logout ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÉ‡∏ô 2 ‡∏ô‡∏≤‡∏ó‡∏µ</span></div>
                    <button onclick="resetSessionTimer();document.getElementById('sessionWarnBanner').remove();" style="background:white;color:#f59e0b;border:none;padding:8px 14px;border-radius:8px;cursor:pointer;font-weight:bold;margin-left:8px;">‡∏â‡∏±‡∏ô‡∏¢‡∏±‡∏á‡∏≠‡∏¢‡∏π‡πà</button>
                </div>`;
                document.body.appendChild(banner);
            }, SESSION_TIMEOUT - SESSION_WARN);
            // logout ‡∏à‡∏£‡∏¥‡∏á
            window._sessionTimer = setTimeout(()=>{
                alert('‚è∞ Session ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤ Login ‡πÉ‡∏´‡∏°‡πà');
                logout();
            }, SESSION_TIMEOUT);
        }
        // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï timer ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô
        ['click','keydown','mousemove','touchstart'].forEach(ev=>{
            document.addEventListener(ev, ()=>resetSessionTimer(), {passive:true});
        });
        window.toggleSub=function(id){const s=document.getElementById(id);s.style.display=(s.style.display==='block')?'none':'block';};
        window.closeTool=function(){if(Object.keys(tempCountData).length>0){if(!confirm("‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏õ‡∏¥‡∏î‡∏à‡∏£‡∏¥‡∏á‡πÑ‡∏´‡∏°?"))return;}document.getElementById('toolAppContainer').classList.add('hidden');document.getElementById('dashboardView').classList.remove('hidden');};
    </script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
</body>
</html>
