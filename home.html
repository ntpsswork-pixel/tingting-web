<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TingTing Dashboard</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <style>
        :root { --sidebar-width: 260px; --primary-dark: #1e293b; --accent-gold: #fccf55; --bg-light: #f1f5f9; --success: #10b981; --danger: #ef4444; --info: #3b82f6; }
        body { margin: 0; display: flex; font-family: 'Segoe UI', Tahoma, sans-serif; background: var(--bg-light); min-height: 100vh; overflow-x: hidden; }
        .sidebar { width: var(--sidebar-width); height: 100vh; background: var(--primary-dark); color: white; position: fixed; left: 0; top: 0; z-index: 1000; display: flex; flex-direction: column; }
        .sidebar-brand { padding: 30px 20px; text-align: center; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .sidebar-brand h2 { margin: 0; color: var(--accent-gold); font-size: 24px; letter-spacing: 2px; }
        .user-info { padding: 20px; margin: 15px; background: rgba(255,255,255,0.05); border-radius: 12px; font-size: 14px; }
        .user-info b { color: var(--accent-gold); display: block; margin-bottom: 4px; }
        .nav-links { flex: 1; padding: 10px 15px; }
        .nav-item { padding: 12px 15px; cursor: pointer; border-radius: 8px; margin-bottom: 5px; transition: 0.3s; display: flex; align-items: center; gap: 10px; color: #cbd5e1; }
        .nav-item:hover { background: rgba(255,255,255,0.05); }
        .nav-item.active { background: var(--accent-gold); color: var(--primary-dark); font-weight: bold; }
        .submenu { padding-left: 20px; display: none; margin-bottom: 10px; border-left: 1px solid #334155; margin-left: 20px; }
        .submenu div { padding: 8px 12px; font-size: 13px; color: #94a3b8; cursor: pointer; border-radius: 5px; }
        .submenu div:hover { color: white; background: rgba(255,255,255,0.05); }
        .main-content { margin-left: var(--sidebar-width); width: calc(100% - var(--sidebar-width)); flex: 1; }
        .banner-container { width: 100%; height: 380px; background: #000; overflow: hidden; position: relative; }
        .app-container { padding: 30px; animation: fadeIn 0.4s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .tool-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; border-bottom: 2px solid #e2e8f0; padding-bottom: 15px; }
        .user-card { background: white; border-radius: 15px; padding: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.03); border: 1px solid #e2e8f0; }
        .stock-table { width: 100%; border-collapse: separate; border-spacing: 0 8px; }
        .stock-row { background: white; border-radius: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.02); }
        .stock-row td { padding: 15px; }
        .btn-action { width: 40px; height: 40px; border-radius: 8px; border: none; color: white; cursor: pointer; transition: 0.2s; font-weight: bold; }
        .hidden { display: none !important; }
        .input-group { background: white; padding: 10px; border-radius: 10px; border: 1px solid #e2e8f0; }
        .input-group label { display: block; font-size: 11px; color: #64748b; margin-bottom: 3px; font-weight: bold; }
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 9999; display: flex; align-items: center; justify-content: center; animation: fadeIn 0.2s ease; }
        .modal-box { background: white; border-radius: 20px; padding: 32px; width: 380px; box-shadow: 0 24px 60px rgba(0,0,0,0.3); }
        .modal-box h3 { margin: 0 0 20px; color: var(--primary-dark); font-size: 18px; }
        .modal-box input { width: 100%; padding: 12px 14px; border: 1px solid #e2e8f0; border-radius: 10px; font-size: 14px; margin-bottom: 12px; box-sizing: border-box; outline: none; transition: border 0.2s; }
        .modal-box input:focus { border-color: var(--info); }
        .modal-error { color: var(--danger); font-size: 12px; margin-bottom: 10px; display: none; }
        .toast { position: fixed; bottom: 30px; right: 30px; background: #1e293b; color: white; padding: 14px 20px; border-radius: 12px; font-size: 14px; z-index: 99999; animation: slideUp 0.3s ease; box-shadow: 0 8px 24px rgba(0,0,0,0.3); }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .upload-progress { display: none; margin-top: 10px; background: #f1f5f9; border-radius: 8px; overflow: hidden; height: 8px; }
        .upload-progress-bar { height: 100%; background: var(--success); transition: width 0.3s; width: 0%; }
        @media print {
            .sidebar, .no-print, button, #bannerAdminSection { display: none !important; }
            .main-content { margin-left: 0 !important; width: 100% !important; }
            .app-container { padding: 0 !important; }
            table { width: 100% !important; border: 1px solid #000 !important; }
            th, td { border: 1px solid #ddd !important; padding: 8px !important; }
        }
    </style>
</head>
<body>
    <div class="sidebar no-print">
        <div class="sidebar-brand"><h2>TINGTING</h2></div>
        <div class="user-info">
            <small>‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô:</small>
            <b id="roleDisplay">...</b>
            <small id="roleStatusText">‡∏ê‡∏≤‡∏ô‡∏∞: -</small>
            <div id="timerDisplay" style="color:var(--accent-gold);font-weight:bold;font-size:12px;margin-top:8px;"></div>
        </div>
        <div style="padding:0 15px 5px;">
            <button onclick="openChangePasswordModal()" style="width:100%;background:rgba(255,255,255,0.05);color:#94a3b8;border:1px solid #334155;padding:9px;border-radius:8px;cursor:pointer;font-size:12px;">
                üîë ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô Password
            </button>
        </div>
        <div class="nav-links">
            <div class="nav-item active" onclick="location.reload()">üè† ‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å Dashboard</div>
            <div id="warehouseMenu" class="hidden">
                <div class="nav-item" onclick="toggleSub('subWH')">üì¶ ‡∏Ñ‡∏•‡∏±‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ ‚ñæ</div>
                <div id="subWH" class="submenu">
                    <div onclick="openStockSummary()" style="color:var(--accent-gold);">üìä ‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏° (PDF/Excel)</div>
                </div>
            </div>
            <div id="toolsMenu" class="hidden">
                <div class="nav-item" onclick="toggleSub('subTools')" style="color:var(--success);">üõ†Ô∏è ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô ‚ñæ</div>
                <div id="subTools" class="submenu">
                    <div onclick="openCentralStock()">‚óè ‡∏ô‡∏±‡∏ö‡∏™‡∏ï‡πä‡∏≠‡∏Å‡∏Ñ‡∏£‡∏±‡∏ß‡∏Å‡∏•‡∏≤‡∏á</div>
                </div>
            </div>
            <div id="adminMenu" class="hidden">
                <div class="nav-item" onclick="toggleSub('subAdmin')" style="color:var(--accent-gold);">üë§ ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡∏ö‡∏ö ‚ñæ</div>
                <div id="subAdmin" class="submenu">
                    <div onclick="openUserManagement()">‚óè ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô & ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå</div>
                    <div onclick="openWarehouseManager()" style="color:var(--accent-gold);">‚óè ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏•‡∏±‡∏á‡πÅ‡∏•‡∏∞‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</div>
                </div>
            </div>
        </div>
        <div class="nav-item" onclick="logout()" style="color:var(--danger);border-top:1px solid rgba(255,255,255,0.05);margin-top:auto;padding:20px;">
            üö™ ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö
        </div>
    </div>

    <div class="main-content">
        <div id="dashboardView" class="no-print">
            <div class="banner-container">
                <div class="swiper mySwiper">
                    <div class="swiper-wrapper" id="bannerWrapper"></div>
                    <div class="swiper-pagination"></div>
                </div>
            </div>
            <div id="bannerAdminSection" class="app-container hidden">
                <div style="background:white;padding:20px;border-radius:15px;border:1px solid #e2e8f0;">
                    <h3 style="margin-top:0;">üì∏ ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏ö‡∏ô‡πÄ‡∏ô‡∏≠‡∏£‡πå (Admin Only)</h3>
                    <div style="display:flex;gap:10px;margin-bottom:10px;">
                        <input type="file" id="bannerFile" accept="image/*" style="flex:1;padding:8px;border:1px solid #ddd;border-radius:8px;">
                        <button onclick="uploadBanner()" style="background:var(--success);color:white;border:none;padding:10px 20px;border-radius:8px;cursor:pointer;">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏ö‡∏ô‡πÄ‡∏ô‡∏≠‡∏£‡πå</button>
                    </div>
                    <div class="upload-progress" id="uploadProgress">
                        <div class="upload-progress-bar" id="uploadProgressBar"></div>
                    </div>
                    <div id="thumbList" style="display:flex;gap:12px;flex-wrap:wrap;margin-top:15px;"></div>
                </div>
            </div>
            <div style="padding:30px;">
                <h3>‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö‡∏™‡∏π‡πà TingTing Dashboard</h3>
                <p>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏°‡∏ô‡∏π‡∏ó‡∏≤‡∏á‡∏ã‡πâ‡∏≤‡∏¢‡∏°‡∏∑‡∏≠‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</p>
                <div id="viewOnlyAlert" class="hidden" style="background:#fff7ed;color:#c2410c;padding:15px;border-radius:10px;border:1px solid #fdba74;margin-top:20px;">
                    ‚ö†Ô∏è <b>‡πÇ‡∏´‡∏°‡∏î‡∏ú‡∏π‡πâ‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£:</b> ‡∏Ñ‡∏∏‡∏ì‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß
                </div>
            </div>
        </div>
        <div id="toolAppContainer" class="app-container hidden"></div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
        import { getFirestore, doc, getDoc, getDocs, setDoc, updateDoc, deleteDoc, collection } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDOduBfKHKwObxOk3MUMGxj1PGT23p_swM",
            authDomain: "tingting-3d57f.firebaseapp.com",
            projectId: "tingting-3d57f",
            storageBucket: "tingting-3d57f.firebasestorage.app",
            messagingSenderId: "998609441304",
            appId: "1:998609441304:web:0c7fbedf869fa2335d296d"
        };

        // Cloudinary config
        const CLOUDINARY_CLOUD = "dof4vtj87";
        const CLOUDINARY_PRESET = "tingting_banners";

        const app = initializeApp(firebaseConfig);
        const db  = getFirestore(app);

        let currentUser   = JSON.parse(localStorage.getItem("currentUser")) || null;
        let warehouseList = ["‡∏Ñ‡∏•‡∏±‡∏á‡∏´‡∏•‡∏±‡∏Å"];
        let allProducts   = [];
        let zoneProductMap= {};
        let countData     = {};
        let roleSettings  = { admin: { menus: ["warehouse","tools","admin"], viewOnly: false }, warehouse: { menus: ["warehouse","tools"], viewOnly: false }, staff: { menus: ["tools"], viewOnly: false } };
        let tempCountData = {};
        let selectedStaff = "";

        async function hashPassword(password) {
            const buf = await crypto.subtle.digest('SHA-256', new TextEncoder().encode(password));
            return Array.from(new Uint8Array(buf)).map(b => b.toString(16).padStart(2,'0')).join('');
        }

        function toast(msg, color = '#1e293b') {
            const t = document.createElement('div');
            t.className = 'toast'; t.style.background = color; t.innerText = msg;
            document.body.appendChild(t);
            setTimeout(() => t.remove(), 3000);
        }

        async function loadConfig() {
            try {
                const snap = await getDoc(doc(db, 'config', 'main'));
                if (snap.exists()) {
                    const d = snap.data();
                    if (d.warehouseList)  warehouseList  = d.warehouseList;
                    if (d.allProducts)    allProducts    = d.allProducts;
                    if (d.zoneProductMap) zoneProductMap = d.zoneProductMap;
                    if (d.roleSettings)   roleSettings   = d.roleSettings;
                }
            } catch(e) { console.error('loadConfig', e); }
        }

        async function saveConfig() {
            await setDoc(doc(db, 'config', 'main'), { warehouseList, allProducts, zoneProductMap, roleSettings }, { merge: true });
        }

        async function loadCountData() {
            try {
                const snap = await getDoc(doc(db, 'stock', 'countData'));
                if (snap.exists()) countData = snap.data();
            } catch(e) { console.error(e); }
        }

        async function saveCountData() {
            await setDoc(doc(db, 'stock', 'countData'), countData);
        }

        // ‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏ö‡∏ô‡πÄ‡∏ô‡∏≠‡∏£‡πå‡∏à‡∏≤‡∏Å Firestore
        async function loadBanners() {
            try {
                const snap = await getDoc(doc(db, 'config', 'banners'));
                return snap.exists() ? (snap.data().urls || []) : [];
            } catch(e) { return []; }
        }

        async function saveBanners(urls) {
            await setDoc(doc(db, 'config', 'banners'), { urls });
        }

        window.onload = async function() {
            if (!currentUser) { window.location.href = 'login.html'; return; }
            document.getElementById('roleDisplay').innerText = currentUser.name;
            await loadConfig();
            await loadCountData();
            applyPermissions();
            await renderBanners();
            setInterval(checkToolExpiry, 1000);
            setInterval(checkHardBanStatus, 8000);
        };

        // ---- BANNER (Cloudinary + Firestore) ----
        window.renderBanners = async function() {
            const urls = await loadBanners();
            const defaultBanner = "https://images.unsplash.com/photo-1504674900247-0877df9cc836?auto=format&fit=crop&w=1200&q=80";
            const bannerUrls = urls.length > 0 ? urls : [defaultBanner];

            const wrapper = document.getElementById('bannerWrapper');
            if (wrapper) {
                wrapper.innerHTML = bannerUrls.map(url => `<div class="swiper-slide"><img src="${url}" style="width:100%;height:100%;object-fit:cover;"></div>`).join('');
                if (window._swiper) window._swiper.destroy(true, true);
                window._swiper = new Swiper(".mySwiper", { pagination:{ el:".swiper-pagination" }, autoplay:{ delay:3500 }, loop: bannerUrls.length > 1 });
            }

            const thumbList = document.getElementById("thumbList");
            if (thumbList) {
                thumbList.innerHTML = urls.map((url, i) => `
                <div style="position:relative;">
                    <img src="${url}" style="width:100px;height:60px;object-fit:cover;border-radius:8px;border:1px solid #ddd;">
                    <button onclick="delBanner(${i})" style="position:absolute;top:-5px;right:-5px;background:red;color:white;border:none;border-radius:50%;width:22px;height:22px;cursor:pointer;font-size:10px;">‚úï</button>
                </div>`).join('');
            }
        };

        window.uploadBanner = async function() {
            const file = document.getElementById('bannerFile').files[0];
            if (!file) { toast('‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡∏Å‡πà‡∏≠‡∏ô', '#c2410c'); return; }

            const progress = document.getElementById('uploadProgress');
            const bar      = document.getElementById('uploadProgressBar');
            progress.style.display = 'block';
            bar.style.width = '30%';

            try {
                // ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏õ Cloudinary
                const formData = new FormData();
                formData.append('file', file);
                formData.append('upload_preset', CLOUDINARY_PRESET);

                bar.style.width = '60%';

                const res  = await fetch(`https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD}/image/upload`, { method: 'POST', body: formData });
                const data = await res.json();

                if (!data.secure_url) throw new Error('Upload failed');

                bar.style.width = '90%';

                // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å URL ‡∏•‡∏á Firestore
                const currentUrls = await loadBanners();
                currentUrls.push(data.secure_url);
                await saveBanners(currentUrls);

                bar.style.width = '100%';
                toast('‚úÖ ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏ö‡∏ô‡πÄ‡∏ô‡∏≠‡∏£‡πå‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!', '#059669');
                document.getElementById('bannerFile').value = '';

                setTimeout(() => { progress.style.display = 'none'; bar.style.width = '0%'; }, 1000);
                await renderBanners();

            } catch(e) {
                console.error(e);
                progress.style.display = 'none';
                bar.style.width = '0%';
                toast('‚ùå ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà', '#c2410c');
            }
        };

        window.delBanner = async function(i) {
            if (!confirm('‡∏•‡∏ö‡πÅ‡∏ö‡∏ô‡πÄ‡∏ô‡∏≠‡∏£‡πå‡∏ô‡∏µ‡πâ?')) return;
            const urls = await loadBanners();
            urls.splice(i, 1);
            await saveBanners(urls);
            toast('üóëÔ∏è ‡∏•‡∏ö‡πÅ‡∏ö‡∏ô‡πÄ‡∏ô‡∏≠‡∏£‡πå‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', '#059669');
            await renderBanners();
        };

        // ---- CHANGE PASSWORD ----
        window.openChangePasswordModal = function() {
            if (currentUser.username === 'admin' && currentUser.role === 'admin') {
                toast('‚ö†Ô∏è ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ Admin ‡∏´‡∏•‡∏±‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô Password ‡πÑ‡∏î‡πâ', '#c2410c'); return;
            }
            const modal = document.createElement('div');
            modal.className = 'modal-overlay'; modal.id = 'changePassModal';
            modal.innerHTML = `
                <div class="modal-box">
                    <h3>üîë ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô Password</h3>
                    <input type="password" id="oldPassInput" placeholder="Password ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô">
                    <input type="password" id="newPassInput" placeholder="Password ‡πÉ‡∏´‡∏°‡πà">
                    <input type="password" id="confirmPassInput" placeholder="‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô Password ‡πÉ‡∏´‡∏°‡πà">
                    <div class="modal-error" id="passModalError"></div>
                    <div style="display:flex;gap:10px;margin-top:8px;">
                        <button onclick="submitChangePassword()" style="flex:1;background:var(--info);color:white;border:none;padding:12px;border-radius:10px;cursor:pointer;font-weight:bold;">‚úÖ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</button>
                        <button onclick="closeModal()" style="flex:1;background:#f1f5f9;color:#475569;border:none;padding:12px;border-radius:10px;cursor:pointer;">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                    </div>
                </div>`;
            document.body.appendChild(modal);
        };

        window.submitChangePassword = async function() {
            const oldPass = document.getElementById('oldPassInput').value;
            const newPass = document.getElementById('newPassInput').value;
            const confirmPass = document.getElementById('confirmPassInput').value;
            const errEl = document.getElementById('passModalError');
            errEl.style.display = 'none';
            if (!oldPass || !newPass || !confirmPass) { errEl.innerText = '‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö'; errEl.style.display = 'block'; return; }
            if (newPass !== confirmPass) { errEl.innerText = '‚ùå Password ‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô'; errEl.style.display = 'block'; return; }
            if (newPass.length < 4) { errEl.innerText = '‚ùå ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 4 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£'; errEl.style.display = 'block'; return; }
            try {
                const userSnap = await getDoc(doc(db, 'users', currentUser.username));
                if (!userSnap.exists()) { errEl.innerText = '‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ'; errEl.style.display = 'block'; return; }
                const hashedOld = await hashPassword(oldPass);
                const storedPass = userSnap.data().password || await hashPassword('1234');
                if (hashedOld !== storedPass) { errEl.innerText = '‚ùå Password ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á'; errEl.style.display = 'block'; return; }
                await setDoc(doc(db, 'users', currentUser.username), { password: await hashPassword(newPass) }, { merge: true });
                closeModal();
                toast('‚úÖ ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô Password ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!', '#059669');
            } catch(e) { errEl.innerText = '‚ö†Ô∏è ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î'; errEl.style.display = 'block'; }
        };

        window.closeModal = function() { const m = document.getElementById('changePassModal'); if (m) m.remove(); };

        // ---- USER MANAGEMENT ----
        window.openUserManagement = function() {
            document.getElementById('dashboardView').classList.add('hidden');
            const container = document.getElementById('toolAppContainer');
            container.classList.remove('hidden');
            container.innerHTML = `
                <div class="tool-header no-print">
                    <h2>üë§ ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô & ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå Role</h2>
                    <button onclick="closeTool()">‚úï ‡∏õ‡∏¥‡∏î</button>
                </div>
                <div style="display:grid;grid-template-columns:1fr 1.5fr;gap:25px;">
                    <div style="background:white;padding:20px;border-radius:15px;border:1px solid #e2e8f0;">
                        <h4 style="margin-top:0;">üé≠ ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Role & ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå</h4>
                        <div style="display:flex;gap:8px;margin-bottom:15px;">
                            <input type="text" id="newRoleName" placeholder="‡∏ä‡∏∑‡πà‡∏≠ Role ‡πÉ‡∏´‡∏°‡πà" style="flex:1;padding:10px;border-radius:8px;border:1px solid #ddd;">
                            <button onclick="addNewRole()" style="background:var(--success);color:white;border:none;padding:10px;border-radius:8px;cursor:pointer;">‡πÄ‡∏û‡∏¥‡πà‡∏° Role</button>
                        </div>
                        <div id="rolePermissionsList"></div>
                    </div>
                    <div>
                        <div style="background:white;padding:20px;border-radius:15px;margin-bottom:20px;display:flex;gap:10px;flex-wrap:wrap;" class="no-print">
                            <input type="text" id="newUserName" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô" style="padding:10px;border-radius:8px;border:1px solid #ddd;flex:1;min-width:120px;">
                            <input type="text" id="newUserKey" placeholder="Username" style="padding:10px;border-radius:8px;border:1px solid #ddd;flex:1;min-width:120px;">
                            <input type="text" id="newUserPass" placeholder="Password (‡πÑ‡∏°‡πà‡∏Å‡∏£‡∏≠‡∏Å = 1234)" style="padding:10px;border-radius:8px;border:1px solid #ddd;flex:1;min-width:140px;">
                            <select id="newUserRole" style="padding:10px;border-radius:8px;flex:1;min-width:100px;"></select>
                            <button onclick="addNewUser()" style="background:var(--info);color:white;border:none;padding:10px 20px;border-radius:8px;cursor:pointer;">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</button>
                        </div>
                        <div id="userGrid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:15px;"></div>
                    </div>
                </div>`;
            renderRoleSettings();
            renderUserCards();
        };

        window.renderUserCards = async function() {
            const grid = document.getElementById('userGrid');
            if (!grid) return;
            grid.innerHTML = '<p style="color:#94a3b8;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</p>';
            const snap = await getDocs(collection(db, 'users'));
            const now = new Date().getTime();
            let html = "";
            snap.forEach(d => {
                const k = d.id, u = d.data();
                const active = u.toolExpiry > now;
                const isSuspended = u.status === 'suspended';
                const isPendingDelete = u.deleteAt !== undefined && u.deleteAt !== null;
                let deleteInfoText = "";
                if (isPendingDelete) {
                    const daysLeft = Math.ceil(((u.deleteAt + 604800000) - now) / 86400000);
                    deleteInfoText = `<div style="color:var(--danger);font-size:10px;margin-top:5px;font-weight:bold;">‚è≥ ‡∏•‡∏ö‡∏ñ‡∏≤‡∏ß‡∏£‡πÉ‡∏ô ${daysLeft > 0 ? daysLeft : 0} ‡∏ß‡∏±‡∏ô</div>`;
                }
                html += `
                <div class="user-card" style="${isSuspended ? 'border:2px solid var(--danger);background:#fff5f5;' : ''} ${isPendingDelete ? 'opacity:0.6;' : ''}">
                    <div style="display:flex;justify-content:space-between;">
                        <b>${u.name}</b>
                        <span style="font-size:10px;background:#eee;padding:2px 6px;border-radius:4px;">${u.role}</span>
                    </div>
                    <small style="color:#64748b;">ID: ${k}</small>
                    ${deleteInfoText}
                    <div style="margin:12px 0;font-size:12px;">
                        ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ${isSuspended ? '<b style="color:var(--danger);">‚õî ‡∏ñ‡∏π‡∏Å‡∏£‡∏∞‡∏á‡∏±‡∏ö</b>' : (active ? 'üü¢ ‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå' : '‚ö™ ‡∏´‡∏°‡∏î‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå')}
                    </div>
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:5px;" class="no-print">
                        <button onclick="grantAccess('${k}',5)" style="background:var(--info);color:white;border:none;padding:8px;border-radius:5px;cursor:pointer;font-size:11px;">+5 ‡∏ä‡∏°.</button>
                        <button onclick="grantAccess('${k}',0)" style="background:var(--accent-gold);border:none;padding:8px;border-radius:5px;cursor:pointer;font-size:11px;">‡∏ñ‡∏≤‡∏ß‡∏£</button>
                        ${isSuspended
                            ? `<button onclick="unbanUser('${k}')" style="background:#0ea5e9;color:white;border:none;padding:8px;border-radius:5px;cursor:pointer;font-size:11px;">üîì ‡∏õ‡∏•‡∏î‡∏£‡∏∞‡∏á‡∏±‡∏ö</button>`
                            : `<button onclick="revokeAccess('${k}')" style="background:var(--danger);color:white;border:none;padding:8px;border-radius:5px;cursor:pointer;font-size:11px;">üö´ ‡∏£‡∏∞‡∏á‡∏±‡∏ö</button>`
                        }
                        ${isPendingDelete
                            ? `<button onclick="cancelDelete('${k}')" style="background:#64748b;color:white;border:none;padding:8px;border-radius:5px;cursor:pointer;font-size:11px;">‚Ü©Ô∏è ‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô</button>`
                            : `<button onclick="requestDelete('${k}')" style="background:#000;color:white;border:none;padding:8px;border-radius:5px;cursor:pointer;font-size:11px;">üóëÔ∏è ‡∏•‡∏ö</button>`
                        }
                        <button onclick="adminResetPassword('${k}')" style="grid-column:span 2;background:#7c3aed;color:white;border:none;padding:8px;border-radius:5px;cursor:pointer;font-size:11px;margin-top:2px;">üîë Reset Password ‚Üí 1234</button>
                    </div>
                </div>`;
            });
            grid.innerHTML = html || '<p style="color:#94a3b8;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</p>';
        };

        window.adminResetPassword = async function(username) {
            if (!confirm(`Reset Password ‡∏Ç‡∏≠‡∏á ${username} ‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô "1234"?`)) return;
            await setDoc(doc(db,'users',username), { password: await hashPassword('1234') }, { merge: true });
            toast('‚úÖ Reset Password ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ Password ‡πÉ‡∏´‡∏°‡πà‡∏Ñ‡∏∑‡∏≠: 1234', '#059669');
        };

        window.unbanUser = async function(username) { await setDoc(doc(db,'users',username), { status:'active' }, { merge:true }); toast('üîì ‡∏õ‡∏•‡∏î‡∏£‡∏∞‡∏á‡∏±‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', '#059669'); renderUserCards(); };
        window.requestDelete = async function(username) { if (!confirm(`‡∏•‡∏ö‡∏ö‡∏±‡∏ç‡∏ä‡∏µ ${username}? (‡∏£‡∏≠‡∏•‡∏ö 7 ‡∏ß‡∏±‡∏ô)`)) return; await setDoc(doc(db,'users',username), { deleteAt: new Date().getTime() }, { merge:true }); renderUserCards(); };
        window.cancelDelete = async function(username) { await setDoc(doc(db,'users',username), { deleteAt: null }, { merge:true }); toast('‚úÖ ‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', '#059669'); renderUserCards(); };
        window.grantAccess = async function(k, h) { const expiry = (h===0) ? 4070908800000 : new Date().getTime()+(h*3600000); await setDoc(doc(db,'users',k), { toolExpiry:expiry, status:'active' }, { merge:true }); toast('‚úÖ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', '#059669'); renderUserCards(); };
        window.revokeAccess = async function(k) { if (!confirm(`üö´ ‡∏£‡∏∞‡∏á‡∏±‡∏ö ${k}?`)) return; await setDoc(doc(db,'users',k), { toolExpiry:0, status:'suspended' }, { merge:true }); toast('üîí ‡∏£‡∏∞‡∏á‡∏±‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', '#c2410c'); renderUserCards(); };

        window.checkHardBanStatus = async function() {
            if (!currentUser || currentUser.username === 'admin') return;
            try {
                const snap = await getDoc(doc(db,'users', currentUser.username));
                if (snap.exists() && snap.data().status === 'suspended') { alert('üö´ ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ñ‡∏π‡∏Å‡∏£‡∏∞‡∏á‡∏±‡∏ö!'); logout(); }
            } catch(e) {}
        };

        window.addNewUser = async function() {
            const n = document.getElementById('newUserName').value.trim();
            const u = document.getElementById('newUserKey').value.trim();
            const r = document.getElementById('newUserRole').value;
            const rawPass = document.getElementById('newUserPass').value.trim() || '1234';
            if (!n || !u) return;
            await setDoc(doc(db,'users',u), { name:n, role:r, username:u, password: await hashPassword(rawPass), toolExpiry:0, status:'active' });
            toast('‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', '#059669');
            document.getElementById('newUserName').value = document.getElementById('newUserKey').value = document.getElementById('newUserPass').value = '';
            renderUserCards();
        };

        window.renderRoleSettings = function() {
            const list = document.getElementById('rolePermissionsList');
            const sel  = document.getElementById('newUserRole');
            if (!list) return;
            let html = '', options = '';
            Object.keys(roleSettings).forEach(role => {
                const perms = roleSettings[role].menus, viewOnly = roleSettings[role].viewOnly || false;
                html += `<div style="padding:12px;border:1px solid #f1f5f9;border-radius:10px;margin-bottom:10px;background:#f8fafc;">
                    <div style="display:flex;justify-content:space-between;">
                        <b style="text-transform:uppercase;">${role}</b>
                        ${role !== 'admin' ? `<small onclick="deleteRole('${role}')" style="color:red;cursor:pointer;">‡∏•‡∏ö Role</small>` : ''}
                    </div>
                    <div style="display:flex;gap:12px;font-size:11px;margin-top:8px;">
                        <label><input type="checkbox" ${perms.includes('warehouse')?'checked':''} onchange="togglePerm('${role}','warehouse')"> ‡∏Ñ‡∏•‡∏±‡∏á</label>
                        <label><input type="checkbox" ${perms.includes('tools')?'checked':''} onchange="togglePerm('${role}','tools')"> ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠</label>
                        <label><input type="checkbox" ${perms.includes('admin')?'checked':''} onchange="togglePerm('${role}','admin')"> ‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô</label>
                        <label style="color:var(--info);font-weight:bold;"><input type="checkbox" ${viewOnly?'checked':''} onchange="toggleViewOnly('${role}')"> üëÅÔ∏è ‡∏î‡∏π‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß</label>
                    </div>
                </div>`;
                options += `<option value="${role}">${role}</option>`;
            });
            list.innerHTML = html;
            if (sel) sel.innerHTML = options;
        };

        window.toggleViewOnly = function(role) { roleSettings[role].viewOnly = !roleSettings[role].viewOnly; saveConfig(); renderRoleSettings(); applyPermissions(); };
        window.togglePerm = function(role, menu) { const idx = roleSettings[role].menus.indexOf(menu); if(idx>-1) roleSettings[role].menus.splice(idx,1); else roleSettings[role].menus.push(menu); saveConfig(); applyPermissions(); renderRoleSettings(); };
        window.addNewRole = function() { const name = document.getElementById('newRoleName').value.trim().toLowerCase(); if(name && !roleSettings[name]) { roleSettings[name]={menus:[],viewOnly:false}; saveConfig(); renderRoleSettings(); } };
        window.deleteRole = function(role) { if(confirm(`‡∏•‡∏ö Role: ${role}?`)) { delete roleSettings[role]; saveConfig(); renderRoleSettings(); } };

        // ---- STOCK TOOL ----
        window.openCentralStock = function() {
            document.getElementById('dashboardView').classList.add('hidden');
            document.getElementById('toolAppContainer').classList.remove('hidden');
            tempCountData = {};
            renderStockTool(warehouseList[0]);
        };

        window.renderStockTool = async function(zone) {
            const container = document.getElementById('toolAppContainer');
            const allowedIds = zoneProductMap[zone] || [];
            const zoneProducts = allProducts.filter(p => allowedIds.includes(p.id));
            const usersSnap = await getDocs(collection(db,'users'));
            let staffOptions = '';
            usersSnap.forEach(d => { const u = d.data(); if(u.status !== 'suspended') staffOptions += `<option value="${u.name}" ${selectedStaff===u.name?'selected':''}>${u.name}</option>`; });

            container.innerHTML = `
                <div class="tool-header no-print">
                    <h2>üì¶ ‡∏ô‡∏±‡∏ö‡∏™‡∏ï‡πä‡∏≠‡∏Å: ${zone}</h2>
                    <button onclick="closeTool()">‚úï ‡∏õ‡∏¥‡∏î</button>
                </div>
                <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:15px;margin-bottom:20px;" class="no-print">
                    <div class="input-group">
                        <label>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏ã‡∏ô</label>
                        <select onchange="renderStockTool(this.value)" style="width:100%;border:none;font-weight:bold;outline:none;">
                            ${warehouseList.map(w=>`<option ${w===zone?'selected':''}>${w}</option>`).join('')}
                        </select>
                    </div>
                    <div class="input-group" style="border:2px solid var(--info);">
                        <label>üë§ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏ô‡∏ô‡∏±‡∏ö</label>
                        <select id="staffName" onchange="selectedStaff=this.value" style="width:100%;border:none;font-weight:bold;outline:none;">
                            <option value="">-- ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å --</option>${staffOptions}
                        </select>
                    </div>
                    <div class="input-group" style="background:#f1f5f9;">
                        <label>üìù ‡∏ú‡∏π‡πâ‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏´‡∏•‡∏±‡∏Å</label>
                        <b>${currentUser.name}</b>
                    </div>
                </div>
                <table class="stock-table">
                    ${zoneProducts.map(p => {
                        const baseTotal = countData[p.id]?.total || 0;
                        const added = tempCountData[p.id]?.added || 0;
                        const lastUpdate = countData[p.id]?.lastUpdate || '-';
                        return `<tr class="stock-row">
                            <td>
                                <b style="font-size:16px;">${p.id}</b><br>
                                <span style="color:#475569;">${p.name}</span><br>
                                <small style="color:#94a3b8;font-size:10px;">‡∏ô‡∏±‡∏ö‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: ${lastUpdate}</small>
                            </td>
                            <td style="text-align:right;">
                                <div style="display:flex;align-items:center;justify-content:flex-end;gap:12px;">
                                    <div style="text-align:right;">
                                        <div style="font-weight:bold;font-size:18px;${added>0?'color:var(--info);':'color:var(--success);'}">
                                            ${added>0?'‡∏£‡∏≠‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô: ':'‡∏™‡∏ï‡πä‡∏≠‡∏Å: '} ${baseTotal+added}
                                        </div>
                                        <small style="color:#94a3b8;">‡∏´‡∏ô‡πà‡∏ß‡∏¢: ${p.unit}</small>
                                    </div>
                                    <input type="number" id="input-${p.id}" class="no-print" style="width:70px;padding:10px;border-radius:8px;border:1px solid #cbd5e1;text-align:center;font-weight:bold;" placeholder="0">
                                    <button onclick="updateStockTemp(event,'${p.id}','${p.name}','${zone}')" class="btn-action" style="background:var(--info);">Ôºã</button>
                                </div>
                            </td>
                        </tr>`;
                    }).join('')}
                </table>
                <div style="margin-top:40px;text-align:center;" class="no-print">
                    <button onclick="finalSaveStock('${zone}')" style="background:var(--success);color:white;padding:18px 60px;border:none;border-radius:15px;font-size:20px;font-weight:bold;cursor:pointer;box-shadow:0 4px 15px rgba(16,185,129,0.4);">
                        üíæ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÅ‡∏•‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                    </button>
                </div>`;
        };

        window.updateStockTemp = function(event, id, name, zone) {
            const btn = event.currentTarget, inputEl = document.getElementById(`input-${id}`);
            const val = parseFloat(inputEl.value) || 0;
            if(val===0) return;
            if(!tempCountData[id]) tempCountData[id] = { added:0, name };
            tempCountData[id].added += val;
            btn.innerText = "OK"; btn.style.background = "#059669";
            setTimeout(() => { btn.innerText = "Ôºã"; btn.style.background = ""; inputEl.value = ""; renderStockTool(zone); }, 350);
        };

        window.finalSaveStock = async function(zone) {
            if (!selectedStaff) { toast('‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏ô‡∏ô‡∏±‡∏ö‡∏Å‡πà‡∏≠‡∏ô', '#c2410c'); return; }
            if (Object.keys(tempCountData).length === 0) { toast('‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á', '#c2410c'); return; }
            if (!confirm(`‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÇ‡∏î‡∏¢‡∏Ñ‡∏∏‡∏ì ${selectedStaff}?`)) return;
            const now = new Date();
            const timeStr = now.toLocaleDateString('th-TH') + " " + now.toLocaleTimeString('th-TH', { hour:'2-digit', minute:'2-digit' });
            Object.keys(tempCountData).forEach(id => {
                if(!countData[id]) countData[id] = { total:0, name: tempCountData[id].name };
                countData[id].total += tempCountData[id].added;
                countData[id].lastUpdate = timeStr;
                countData[id].countedBy = selectedStaff;
            });
            await saveCountData();
            tempCountData = {};
            toast('‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', '#059669');
            renderStockTool(zone);
        };

        // ---- WAREHOUSE MANAGER ----
        window.openWarehouseManager = function() {
            document.getElementById('dashboardView').classList.add('hidden');
            const container = document.getElementById('toolAppContainer');
            container.classList.remove('hidden');
            container.innerHTML = `
                <div class="tool-header">
                    <h2>‚öôÔ∏è ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏•‡∏±‡∏á‡πÅ‡∏•‡∏∞‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</h2>
                    <button onclick="closeTool()">‚úï ‡∏õ‡∏¥‡∏î</button>
                </div>
                <div style="display:grid;grid-template-columns:1fr 1.2fr;gap:25px;">
                    <div style="background:white;padding:20px;border-radius:15px;border:1px solid #e2e8f0;">
                        <h4>üì¶ ‡∏Ñ‡∏•‡∏±‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (Zones)</h4>
                        <div style="display:flex;gap:8px;margin-bottom:15px;">
                            <input type="text" id="newWhName" placeholder="‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏•‡∏±‡∏á/‡πÇ‡∏ã‡∏ô‡πÉ‡∏´‡∏°‡πà" style="flex:1;padding:10px;border-radius:8px;border:1px solid #ddd;">
                            <button onclick="addWh()" style="background:var(--success);color:white;padding:10px 20px;border:none;border-radius:8px;cursor:pointer;">‡πÄ‡∏û‡∏¥‡πà‡∏°</button>
                        </div>
                        <div id="whListContainer"></div>
                    </div>
                    <div style="background:white;padding:20px;border-radius:15px;border:1px solid #e2e8f0;">
                        <h4>üçé ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</h4>
                        <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:10px;">
                            <input type="text" id="newPdId" placeholder="‡∏£‡∏´‡∏±‡∏™ SKU" style="padding:10px;border:1px solid #ddd;border-radius:8px;">
                            <input type="text" id="newPdUnit" placeholder="‡∏´‡∏ô‡πà‡∏ß‡∏¢" style="padding:10px;border:1px solid #ddd;border-radius:8px;">
                            <input type="text" id="newPdName" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤" style="grid-column:span 2;padding:10px;border:1px solid #ddd;border-radius:8px;">
                            <button onclick="addPd()" style="grid-column:span 2;background:var(--info);color:white;padding:12px;border-radius:8px;border:none;cursor:pointer;font-weight:bold;">+ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</button>
                        </div>
                        <div id="pdMasterContainer" style="max-height:200px;overflow-y:auto;border-top:1px solid #eee;padding-top:10px;"></div>
                    </div>
                </div>
                <div style="margin-top:25px;background:white;padding:25px;border-radius:15px;border:1px solid #e2e8f0;">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
                        <h4 style="margin:0;">üîó ‡∏à‡∏±‡∏ö‡∏Ñ‡∏π‡πà‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡πÇ‡∏ã‡∏ô</h4>
                        <select id="selectZoneMap" onchange="renderMapping()" style="padding:12px;border-radius:8px;min-width:300px;border:2px solid var(--primary-dark);font-weight:bold;"></select>
                    </div>
                    <div id="mappingContainer" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:12px;"></div>
                </div>`;
            renderWhList(); renderPdList();
            document.getElementById('selectZoneMap').innerHTML = warehouseList.map(wh=>`<option value="${wh}">${wh}</option>`).join('');
            renderMapping();
        };

        window.renderWhList = function() { const c = document.getElementById('whListContainer'); if(!c) return; c.innerHTML = warehouseList.map((wh,i)=>`<div style="display:flex;justify-content:space-between;align-items:center;padding:12px;border-bottom:1px solid #f1f5f9;"><span style="font-weight:bold;">${wh}</span><button onclick="deleteWh(${i})" style="color:var(--danger);background:none;border:none;cursor:pointer;">üóëÔ∏è</button></div>`).join(''); };
        window.renderPdList = function() { const c = document.getElementById('pdMasterContainer'); if(!c) return; c.innerHTML = allProducts.map((p,i)=>`<div style="font-size:12px;padding:8px;background:#f8fafc;margin-bottom:5px;display:flex;justify-content:space-between;border-radius:6px;border:1px solid #edf2f7;"><span><b>${p.id}</b> - ${p.name} (${p.unit})</span><span onclick="deletePd(${i})" style="cursor:pointer;color:#cbd5e1;">‚úï</span></div>`).join(''); };
        window.renderMapping = function() { const zone=document.getElementById('selectZoneMap').value, c=document.getElementById('mappingContainer'); if(!zone||!c) return; const mapped=zoneProductMap[zone]||[]; c.innerHTML=allProducts.map(pd=>`<label style="display:flex;align-items:center;gap:12px;padding:15px;border:1px solid #e2e8f0;border-radius:12px;cursor:pointer;background:white;"><input type="checkbox" style="width:18px;height:18px;" ${mapped.includes(pd.id)?'checked':''} onchange="togglePdMapping('${zone}','${pd.id}')"><div style="font-size:13px;"><b>${pd.id}</b><br><span style="color:#64748b;">${pd.name}</span></div></label>`).join(''); };
        window.togglePdMapping = function(zone,id) { if(!zoneProductMap[zone]) zoneProductMap[zone]=[]; const idx=zoneProductMap[zone].indexOf(id); if(idx>-1) zoneProductMap[zone].splice(idx,1); else zoneProductMap[zone].push(id); saveConfig(); };
        window.addWh = function() { const n=document.getElementById('newWhName').value.trim(); if(n){warehouseList.push(n); saveConfig(); openWarehouseManager();} };
        window.deleteWh = function(i) { if(confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡∏ö‡πÇ‡∏ã‡∏ô?')){warehouseList.splice(i,1); saveConfig(); openWarehouseManager();} };
        window.addPd = function() { const id=document.getElementById('newPdId').value.trim(), unit=document.getElementById('newPdUnit').value.trim(), name=document.getElementById('newPdName').value.trim(); if(id&&name&&unit){allProducts.push({id,name,unit}); saveConfig(); renderPdList(); renderMapping(); document.getElementById('newPdId').value=document.getElementById('newPdUnit').value=document.getElementById('newPdName').value='';} };
        window.deletePd = function(i) { if(confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤?')){allProducts.splice(i,1); saveConfig(); renderPdList(); renderMapping();} };

        // ---- PERMISSIONS ----
        window.applyPermissions = function() {
            // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô viewOnly ‡πÉ‡∏´‡πâ‡πÄ‡∏´‡πá‡∏ô‡πÄ‡∏°‡∏ô‡∏π‡∏ó‡∏∏‡∏Å‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô admin
const effectivePerms = isViewOnly ? ["warehouse","tools","admin"] : perms;
document.getElementById('warehouseMenu').classList.toggle('hidden',!effectivePerms.includes('warehouse'));
document.getElementById('toolsMenu').classList.toggle('hidden',!effectivePerms.includes('tools'));
document.getElementById('adminMenu').classList.toggle('hidden',!effectivePerms.includes('admin'));
document.getElementById('bannerAdminSection').classList.toggle('hidden',!effectivePerms.includes('admin'));
            document.getElementById('bannerAdminSection').classList.toggle('hidden',!perms.includes('admin'));
            document.getElementById('viewOnlyAlert').classList.toggle('hidden',!isViewOnly);
            let s=document.getElementById("viewOnlyStyle");
            if(isViewOnly){if(!s){const st=document.createElement('style'); st.id="viewOnlyStyle"; st.innerHTML=`.btn-action,button:not(.no-print):not([onclick*="closeTool"]):not([onclick*="logout"]),input[type="number"],input[type="file"],.stock-table input{display:none!important;}`; document.head.appendChild(st);}} else if(s){s.remove();}
            document.getElementById('roleStatusText').innerText="‡∏ê‡∏≤‡∏ô‡∏∞: "+role.toUpperCase();
        };

        window.checkToolExpiry = async function() {
            const now=new Date().getTime(), perms=roleSettings[currentUser.role]?.menus||[], menu=document.getElementById('toolsMenu');
            if(!perms.includes('tools')){menu.classList.add('hidden'); return;}
            if(currentUser.role==='admin'){menu.classList.remove('hidden'); document.getElementById('timerDisplay').innerText="‚è≥ ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå: ‡∏ñ‡∏≤‡∏ß‡∏£"; return;}
            try {
                const snap=await getDoc(doc(db,'users',currentUser.username));
                if(!snap.exists()){menu.classList.add('hidden'); return;}
                const expiry=snap.data().toolExpiry||0;
                if(now<expiry){
                    menu.classList.remove('hidden');
                    if(expiry>4000000000000){document.getElementById('timerDisplay').innerText="‚è≥ ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå: ‡∏ñ‡∏≤‡∏ß‡∏£";}
                    else{const diff=Math.floor((expiry-now)/60000); document.getElementById('timerDisplay').innerText=`‚è≥ ‡πÄ‡∏´‡∏•‡∏∑‡∏≠: ${Math.floor(diff/60)}‡∏ä‡∏°. ${diff%60}‡∏ô.`;}
                } else {menu.classList.add('hidden');}
            } catch(e){}
        };

        // ---- STOCK SUMMARY ----
        window.openStockSummary = function() {
            document.getElementById('dashboardView').classList.add('hidden');
            const container = document.getElementById('toolAppContainer');
            container.classList.remove('hidden');
            let rows = "";
            Object.keys(countData).forEach(id => {
                const pd = allProducts.find(p=>p.id===id);
                if(countData[id].total>0) rows+=`<tr><td style="padding:10px;">${id}</td><td>${countData[id].name}</td><td style="text-align:center;"><b>${countData[id].total}</b></td><td>${pd?pd.unit:''}</td><td style="font-size:11px;">${countData[id].lastUpdate}</td><td style="font-size:11px;">${countData[id].countedBy||'-'}</td></tr>`;
            });
            container.innerHTML = `
                <div class="tool-header">
                    <h2>üìä ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏ï‡πä‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h2>
                    <div class="no-print">
                        <button onclick="exportAllStockData()" style="background:var(--success);color:white;padding:10px;border-radius:8px;cursor:pointer;">Export Excel</button>
                        <button onclick="window.print()" style="background:var(--danger);color:white;padding:10px;border-radius:8px;cursor:pointer;">Print PDF</button>
                        <button onclick="closeTool()" style="margin-left:10px;">‚úï</button>
                    </div>
                </div>
                <table style="width:100%;border-collapse:collapse;background:white;border-radius:10px;overflow:hidden;">
                    <thead style="background:var(--primary-dark);color:white;">
                        <tr><th style="padding:12px;">SKU</th><th>‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th><th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th><th>‡∏´‡∏ô‡πà‡∏ß‡∏¢</th><th>‡∏ô‡∏±‡∏ö‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</th><th>‡∏Ñ‡∏ô‡∏ô‡∏±‡∏ö</th></tr>
                    </thead>
                    <tbody>${rows||'<tr><td colspan="6" style="text-align:center;padding:20px;">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>'}</tbody>
                </table>`;
        };

        window.exportAllStockData = function() {
            const data=[["‡∏£‡∏´‡∏±‡∏™","‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤","‡∏à‡∏≥‡∏ô‡∏ß‡∏ô","‡∏´‡∏ô‡πà‡∏ß‡∏¢","‡πÄ‡∏ß‡∏•‡∏≤","‡∏Ñ‡∏ô‡∏ô‡∏±‡∏ö"]];
            Object.keys(countData).forEach(id=>{if(countData[id].total>0) data.push([id,countData[id].name,countData[id].total,"",countData[id].lastUpdate,countData[id].countedBy]);});
            const ws=XLSX.utils.aoa_to_sheet(data), wb=XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb,ws,"Stock");
            XLSX.writeFile(wb,`Stock_Report.xlsx`);
        };

        window.logout = function() { localStorage.removeItem("currentUser"); window.location.href = "login.html"; };
        window.toggleSub = function(id) { const s=document.getElementById(id); s.style.display=(s.style.display==='block')?'none':'block'; };
        window.closeTool = function() { if(Object.keys(tempCountData).length>0){if(!confirm("‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏õ‡∏¥‡∏î‡∏à‡∏£‡∏¥‡∏á‡πÑ‡∏´‡∏°?")) return;} document.getElementById('toolAppContainer').classList.add('hidden'); document.getElementById('dashboardView').classList.remove('hidden'); };
    </script>
    <script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>
</body>
</html>
