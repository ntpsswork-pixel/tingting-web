<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TingTing Dashboard</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <style>
        :root { --sidebar-width: 260px; --primary-dark: #1e293b; --accent-gold: #fccf55; --bg-light: #f1f5f9; --success: #10b981; --danger: #ef4444; --info: #3b82f6; }
        body { margin: 0; display: flex; font-family: 'Segoe UI', Tahoma, sans-serif; background: var(--bg-light); min-height: 100vh; overflow-x: hidden; }
        .sidebar { width: var(--sidebar-width); height: 100vh; background: var(--primary-dark); color: white; position: fixed; left: 0; top: 0; z-index: 1000; display: flex; flex-direction: column; }
        .sidebar-brand { padding: 30px 20px; text-align: center; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .sidebar-brand h2 { margin: 0; color: var(--accent-gold); font-size: 24px; letter-spacing: 2px; }
        .user-info { padding: 20px; margin: 15px; background: rgba(255,255,255,0.05); border-radius: 12px; font-size: 14px; }
        .user-info b { color: var(--accent-gold); display: block; margin-bottom: 4px; }
        .nav-links { flex: 1; padding: 10px 15px; overflow-y: auto; }
        .nav-item { padding: 12px 15px; cursor: pointer; border-radius: 8px; margin-bottom: 5px; transition: 0.3s; display: flex; align-items: center; gap: 10px; color: #cbd5e1; }
        .nav-item:hover { background: rgba(255,255,255,0.05); }
        .nav-item.active { background: var(--accent-gold); color: var(--primary-dark); font-weight: bold; }
        .submenu { padding-left: 20px; display: none; margin-bottom: 10px; border-left: 1px solid #334155; margin-left: 20px; }
        .submenu div { padding: 8px 12px; font-size: 13px; color: #94a3b8; cursor: pointer; border-radius: 5px; }
        .submenu div:hover { color: white; background: rgba(255,255,255,0.05); }
        .main-content { margin-left: var(--sidebar-width); width: calc(100% - var(--sidebar-width)); flex: 1; }
        .banner-container { width: 100%; height: 380px; background: #000; overflow: hidden; position: relative; }
        .app-container { padding: 30px; animation: fadeIn 0.4s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .tool-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; border-bottom: 2px solid #e2e8f0; padding-bottom: 15px; }
        .user-card { background: white; border-radius: 15px; padding: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.03); border: 1px solid #e2e8f0; }
        .stock-table { width: 100%; border-collapse: separate; border-spacing: 0 8px; }
        .stock-row { background: white; border-radius: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.02); }
        .stock-row td { padding: 15px; }
        .btn-action { width: 40px; height: 40px; border-radius: 8px; border: none; color: white; cursor: pointer; transition: 0.2s; font-weight: bold; }
        .hidden { display: none !important; }
        .input-group { background: white; padding: 10px; border-radius: 10px; border: 1px solid #e2e8f0; }
        .input-group label { display: block; font-size: 11px; color: #64748b; margin-bottom: 3px; font-weight: bold; }
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 9999; display: flex; align-items: center; justify-content: center; animation: fadeIn 0.2s ease; }
        .modal-box { background: white; border-radius: 20px; padding: 32px; width: 420px; box-shadow: 0 24px 60px rgba(0,0,0,0.3); max-height: 85vh; overflow-y: auto; }
        .modal-box h3 { margin: 0 0 20px; color: var(--primary-dark); font-size: 18px; }
        .modal-box input { width: 100%; padding: 12px 14px; border: 1px solid #e2e8f0; border-radius: 10px; font-size: 14px; margin-bottom: 12px; box-sizing: border-box; outline: none; transition: border 0.2s; font-family: 'Segoe UI', sans-serif; }
        .modal-box input:focus { border-color: var(--info); }
        .modal-error { color: var(--danger); font-size: 12px; margin-bottom: 10px; display: none; }
        .toast { position: fixed; bottom: 30px; right: 30px; background: #1e293b; color: white; padding: 14px 20px; border-radius: 12px; font-size: 14px; z-index: 99999; animation: toastIn 0.3s ease; box-shadow: 0 8px 24px rgba(0,0,0,0.3); max-width: 300px; }
        @keyframes toastIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .upload-progress { display: none; margin-top: 10px; background: #f1f5f9; border-radius: 8px; overflow: hidden; height: 8px; }
        .upload-progress-bar { height: 100%; background: var(--success); transition: width 0.3s; width: 0%; }
        .filter-bar { background: white; padding: 20px; border-radius: 15px; border: 1px solid #e2e8f0; margin-bottom: 20px; display: flex; gap: 15px; flex-wrap: wrap; align-items: flex-end; }
        .filter-bar label { font-size: 11px; color: #64748b; font-weight: bold; display: block; margin-bottom: 5px; }
        .filter-bar select, .filter-bar input[type="date"] { padding: 10px 14px; border: 1px solid #e2e8f0; border-radius: 10px; font-size: 14px; outline: none; min-width: 180px; }
        .filter-bar select:focus, .filter-bar input:focus { border-color: var(--info); }
        .history-card { background: white; border-radius: 12px; border: 1px solid #e2e8f0; margin-bottom: 15px; overflow: hidden; }
        .history-card-header { padding: 15px 20px; background: #f8fafc; border-bottom: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center; }
        .item-row { display: flex; align-items: center; gap: 8px; padding: 8px; border:1px solid #f1f5f9; border-radius: 8px; margin-bottom: 6px; background: #f8fafc; font-size: 13px; }
        .item-row span { flex: 1; }
        .btn-sm { padding: 4px 10px; border-radius: 6px; border: none; cursor: pointer; font-size: 12px; font-weight: bold; }
        @media print {
            .sidebar, .no-print, button, #bannerAdminSection { display: none !important; }
            .main-content { margin-left: 0 !important; width: 100% !important; }
            .app-container { padding: 0 !important; }
            table { width: 100% !important; border: 1px solid #000 !important; }
            th, td { border: 1px solid #ddd !important; padding: 8px !important; }
            .history-card { break-inside: avoid; }
        }
    </style>
</head>
<body>
    <div class="sidebar no-print">
        <div class="sidebar-brand"><h2>TINGTING</h2></div>
        <div class="user-info">
            <small>‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô:</small>
            <b id="roleDisplay">...</b>
            <small id="roleStatusText">‡∏ê‡∏≤‡∏ô‡∏∞: -</small>
            <div id="timerDisplay" style="color:var(--accent-gold);font-weight:bold;font-size:12px;margin-top:8px;"></div>
        </div>
        <div style="padding:0 15px 5px;">
            <button onclick="openChangePasswordModal()" style="width:100%;background:rgba(255,255,255,0.05);color:#94a3b8;border:1px solid #334155;padding:9px;border-radius:8px;cursor:pointer;font-size:12px;">üîë ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô Password</button>
        </div>
        <div class="nav-links">
            <div class="nav-item active" onclick="location.reload()">üè† ‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å Dashboard</div>
            <div id="warehouseMenu" class="hidden">
                <div class="nav-item" onclick="toggleSub('subWH')">üì¶ ‡∏Ñ‡∏•‡∏±‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ ‚ñæ</div>
                <div id="subWH" class="submenu">
                    <div onclick="openStockSummary()" style="color:var(--accent-gold);">üìä ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ & Export ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</div>
                </div>
            </div>
            <div id="toolsMenu" class="hidden">
                <div class="nav-item" onclick="toggleSub('subTools')" style="color:var(--success);">üõ†Ô∏è ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô ‚ñæ</div>
                <div id="subTools" class="submenu">
                    <div onclick="openCentralStock()">‚óè ‡∏ô‡∏±‡∏ö‡∏™‡∏ï‡πä‡∏≠‡∏Å‡∏Ñ‡∏£‡∏±‡∏ß‡∏Å‡∏•‡∏≤‡∏á</div>
                </div>
            </div>
            <div id="adminMenu" class="hidden">
                <div class="nav-item" onclick="toggleSub('subAdmin')" style="color:var(--accent-gold);">üë§ ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡∏ö‡∏ö ‚ñæ</div>
                <div id="subAdmin" class="submenu">
                    <div onclick="openUserManagement()">‚óè ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô & ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå</div>
                    <div onclick="openWarehouseManager()" style="color:var(--accent-gold);">‚óè ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏•‡∏±‡∏á‡πÅ‡∏•‡∏∞‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</div>
                </div>
            </div>
        </div>
        <div class="nav-item" onclick="logout()" style="color:var(--danger);border-top:1px solid rgba(255,255,255,0.05);margin-top:auto;padding:20px;">üö™ ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</div>
    </div>

    <div class="main-content">
        <div id="dashboardView" class="no-print">
            <div class="banner-container">
                <div class="swiper mySwiper">
                    <div class="swiper-wrapper" id="bannerWrapper"></div>
                    <div class="swiper-pagination"></div>
                </div>
            </div>
            <div id="bannerAdminSection" class="app-container hidden">
                <div style="background:white;padding:20px;border-radius:15px;border:1px solid #e2e8f0;">
                    <h3 style="margin-top:0;">üì∏ ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏ö‡∏ô‡πÄ‡∏ô‡∏≠‡∏£‡πå (Admin Only)</h3>
                    <div style="display:flex;gap:10px;margin-bottom:10px;">
                        <input type="file" id="bannerFile" accept="image/*" style="flex:1;padding:8px;border:1px solid #ddd;border-radius:8px;">
                        <button onclick="uploadBanner()" style="background:var(--success);color:white;border:none;padding:10px 20px;border-radius:8px;cursor:pointer;">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏ö‡∏ô‡πÄ‡∏ô‡∏≠‡∏£‡πå</button>
                    </div>
                    <div class="upload-progress" id="uploadProgress"><div class="upload-progress-bar" id="uploadProgressBar"></div></div>
                    <div id="thumbList" style="display:flex;gap:12px;flex-wrap:wrap;margin-top:15px;"></div>
                </div>
            </div>
            <div style="padding:30px;">
                <h3>‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö‡∏™‡∏π‡πà TingTing Dashboard</h3>
                <p>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏°‡∏ô‡∏π‡∏ó‡∏≤‡∏á‡∏ã‡πâ‡∏≤‡∏¢‡∏°‡∏∑‡∏≠‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</p>
                <div id="viewOnlyAlert" class="hidden" style="background:#fff7ed;color:#c2410c;padding:15px;border-radius:10px;border:1px solid #fdba74;margin-top:20px;">
                    ‚ö†Ô∏è <b>‡πÇ‡∏´‡∏°‡∏î‡∏î‡∏π‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß:</b> ‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏´‡∏£‡∏∑‡∏≠‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏î‡πâ
                </div>
            </div>
        </div>
        <div id="toolAppContainer" class="app-container hidden"></div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
        import { getFirestore, doc, getDoc, getDocs, setDoc, addDoc, collection } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDOduBfKHKwObxOk3MUMGxj1PGT23p_swM",
            authDomain: "tingting-3d57f.firebaseapp.com",
            projectId: "tingting-3d57f",
            storageBucket: "tingting-3d57f.firebasestorage.app",
            messagingSenderId: "998609441304",
            appId: "1:998609441304:web:0c7fbedf869fa2335d296d"
        };

        const CLOUDINARY_CLOUD  = "dof4vtj87";
        const CLOUDINARY_PRESET = "tingting_banners";

        const app = initializeApp(firebaseConfig);
        const db  = getFirestore(app);

        let currentUser    = JSON.parse(localStorage.getItem("currentUser")) || null;
        let warehouseList  = ["‡∏Ñ‡∏•‡∏±‡∏á‡∏´‡∏•‡∏±‡∏Å"];
        let allProducts    = [];
        let zoneProductMap = {};
        let countData      = {};
        let roleSettings   = {
            admin:     { menus: ["warehouse","tools","admin"], viewOnly: false },
            warehouse: { menus: ["warehouse","tools"],         viewOnly: false },
            staff:     { menus: ["tools"],                     viewOnly: false }
        };
        let tempCountData = {};
        let selectedStaff = "";
        let selectedDate = new Date().toISOString().split('T')[0]; // ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô default

        // ---- UTILS ----
        async function hashPassword(p) {
            const buf = await crypto.subtle.digest('SHA-256', new TextEncoder().encode(p));
            return Array.from(new Uint8Array(buf)).map(b => b.toString(16).padStart(2,'0')).join('');
        }

        function toast(msg, color = '#1e293b') {
            document.querySelectorAll('.toast').forEach(t => t.remove());
            const t = document.createElement('div');
            t.className = 'toast'; t.style.background = color; t.innerText = msg;
            document.body.appendChild(t);
            setTimeout(() => t.remove(), 3000);
        }

        // ---- FIREBASE HELPERS ----
        async function loadConfig() {
            try {
                const snap = await getDoc(doc(db,'config','main'));
                if (snap.exists()) {
                    const d = snap.data();
                    if (d.warehouseList)  warehouseList  = d.warehouseList;
                    if (d.allProducts)    allProducts    = d.allProducts;
                    if (d.zoneProductMap) zoneProductMap = d.zoneProductMap;
                    if (d.roleSettings)   roleSettings   = d.roleSettings;
                }
            } catch(e) { console.error(e); }
        }

        async function saveConfig() {
            try { await setDoc(doc(db,'config','main'), { warehouseList, allProducts, zoneProductMap, roleSettings }, { merge:true }); }
            catch(e) { toast('‚ùå ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å config ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à','#c2410c'); }
        }

        async function loadCountData() {
            try { const s = await getDoc(doc(db,'stock','countData')); if (s.exists()) countData = s.data(); }
            catch(e) { console.error(e); }
        }

        async function saveCountData() {
            try { await setDoc(doc(db,'stock','countData'), countData); }
            catch(e) { toast('‚ùå ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏ï‡πä‡∏≠‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à','#c2410c'); }
        }

        async function loadBanners() {
            try { const s = await getDoc(doc(db,'config','banners')); return s.exists() ? (s.data().urls || []) : []; }
            catch(e) { return []; }
        }

        async function saveBanners(urls) { await setDoc(doc(db,'config','banners'), { urls }); }

        function getVisibleWarehouses() {
            const u = currentUser;
            if (u.username && u.username.toUpperCase().startsWith('BT000')) {
                return u.assignedZones && u.assignedZones.length > 0 ? u.assignedZones : [];
            }
            return warehouseList;
        }

        // ---- ONLOAD ----
        window.onload = async function() {
            if (!currentUser) { window.location.href = 'login.html'; return; }
            document.getElementById('roleDisplay').innerText = currentUser.name;
            await loadConfig();
            await loadCountData();
            applyPermissions();
            await renderBanners();
            setInterval(checkToolExpiry, 5000);
            setInterval(checkHardBanStatus, 10000);
        };

        // ---- PERMISSIONS ----
        window.applyPermissions = function() {
            const role       = currentUser.role || 'guest';
            const perms      = roleSettings[role]?.menus || [];
            const isViewOnly = roleSettings[role]?.viewOnly || false;
            const effectivePerms = isViewOnly ? ["warehouse","tools","admin"] : perms;

            document.getElementById('warehouseMenu').classList.toggle('hidden', !effectivePerms.includes('warehouse'));
            document.getElementById('toolsMenu').classList.toggle('hidden', !effectivePerms.includes('tools'));
            document.getElementById('adminMenu').classList.toggle('hidden', !effectivePerms.includes('admin'));
            document.getElementById('bannerAdminSection').classList.toggle('hidden', !effectivePerms.includes('admin'));
            document.getElementById('viewOnlyAlert').classList.toggle('hidden', !isViewOnly);

            let existingStyle = document.getElementById("viewOnlyStyle");
            if (isViewOnly) {
                if (!existingStyle) {
                    const st = document.createElement('style');
                    st.id = "viewOnlyStyle";
                    st.innerHTML = `
                        button[onclick*="finalSaveStock"], button[onclick*="addNewUser"],
                        button[onclick*="addWh"], button[onclick*="addPd"],
                        button[onclick*="grantAccess"], button[onclick*="revokeAccess"],
                        button[onclick*="unbanUser"], button[onclick*="requestDelete"],
                        button[onclick*="cancelDelete"], button[onclick*="adminResetPassword"],
                        button[onclick*="uploadBanner"], button[onclick*="delBanner"],
                        button[onclick*="updateStockTemp"], button[onclick*="saveEdit"],
                        button[onclick*="saveAssignedZones"], .btn-action { display: none !important; }
                        .viewonly-input { pointer-events: none !important; opacity: 0.7 !important; }
                    `;
                    document.head.appendChild(st);
                }
            } else if (existingStyle) { existingStyle.remove(); }

            document.getElementById('roleStatusText').innerText = "‡∏ê‡∏≤‡∏ô‡∏∞: " + role.toUpperCase() + (isViewOnly ? " (‡∏î‡∏π‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß)" : "");
        };

        window.checkToolExpiry = async function() {
            const now=new Date().getTime(), role=currentUser.role||'guest';
            const perms=roleSettings[role]?.menus||[], isVO=roleSettings[role]?.viewOnly||false;
            const effP = isVO ? ["warehouse","tools","admin"] : perms;
            const menu = document.getElementById('toolsMenu');
            if (!effP.includes('tools')) { menu.classList.add('hidden'); return; }
            if (role==='admin') { menu.classList.remove('hidden'); document.getElementById('timerDisplay').innerText="‚è≥ ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå: ‡∏ñ‡∏≤‡∏ß‡∏£"; return; }
            try {
                const snap=await getDoc(doc(db,'users',currentUser.username));
                if (!snap.exists()) { menu.classList.add('hidden'); return; }
                const expiry=snap.data().toolExpiry||0;
                if (now<expiry) {
                    menu.classList.remove('hidden');
                    if (expiry>4000000000000) { document.getElementById('timerDisplay').innerText="‚è≥ ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå: ‡∏ñ‡∏≤‡∏ß‡∏£"; }
                    else { const d=Math.floor((expiry-now)/60000); document.getElementById('timerDisplay').innerText=`‚è≥ ‡πÄ‡∏´‡∏•‡∏∑‡∏≠: ${Math.floor(d/60)}‡∏ä‡∏°. ${d%60}‡∏ô.`; }
                } else { menu.classList.add('hidden'); }
            } catch(e) {}
        };

        window.checkHardBanStatus = async function() {
            if (!currentUser||currentUser.username==='admin') return;
            try {
                const snap=await getDoc(doc(db,'users',currentUser.username));
                if (snap.exists()&&snap.data().status==='suspended') { alert('üö´ ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ñ‡∏π‡∏Å‡∏£‡∏∞‡∏á‡∏±‡∏ö!'); logout(); }
            } catch(e) {}
        };

        // ---- BANNER ----
        window.renderBanners = async function() {
            const urls=await loadBanners();
            const defUrl="https://images.unsplash.com/photo-1504674900247-0877df9cc836?auto=format&fit=crop&w=1200&q=80";
            const show=urls.length>0?urls:[defUrl];
            const wrapper=document.getElementById('bannerWrapper');
            if (wrapper) {
                wrapper.innerHTML=show.map(u=>`<div class="swiper-slide"><img src="${u}" style="width:100%;height:100%;object-fit:cover;"></div>`).join('');
                if (window._sw) { try{window._sw.destroy(true,true);}catch(e){} }
                window._sw=new Swiper(".mySwiper",{pagination:{el:".swiper-pagination"},autoplay:{delay:3500},loop:show.length>1});
            }
            const tl=document.getElementById("thumbList");
            if (tl) tl.innerHTML=urls.map((u,i)=>`<div style="position:relative;"><img src="${u}" style="width:100px;height:60px;object-fit:cover;border-radius:8px;border:1px solid #ddd;"><button onclick="delBanner(${i})" style="position:absolute;top:-5px;right:-5px;background:red;color:white;border:none;border-radius:50%;width:22px;height:22px;cursor:pointer;font-size:10px;">‚úï</button></div>`).join('');
        };

        window.uploadBanner = async function() {
            const file=document.getElementById('bannerFile').files[0];
            if (!file) { toast('‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡∏Å‡πà‡∏≠‡∏ô','#c2410c'); return; }
            const prog=document.getElementById('uploadProgress'), bar=document.getElementById('uploadProgressBar');
            prog.style.display='block'; bar.style.width='30%';
            try {
                const fd=new FormData(); fd.append('file',file); fd.append('upload_preset',CLOUDINARY_PRESET);
                bar.style.width='60%';
                const res=await fetch(`https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD}/image/upload`,{method:'POST',body:fd});
                const data=await res.json();
                if (!data.secure_url) throw new Error('Upload failed');
                bar.style.width='90%';
                const cur=await loadBanners(); cur.push(data.secure_url);
                await saveBanners(cur); bar.style.width='100%';
                toast('‚úÖ ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏ö‡∏ô‡πÄ‡∏ô‡∏≠‡∏£‡πå‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!','#059669');
                document.getElementById('bannerFile').value='';
                setTimeout(()=>{prog.style.display='none';bar.style.width='0%';},1000);
                await renderBanners();
            } catch(e) { prog.style.display='none'; bar.style.width='0%'; toast('‚ùå ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à','#c2410c'); }
        };

        window.delBanner = async function(i) {
            if (!confirm('‡∏•‡∏ö‡πÅ‡∏ö‡∏ô‡πÄ‡∏ô‡∏≠‡∏£‡πå‡∏ô‡∏µ‡πâ?')) return;
            const urls=await loadBanners(); urls.splice(i,1);
            await saveBanners(urls); toast('üóëÔ∏è ‡∏•‡∏ö‡πÅ‡∏ö‡∏ô‡πÄ‡∏ô‡∏≠‡∏£‡πå‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢','#059669');
            await renderBanners();
        };

        // ---- CHANGE PASSWORD ----
        window.openChangePasswordModal = function() {
            if (currentUser.username==='admin'&&currentUser.role==='admin') { toast('‚ö†Ô∏è ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ Admin ‡∏´‡∏•‡∏±‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô Password ‡πÑ‡∏î‡πâ','#c2410c'); return; }
            const modal=document.createElement('div'); modal.className='modal-overlay'; modal.id='changePassModal';
            modal.innerHTML=`<div class="modal-box"><h3>üîë ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô Password</h3>
                <input type="password" id="oldPassInput" placeholder="Password ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô">
                <input type="password" id="newPassInput" placeholder="Password ‡πÉ‡∏´‡∏°‡πà">
                <input type="password" id="confirmPassInput" placeholder="‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô Password ‡πÉ‡∏´‡∏°‡πà">
                <div class="modal-error" id="passModalError"></div>
                <div style="display:flex;gap:10px;margin-top:8px;">
                    <button onclick="submitChangePassword()" style="flex:1;background:var(--info);color:white;border:none;padding:12px;border-radius:10px;cursor:pointer;font-weight:bold;">‚úÖ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</button>
                    <button onclick="closeModal()" style="flex:1;background:#f1f5f9;color:#475569;border:none;padding:12px;border-radius:10px;cursor:pointer;">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                </div></div>`;
            document.body.appendChild(modal);
        };

        window.submitChangePassword = async function() {
            const op=document.getElementById('oldPassInput').value, np=document.getElementById('newPassInput').value, cp=document.getElementById('confirmPassInput').value;
            const err=document.getElementById('passModalError'); err.style.display='none';
            if (!op||!np||!cp){err.innerText='‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö';err.style.display='block';return;}
            if (np!==cp){err.innerText='‚ùå Password ‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô';err.style.display='block';return;}
            if (np.length<4){err.innerText='‚ùå ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 4 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£';err.style.display='block';return;}
            try {
                const snap=await getDoc(doc(db,'users',currentUser.username));
                if (!snap.exists()){err.innerText='‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ';err.style.display='block';return;}
                const ho=await hashPassword(op), st=snap.data().password||await hashPassword('1234');
                if (ho!==st){err.innerText='‚ùå Password ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á';err.style.display='block';return;}
                await setDoc(doc(db,'users',currentUser.username),{password:await hashPassword(np)},{merge:true});
                closeModal(); toast('‚úÖ ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô Password ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!','#059669');
            } catch(e){err.innerText='‚ö†Ô∏è ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î';err.style.display='block';}
        };

        window.closeModal = function() { const m=document.getElementById('changePassModal'); if(m) m.remove(); };

        // ---- USER MANAGEMENT ----
        window.openUserManagement = function() {
            document.getElementById('dashboardView').classList.add('hidden');
            const c=document.getElementById('toolAppContainer'); c.classList.remove('hidden');
            c.innerHTML=`<div class="tool-header no-print"><h2>üë§ ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô & ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå Role</h2><button onclick="closeTool()">‚úï ‡∏õ‡∏¥‡∏î</button></div>
            <div style="display:grid;grid-template-columns:1fr 1.5fr;gap:25px;">
                <div style="background:white;padding:20px;border-radius:15px;border:1px solid #e2e8f0;">
                    <h4 style="margin-top:0;">üé≠ ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Role & ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå</h4>
                    <div style="display:flex;gap:8px;margin-bottom:15px;">
                        <input type="text" id="newRoleName" placeholder="‡∏ä‡∏∑‡πà‡∏≠ Role ‡πÉ‡∏´‡∏°‡πà" style="flex:1;padding:10px;border-radius:8px;border:1px solid #ddd;">
                        <button onclick="addNewRole()" style="background:var(--success);color:white;border:none;padding:10px;border-radius:8px;cursor:pointer;">‡πÄ‡∏û‡∏¥‡πà‡∏° Role</button>
                    </div>
                    <div id="rolePermissionsList"></div>
                </div>
                <div>
                    <div style="background:white;padding:20px;border-radius:15px;margin-bottom:20px;display:flex;gap:10px;flex-wrap:wrap;" class="no-print">
                        <input type="text" id="newUserName" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô" style="padding:10px;border-radius:8px;border:1px solid #ddd;flex:1;min-width:120px;">
                        <input type="text" id="newUserKey" placeholder="Username" style="padding:10px;border-radius:8px;border:1px solid #ddd;flex:1;min-width:120px;">
                        <input type="text" id="newUserPass" placeholder="Password (‡πÑ‡∏°‡πà‡∏Å‡∏£‡∏≠‡∏Å = 1234)" style="padding:10px;border-radius:8px;border:1px solid #ddd;flex:1;min-width:140px;">
                        <select id="newUserRole" style="padding:10px;border-radius:8px;flex:1;min-width:100px;"></select>
                        <button onclick="addNewUser()" style="background:var(--info);color:white;border:none;padding:10px 20px;border-radius:8px;cursor:pointer;">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</button>
                    </div>
                    <div id="userGrid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:15px;"></div>
                </div>
            </div>`;
            renderRoleSettings(); renderUserCards();
        };

        window.renderUserCards = async function() {
            const grid=document.getElementById('userGrid'); if(!grid) return;
            grid.innerHTML='<p style="color:#94a3b8;padding:20px;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</p>';
            const snap=await getDocs(collection(db,'users')), now=new Date().getTime(); let html="";
            snap.forEach(d=>{
                const k=d.id, u=d.data(), active=u.toolExpiry>now, isSusp=u.status==='suspended';
                const isPendDel=u.deleteAt!=null&&u.deleteAt!==undefined;
                const isBranch=k.toUpperCase().startsWith('BT000');
                let delInfo="";
                if(isPendDel){const dl=Math.ceil(((u.deleteAt+604800000)-now)/86400000);delInfo=`<div style="color:var(--danger);font-size:10px;margin-top:5px;font-weight:bold;">‚è≥ ‡∏•‡∏ö‡∏ñ‡∏≤‡∏ß‡∏£‡πÉ‡∏ô ${dl>0?dl:0} ‡∏ß‡∏±‡∏ô</div>`;}
                const assignedZones=u.assignedZones||[];
                const zoneInfo=isBranch?`<div style="font-size:11px;color:var(--info);margin-top:4px;">üìç ‡∏Ñ‡∏•‡∏±‡∏á: ${assignedZones.length>0?assignedZones.join(', '):'‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ú‡∏π‡∏Å‡∏Ñ‡∏•‡∏±‡∏á'}</div>`:'';
                html+=`<div class="user-card" style="${isSusp?'border:2px solid var(--danger);background:#fff5f5;':''} ${isPendDel?'opacity:0.6;':''}">
                    <div style="display:flex;justify-content:space-between;align-items:flex-start;">
                        <div>
                            <b id="uname_${k}">${u.name}</b>
                            <small style="color:#64748b;display:block;">ID: ${k}</small>
                        </div>
                        <div style="display:flex;gap:5px;align-items:center;">
                            ${isBranch?'<span style="font-size:10px;background:#dbeafe;color:#1d4ed8;padding:2px 6px;border-radius:4px;">‡∏™‡∏≤‡∏Ç‡∏≤</span>':''}
                            <span id="urole_${k}" style="font-size:10px;background:#eee;padding:2px 6px;border-radius:4px;">${u.role}</span>
                            <button onclick="openEditUserModal('${k}','${u.name}','${u.role}')" style="background:#f1f5f9;border:1px solid #e2e8f0;border-radius:5px;padding:3px 7px;cursor:pointer;font-size:11px;">‚úèÔ∏è</button>
                        </div>
                    </div>
                    ${delInfo}${zoneInfo}
                    <div style="margin:12px 0;font-size:12px;">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ${isSusp?'<b style="color:var(--danger);">‚õî ‡∏ñ‡∏π‡∏Å‡∏£‡∏∞‡∏á‡∏±‡∏ö</b>':(active?'üü¢ ‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå':'‚ö™ ‡∏´‡∏°‡∏î‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå')}</div>
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:5px;" class="no-print">
                        <button onclick="grantAccess('${k}',5)" style="background:var(--info);color:white;border:none;padding:8px;border-radius:5px;cursor:pointer;font-size:11px;">+5 ‡∏ä‡∏°.</button>
                        <button onclick="grantAccess('${k}',0)" style="background:var(--accent-gold);border:none;padding:8px;border-radius:5px;cursor:pointer;font-size:11px;">‡∏ñ‡∏≤‡∏ß‡∏£</button>
                        ${isSusp?`<button onclick="unbanUser('${k}')" style="background:#0ea5e9;color:white;border:none;padding:8px;border-radius:5px;cursor:pointer;font-size:11px;">üîì ‡∏õ‡∏•‡∏î‡∏£‡∏∞‡∏á‡∏±‡∏ö</button>`:`<button onclick="revokeAccess('${k}')" style="background:var(--danger);color:white;border:none;padding:8px;border-radius:5px;cursor:pointer;font-size:11px;">üö´ ‡∏£‡∏∞‡∏á‡∏±‡∏ö</button>`}
                        ${isPendDel?`<button onclick="cancelDelete('${k}')" style="background:#64748b;color:white;border:none;padding:8px;border-radius:5px;cursor:pointer;font-size:11px;">‚Ü©Ô∏è ‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô</button>`:`<button onclick="requestDelete('${k}')" style="background:#000;color:white;border:none;padding:8px;border-radius:5px;cursor:pointer;font-size:11px;">üóëÔ∏è ‡∏•‡∏ö</button>`}
                        <button onclick="adminResetPassword('${k}')" style="grid-column:span 2;background:#7c3aed;color:white;border:none;padding:8px;border-radius:5px;cursor:pointer;font-size:11px;margin-top:2px;">üîë Reset Password ‚Üí 1234</button>
                        ${isBranch?`<button onclick="openAssignZoneModal('${k}')" style="grid-column:span 2;background:#0891b2;color:white;border:none;padding:8px;border-radius:5px;cursor:pointer;font-size:11px;margin-top:2px;">üìç ‡∏ú‡∏π‡∏Å‡∏Ñ‡∏•‡∏±‡∏á‡∏™‡∏≤‡∏Ç‡∏≤</button>`:''}
                    </div>
                </div>`;
            });
            grid.innerHTML=html||'<p style="color:#94a3b8;padding:20px;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</p>';
        };

        window.openAssignZoneModal = async function(username) {
            const snap=await getDoc(doc(db,'users',username));
            const userData=snap.exists()?snap.data():{};
            const assigned=userData.assignedZones||[];
            const modal=document.createElement('div'); modal.className='modal-overlay'; modal.id='assignZoneModal';
            modal.innerHTML=`<div class="modal-box"><h3>üìç ‡∏ú‡∏π‡∏Å‡∏Ñ‡∏•‡∏±‡∏á‡πÉ‡∏´‡πâ ${username}</h3>
                <p style="color:#64748b;font-size:13px;margin-bottom:15px;">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏•‡∏±‡∏á‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ user ‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á</p>
                <div id="zoneCheckList" style="display:flex;flex-direction:column;gap:10px;margin-bottom:20px;">
                    ${warehouseList.map(wh=>`<label style="display:flex;align-items:center;gap:10px;padding:12px;border:1px solid #e2e8f0;border-radius:10px;cursor:pointer;">
                        <input type="checkbox" value="${wh}" ${assigned.includes(wh)?'checked':''} style="width:18px;height:18px;">
                        <span>${wh}</span></label>`).join('')}
                </div>
                <div style="display:flex;gap:10px;">
                    <button onclick="saveAssignedZones('${username}')" style="flex:1;background:var(--success);color:white;border:none;padding:12px;border-radius:10px;cursor:pointer;font-weight:bold;">‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                    <button onclick="document.getElementById('assignZoneModal').remove()" style="flex:1;background:#f1f5f9;color:#475569;border:none;padding:12px;border-radius:10px;cursor:pointer;">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                </div></div>`;
            document.body.appendChild(modal);
        };

        window.saveAssignedZones = async function(username) {
            const checks=document.querySelectorAll('#zoneCheckList input:checked');
            const zones=Array.from(checks).map(c=>c.value);
            await setDoc(doc(db,'users',username),{assignedZones:zones},{merge:true});
            if (currentUser.username===username){currentUser.assignedZones=zones;localStorage.setItem('currentUser',JSON.stringify(currentUser));}
            document.getElementById('assignZoneModal').remove();
            toast('‚úÖ ‡∏ú‡∏π‡∏Å‡∏Ñ‡∏•‡∏±‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢','#059669'); renderUserCards();
        };

        window.adminResetPassword=async function(u){if(!confirm(`Reset Password ‡∏Ç‡∏≠‡∏á ${u} ‚Üí "1234"?`))return;await setDoc(doc(db,'users',u),{password:await hashPassword('1234')},{merge:true});toast('‚úÖ Reset ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ Password ‡πÉ‡∏´‡∏°‡πà: 1234','#059669');};

        window.openEditUserModal=function(uid,uname,urole){
            const existing=document.getElementById('editUserModal');if(existing)existing.remove();
            const roleOpts=Object.keys(roleSettings).map(r=>`<option value="${r}" ${r===urole?'selected':''}>${r}</option>`).join('');
            const modal=document.createElement('div');modal.className='modal-overlay';modal.id='editUserModal';
            modal.innerHTML=`<div class="modal-box"><h3>‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</h3>
                <div style="font-size:12px;color:#64748b;margin-bottom:12px;">ID: ${uid}</div>
                <label style="font-size:12px;font-weight:bold;color:#475569;display:block;margin-bottom:4px;">‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</label>
                <input type="text" id="editUserName" value="${uname}" style="width:100%;padding:10px;border:1px solid #e2e8f0;border-radius:8px;font-size:14px;box-sizing:border-box;margin-bottom:12px;">
                <label style="font-size:12px;font-weight:bold;color:#475569;display:block;margin-bottom:4px;">Role</label>
                <select id="editUserRole" style="width:100%;padding:10px;border:1px solid #e2e8f0;border-radius:8px;font-size:14px;margin-bottom:20px;">${roleOpts}</select>
                <div style="display:flex;gap:10px;">
                    <button onclick="saveEditUser('${uid}')" style="flex:1;background:var(--success);color:white;border:none;padding:12px;border-radius:10px;cursor:pointer;font-weight:bold;">‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                    <button onclick="document.getElementById('editUserModal').remove()" style="flex:1;background:#f1f5f9;color:#475569;border:none;padding:12px;border-radius:10px;cursor:pointer;">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                </div></div>`;
            document.body.appendChild(modal);
        };

        window.saveEditUser=async function(uid){
            const newName=document.getElementById('editUserName').value.trim();
            const newRole=document.getElementById('editUserRole').value;
            if(!newName){toast('‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠','#c2410c');return;}
            await setDoc(doc(db,'users',uid),{name:newName,role:newRole},{merge:true});
            document.getElementById('editUserModal').remove();
            toast('‚úÖ ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢','#059669');
            renderUserCards();
        };
        window.unbanUser=async function(u){await setDoc(doc(db,'users',u),{status:'active'},{merge:true});toast('üîì ‡∏õ‡∏•‡∏î‡∏£‡∏∞‡∏á‡∏±‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢','#059669');renderUserCards();};
        window.requestDelete=async function(u){if(!confirm(`‡∏•‡∏ö‡∏ö‡∏±‡∏ç‡∏ä‡∏µ ${u}? (‡∏£‡∏≠‡∏•‡∏ö 7 ‡∏ß‡∏±‡∏ô)`))return;await setDoc(doc(db,'users',u),{deleteAt:new Date().getTime()},{merge:true});renderUserCards();};
        window.cancelDelete=async function(u){await setDoc(doc(db,'users',u),{deleteAt:null},{merge:true});toast('‚úÖ ‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢','#059669');renderUserCards();};
        window.grantAccess=async function(k,h){await setDoc(doc(db,'users',k),{toolExpiry:h===0?4070908800000:new Date().getTime()+(h*3600000),status:'active'},{merge:true});toast('‚úÖ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢','#059669');renderUserCards();};
        window.revokeAccess=async function(k){if(!confirm(`üö´ ‡∏£‡∏∞‡∏á‡∏±‡∏ö ${k}?`))return;await setDoc(doc(db,'users',k),{toolExpiry:0,status:'suspended'},{merge:true});toast('üîí ‡∏£‡∏∞‡∏á‡∏±‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢','#c2410c');renderUserCards();};
        window.addNewUser=async function(){
            const n=document.getElementById('newUserName').value.trim(),u=document.getElementById('newUserKey').value.trim(),r=document.getElementById('newUserRole').value,rp=document.getElementById('newUserPass').value.trim()||'1234';
            if(!n||!u)return;
            const ud={name:n,role:r,username:u,password:await hashPassword(rp),toolExpiry:0,status:'active'};
            if(u.toUpperCase().startsWith('BT000'))ud.assignedZones=[];
            await setDoc(doc(db,'users',u),ud);
            toast('‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢','#059669');
            document.getElementById('newUserName').value=document.getElementById('newUserKey').value=document.getElementById('newUserPass').value='';
            renderUserCards();
        };

        window.renderRoleSettings=function(){
            const list=document.getElementById('rolePermissionsList'),sel=document.getElementById('newUserRole');if(!list)return;
            let html='',opts='';
            Object.keys(roleSettings).forEach(role=>{
                const perms=roleSettings[role].menus,vo=roleSettings[role].viewOnly||false;
                html+=`<div style="padding:12px;border:1px solid #f1f5f9;border-radius:10px;margin-bottom:10px;background:#f8fafc;">
                    <div style="display:flex;justify-content:space-between;"><b style="text-transform:uppercase;">${role}</b>${role!=='admin'?`<small onclick="deleteRole('${role}')" style="color:red;cursor:pointer;">‡∏•‡∏ö Role</small>`:''}</div>
                    <div style="display:flex;gap:12px;font-size:11px;margin-top:8px;flex-wrap:wrap;">
                        <label><input type="checkbox" ${perms.includes('warehouse')?'checked':''} onchange="togglePerm('${role}','warehouse')"> ‡∏Ñ‡∏•‡∏±‡∏á</label>
                        <label><input type="checkbox" ${perms.includes('tools')?'checked':''} onchange="togglePerm('${role}','tools')"> ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠</label>
                        <label><input type="checkbox" ${perms.includes('admin')?'checked':''} onchange="togglePerm('${role}','admin')"> ‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô</label>
                        <label style="color:var(--info);font-weight:bold;"><input type="checkbox" ${vo?'checked':''} onchange="toggleViewOnly('${role}')"> üëÅÔ∏è ‡∏î‡∏π‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß</label>
                    </div></div>`;
                opts+=`<option value="${role}">${role}</option>`;
            });
            list.innerHTML=html;if(sel)sel.innerHTML=opts;
        };

        window.toggleViewOnly=function(r){roleSettings[r].viewOnly=!roleSettings[r].viewOnly;saveConfig();renderRoleSettings();applyPermissions();};
        window.togglePerm=function(r,m){const i=roleSettings[r].menus.indexOf(m);if(i>-1)roleSettings[r].menus.splice(i,1);else roleSettings[r].menus.push(m);saveConfig();applyPermissions();renderRoleSettings();};
        window.addNewRole=function(){const n=document.getElementById('newRoleName').value.trim().toLowerCase();if(n&&!roleSettings[n]){roleSettings[n]={menus:[],viewOnly:false};saveConfig();renderRoleSettings();}};
        window.deleteRole=function(r){if(confirm(`‡∏•‡∏ö Role: ${r}?`)){delete roleSettings[r];saveConfig();renderRoleSettings();}};

        // ---- STOCK TOOL (‡πÅ‡∏Å‡πâ bug selectedStaff) ----
        window.openCentralStock=function(){
            document.getElementById('dashboardView').classList.add('hidden');
            document.getElementById('toolAppContainer').classList.remove('hidden');
            tempCountData={};
            const visibleZones=getVisibleWarehouses();
            renderStockTool(visibleZones[0]||warehouseList[0]);
        };

        window.renderStockTool=async function(zone){
            const c=document.getElementById('toolAppContainer');
            const visibleZones=getVisibleWarehouses();
            const zoneProds=allProducts.filter(p=>(zoneProductMap[zone]||[]).includes(p.id));
            const usSnap=await getDocs(collection(db,'users')); let staffOpts='';
            usSnap.forEach(d=>{const u=d.data();if(u.status!=='suspended')staffOpts+=`<option value="${u.name}" ${selectedStaff===u.name?'selected':''}>${u.name}</option>`;});

            c.innerHTML=`<div class="tool-header no-print"><h2>üì¶ ‡∏ô‡∏±‡∏ö‡∏™‡∏ï‡πä‡∏≠‡∏Å: ${zone}</h2><button onclick="closeTool()">‚úï ‡∏õ‡∏¥‡∏î</button></div>
            <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:15px;margin-bottom:20px;" class="no-print">
                <div class="input-group"><label>üì¶ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏ã‡∏ô</label>
                    <select onchange="renderStockTool(this.value)" style="width:100%;border:none;font-weight:bold;outline:none;">
                        ${visibleZones.map(w=>`<option ${w===zone?'selected':''}>${w}</option>`).join('')}
                    </select></div>
                <div class="input-group" style="border:2px solid var(--danger);"><label>üìÖ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ô‡∏±‡∏ö (‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÄ‡∏•‡∏∑‡∏≠‡∏Å)</label>
                    <input type="date" id="countDate" value="${selectedDate}" onchange="selectedDate=this.value" style="width:100%;border:none;font-weight:bold;outline:none;font-size:14px;">
                </div>
                <div class="input-group" style="border:2px solid var(--info);"><label>üë§ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏ô‡∏ô‡∏±‡∏ö</label>
                    <select id="staffSelect" onchange="selectedStaff=this.value" style="width:100%;border:none;font-weight:bold;outline:none;">
                        <option value="">-- ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å --</option>${staffOpts}
                    </select></div>
                <div class="input-group" style="background:#f1f5f9;"><label>üìù ‡∏ú‡∏π‡πâ‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏´‡∏•‡∏±‡∏Å</label><b>${currentUser.name}</b></div>
            </div>
            <table class="stock-table">${zoneProds.map(p=>{
                const units=p.units||[{name:p.unit||'',rate:0},{name:p.subUnit||'',rate:0}].filter(u=>u.name);
                const pending=tempCountData[p.id];
                const hasPending=pending&&units.some((_,ui)=>(pending['u'+ui]||0)>0);
                const lu=countData[p.id]?.lastUpdate||'-';
                const borderColors=['var(--info)','#a78bfa','#f59e0b'];
                return `<tr class="stock-row">
                <td><b style="font-size:16px;">${p.id}</b><br><span style="color:#475569;">${p.name}</span><br><small style="color:#94a3b8;font-size:10px;">‡∏ô‡∏±‡∏ö‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: ${lu}</small></td>
                <td style="text-align:right;">
                    <div style="display:flex;align-items:center;justify-content:flex-end;gap:12px;">
                        <div style="text-align:right;min-width:140px;">
                            ${hasPending
                                ? `<div style="font-size:13px;color:var(--info);font-weight:bold;">${units.map((_,ui)=>(pending['u'+ui]||0)>0?`<span>${pending['u'+ui]} ${units[ui].name}</span>`:'').filter(Boolean).join(' + ')}</div>
                                   <div style="font-size:11px;color:#94a3b8;">‡∏£‡∏≠‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô...</div>`
                                : `<div style="font-size:12px;color:#cbd5e1;">‚Äî</div>`
                            }
                        </div>
                        <div style="display:flex;flex-direction:column;gap:5px;">
                            ${units.map((u,ui)=>`
                            <div style="display:flex;align-items:center;gap:5px;">
                                <small style="color:${borderColors[ui]||'#64748b'};width:45px;text-align:right;font-weight:bold;">${u.name}:</small>
                                <input type="number" id="input_${p.id}_${ui}" min="0" class="no-print viewonly-input"
                                    style="width:75px;padding:7px;border-radius:8px;border:2px solid ${borderColors[ui]||'#cbd5e1'};text-align:center;font-weight:bold;font-size:14px;"
                                    onkeydown="if(event.key==='Enter') addStock('${p.id}','${p.name}','${zone}',${ui})">
                            </div>`).join('')}
                        </div>
                        <button onclick="addStockAll('${p.id}','${p.name}','${zone}')" class="btn-action no-print" style="background:var(--info);font-size:20px;">Ôºã</button>
                    </div>
                </td></tr>`;}).join('')}</table>
            <p style="color:#94a3b8;font-size:12px;text-align:center;margin-top:5px;" class="no-print">üí° ‡∏Å‡∏£‡∏≠‡∏Å‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î Enter ‡πÉ‡∏ô‡∏ä‡πà‡∏≠‡∏á‡∏ô‡∏±‡πâ‡∏ô ‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏î Ôºã ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ó‡∏∏‡∏Å‡∏ä‡πà‡∏≠‡∏á‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏±‡∏ô</p>
            <div style="margin-top:25px;text-align:center;" class="no-print">
                <button onclick="finalSaveStock('${zone}')" style="background:var(--success);color:white;padding:18px 60px;border:none;border-radius:15px;font-size:20px;font-weight:bold;cursor:pointer;box-shadow:0 4px 15px rgba(16,185,129,0.4);">üíæ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÅ‡∏•‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
            </div>`;
        };

        // addStock: ‡∏Å‡∏£‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î Enter ‡πÉ‡∏ô‡∏ä‡πà‡∏≠‡∏á‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏ô‡∏±‡πâ‡∏ô
        window.addStock=function(id,name,zone,unitIndex){
            const staffEl=document.getElementById('staffSelect');
            if(staffEl&&staffEl.value) selectedStaff=staffEl.value;
            const el=document.getElementById(`input_${id}_${unitIndex}`);
            const val=parseFloat(el?.value)||0;
            if(val<=0){if(el){el.style.borderColor='var(--danger)';setTimeout(()=>el.style.borderColor='',800);}return;}
            if(!tempCountData[id])tempCountData[id]={name};
            tempCountData[id]['u'+unitIndex]=(tempCountData[id]['u'+unitIndex]||0)+val;
            if(el){el.value='';el.style.borderColor='var(--success)';setTimeout(()=>el.style.borderColor='',600);}
            setTimeout(()=>renderStockTool(zone),400);
        };

        // addStockAll: ‡∏Å‡∏î Ôºã ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ó‡∏∏‡∏Å‡∏ä‡πà‡∏≠‡∏á‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏±‡∏ô
        window.addStockAll=function(id,name,zone){
            const staffEl=document.getElementById('staffSelect');
            if(staffEl&&staffEl.value) selectedStaff=staffEl.value;
            const p=allProducts.find(pd=>pd.id===id);
            const units=p?.units||[{name:p?.unit||'',rate:0}];
            let anyVal=false;
            units.forEach((_,ui)=>{
                const el=document.getElementById(`input_${id}_${ui}`);
                const val=parseFloat(el?.value)||0;
                if(val>0){
                    if(!tempCountData[id])tempCountData[id]={name};
                    tempCountData[id]['u'+ui]=(tempCountData[id]['u'+ui]||0)+val;
                    if(el){el.value='';el.style.borderColor='var(--success)';setTimeout(()=>el.style.borderColor='',600);}
                    anyVal=true;
                }
            });
            if(!anyVal){toast('‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Å‡πà‡∏≠‡∏ô','#c2410c');return;}
            setTimeout(()=>renderStockTool(zone),400);
        };

        window.finalSaveStock=async function(zone){
            const staffEl=document.getElementById('staffSelect');
            if(staffEl&&staffEl.value) selectedStaff=staffEl.value;
            const dateEl=document.getElementById('countDate');
            if(dateEl&&dateEl.value) selectedDate=dateEl.value;

            if(!selectedDate){toast('‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ô‡∏±‡∏ö‡∏Å‡πà‡∏≠‡∏ô','#c2410c');return;}
            if(!selectedStaff){toast('‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏ô‡∏ô‡∏±‡∏ö‡∏Å‡πà‡∏≠‡∏ô','#c2410c');return;}
            const hasChanges=Object.keys(tempCountData).some(id=>{
                const td=tempCountData[id];
                return Object.keys(td).filter(k=>k.startsWith('u')).some(k=>(td[k]||0)>0);
            });
            if(!hasChanges){toast('‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÅ‡∏•‡∏∞‡∏Å‡∏î Ôºã ‡∏Å‡πà‡∏≠‡∏ô','#c2410c');return;}
            if(!confirm(`‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${selectedDate} ‡πÇ‡∏î‡∏¢‡∏Ñ‡∏∏‡∏ì ${selectedStaff}?`))return;

            // ‡πÅ‡∏õ‡∏•‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏≤‡∏Å yyyy-mm-dd ‡πÄ‡∏õ‡πá‡∏ô dd/mm/yyyy (‡πÑ‡∏ó‡∏¢)
            const [yr,mo,dy]=selectedDate.split('-');
            const dateStr=`${dy}/${mo}/${parseInt(yr)+543}`;
            const now=new Date();
            const timeStr=now.toLocaleTimeString('th-TH',{hour:'2-digit',minute:'2-digit'});
            const ts=dateStr+' '+timeStr;

            // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡πÉ‡∏ô countData (‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏´‡∏•‡∏±‡∏Å‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô)
            Object.keys(tempCountData).forEach(id=>{
                const td=tempCountData[id];
                const p=allProducts.find(pd=>pd.id===id);
                const units=p?.units||[{name:p?.unit||'',rate:0}];
                // ‡πÅ‡∏õ‡∏•‡∏á‡∏ó‡∏∏‡∏Å‡∏´‡∏ô‡πà‡∏ß‡∏¢‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏´‡∏•‡∏±‡∏Å
                let totalInUnit1=td['u0']||0;
                // u1 ‡πÅ‡∏õ‡∏•‡∏á‡πÇ‡∏î‡∏¢ rate[0] ‡∏Ç‡∏≠‡∏á unit[0]
                if((td['u1']||0)>0&&units[0]?.rate>0) totalInUnit1+=((td['u1']||0)/units[0].rate);
                if((td['u2']||0)>0&&units[0]?.rate>0&&units[1]?.rate>0) totalInUnit1+=((td['u2']||0)/(units[0].rate*units[1].rate));
                if(!countData[id])countData[id]={total:0,name:td.name};
                // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡πÄ‡∏õ‡πá‡∏ô 0 ‡πÅ‡∏•‡πâ‡∏ß‡πÉ‡∏™‡πà‡∏¢‡∏≠‡∏î‡∏ó‡∏µ‡πà‡∏ô‡∏±‡∏ö‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô (‡πÑ‡∏°‡πà‡∏™‡∏∞‡∏™‡∏°)
                countData[id].total=Math.round(totalInUnit1*1000)/1000;
                countData[id].lastUpdate=ts;
                countData[id].countedBy=selectedStaff;
            });
            await saveCountData();

            // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å history ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏∏‡∏Å‡∏´‡∏ô‡πà‡∏ß‡∏¢
            const sessionItems=Object.keys(tempCountData).map(id=>{
                const td=tempCountData[id];
                const p=allProducts.find(pd=>pd.id===id);
                const units=p?.units||[{name:p?.unit||'',rate:0}];
                const amounts=units.map((_,ui)=>({amount:td['u'+ui]||0,unit:units[ui]?.name||''}));
                return {id,name:td.name,amounts,units};
            });

            await addDoc(collection(db,'stockHistory'),{
                zone,date:dateStr,timestamp:now.getTime(),
                countedBy:selectedStaff,recordedBy:currentUser.name,items:sessionItems
            });

            tempCountData={};
            toast('‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡πÅ‡∏•‡πâ‡∏ß','#059669');
            renderStockTool(zone);
        };

        // ---- STOCK SUMMARY ----
        window.openStockSummary=async function(){
            document.getElementById('dashboardView').classList.add('hidden');
            const c=document.getElementById('toolAppContainer');c.classList.remove('hidden');
            const visibleZones=getVisibleWarehouses();
            c.innerHTML=`<div class="tool-header"><h2>üìä ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ & Export ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</h2><button onclick="closeTool()">‚úï ‡∏õ‡∏¥‡∏î</button></div>
            <div class="filter-bar no-print" style="flex-wrap:wrap;gap:12px;">
                <div>
                    <label>üìã ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</label>
                    <select id="reportMode" onchange="switchReportMode()" style="padding:10px 14px;border:2px solid var(--primary-dark);border-radius:10px;font-size:14px;font-weight:bold;min-width:220px;">
                        <option value="history">üìú ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡∏ö (‡∏ó‡∏∏‡∏Å session)</option>
                        <option value="snapshot">üì¶ ‡∏¢‡∏≠‡∏î‡∏™‡∏ï‡πä‡∏≠‡∏Å‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î (‡∏û‡∏£‡πâ‡∏≠‡∏° export)</option>
                    </select>
                </div>
                <div><label>üì¶ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏•‡∏±‡∏á</label>
                    <select id="filterZone" onchange="loadCurrentReport()">
                        <option value="">‚Äî ‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏•‡∏±‡∏á ‚Äî</option>
                        ${visibleZones.map(w=>`<option value="${w}">${w}</option>`).join('')}
                    </select></div>
                <div id="dateFromWrap"><label>üìÖ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô</label><input type="date" id="filterDateFrom" onchange="loadCurrentReport()"></div>
                <div id="dateToWrap"><label>üìÖ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î</label><input type="date" id="filterDateTo" onchange="loadCurrentReport()"></div>
                <div style="display:flex;gap:8px;align-items:flex-end;">
                    <button onclick="exportCurrentReport()" style="background:var(--success);color:white;border:none;padding:12px 20px;border-radius:10px;cursor:pointer;font-weight:bold;">üì• Export Excel</button>
                    <button onclick="window.print()" style="background:var(--danger);color:white;border:none;padding:12px 20px;border-radius:10px;cursor:pointer;font-weight:bold;">üñ®Ô∏è Print PDF</button>
                </div>
            </div>
            <div id="historyContainer"><p style="color:#94a3b8;text-align:center;padding:40px;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</p></div>`;
            await loadCurrentReport();
        };

        window.switchReportMode=function(){
            const mode=document.getElementById('reportMode').value;
            document.getElementById('dateFromWrap').style.display=mode==='history'?'':'none';
            document.getElementById('dateToWrap').style.display=mode==='history'?'':'none';
            loadCurrentReport();
        };

        window.loadCurrentReport=async function(){
            const mode=document.getElementById('reportMode')?.value||'history';
            if(mode==='snapshot') await loadSnapshot();
            else await loadHistory();
        };

        window.exportCurrentReport=function(){
            const mode=document.getElementById('reportMode')?.value||'history';
            if(mode==='snapshot') exportExcelSnapshot();
            else exportExcelHistory();
        };

        // ---- SNAPSHOT: ‡∏¢‡∏≠‡∏î‡∏™‡∏ï‡πä‡∏≠‡∏Å‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ ----
        window.loadSnapshot=async function(){
            const zone=document.getElementById('filterZone')?.value||'';
            const container=document.getElementById('historyContainer');
            if(!container)return;
            container.innerHTML='<p style="color:#94a3b8;text-align:center;padding:40px;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</p>';
            try{
                await loadCountData();
                const zones=zone?[zone]:getVisibleWarehouses();
                let html='';
                zones.forEach(z=>{
                    const prods=allProducts.filter(p=>(zoneProductMap[z]||[]).includes(p.id));
                    if(!prods.length)return;
                    html+=`<div class="history-card" style="margin-bottom:20px;">
                        <div class="history-card-header"><b>üì¶ ${z}</b></div>
                        <table style="width:100%;border-collapse:collapse;">
                            <thead><tr style="background:#f8fafc;">
                                <th style="padding:10px;text-align:left;font-size:12px;color:#64748b;">‡∏£‡∏´‡∏±‡∏™</th>
                                <th style="padding:10px;text-align:left;font-size:12px;color:#64748b;">‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th>
                                <th style="padding:10px;text-align:center;font-size:12px;color:#64748b;">‡∏¢‡∏≠‡∏î‡∏™‡∏ï‡πä‡∏≠‡∏Å</th>
                                <th style="padding:10px;text-align:center;font-size:12px;color:#64748b;">‡∏´‡∏ô‡πà‡∏ß‡∏¢</th>
                                <th style="padding:10px;text-align:center;font-size:12px;color:#64748b;">‡∏ô‡∏±‡∏ö‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</th>
                                <th style="padding:10px;text-align:center;font-size:12px;color:#64748b;">‡πÇ‡∏î‡∏¢</th>
                            </tr></thead>
                            <tbody>${prods.map(p=>{
                                const cd=countData[p.id]||{total:0};
                                const units=p.units||[{name:p.unit||''}];
                                return `<tr style="border-top:1px solid #f1f5f9;">
                                    <td style="padding:10px;font-weight:bold;">${p.id}</td>
                                    <td style="padding:10px;color:#475569;">${p.name}</td>
                                    <td style="padding:10px;text-align:center;font-weight:bold;color:var(--success);font-size:16px;">${cd.total||0}</td>
                                    <td style="padding:10px;text-align:center;color:#64748b;">${units[0]?.name||''}</td>
                                    <td style="padding:10px;text-align:center;font-size:12px;color:#94a3b8;">${cd.lastUpdate||'-'}</td>
                                    <td style="padding:10px;text-align:center;font-size:12px;color:#94a3b8;">${cd.countedBy||'-'}</td>
                                </tr>`;}).join('')}
                            </tbody>
                        </table>
                    </div>`;
                });
                container.innerHTML=html||'<p style="color:#94a3b8;text-align:center;padding:40px;">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p>';
            }catch(e){console.error(e);container.innerHTML='<p style="color:var(--danger);text-align:center;padding:40px;">‚ùå ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</p>';}
        };

        window.exportExcelSnapshot=function(){
            const zone=document.getElementById('filterZone')?.value||'';
            const zones=zone?[zone]:getVisibleWarehouses();
            const rows=[['‡∏Ñ‡∏•‡∏±‡∏á','‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤','‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤','‡∏¢‡∏≠‡∏î‡∏™‡∏ï‡πä‡∏≠‡∏Å','‡∏´‡∏ô‡πà‡∏ß‡∏¢','‡∏ô‡∏±‡∏ö‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î','‡πÇ‡∏î‡∏¢']];
            zones.forEach(z=>{
                const prods=allProducts.filter(p=>(zoneProductMap[z]||[]).includes(p.id));
                prods.forEach(p=>{
                    const cd=countData[p.id]||{total:0};
                    const units=p.units||[{name:p.unit||''}];
                    rows.push([z,p.id,p.name,cd.total||0,units[0]?.name||'',cd.lastUpdate||'',cd.countedBy||'']);
                });
            });
            const ws=XLSX.utils.aoa_to_sheet(rows),wb=XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb,ws,'‡∏¢‡∏≠‡∏î‡∏™‡∏ï‡πä‡∏≠‡∏Å');
            XLSX.writeFile(wb,`Stock_Snapshot_${new Date().toLocaleDateString('th-TH')}.xlsx`);
        };

        let currentHistoryData=[];

        window.loadHistory=async function(){
            const zone=document.getElementById('filterZone')?.value||'';
            const dateFrom=document.getElementById('filterDateFrom')?.value||'';
            const dateTo=document.getElementById('filterDateTo')?.value||'';
            // ‡∏ñ‡πâ‡∏≤‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô snapshot mode ‡πÉ‡∏´‡πâ‡∏Ç‡πâ‡∏≤‡∏°‡πÑ‡∏õ
            if(document.getElementById('reportMode')?.value==='snapshot'){loadSnapshot();return;}
            const container=document.getElementById('historyContainer');
            if(!container)return;
            container.innerHTML='<p style="color:#94a3b8;text-align:center;padding:40px;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</p>';
            try {
                const snap=await getDocs(collection(db,'stockHistory'));
                let sessions=[];
                snap.forEach(d=>sessions.push({id:d.id,...d.data()}));
                if(zone)sessions=sessions.filter(s=>s.zone===zone);
                if(dateFrom){const from=new Date(dateFrom).getTime();sessions=sessions.filter(s=>s.timestamp>=from);}
                if(dateTo){const to=new Date(dateTo).getTime()+86399999;sessions=sessions.filter(s=>s.timestamp<=to);}
                sessions.sort((a,b)=>b.timestamp-a.timestamp);
                currentHistoryData=sessions;
                if(sessions.length===0){container.innerHTML='<p style="color:#94a3b8;text-align:center;padding:40px;">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏°‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</p>';return;}
                container.innerHTML=sessions.map(s=>`
                <div class="history-card">
                    <div class="history-card-header">
                        <div><b style="font-size:15px;">üì¶ ${s.zone}</b>
                        <span style="margin-left:12px;color:#64748b;font-size:13px;">üìÖ ${s.date} ${s.countedBy?'‚Ä¢ üë§ '+s.countedBy:''}</span></div>
                        <span style="font-size:11px;color:#94a3b8;">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÇ‡∏î‡∏¢: ${s.recordedBy||'-'}</span>
                    </div>
                    <table style="width:100%;border-collapse:collapse;">
                        <thead><tr style="background:#f8fafc;">
                            <th style="padding:10px;text-align:left;font-size:12px;color:#64748b;">‡∏£‡∏´‡∏±‡∏™</th>
                            <th style="padding:10px;text-align:left;font-size:12px;color:#64748b;">‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th>
                            <th style="padding:10px;text-align:center;font-size:12px;color:#64748b;">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th>
                            <th style="padding:10px;text-align:center;font-size:12px;color:#64748b;">‡∏´‡∏ô‡πà‡∏ß‡∏¢</th>
                            <th style="padding:10px;text-align:center;font-size:12px;color:#64748b;">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th>
                            <th style="padding:10px;text-align:center;font-size:12px;color:#64748b;">‡∏´‡∏ô‡πà‡∏ß‡∏¢</th>
                            <th style="padding:10px;text-align:center;font-size:12px;color:#64748b;">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th>
                            <th style="padding:10px;text-align:center;font-size:12px;color:#64748b;">‡∏´‡∏ô‡πà‡∏ß‡∏¢</th>
                        </tr></thead>
                        <tbody>${(s.items||[]).map(it=>{
                            // support both old and new format
                            const amounts=it.amounts||[{amount:it.amountMain||it.amount||0,unit:it.unit||''},{amount:it.amountSub||0,unit:it.subUnit||''}].filter(a=>a.unit);
                            return `<tr style="border-top:1px solid #f1f5f9;">
                            <td style="padding:10px;font-weight:bold;">${it.id}</td>
                            <td style="padding:10px;color:#475569;">${it.name}</td>
                            ${amounts.map(a=>`<td style="padding:10px;text-align:center;font-weight:bold;color:var(--success);">${a.amount>0?a.amount:'-'}</td><td style="padding:10px;text-align:center;color:#64748b;">${a.unit}</td>`).join('')}
                        </tr>`;}).join('')}</tbody>
                    </table>
                </div>`).join('');
            } catch(e){console.error(e);container.innerHTML='<p style="color:var(--danger);text-align:center;padding:40px;">‚ùå ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</p>';}
        };

        window.exportExcelHistory=function(){
            if(!currentHistoryData||currentHistoryData.length===0){toast('‚ùå ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ export','#c2410c');return;}
            const rows=[["‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà","‡∏Ñ‡∏•‡∏±‡∏á","‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤","‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤","‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏´‡∏ô‡πà‡∏ß‡∏¢1","‡∏´‡∏ô‡πà‡∏ß‡∏¢1","‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏´‡∏ô‡πà‡∏ß‡∏¢2","‡∏´‡∏ô‡πà‡∏ß‡∏¢2","‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏´‡∏ô‡πà‡∏ß‡∏¢3","‡∏´‡∏ô‡πà‡∏ß‡∏¢3","‡∏Ñ‡∏ô‡∏ô‡∏±‡∏ö","‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÇ‡∏î‡∏¢"]];
            currentHistoryData.forEach(s=>{
                (s.items||[]).forEach(it=>{
                    const amounts=it.amounts||[{amount:it.amountMain||it.amount||0,unit:it.unit||''},{amount:it.amountSub||0,unit:it.subUnit||''}].filter(a=>a.unit);
                    // pad ‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö 3 ‡∏´‡∏ô‡πà‡∏ß‡∏¢‡πÄ‡∏™‡∏°‡∏≠ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ï‡∏£‡∏á
                    const padded=Array.from({length:3},(_,i)=>amounts[i]||{amount:0,unit:''});
                    const row=[s.date,s.zone,it.id,it.name,
                        padded[0].amount||0, padded[0].unit||'',
                        padded[1].amount||0, padded[1].unit||'',
                        padded[2].amount||0, padded[2].unit||'',
                        s.countedBy||'',s.recordedBy||''];
                    rows.push(row);
                });
            });
            const ws=XLSX.utils.aoa_to_sheet(rows),wb=XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb,ws,"StockHistory");
            const zone=document.getElementById('filterZone')?.value||'all';
            XLSX.writeFile(wb,`StockHistory_${zone}_${new Date().toLocaleDateString('th-TH')}.xlsx`);
        };

        // ---- WAREHOUSE MANAGER (‡πÄ‡∏û‡∏¥‡πà‡∏° edit + subUnit) ----
        window.openWarehouseManager=function(){
            document.getElementById('dashboardView').classList.add('hidden');
            const c=document.getElementById('toolAppContainer');c.classList.remove('hidden');
            c.innerHTML=`<div class="tool-header"><h2>‚öôÔ∏è ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏•‡∏±‡∏á‡πÅ‡∏•‡∏∞‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</h2><button onclick="closeTool()">‚úï ‡∏õ‡∏¥‡∏î</button></div>
            <div style="display:grid;grid-template-columns:1fr 1.2fr;gap:25px;">
                <div style="background:white;padding:20px;border-radius:15px;border:1px solid #e2e8f0;">
                    <h4>üì¶ ‡∏Ñ‡∏•‡∏±‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (Zones)</h4>
                    <div style="display:flex;gap:8px;margin-bottom:15px;">
                        <input type="text" id="newWhName" placeholder="‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏•‡∏±‡∏á/‡πÇ‡∏ã‡∏ô‡πÉ‡∏´‡∏°‡πà" style="flex:1;padding:10px;border-radius:8px;border:1px solid #ddd;">
                        <button onclick="addWh()" style="background:var(--success);color:white;padding:10px 20px;border:none;border-radius:8px;cursor:pointer;">‡πÄ‡∏û‡∏¥‡πà‡∏°</button>
                    </div>
                    <div id="whListContainer"></div>
                </div>
                <div style="background:white;padding:20px;border-radius:15px;border:1px solid #e2e8f0;">
                    <h4>üçé ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</h4>
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:10px;">
                        <input type="text" id="newPdId" placeholder="‡∏£‡∏´‡∏±‡∏™ SKU" style="padding:10px;border:1px solid #ddd;border-radius:8px;">
                        <input type="text" id="newPdName" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤" style="padding:10px;border:1px solid #ddd;border-radius:8px;grid-column:span 1;">
                    </div>
                    <div style="background:#f8fafc;border-radius:8px;padding:10px;margin-bottom:10px;border:1px solid #e2e8f0;">
                        <div style="font-size:11px;color:#64748b;font-weight:bold;margin-bottom:8px;">‡∏´‡∏ô‡πà‡∏ß‡∏¢‡πÅ‡∏•‡∏∞‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡πÅ‡∏õ‡∏•‡∏á (‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 3 ‡∏´‡∏ô‡πà‡∏ß‡∏¢)</div>
                        <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:6px;align-items:center;margin-bottom:6px;">
                            <input type="text" id="newPdUnit1" placeholder="‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏ó‡∏µ‡πà 1 (‡πÉ‡∏´‡∏ç‡πà‡∏™‡∏∏‡∏î) ‡πÄ‡∏ä‡πà‡∏ô ‡∏•‡∏±‡∏á" style="padding:8px;border:1px solid #ddd;border-radius:6px;font-size:12px;">
                            <input type="number" id="newPdRate1" placeholder="1 ‡∏•‡∏±‡∏á = ? ‡∏ñ‡∏∏‡∏á" min="1" style="padding:8px;border:1px solid #ddd;border-radius:6px;font-size:12px;">
                            <small style="color:#94a3b8;">√ó ‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏ó‡∏µ‡πà 2</small>
                        </div>
                        <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:6px;align-items:center;margin-bottom:6px;">
                            <input type="text" id="newPdUnit2" placeholder="‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏ó‡∏µ‡πà 2 (‡∏Å‡∏•‡∏≤‡∏á) ‡πÄ‡∏ä‡πà‡∏ô ‡∏ñ‡∏∏‡∏á" style="padding:8px;border:1px solid #ddd;border-radius:6px;font-size:12px;">
                            <input type="number" id="newPdRate2" placeholder="1 ‡∏ñ‡∏∏‡∏á = ? ‡∏Å‡∏£‡∏±‡∏°" min="1" style="padding:8px;border:1px solid #ddd;border-radius:6px;font-size:12px;">
                            <small style="color:#94a3b8;">√ó ‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏ó‡∏µ‡πà 3</small>
                        </div>
                        <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:6px;align-items:center;">
                            <input type="text" id="newPdUnit3" placeholder="‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏ó‡∏µ‡πà 3 (‡πÄ‡∏•‡πá‡∏Å‡∏™‡∏∏‡∏î) ‡πÄ‡∏ä‡πà‡∏ô ‡∏Å‡∏£‡∏±‡∏°" style="padding:8px;border:1px solid #ddd;border-radius:6px;font-size:12px;">
                            <div></div><small style="color:#94a3b8;">‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢</small>
                        </div>
                    </div>
                    <button onclick="addPd()" style="width:100%;background:var(--info);color:white;padding:12px;border-radius:8px;border:none;cursor:pointer;font-weight:bold;">+ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</button>
                    <div id="pdMasterContainer" style="max-height:250px;overflow-y:auto;border-top:1px solid #eee;padding-top:10px;"></div>
                </div>
            </div>
            <div style="margin-top:25px;background:white;padding:25px;border-radius:15px;border:1px solid #e2e8f0;">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
                    <h4 style="margin:0;">üîó ‡∏à‡∏±‡∏ö‡∏Ñ‡∏π‡πà‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡πÇ‡∏ã‡∏ô</h4>
                    <select id="selectZoneMap" onchange="renderMapping()" style="padding:12px;border-radius:8px;min-width:300px;border:2px solid var(--primary-dark);font-weight:bold;"></select>
                </div>
                <div id="mappingContainer" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:12px;"></div>
            </div>`;
            renderWhList(); renderPdList();
            document.getElementById('selectZoneMap').innerHTML=warehouseList.map(w=>`<option value="${w}">${w}</option>`).join('');
            renderMapping();
        };

        window.renderWhList=function(){
            const c=document.getElementById('whListContainer');if(!c)return;
            c.innerHTML=warehouseList.map((wh,i)=>`
            <div style="display:flex;align-items:center;gap:8px;padding:10px;border-bottom:1px solid #f1f5f9;" id="whRow_${i}">
                <span style="flex:1;font-weight:bold;" id="whLabel_${i}">${wh}</span>
                <input id="whInput_${i}" value="${wh}" style="flex:1;display:none;padding:6px 10px;border:1px solid var(--info);border-radius:6px;">
                <button class="btn-sm" style="background:var(--info);color:white;" onclick="toggleEditWh(${i})">‚úèÔ∏è</button>
                <button class="btn-sm" style="background:var(--success);color:white;display:none;" id="whSaveBtn_${i}" onclick="saveEditWh(${i})">üíæ</button>
                <button class="btn-sm" style="background:var(--danger);color:white;" onclick="deleteWh(${i})">üóëÔ∏è</button>
            </div>`).join('');
        };

        window.toggleEditWh=function(i){
            document.getElementById(`whLabel_${i}`).style.display='none';
            document.getElementById(`whInput_${i}`).style.display='block';
            document.getElementById(`whSaveBtn_${i}`).style.display='inline';
        };

        window.saveEditWh=function(i){
            const newName=document.getElementById(`whInput_${i}`).value.trim();
            if(!newName)return;
            const oldName=warehouseList[i];
            warehouseList[i]=newName;
            // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï zoneProductMap ‡∏î‡πâ‡∏ß‡∏¢
            if(oldName!==newName&&zoneProductMap[oldName]){
                zoneProductMap[newName]=zoneProductMap[oldName];
                delete zoneProductMap[oldName];
            }
            saveConfig(); renderWhList();
            document.getElementById('selectZoneMap').innerHTML=warehouseList.map(w=>`<option value="${w}">${w}</option>`).join('');
            renderMapping();
            toast('‚úÖ ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏•‡∏±‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢','#059669');
        };

        window.renderPdList=function(){
            const c=document.getElementById('pdMasterContainer');if(!c)return;
            c.innerHTML=allProducts.map((p,i)=>{
                const units=p.units||[{name:p.unit,rate:0},{name:p.subUnit||'',rate:0}].filter(u=>u.name);
                const unitsStr=units.map((u,ui)=>u.name+(ui<units.length-1&&u.rate>0?' (√ó'+u.rate+')':'')).join(' ‚Üí ');
                return `<div style="padding:8px;background:#f8fafc;margin-bottom:6px;border-radius:8px;border:1px solid #edf2f7;">
                <div style="display:flex;align-items:center;gap:6px;">
                    <div style="flex:1;font-size:12px;"><b>${p.id}</b> - ${p.name}<br><span style="color:#94a3b8;font-size:11px;">${unitsStr}</span></div>
                    <button class="btn-sm" style="background:var(--info);color:white;" onclick="toggleEditPd(${i})">‚úèÔ∏è</button>
                    <button class="btn-sm" style="background:var(--danger);color:white;" onclick="deletePd(${i})">‚úï</button>
                </div>
                <div id="pdEditArea_${i}" style="display:none;margin-top:8px;">
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:6px;">
                        <input id="pdEditName_${i}" value="${p.name}" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤" style="padding:6px;border:1px solid #ddd;border-radius:6px;font-size:12px;grid-column:span 2;">
                        ${units.map((u,ui)=>`
                        <input id="pdEditUnit${ui}_${i}" value="${u.name}" placeholder="‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏ó‡∏µ‡πà ${ui+1}" style="padding:6px;border:1px solid #ddd;border-radius:6px;font-size:12px;">
                        ${ui<units.length-1?`<input id="pdEditRate${ui}_${i}" value="${u.rate||''}" placeholder="‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡πÅ‡∏õ‡∏•‡∏á √ó" type="number" min="1" style="padding:6px;border:1px solid #ddd;border-radius:6px;font-size:12px;">`:'<div></div>'}`).join('')}
                        <button onclick="saveEditPd(${i})" style="grid-column:span 2;background:var(--success);color:white;border:none;padding:6px;border-radius:6px;cursor:pointer;font-size:12px;font-weight:bold;">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                    </div>
                </div>
            </div>`;}).join('');
        };

        window.toggleEditPd=function(i){
            const area=document.getElementById(`pdEditArea_${i}`);
            area.style.display=area.style.display==='none'?'block':'none';
        };

        window.saveEditPd=function(i){
            const name=document.getElementById(`pdEditName_${i}`)?.value.trim();
            if(!name)return;
            const existingUnits=allProducts[i].units||[{name:allProducts[i].unit,rate:0},{name:allProducts[i].subUnit||'',rate:0}].filter(u=>u.name);
            const newUnits=[];
            for(let ui=0;ui<existingUnits.length;ui++){
                const uName=document.getElementById(`pdEditUnit${ui}_${i}`)?.value.trim()||'';
                const uRate=parseFloat(document.getElementById(`pdEditRate${ui}_${i}`)?.value)||0;
                if(uName) newUnits.push({name:uName,rate:uRate});
            }
            if(!newUnits.length)return;
            allProducts[i].name=name;
            allProducts[i].units=newUnits;
            allProducts[i].unit=newUnits[0]?.name||'';
            allProducts[i].subUnit=newUnits[1]?.name||'';
            saveConfig(); renderPdList();
            toast('‚úÖ ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢','#059669');
        };

        window.renderMapping=function(){
            const zone=document.getElementById('selectZoneMap').value,c=document.getElementById('mappingContainer');
            if(!zone||!c)return;
            const mapped=zoneProductMap[zone]||[];
            c.innerHTML=allProducts.map(p=>`<label style="display:flex;align-items:center;gap:12px;padding:15px;border:1px solid #e2e8f0;border-radius:12px;cursor:pointer;background:white;">
                <input type="checkbox" style="width:18px;height:18px;" ${mapped.includes(p.id)?'checked':''} onchange="togglePdMapping('${zone}','${p.id}')">
                <div style="font-size:13px;"><b>${p.id}</b><br><span style="color:#64748b;">${p.name}</span>
                <br><span style="color:#94a3b8;font-size:11px;">${p.unit}${p.subUnit?' / '+p.subUnit:''}</span></div>
            </label>`).join('');
        };

        window.togglePdMapping=function(z,id){if(!zoneProductMap[z])zoneProductMap[z]=[];const i=zoneProductMap[z].indexOf(id);if(i>-1)zoneProductMap[z].splice(i,1);else zoneProductMap[z].push(id);saveConfig();};
        window.addWh=function(){const n=document.getElementById('newWhName').value.trim();if(n){warehouseList.push(n);saveConfig();openWarehouseManager();}};
        window.deleteWh=function(i){if(confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡∏ö‡πÇ‡∏ã‡∏ô?')){warehouseList.splice(i,1);saveConfig();openWarehouseManager();}};

        window.addPd=function(){
            const id=document.getElementById('newPdId').value.trim();
            const name=document.getElementById('newPdName').value.trim();
            const u1=document.getElementById('newPdUnit1').value.trim();
            const u2=document.getElementById('newPdUnit2').value.trim();
            const u3=document.getElementById('newPdUnit3').value.trim();
            const r1=parseFloat(document.getElementById('newPdRate1').value)||0;
            const r2=parseFloat(document.getElementById('newPdRate2').value)||0;
            if(!id||!name||!u1){toast('‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å ‡∏£‡∏´‡∏±‡∏™, ‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ ‡πÅ‡∏•‡∏∞‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏ó‡∏µ‡πà 1 ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢','#c2410c');return;}
            // ‡∏™‡∏£‡πâ‡∏≤‡∏á units array
            const units=[];
            if(u1) units.push({name:u1,rate:r1||0}); // rate = ‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡πÅ‡∏õ‡∏•‡∏á‡πÑ‡∏õ‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏ñ‡∏±‡∏î‡πÑ‡∏õ
            if(u2) units.push({name:u2,rate:r2||0});
            if(u3) units.push({name:u3,rate:0}); // ‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢‡πÑ‡∏°‡πà‡∏°‡∏µ rate
            allProducts.push({id,name,units,
                // backward compat
                unit:u1, subUnit:u2||''
            });
            saveConfig(); renderPdList(); renderMapping();
            ['newPdId','newPdName','newPdUnit1','newPdRate1','newPdUnit2','newPdRate2','newPdUnit3'].forEach(x=>{
                const el=document.getElementById(x); if(el) el.value='';
            });
            toast('‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢','#059669');
        };

        window.deletePd=function(i){if(confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤?')){allProducts.splice(i,1);saveConfig();renderPdList();renderMapping();}};

        // ---- MISC ----
        window.logout=function(){localStorage.removeItem("currentUser");window.location.href="login.html";};
        window.toggleSub=function(id){const s=document.getElementById(id);s.style.display=(s.style.display==='block')?'none':'block';};
        window.closeTool=function(){if(Object.keys(tempCountData).length>0){if(!confirm("‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏õ‡∏¥‡∏î‡∏à‡∏£‡∏¥‡∏á‡πÑ‡∏´‡∏°?"))return;}document.getElementById('toolAppContainer').classList.add('hidden');document.getElementById('dashboardView').classList.remove('hidden');};

        // ============================================================
        // ‚úÖ ‡∏ü‡∏µ‡πÄ‡∏à‡∏≠‡∏£‡πå‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°‡∏ó‡∏±‡πâ‡∏á 11 ‡∏Ç‡πâ‡∏≠ (‡πÑ‡∏°‡πà‡πÅ‡∏Å‡πâ‡πÇ‡∏Ñ‡πâ‡∏î‡πÄ‡∏î‡∏¥‡∏°)
        // ============================================================

        // ----------------------------------------------------------
        // [1] SESSION TIMEOUT ‚Äî logout ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô 30 ‡∏ô‡∏≤‡∏ó‡∏µ
        // ----------------------------------------------------------
        (function initSessionTimeout() {
            const TIMEOUT_MS = 30 * 60 * 1000; // 30 ‡∏ô‡∏≤‡∏ó‡∏µ
            const WARN_MS    = 2 * 60 * 1000;  // ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏Å‡πà‡∏≠‡∏ô 2 ‡∏ô‡∏≤‡∏ó‡∏µ
            let timer, warnTimer, warnShown = false;

            function resetTimer() {
                clearTimeout(timer); clearTimeout(warnTimer); warnShown = false;
                const existWarn = document.getElementById('sessionWarnBanner');
                if (existWarn) existWarn.remove();

                warnTimer = setTimeout(() => {
                    if (warnShown) return; warnShown = true;
                    const banner = document.createElement('div');
                    banner.id = 'sessionWarnBanner';
                    banner.style.cssText = 'position:fixed;top:0;left:0;right:0;background:#f59e0b;color:#1e293b;padding:14px 20px;text-align:center;font-weight:bold;z-index:99998;font-size:14px;';
                    banner.innerHTML = '‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô ‚Äî ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞ logout ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÉ‡∏ô 2 ‡∏ô‡∏≤‡∏ó‡∏µ <button onclick="document.getElementById(\'sessionWarnBanner\').remove();resetSessionTimer();" style="margin-left:15px;background:#1e293b;color:white;border:none;padding:6px 14px;border-radius:6px;cursor:pointer;">‡∏â‡∏±‡∏ô‡∏¢‡∏±‡∏á‡∏≠‡∏¢‡∏π‡πà</button>';
                    document.body.appendChild(banner);
                }, TIMEOUT_MS - WARN_MS);

                timer = setTimeout(() => {
                    alert('‚è∞ ‡∏´‡∏°‡∏î‡πÄ‡∏ß‡∏•‡∏≤‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞ logout ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥');
                    window.logout();
                }, TIMEOUT_MS);
            }

            window.resetSessionTimer = resetTimer;
            ['click','keydown','mousemove','touchstart','scroll'].forEach(ev => document.addEventListener(ev, resetTimer, { passive: true }));
            resetTimer();
        })();

        // ----------------------------------------------------------
        // [2] ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô LOGIN ‡∏ñ‡∏π‡∏Å‡∏Ç‡πâ‡∏≤‡∏° ‚Äî ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö token ‡∏Å‡∏±‡∏ö Firebase ‡∏ó‡∏∏‡∏Å 60 ‡∏ß‡∏¥
        // ----------------------------------------------------------
        (function initFirebaseSessionCheck() {
            async function verifySession() {
                if (!currentUser || currentUser.username === 'admin') return;
                try {
                    const snap = await getDoc(doc(db, 'users', currentUser.username));
                    if (!snap.exists()) { alert('‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö'); window.logout(); return; }
                    const data = snap.data();
                    if (data.status === 'suspended') { alert('üö´ ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ñ‡∏π‡∏Å‡∏£‡∏∞‡∏á‡∏±‡∏ö'); window.logout(); }
                } catch(e) {}
            }
            setInterval(verifySession, 60000);
            verifySession();
        })();

        // ----------------------------------------------------------
        // [3] RATE LIMIT ‡∏Å‡∏≤‡∏£ LOGIN ‡∏ú‡∏¥‡∏î ‚Äî ‡πÄ‡∏Å‡πá‡∏ö‡πÉ‡∏ô Firebase ‡πÉ‡∏´‡πâ Admin ‡∏õ‡∏•‡∏î‡πÑ‡∏î‡πâ
        //     login.html ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å checkLoginRateLimit / recordLoginFail
        //     Admin ‡∏õ‡∏•‡∏î lockout ‡∏ú‡πà‡∏≤‡∏ô‡∏´‡∏ô‡πâ‡∏≤ User Management ‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢
        // ----------------------------------------------------------

        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ username ‡∏ñ‡∏π‡∏Å‡∏•‡πá‡∏≠‡∏Ñ‡∏≠‡∏¢‡∏π‡πà‡πÑ‡∏´‡∏°
        window.checkLoginRateLimit = async function(username) {
            try {
                const snap = await getDoc(doc(db, 'loginLock', username));
                if (!snap.exists()) return { locked: false };
                const data = snap.data();
                const now = Date.now();
                if (data.lockedUntil && now < data.lockedUntil) {
                    const remaining = Math.ceil((data.lockedUntil - now) / 60000);
                    return { locked: true, remaining, failCount: data.failCount || 0 };
                }
                return { locked: false };
            } catch(e) { return { locked: false }; }
        };

        // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡∏ú‡∏¥‡∏î
        window.recordLoginFail = async function(username) {
            try {
                const snap = await getDoc(doc(db, 'loginLock', username));
                const now = Date.now();
                let failCount = 1;
                if (snap.exists()) {
                    const d = snap.data();
                    failCount = (now - (d.lastFail || 0) < 15 * 60 * 1000) ? (d.failCount || 0) + 1 : 1;
                }
                const lockedUntil = failCount >= 5 ? now + 15 * 60 * 1000 : null;
                await setDoc(doc(db, 'loginLock', username), {
                    failCount, lastFail: now, lockedUntil: lockedUntil || null, username
                });
                return { failCount, locked: failCount >= 5 };
            } catch(e) { return { failCount: 0, locked: false }; }
        };

        // ‡∏•‡πâ‡∏≤‡∏á lockout ‡∏´‡∏•‡∏±‡∏á login ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
        window.clearLoginFail = async function(username) {
            try {
                const { deleteDoc } = await import("https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js");
                await deleteDoc(doc(db, 'loginLock', username));
            } catch(e) {}
        };

        // Admin ‡∏õ‡∏•‡∏î lockout ‡∏Ç‡∏≠‡∏á user ‡∏Ñ‡∏ô‡πÉ‡∏î‡∏Å‡πá‡πÑ‡∏î‡πâ
        window.adminUnlockLogin = async function(username) {
            if (!confirm('‡∏õ‡∏•‡∏î lockout ‡∏Ç‡∏≠‡∏á "' + username + '"?')) return;
            try {
                const { deleteDoc } = await import("https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js");
                await deleteDoc(doc(db, 'loginLock', username));
                await addAuditLog('unlockLogin', '‡∏õ‡∏•‡∏î lockout ‡πÉ‡∏´‡πâ ' + username);
                toast('‚úÖ ‡∏õ‡∏•‡∏î lockout "' + username + '" ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', '#059669');
                renderLockedUsers();
            } catch(e) { toast('‚ùå ‡∏õ‡∏•‡∏î‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', '#c2410c'); }
        };

        // ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏•‡πá‡∏≠‡∏Ñ ‡πÉ‡∏ô User Management
        window.renderLockedUsers = async function() {
            const panel = document.getElementById('lockedUsersPanel');
            if (!panel) return;
            panel.innerHTML = '<p style="color:#94a3b8;font-size:13px;text-align:center;padding:10px;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</p>';
            try {
                const snap = await getDocs(collection(db, 'loginLock'));
                const now = Date.now();
                let locked = [];
                snap.forEach(d => {
                    const data = d.data();
                    if (data.lockedUntil && now < data.lockedUntil) {
                        locked.push({ username: d.id, ...data });
                    }
                });
                if (locked.length === 0) {
                    panel.innerHTML = '<p style="color:#94a3b8;font-size:13px;text-align:center;padding:10px;">‚úÖ ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ñ‡∏π‡∏Å‡∏•‡πá‡∏≠‡∏Ñ‡∏≠‡∏¢‡∏π‡πà</p>';
                    return;
                }
                panel.innerHTML = locked.map(u => {
                    const remaining = Math.ceil((u.lockedUntil - now) / 60000);
                    return '<div style="display:flex;align-items:center;justify-content:space-between;padding:10px 12px;background:#fff5f5;border:1px solid #fecaca;border-radius:10px;margin-bottom:8px;">' +
                        '<div><b style="color:var(--danger);">üîí ' + u.username + '</b>' +
                        '<span style="font-size:12px;color:#94a3b8;margin-left:8px;">‡∏ú‡∏¥‡∏î ' + u.failCount + ' ‡∏Ñ‡∏£‡∏±‡πâ‡∏á ‚Ä¢ ‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ' + remaining + ' ‡∏ô‡∏≤‡∏ó‡∏µ</span></div>' +
                        '<button onclick="adminUnlockLogin('' + u.username + '')" style="background:var(--success);color:white;border:none;padding:7px 14px;border-radius:7px;cursor:pointer;font-size:12px;font-weight:bold;">üîì ‡∏õ‡∏•‡∏î Lockout</button>' +
                        '</div>';
                }).join('');
            } catch(e) { panel.innerHTML = '<p style="color:var(--danger);font-size:13px;">‚ùå ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</p>'; }
        };

        // Patch openUserManagement ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏° Lockout Panel
        const _origOpenUserManagement = window.openUserManagement;
        window.openUserManagement = function() {
            _origOpenUserManagement();
            if (currentUser.role !== 'admin') return;
            const header = document.querySelector('#toolAppContainer .tool-header');
            if (!header || document.getElementById('lockedUsersPanelWrap')) return;
            const wrap = document.createElement('div');
            wrap.id = 'lockedUsersPanelWrap';
            wrap.style.cssText = 'background:white;padding:18px 20px;border-radius:14px;border:1px solid #fecaca;margin-bottom:20px;';
            wrap.innerHTML = '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">' +
                '<b style="color:var(--danger);">üîí ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ñ‡∏π‡∏Å‡∏•‡πá‡∏≠‡∏Ñ (Login ‡∏ú‡∏¥‡∏î‡πÄ‡∏Å‡∏¥‡∏ô 5 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á)</b>' +
                '<button onclick="renderLockedUsers()" style="background:#f1f5f9;border:1px solid #e2e8f0;border-radius:7px;padding:5px 12px;cursor:pointer;font-size:12px;">üîÑ ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä</button></div>' +
                '<div id="lockedUsersPanel"><p style="color:#94a3b8;font-size:13px;text-align:center;padding:10px;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</p></div>';
            header.after(wrap);
            renderLockedUsers();
        };

        // ----------------------------------------------------------
        // [4] ‡∏•‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ stockHistory (Admin ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô)
        // ----------------------------------------------------------
        window.deleteHistorySession = async function(sessionId) {
            if (currentUser.role !== 'admin') { toast('‚õî ‡πÄ‡∏â‡∏û‡∏≤‡∏∞ Admin ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô', '#c2410c'); return; }
            if (!confirm('‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡∏ö‡∏™‡∏ï‡πä‡∏≠‡∏Å‡∏ô‡∏µ‡πâ‡∏ñ‡∏≤‡∏ß‡∏£?')) return;
            try {
                const { deleteDoc } = await import("https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js");
                await deleteDoc(doc(db, 'stockHistory', sessionId));
                toast('üóëÔ∏è ‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', '#059669');
                loadHistory();
            } catch(e) { toast('‚ùå ‡∏•‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', '#c2410c'); }
        };

        // patch loadHistory ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏õ‡∏∏‡πà‡∏°‡∏•‡∏ö (‡πÄ‡∏â‡∏û‡∏≤‡∏∞ admin)
        const _origLoadHistory = window.loadHistory;
        window.loadHistory = async function() {
            await _origLoadHistory();
            if (currentUser.role !== 'admin') return;
            // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏õ‡∏∏‡πà‡∏°‡∏•‡∏ö‡πÉ‡∏ô history-card-header
            document.querySelectorAll('.history-card').forEach((card, i) => {
                const header = card.querySelector('.history-card-header');
                if (!header || header.querySelector('.del-history-btn')) return;
                const sid = currentHistoryData[i]?.id;
                if (!sid) return;
                const btn = document.createElement('button');
                btn.className = 'del-history-btn';
                btn.innerHTML = 'üóëÔ∏è ‡∏•‡∏ö';
                btn.style.cssText = 'background:var(--danger);color:white;border:none;padding:5px 12px;border-radius:7px;cursor:pointer;font-size:12px;font-weight:bold;';
                btn.onclick = () => deleteHistorySession(sid);
                header.appendChild(btn);
            });
        };

        // ----------------------------------------------------------
        // [5] ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏ï‡πä‡∏≠‡∏Å‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô (‡∏¢‡∏≠‡∏î‡πÉ‡∏ô countData) ‚Äî Admin ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
        // ----------------------------------------------------------
        window.openEditStockModal = function(productId) {
            if (currentUser.role !== 'admin') { toast('‚õî ‡πÄ‡∏â‡∏û‡∏≤‡∏∞ Admin ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô', '#c2410c'); return; }
            const p = allProducts.find(pd => pd.id === productId);
            const cur = countData[productId]?.total || 0;
            const modal = document.createElement('div'); modal.className = 'modal-overlay'; modal.id = 'editStockModal';
            modal.innerHTML = `<div class="modal-box">
                <h3>‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏¢‡∏≠‡∏î‡∏™‡∏ï‡πä‡∏≠‡∏Å: ${productId}</h3>
                <p style="color:#64748b;font-size:13px;margin-bottom:15px;">‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤: <b>${p?.name || productId}</b><br>‡∏¢‡∏≠‡∏î‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô: <b style="color:var(--success);">${cur} ${p?.unit || ''}</b></p>
                <label style="font-size:12px;font-weight:bold;color:#475569;display:block;margin-bottom:6px;">‡∏¢‡∏≠‡∏î‡πÉ‡∏´‡∏°‡πà (‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏´‡∏•‡∏±‡∏Å)</label>
                <input type="number" id="editStockVal" value="${cur}" min="0" style="width:100%;padding:12px;border:2px solid var(--info);border-radius:10px;font-size:18px;font-weight:bold;text-align:center;box-sizing:border-box;margin-bottom:12px;">
                <label style="font-size:12px;font-weight:bold;color:#475569;display:block;margin-bottom:6px;">‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</label>
                <input type="text" id="editStockReason" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏¢‡∏≠‡∏î‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î" style="width:100%;padding:12px;border:1px solid #e2e8f0;border-radius:10px;font-size:14px;box-sizing:border-box;margin-bottom:15px;">
                <div style="display:flex;gap:10px;">
                    <button onclick="saveEditStock('${productId}')" style="flex:1;background:var(--success);color:white;border:none;padding:12px;border-radius:10px;cursor:pointer;font-weight:bold;">‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                    <button onclick="document.getElementById('editStockModal').remove()" style="flex:1;background:#f1f5f9;color:#475569;border:none;padding:12px;border-radius:10px;cursor:pointer;">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                </div></div>`;
            document.body.appendChild(modal);
        };

        window.saveEditStock = async function(productId) {
            const val = parseFloat(document.getElementById('editStockVal').value);
            const reason = document.getElementById('editStockReason').value.trim();
            if (isNaN(val) || val < 0) { toast('‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏¢‡∏≠‡∏î‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', '#c2410c'); return; }
            if (!reason) { toast('‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•', '#c2410c'); return; }
            const oldVal = countData[productId]?.total || 0;
            if (!countData[productId]) countData[productId] = {};
            countData[productId].total = val;
            countData[productId].lastUpdate = new Date().toLocaleString('th-TH');
            countData[productId].countedBy = currentUser.name + ' (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç)';
            await saveCountData();
            // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å audit log
            await addAuditLog('‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏¢‡∏≠‡∏î‡∏™‡∏ï‡πä‡∏≠‡∏Å', `${productId}: ${oldVal} ‚Üí ${val} (${reason})`);
            document.getElementById('editStockModal').remove();
            toast('‚úÖ ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏¢‡∏≠‡∏î‡∏™‡∏ï‡πä‡∏≠‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', '#059669');
        };

        // ----------------------------------------------------------
        // [6] DASHBOARD SUMMARY ‚Äî ‡πÅ‡∏™‡∏î‡∏á card ‡∏™‡∏£‡∏∏‡∏õ‡∏ó‡∏µ‡πà‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å
        // ----------------------------------------------------------
        async function renderDashboardSummary() {
            const summaryEl = document.getElementById('dashboardSummary');
            if (!summaryEl) return;
            try {
                const snap = await getDocs(collection(db, 'stockHistory'));
                let sessions = [];
                snap.forEach(d => sessions.push(d.data()));
                const today = new Date().toLocaleDateString('th-TH');
                const todaySessions = sessions.filter(s => s.date === today);
                const totalSessions = sessions.length;
                const lastSession = sessions.sort((a,b) => b.timestamp - a.timestamp)[0];
                const totalZones = warehouseList.length;
                const totalProducts = allProducts.length;

                summaryEl.innerHTML = `
                <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:15px;margin-top:20px;">
                    <div style="background:white;border-radius:15px;padding:20px;border-left:4px solid var(--success);box-shadow:0 2px 8px rgba(0,0,0,0.04);">
                        <div style="font-size:28px;font-weight:bold;color:var(--success);">${todaySessions.length}</div>
                        <div style="color:#64748b;font-size:13px;margin-top:4px;">üìã ‡∏ô‡∏±‡∏ö‡∏™‡∏ï‡πä‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</div>
                    </div>
                    <div style="background:white;border-radius:15px;padding:20px;border-left:4px solid var(--info);box-shadow:0 2px 8px rgba(0,0,0,0.04);">
                        <div style="font-size:28px;font-weight:bold;color:var(--info);">${totalSessions}</div>
                        <div style="color:#64748b;font-size:13px;margin-top:4px;">üìä ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
                    </div>
                    <div style="background:white;border-radius:15px;padding:20px;border-left:4px solid #f59e0b;box-shadow:0 2px 8px rgba(0,0,0,0.04);">
                        <div style="font-size:28px;font-weight:bold;color:#f59e0b;">${totalZones}</div>
                        <div style="color:#64748b;font-size:13px;margin-top:4px;">üì¶ ‡∏Ñ‡∏•‡∏±‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
                    </div>
                    <div style="background:white;border-radius:15px;padding:20px;border-left:4px solid #8b5cf6;box-shadow:0 2px 8px rgba(0,0,0,0.04);">
                        <div style="font-size:28px;font-weight:bold;color:#8b5cf6;">${totalProducts}</div>
                        <div style="color:#64748b;font-size:13px;margin-top:4px;">üçé ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
                    </div>
                </div>
                ${lastSession ? `<div style="margin-top:15px;background:white;padding:15px 20px;border-radius:12px;border:1px solid #e2e8f0;font-size:13px;color:#64748b;">
                    üïê ‡∏ô‡∏±‡∏ö‡∏™‡∏ï‡πä‡∏≠‡∏Å‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: <b style="color:var(--primary-dark);">üì¶ ${lastSession.zone}</b> ‚Äî ${lastSession.date} ‡πÇ‡∏î‡∏¢ <b>${lastSession.countedBy||'-'}</b>
                </div>` : ''}`;
            } catch(e) { summaryEl.innerHTML = ''; }
        }

        // Patch onload ‡πÄ‡∏û‡∏∑‡πà‡∏≠ inject summary div ‡πÅ‡∏•‡∏∞ render
        const _origOnload = window.onload;
        window.onload = async function() {
            await _origOnload();
            // inject summary container ‡∏´‡∏•‡∏±‡∏á welcome text
            const welcomeDiv = document.querySelector('#dashboardView > div[style*="padding:30px"]');
            if (welcomeDiv) {
                const summaryDiv = document.createElement('div');
                summaryDiv.id = 'dashboardSummary';
                welcomeDiv.appendChild(summaryDiv);
            }
            await renderDashboardSummary();
        };

        // ----------------------------------------------------------
        // [7] ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÉ‡∏Å‡∏•‡πâ‡∏´‡∏°‡∏î (‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏ô‡πâ‡∏≠‡∏¢‡∏Å‡∏ß‡πà‡∏≤ 30 ‡∏ô‡∏≤‡∏ó‡∏µ)
        // ----------------------------------------------------------
        (function initExpiryWarning() {
            let warned = false;
            const _origCheck = window.checkToolExpiry;
            window.checkToolExpiry = async function() {
                await _origCheck();
                if (warned || currentUser.role === 'admin') return;
                try {
                    const snap = await getDoc(doc(db, 'users', currentUser.username));
                    if (!snap.exists()) return;
                    const expiry = snap.data().toolExpiry || 0;
                    const now = Date.now();
                    const remaining = expiry - now;
                    if (remaining > 0 && remaining < 30 * 60 * 1000 && expiry < 4000000000000) {
                        warned = true;
                        const mins = Math.ceil(remaining / 60000);
                        const banner = document.createElement('div');
                        banner.style.cssText = 'position:fixed;bottom:80px;right:20px;background:#f59e0b;color:#1e293b;padding:14px 18px;border-radius:12px;font-size:13px;font-weight:bold;z-index:9998;box-shadow:0 4px 15px rgba(0,0,0,0.2);max-width:260px;';
                        banner.innerHTML = `‚è∞ ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÄ‡∏´‡∏•‡∏∑‡∏≠ <b>${mins} ‡∏ô‡∏≤‡∏ó‡∏µ</b><br><small style="font-weight:normal;">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠ Admin ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ï‡πà‡∏≠‡∏≠‡∏≤‡∏¢‡∏∏</small><br><button onclick="this.parentElement.remove()" style="margin-top:8px;background:#1e293b;color:white;border:none;padding:4px 10px;border-radius:5px;cursor:pointer;font-size:11px;">‡∏õ‡∏¥‡∏î</button>`;
                        document.body.appendChild(banner);
                        setTimeout(() => banner.remove(), 15000);
                    }
                } catch(e) {}
            };
        })();

        // ----------------------------------------------------------
        // [8] ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏±‡∏ö‡∏™‡∏ï‡πä‡∏≠‡∏Å
        // ----------------------------------------------------------
        // Patch renderStockTool ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ä‡πà‡∏≠‡∏á search
        const _origRenderStockTool = window.renderStockTool;
        window.renderStockTool = async function(zone) {
            await _origRenderStockTool(zone);
            // ‡πÄ‡∏û‡∏¥‡πà‡∏° search bar ‡∏´‡∏•‡∏±‡∏á tool-header
            const toolHeader = document.querySelector('#toolAppContainer .tool-header');
            if (!toolHeader || document.getElementById('stockSearchBar')) return;
            const searchBar = document.createElement('div');
            searchBar.id = 'stockSearchBar';
            searchBar.style.cssText = 'margin-bottom:15px;';
            searchBar.innerHTML = `<input type="text" id="stockSearchInput" placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (‡∏£‡∏´‡∏±‡∏™/‡∏ä‡∏∑‡πà‡∏≠)..." oninput="filterStockRows(this.value)"
                style="width:100%;padding:12px 16px;border:2px solid var(--info);border-radius:12px;font-size:14px;box-sizing:border-box;outline:none;">`;
            toolHeader.after(searchBar);
        };

        window.filterStockRows = function(query) {
            const q = query.toLowerCase().trim();
            document.querySelectorAll('.stock-table .stock-row').forEach(row => {
                const text = row.innerText.toLowerCase();
                row.style.display = (!q || text.includes(q)) ? '' : 'none';
            });
        };

        // ----------------------------------------------------------
        // [9] Export ‡∏¢‡∏≠‡∏î‡∏™‡∏ï‡πä‡∏≠‡∏Å‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô ‚Äî ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß‡πÉ‡∏ô loadSnapshot/exportExcelSnapshot
        //     ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏õ‡∏∏‡πà‡∏°‡∏•‡∏±‡∏î‡πÉ‡∏ô sidebar submenu
        // ----------------------------------------------------------
        // ‡πÄ‡∏û‡∏¥‡πà‡∏° submenu item "‡∏¢‡∏≠‡∏î‡∏™‡∏ï‡πä‡∏≠‡∏Å‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô" ‡πÉ‡∏ô warehouseMenu ‡∏´‡∏•‡∏±‡∏á onload
        (function addSnapshotMenu() {
            const observer = new MutationObserver(() => {
                const subWH = document.getElementById('subWH');
                if (!subWH || document.getElementById('snapshotMenuBtn')) return;
                const btn = document.createElement('div');
                btn.id = 'snapshotMenuBtn';
                btn.style.cssText = 'padding:8px 12px;font-size:13px;color:#10b981;cursor:pointer;border-radius:5px;';
                btn.innerHTML = 'üì¶ ‡∏¢‡∏≠‡∏î‡∏™‡∏ï‡πä‡∏≠‡∏Å‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô';
                btn.onmouseenter = () => btn.style.background = 'rgba(255,255,255,0.05)';
                btn.onmouseleave = () => btn.style.background = '';
                btn.onclick = () => {
                    openStockSummary().then(() => {
                        const sel = document.getElementById('reportMode');
                        if (sel) { sel.value = 'snapshot'; switchReportMode(); }
                    });
                };
                subWH.appendChild(btn);
                observer.disconnect();
            });
            observer.observe(document.body, { childList: true, subtree: true });
        })();

        // ----------------------------------------------------------
        // [10] AUDIT LOG ‚Äî ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡∏≥‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡πÉ‡∏ô Firebase
        // ----------------------------------------------------------
        async function addAuditLog(action, detail) {
            try {
                await addDoc(collection(db, 'auditLog'), {
                    user: currentUser.name,
                    username: currentUser.username,
                    action,
                    detail,
                    timestamp: Date.now(),
                    date: new Date().toLocaleString('th-TH')
                });
            } catch(e) { console.warn('Audit log failed:', e); }
        }

        // Hook ‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ‡πÉ‡∏ô functions ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç
        const _origSaveConfig = saveConfig;
        // Wrap login/logout
        const _origLogout = window.logout;
        window.logout = function() {
            addAuditLog('logout', '‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö').finally(() => _origLogout());
        };

        // Hook grantAccess
        const _origGrantAccess = window.grantAccess;
        window.grantAccess = async function(k, h) {
            await _origGrantAccess(k, h);
            await addAuditLog('grantAccess', `‡πÉ‡∏´‡πâ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå ${k} ${h === 0 ? '‡∏ñ‡∏≤‡∏ß‡∏£' : '+' + h + '‡∏ä‡∏°.'}`);
        };
        // Hook revokeAccess
        const _origRevokeAccess = window.revokeAccess;
        window.revokeAccess = async function(k) {
            await _origRevokeAccess(k);
            await addAuditLog('revokeAccess', `‡∏£‡∏∞‡∏á‡∏±‡∏ö ${k}`);
        };
        // Hook finalSaveStock
        const _origFinalSaveStock = window.finalSaveStock;
        window.finalSaveStock = async function(zone) {
            await _origFinalSaveStock(zone);
            await addAuditLog('saveStock', `‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏ï‡πä‡∏≠‡∏Å zone: ${zone} ‡πÇ‡∏î‡∏¢ ${selectedStaff}`);
        };

        // ‡∏´‡∏ô‡πâ‡∏≤‡∏î‡∏π Audit Log (Admin ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô)
        window.openAuditLog = async function() {
            if (currentUser.role !== 'admin') { toast('‚õî ‡πÄ‡∏â‡∏û‡∏≤‡∏∞ Admin ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô', '#c2410c'); return; }
            document.getElementById('dashboardView').classList.add('hidden');
            const c = document.getElementById('toolAppContainer'); c.classList.remove('hidden');
            c.innerHTML = `<div class="tool-header"><h2>üìã Audit Log ‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</h2><button onclick="closeTool()">‚úï ‡∏õ‡∏¥‡∏î</button></div>
            <div style="background:white;padding:20px;border-radius:15px;border:1px solid #e2e8f0;">
                <p style="color:#94a3b8;text-align:center;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</p>
            </div>`;
            try {
                const snap = await getDocs(collection(db, 'auditLog'));
                let logs = [];
                snap.forEach(d => logs.push(d.data()));
                logs.sort((a, b) => b.timestamp - a.timestamp);
                logs = logs.slice(0, 200); // ‡πÅ‡∏™‡∏î‡∏á‡πÅ‡∏Ñ‡πà 200 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
                c.querySelector('div:last-child').innerHTML = `
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;">
                    <b>üìã Log ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î ${logs.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</b>
                    <input type="text" placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤..." oninput="filterAuditLog(this.value)" style="padding:8px 14px;border:1px solid #e2e8f0;border-radius:8px;font-size:13px;outline:none;">
                </div>
                <div id="auditLogTable" style="overflow-x:auto;">
                <table style="width:100%;border-collapse:collapse;font-size:13px;">
                    <thead><tr style="background:#f8fafc;"><th style="padding:10px;text-align:left;">‡∏ß‡∏±‡∏ô‡πÄ‡∏ß‡∏•‡∏≤</th><th style="padding:10px;text-align:left;">‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</th><th style="padding:10px;text-align:left;">‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡∏≥</th><th style="padding:10px;text-align:left;">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</th></tr></thead>
                    <tbody id="auditLogBody">
                    ${logs.map(l => `<tr style="border-top:1px solid #f1f5f9;" class="audit-row">
                        <td style="padding:10px;color:#94a3b8;white-space:nowrap;">${l.date||'-'}</td>
                        <td style="padding:10px;font-weight:bold;">${l.name||l.username||'-'}</td>
                        <td style="padding:10px;"><span style="background:#e0f2fe;color:#0369a1;padding:3px 8px;border-radius:5px;font-size:11px;">${l.action||'-'}</span></td>
                        <td style="padding:10px;color:#475569;">${l.detail||'-'}</td>
                    </tr>`).join('')}
                    </tbody>
                </table></div>`;
            } catch(e) { c.querySelector('div:last-child').innerHTML = '<p style="color:var(--danger);text-align:center;">‚ùå ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</p>'; }
        };

        window.filterAuditLog = function(q) {
            document.querySelectorAll('#auditLogBody .audit-row').forEach(row => {
                row.style.display = row.innerText.toLowerCase().includes(q.toLowerCase()) ? '' : 'none';
            });
        };

        // ‡πÄ‡∏û‡∏¥‡πà‡∏° Audit Log ‡πÉ‡∏ô Admin submenu
        (function addAuditLogMenu() {
            const observer = new MutationObserver(() => {
                const subAdmin = document.getElementById('subAdmin');
                if (!subAdmin || document.getElementById('auditLogMenuBtn')) return;
                const btn = document.createElement('div');
                btn.id = 'auditLogMenuBtn';
                btn.style.cssText = 'padding:8px 12px;font-size:13px;color:#94a3b8;cursor:pointer;border-radius:5px;';
                btn.innerHTML = '‚óè Audit Log';
                btn.onmouseenter = () => { btn.style.color = 'white'; btn.style.background = 'rgba(255,255,255,0.05)'; };
                btn.onmouseleave = () => { btn.style.color = '#94a3b8'; btn.style.background = ''; };
                btn.onclick = openAuditLog;
                subAdmin.appendChild(btn);
                observer.disconnect();
            });
            observer.observe(document.body, { childList: true, subtree: true });
        })();

        // ----------------------------------------------------------
        // [11] BACKUP & RESTORE CONFIG
        // ----------------------------------------------------------
        window.backupConfig = function() {
            const data = { warehouseList, allProducts, zoneProductMap, roleSettings, backupDate: new Date().toLocaleString('th-TH') };
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `TingTing_Backup_${new Date().toLocaleDateString('th-TH').replace(/\//g,'-')}.json`;
            a.click();
            toast('‚úÖ Backup ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', '#059669');
            addAuditLog('backup', 'Backup config');
        };

        window.restoreConfig = function() {
            const input = document.createElement('input');
            input.type = 'file'; input.accept = '.json';
            input.onchange = async function(e) {
                const file = e.target.files[0]; if (!file) return;
                try {
                    const text = await file.text();
                    const data = JSON.parse(text);
                    if (!data.warehouseList || !data.allProducts) { toast('‚ùå ‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', '#c2410c'); return; }
                    if (!confirm(`‚ö†Ô∏è Restore ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Backup ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${data.backupDate}?\n‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà`)) return;
                    warehouseList  = data.warehouseList;
                    allProducts    = data.allProducts;
                    zoneProductMap = data.zoneProductMap || {};
                    roleSettings   = data.roleSettings   || roleSettings;
                    await saveConfig();
                    toast('‚úÖ Restore ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏Å‡∏≥‡∏•‡∏±‡∏á reload...', '#059669');
                    addAuditLog('restore', `Restore ‡∏à‡∏≤‡∏Å backup ${data.backupDate}`);
                    setTimeout(() => location.reload(), 1500);
                } catch(e) { toast('‚ùå Restore ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏™‡∏µ‡∏¢‡∏´‡∏≤‡∏¢', '#c2410c'); }
            };
            input.click();
        };

        // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏õ‡∏∏‡πà‡∏° Backup/Restore ‡πÉ‡∏ô WarehouseManager
        const _origOpenWarehouseManager = window.openWarehouseManager;
        window.openWarehouseManager = function() {
            _origOpenWarehouseManager();
            // inject backup/restore bar ‡∏´‡∏•‡∏±‡∏á tool-header
            const header = document.querySelector('#toolAppContainer .tool-header');
            if (!header || document.getElementById('backupBar')) return;
            const bar = document.createElement('div');
            bar.id = 'backupBar';
            bar.style.cssText = 'background:white;padding:15px 20px;border-radius:12px;border:1px solid #e2e8f0;margin-bottom:20px;display:flex;gap:10px;align-items:center;';
            bar.innerHTML = `<span style="font-size:13px;color:#64748b;flex:1;">üíæ ‡∏™‡∏≥‡∏£‡∏≠‡∏á/‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡∏∞‡∏ö‡∏ö</span>
                <button onclick="backupConfig()" style="background:var(--success);color:white;border:none;padding:10px 18px;border-radius:8px;cursor:pointer;font-size:13px;font-weight:bold;">üì• Backup JSON</button>
                <button onclick="restoreConfig()" style="background:#f59e0b;color:#1e293b;border:none;padding:10px 18px;border-radius:8px;cursor:pointer;font-size:13px;font-weight:bold;">üì§ Restore JSON</button>`;
            header.after(bar);
        };

        // ----------------------------------------------------------
        // [MOBILE] Hamburger Sidebar (responsive)
        // ----------------------------------------------------------
        window.toggleSidebar = function() {
            document.querySelector('.sidebar').classList.toggle('open');
            document.getElementById('sidebarOverlay').classList.toggle('open');
        };
        window.closeSidebar = function() {
            document.querySelector('.sidebar').classList.remove('open');
            document.getElementById('sidebarOverlay').classList.remove('open');
        };

        // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å audit log ‡∏ï‡∏≠‡∏ô login (‡πÄ‡∏°‡∏∑‡πà‡∏≠ onload ‡πÄ‡∏™‡∏£‡πá‡∏à)
        setTimeout(() => addAuditLog('login', `‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö role: ${currentUser.role}`), 2000);

    </script>

    <!-- MOBILE RESPONSIVE STYLES -->
    <style>
        .hamburger { display:none; position:fixed; top:15px; left:15px; z-index:2000; background:var(--primary-dark); color:var(--accent-gold); border:none; border-radius:10px; width:44px; height:44px; font-size:20px; cursor:pointer; box-shadow:0 4px 12px rgba(0,0,0,0.3); align-items:center; justify-content:center; }
        .sidebar-overlay { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.5); z-index:999; }
        .sidebar-overlay.open { display:block; }
        @media (max-width:768px) {
            .hamburger { display:flex; }
            .sidebar { transform:translateX(-100%); transition:transform 0.3s ease; z-index:1001; }
            .sidebar.open { transform:translateX(0); }
            .main-content { margin-left:0 !important; width:100% !important; }
            .banner-container { height:200px; }
            .app-container { padding:15px; padding-top:70px; }
            .modal-box { width:90vw; padding:20px; }
            .tool-header { flex-direction:column; gap:10px; align-items:flex-start; padding-top:50px; }
            .tool-header button { align-self:flex-end; }
            .filter-bar { flex-direction:column; }
            .filter-bar select, .filter-bar input[type="date"] { min-width:unset; width:100%; box-sizing:border-box; }
            .stock-row td { padding:10px 8px; }
            .history-card-header { flex-direction:column; align-items:flex-start; gap:5px; }
        }
    </style>

    <!-- HAMBURGER + OVERLAY HTML -->
    <script>
        // inject hamburger ‡πÅ‡∏•‡∏∞ overlay ‡∏Å‡πà‡∏≠‡∏ô sidebar
        document.addEventListener('DOMContentLoaded', function() {
            const hamburger = document.createElement('button');
            hamburger.className = 'hamburger no-print';
            hamburger.id = 'hamburgerBtn';
            hamburger.innerHTML = '‚ò∞';
            hamburger.onclick = () => toggleSidebar();
            document.body.insertBefore(hamburger, document.body.firstChild);

            const overlay = document.createElement('div');
            overlay.className = 'sidebar-overlay no-print';
            overlay.id = 'sidebarOverlay';
            overlay.onclick = () => closeSidebar();
            document.body.insertBefore(overlay, document.body.firstChild);

            // ‡∏õ‡∏¥‡∏î sidebar ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Å‡∏î‡πÄ‡∏°‡∏ô‡∏π (mobile)
            document.querySelectorAll('.submenu div, .nav-item').forEach(el => {
                el.addEventListener('click', () => {
                    if (window.innerWidth <= 768) closeSidebar();
                });
            });
        });
    </script>

    <script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>
</body>
</html>
