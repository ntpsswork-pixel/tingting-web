<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TingTing Dashboard</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <style>
        :root { --sidebar-width: 260px; --primary-dark: #1e293b; --accent-gold: #fccf55; --bg-light: #f1f5f9; --success: #10b981; --danger: #ef4444; --info: #3b82f6; }
        body { margin: 0; display: flex; font-family: 'Segoe UI', Tahoma, sans-serif; background: var(--bg-light); min-height: 100vh; overflow-x: hidden; }
        .sidebar { width: var(--sidebar-width); height: 100vh; background: var(--primary-dark); color: white; position: fixed; left: 0; top: 0; z-index: 1000; display: flex; flex-direction: column; }
        .sidebar-brand { padding: 30px 20px; text-align: center; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .sidebar-brand h2 { margin: 0; color: var(--accent-gold); font-size: 24px; letter-spacing: 2px; }
        .user-info { padding: 20px; margin: 15px; background: rgba(255,255,255,0.05); border-radius: 12px; font-size: 14px; }
        .user-info b { color: var(--accent-gold); display: block; margin-bottom: 4px; }
        .nav-links { flex: 1; padding: 10px 15px; overflow-y: auto; }
        .nav-item { padding: 12px 15px; cursor: pointer; border-radius: 8px; margin-bottom: 5px; transition: 0.3s; display: flex; align-items: center; gap: 10px; color: #cbd5e1; }
        .nav-item:hover { background: rgba(255,255,255,0.05); }
        .nav-item.active { background: var(--accent-gold); color: var(--primary-dark); font-weight: bold; }
        .submenu { padding-left: 20px; display: none; margin-bottom: 10px; border-left: 1px solid #334155; margin-left: 20px; }
        .submenu div { padding: 8px 12px; font-size: 13px; color: #94a3b8; cursor: pointer; border-radius: 5px; }
        .submenu div:hover { color: white; background: rgba(255,255,255,0.05); }
        .main-content { margin-left: var(--sidebar-width); width: calc(100% - var(--sidebar-width)); flex: 1; }
        .banner-container { width: 100%; height: 380px; background: #000; overflow: hidden; position: relative; }
        .app-container { padding: 30px; animation: fadeIn 0.4s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .tool-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; border-bottom: 2px solid #e2e8f0; padding-bottom: 15px; }
        .user-card { background: white; border-radius: 15px; padding: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.03); border: 1px solid #e2e8f0; }
        .stock-table { width: 100%; border-collapse: separate; border-spacing: 0 8px; }
        .stock-row { background: white; border-radius: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.02); }
        .stock-row td { padding: 15px; }
        .btn-action { width: 40px; height: 40px; border-radius: 8px; border: none; color: white; cursor: pointer; transition: 0.2s; font-weight: bold; }
        .hidden { display: none !important; }
        .input-group { background: white; padding: 10px; border-radius: 10px; border: 1px solid #e2e8f0; }
        .input-group label { display: block; font-size: 11px; color: #64748b; margin-bottom: 3px; font-weight: bold; }
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 9999; display: flex; align-items: center; justify-content: center; animation: fadeIn 0.2s ease; }
        .modal-box { background: white; border-radius: 20px; padding: 32px; width: 420px; box-shadow: 0 24px 60px rgba(0,0,0,0.3); max-height: 85vh; overflow-y: auto; }
        .modal-box h3 { margin: 0 0 20px; color: var(--primary-dark); font-size: 18px; }
        .modal-box input { width: 100%; padding: 12px 14px; border: 1px solid #e2e8f0; border-radius: 10px; font-size: 14px; margin-bottom: 12px; box-sizing: border-box; outline: none; transition: border 0.2s; font-family: 'Segoe UI', sans-serif; }
        .modal-box input:focus { border-color: var(--info); }
        .modal-error { color: var(--danger); font-size: 12px; margin-bottom: 10px; display: none; }
        .toast { position: fixed; bottom: 30px; right: 30px; background: #1e293b; color: white; padding: 14px 20px; border-radius: 12px; font-size: 14px; z-index: 99999; animation: toastIn 0.3s ease; box-shadow: 0 8px 24px rgba(0,0,0,0.3); max-width: 300px; }
        @keyframes toastIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .upload-progress { display: none; margin-top: 10px; background: #f1f5f9; border-radius: 8px; overflow: hidden; height: 8px; }
        .upload-progress-bar { height: 100%; background: var(--success); transition: width 0.3s; width: 0%; }
        .filter-bar { background: white; padding: 20px; border-radius: 15px; border: 1px solid #e2e8f0; margin-bottom: 20px; display: flex; gap: 15px; flex-wrap: wrap; align-items: flex-end; }
        .filter-bar label { font-size: 11px; color: #64748b; font-weight: bold; display: block; margin-bottom: 5px; }
        .filter-bar select, .filter-bar input[type="date"] { padding: 10px 14px; border: 1px solid #e2e8f0; border-radius: 10px; font-size: 14px; outline: none; min-width: 180px; }
        .filter-bar select:focus, .filter-bar input:focus { border-color: var(--info); }
        .history-card { background: white; border-radius: 12px; border: 1px solid #e2e8f0; margin-bottom: 15px; overflow: hidden; }
        .history-card-header { padding: 15px 20px; background: #f8fafc; border-bottom: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center; }
        .item-row { display: flex; align-items: center; gap: 8px; padding: 8px; border:1px solid #f1f5f9; border-radius: 8px; margin-bottom: 6px; background: #f8fafc; font-size: 13px; }
        .item-row span { flex: 1; }
        .btn-sm { padding: 4px 10px; border-radius: 6px; border: none; cursor: pointer; font-size: 12px; font-weight: bold; }
        .online-dot { width:10px;height:10px;border-radius:50%;background:var(--success);display:inline-block;box-shadow:0 0 0 2px rgba(16,185,129,0.3);animation:pulse-green 2s infinite; }
        .offline-dot { width:10px;height:10px;border-radius:50%;background:#94a3b8;display:inline-block; }
        @keyframes pulse-green { 0%,100%{box-shadow:0 0 0 2px rgba(16,185,129,0.3);} 50%{box-shadow:0 0 0 5px rgba(16,185,129,0.1);} }
        .online-list { padding: 10px 15px 0; }
        .online-item { display:flex;align-items:center;gap:8px;padding:6px 0;border-bottom:1px solid rgba(255,255,255,0.05);font-size:12px;color:#cbd5e1; }
        @media print {
            .sidebar, .no-print, button, #bannerAdminSection { display: none !important; }
            .main-content { margin-left: 0 !important; width: 100% !important; }
            .app-container { padding: 0 !important; }
            table { width: 100% !important; border: 1px solid #000 !important; }
            th, td { border: 1px solid #ddd !important; padding: 8px !important; }
            .history-card { break-inside: avoid; }
        }
        /* ---- MOBILE RESPONSIVE ---- */
        .hamburger { display:none; position:fixed; top:14px; left:14px; z-index:2000; background:var(--primary-dark); border:none; border-radius:10px; padding:10px 13px; cursor:pointer; flex-direction:column; gap:5px; }
        .hamburger span { display:block; width:22px; height:2px; background:var(--accent-gold); border-radius:2px; transition:0.3s; }
        .sidebar-overlay { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.5); z-index:999; }
        @media (max-width: 768px) {
            .hamburger { display:flex; }
            .sidebar { transform:translateX(-100%); transition:transform 0.3s ease; z-index:1000; }
            .sidebar.open { transform:translateX(0); }
            .sidebar-overlay.open { display:block; }
            .main-content { margin-left:0 !important; width:100% !important; }
            .app-container { padding:16px !important; }
            .tool-header { flex-direction:column; gap:10px; padding-top:50px; }
            .filter-bar { flex-direction:column; }
            .filter-bar select, .filter-bar input[type="date"] { min-width:unset; width:100%; }
            .stock-row td { padding:10px 8px; }
            .user-card { padding:14px; }
            #dashSummaryCards { grid-template-columns:1fr 1fr !important; }
            .history-card-header { flex-direction:column; gap:6px; }
        }
        @media (max-width: 480px) {
            #dashSummaryCards { grid-template-columns:1fr !important; }
        }
    </style>
</head>
<body>
    <!-- Mobile hamburger -->
    <button class="hamburger no-print" onclick="toggleSidebar()" aria-label="‡πÄ‡∏°‡∏ô‡∏π">
        <span></span><span></span><span></span>
    </button>
    <div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleSidebar()"></div>
    <div class="sidebar no-print" id="mainSidebar">
        <div class="sidebar-brand"><h2>TINGTING</h2></div>
        <div class="user-info">
            <small>‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô:</small>
            <b id="roleDisplay">...</b>
            <small id="roleStatusText">‡∏ê‡∏≤‡∏ô‡∏∞: -</small>
            <div id="timerDisplay" style="color:var(--accent-gold);font-weight:bold;font-size:12px;margin-top:8px;"></div>
        </div>
        <div style="padding:0 15px 5px;">
            <button onclick="openChangePasswordModal()" style="width:100%;background:rgba(255,255,255,0.05);color:#94a3b8;border:1px solid #334155;padding:9px;border-radius:8px;cursor:pointer;font-size:12px;">üîë ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô Password</button>
        </div>
        <div class="online-list" id="onlineListSidebar"></div>
        <div class="nav-links">
            <div class="nav-item active" onclick="location.reload()">üè† ‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å Dashboard</div>
            <div id="warehouseMenu" class="hidden">
                <div class="nav-item" onclick="toggleSub('subWH')">üì¶ ‡∏Ñ‡∏•‡∏±‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ ‚ñæ</div>
                <div id="subWH" class="submenu">
                    <div onclick="openStockSummary()" style="color:var(--accent-gold);">üìä ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ & Export ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</div>
                    <div onclick="openInventoryCheck()" style="color:#10b981;">üìã ‡πÉ‡∏ö‡∏ô‡∏±‡∏ö‡∏™‡∏ï‡πä‡∏≠‡∏Å‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</div>
                    <div onclick="openPurchaseOrder()" style="color:#ef4444;">üõí ‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</div>
                    <div onclick="openImportProducts()" style="color:#8b5cf6;">üì• Import ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏à‡∏≤‡∏Å Excel</div>
                </div>
            </div>
            <div id="requisitionMenu" class="hidden">
                <div class="nav-item" onclick="toggleSub('subReq')" style="color:#f59e0b;">üìã ‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏ö‡∏¥‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ ‚ñæ</div>
                <div id="subReq" class="submenu">
                    <div onclick="openCreateRequisition()" style="color:#f59e0b;">‚úèÔ∏è ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡πÄ‡∏ö‡∏¥‡∏Å‡πÉ‡∏´‡∏°‡πà</div>
                    <div onclick="openMyRequisitions()">üìÑ ‡πÉ‡∏ö‡πÄ‡∏ö‡∏¥‡∏Å‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</div>
                    <div id="reqApproveMenu" class="hidden" onclick="openPendingRequisitions()" style="color:#ef4444;">üîî ‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ <span id="reqBadge" style="background:#ef4444;color:white;border-radius:10px;padding:1px 7px;font-size:10px;margin-left:4px;"></span></div>
                    <div id="reqAllMenu" class="hidden" onclick="openAllRequisitions()">üìä ‡πÉ‡∏ö‡πÄ‡∏ö‡∏¥‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
                </div>
            </div>
            <div id="toolsMenu" class="hidden">
                <div class="nav-item" onclick="toggleSub('subTools')" style="color:var(--success);">üõ†Ô∏è ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô ‚ñæ</div>
                <div id="subTools" class="submenu">
                    <div onclick="openCentralStock()">‚óè ‡∏ô‡∏±‡∏ö‡∏™‡∏ï‡πä‡∏≠‡∏Å‡∏Ñ‡∏£‡∏±‡∏ß‡∏Å‡∏•‡∏≤‡∏á</div>
                </div>
            </div>
            <div id="adminMenu" class="hidden">
                <div class="nav-item" onclick="toggleSub('subAdmin')" style="color:var(--accent-gold);">üë§ ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡∏ö‡∏ö ‚ñæ</div>
                <div id="subAdmin" class="submenu">
                    <div onclick="openUserManagement()">‚óè ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô & ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå</div>
                    <div onclick="openWarehouseManager()" style="color:var(--accent-gold);">‚óè ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏•‡∏±‡∏á‡πÅ‡∏•‡∏∞‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</div>
                </div>
            </div>
        </div>
        <div class="nav-item" onclick="logout()" style="color:var(--danger);border-top:1px solid rgba(255,255,255,0.05);margin-top:auto;padding:20px;">üö™ ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</div>
    </div>  <!-- end sidebar -->

    <div class="main-content">
        <div id="dashboardView" class="no-print">
            <!-- BANNER ADMIN (admin only, hidden by default) -->
            <div id="bannerAdminSection" class="hidden" style="padding:20px 30px 0;">
                <div style="background:white;padding:20px;border-radius:15px;border:1px solid #e2e8f0;">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
                        <h3 style="margin:0;">üì∏ ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏ö‡∏ô‡πÄ‡∏ô‡∏≠‡∏£‡πå</h3>
                        <button onclick="document.getElementById('bannerAdminSection').classList.add('hidden')" style="background:#f1f5f9;border:none;padding:6px 14px;border-radius:8px;cursor:pointer;color:#64748b;">‚úï ‡∏õ‡∏¥‡∏î</button>
                    </div>
                    <div style="display:flex;gap:10px;margin-bottom:10px;">
                        <input type="file" id="bannerFile" accept="image/*" style="flex:1;padding:8px;border:1px solid #ddd;border-radius:8px;">
                        <button onclick="uploadBanner()" style="background:var(--success);color:white;border:none;padding:10px 20px;border-radius:8px;cursor:pointer;">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°</button>
                    </div>
                    <div class="upload-progress" id="uploadProgress"><div class="upload-progress-bar" id="uploadProgressBar"></div></div>
                    <div id="thumbList" style="display:flex;gap:12px;flex-wrap:wrap;margin-top:15px;"></div>
                </div>
            </div>

            <!-- MAIN DASHBOARD -->
            <div class="app-container">
                <div id="viewOnlyAlert" class="hidden" style="background:#fff7ed;color:#c2410c;padding:15px;border-radius:10px;border:1px solid #fdba74;margin-bottom:20px;">
                    ‚ö†Ô∏è <b>‡πÇ‡∏´‡∏°‡∏î‡∏î‡∏π‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß:</b> ‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏´‡∏£‡∏∑‡∏≠‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏î‡πâ
                </div>

                <!-- alert banner -->
                <div id="dashAlertBanner"></div>
                <!-- greeting -->
                <div style="margin-bottom:24px;">
                    <h2 style="margin:0;color:var(--primary-dark);" id="greetingText">‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ...</h2>
                    <p style="margin:4px 0 0;color:#64748b;font-size:14px;" id="greetingDate"></p>
                </div>

                <!-- SUMMARY CARDS -->
                <div id="dashSummaryCards" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:16px;margin-bottom:28px;">
                    <div style="background:white;border-radius:14px;padding:20px;border:1px solid #e2e8f0;text-align:center;color:#94a3b8;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>
                </div>

                <!-- CHART + RECENT -->
                <div style="display:grid;grid-template-columns:1.4fr 1fr;gap:20px;">
                    <!-- trend chart -->
                    <div style="background:white;border-radius:14px;padding:24px;border:1px solid #e2e8f0;">
                        <h4 style="margin:0 0 16px;color:var(--primary-dark);">üìà Trend ‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡∏ö‡∏™‡∏ï‡πä‡∏≠‡∏Å 7 ‡∏ß‡∏±‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</h4>
                        <canvas id="trendChart" height="180"></canvas>
                    </div>
                    <!-- recent sessions -->
                    <div style="background:white;border-radius:14px;padding:24px;border:1px solid #e2e8f0;">
                        <h4 style="margin:0 0 16px;color:var(--primary-dark);">üïê ‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡∏ö‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</h4>
                        <div id="dashRecentList"><p style="color:#94a3b8;font-size:13px;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</p></div>
                    </div>
                </div>
            </div>
        </div>
        <div id="toolAppContainer" class="app-container hidden"></div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
        import { getFirestore, doc, getDoc, getDocs, setDoc, addDoc, collection } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
        import { getDatabase, ref, set, onValue, onDisconnect, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDOduBfKHKwObxOk3MUMGxj1PGT23p_swM",
            authDomain: "tingting-3d57f.firebaseapp.com",
            projectId: "tingting-3d57f",
            storageBucket: "tingting-3d57f.firebasestorage.app",
            messagingSenderId: "998609441304",
            appId: "1:998609441304:web:0c7fbedf869fa2335d296d",
            databaseURL: "https://tingting-3d57f-default-rtdb.asia-southeast1.firebasedatabase.app"
        };

        const CLOUDINARY_CLOUD  = "dof4vtj87";
        const CLOUDINARY_PRESET = "tingting_banners";

        const app  = initializeApp(firebaseConfig);
        const db   = getFirestore(app);
        const rtdb = getDatabase(app);

        let currentUser    = JSON.parse(localStorage.getItem("currentUser")) || null;
        let warehouseList  = ["‡∏Ñ‡∏•‡∏±‡∏á‡∏´‡∏•‡∏±‡∏Å"];
        let allProducts    = [];
        let zoneProductMap = {};
        let countData      = {};
        let roleSettings   = {
            admin:     { menus: ["warehouse","tools","admin","requisition"], viewOnly: false },
            warehouse: { menus: ["warehouse","tools","requisition"],         viewOnly: false },
            staff:     { menus: ["tools","requisition"],                     viewOnly: false }
        };
        let tempCountData = {};
        let selectedStaff = "";
        let selectedDate = new Date().toISOString().split('T')[0];
        let productMinMax = {}; // { "zone__productId": { min, max } }

        // ---- UTILS ----
        async function hashPassword(p) {
            const buf = await crypto.subtle.digest('SHA-256', new TextEncoder().encode(p));
            return Array.from(new Uint8Array(buf)).map(b => b.toString(16).padStart(2,'0')).join('');
        }

        function toast(msg, color = '#1e293b') {
            document.querySelectorAll('.toast').forEach(t => t.remove());
            const t = document.createElement('div');
            t.className = 'toast'; t.style.background = color; t.innerText = msg;
            document.body.appendChild(t);
            setTimeout(() => t.remove(), 3000);
        }

        // ---- FIREBASE HELPERS ----
        async function loadConfig() {
            try {
                const snap = await getDoc(doc(db,'config','main'));
                if (snap.exists()) {
                    const d = snap.data();
                    if (d.warehouseList)  warehouseList  = d.warehouseList;
                    if (d.allProducts)    allProducts    = d.allProducts;
                    if (d.zoneProductMap) zoneProductMap = d.zoneProductMap;
                    if (d.roleSettings)   roleSettings   = d.roleSettings;
                    if (d.productMinMax)  productMinMax  = d.productMinMax;
                }
            } catch(e) { console.error(e); }
        }

        async function saveConfig() {
            try { await setDoc(doc(db,'config','main'), { warehouseList, allProducts, zoneProductMap, roleSettings, productMinMax }, { merge:true }); }
            catch(e) { toast('‚ùå ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å config ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à','#c2410c'); }
        }

        async function loadCountData() {
            try { const s = await getDoc(doc(db,'stock','countData')); if (s.exists()) countData = s.data(); }
            catch(e) { console.error(e); }
        }

        async function saveCountData() {
            try { await setDoc(doc(db,'stock','countData'), countData); }
            catch(e) { toast('‚ùå ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏ï‡πä‡∏≠‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à','#c2410c'); }
        }

        async function loadBanners() {
            try { const s = await getDoc(doc(db,'config','banners')); return s.exists() ? (s.data().urls || []) : []; }
            catch(e) { return []; }
        }

        async function saveBanners(urls) { await setDoc(doc(db,'config','banners'), { urls }); }

        function getVisibleWarehouses() {
            const u = currentUser;
            if (u.username && u.username.toUpperCase().startsWith('BT000')) {
                return u.assignedZones && u.assignedZones.length > 0 ? u.assignedZones : [];
            }
            return warehouseList;
        }

        // ---- ONLOAD ----
        window.onload = async function() {
            if (!currentUser) { window.location.href = 'login.html'; return; }
            document.getElementById('roleDisplay').innerText = currentUser.name;
            await loadConfig();
            await loadCountData();
            applyPermissions();
            await renderBanners();
            setInterval(checkToolExpiry, 5000);
            setInterval(checkHardBanStatus, 10000);
            initPresence();
            listenOnlineUsers();
            initDashboard();
            resetSessionTimer();
            loadReqBadge();
        };

        // ---- DASHBOARD ----
        let trendChartInstance = null;

        async function initDashboard() {
            // greeting
            const hour = new Date().getHours();
            const greet = hour<12?'üåÖ ‡∏≠‡∏£‡∏∏‡∏ì‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏¥‡πå':hour<17?'‚òÄÔ∏è ‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏ï‡∏≠‡∏ô‡∏ö‡πà‡∏≤‡∏¢':'üåô ‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏ï‡∏≠‡∏ô‡πÄ‡∏¢‡πá‡∏ô';
            const el = document.getElementById('greetingText');
            const elDate = document.getElementById('greetingDate');
            if(el) el.innerText = greet+' ‡∏Ñ‡∏∏‡∏ì'+currentUser.name;
            if(elDate) {
                const now = new Date();
                elDate.innerText = now.toLocaleDateString('th-TH',{weekday:'long',year:'numeric',month:'long',day:'numeric'});
            }
            await loadCountData();
            renderSummaryCards();
            await loadDashHistory();
            renderStockAlerts();
        }

        function renderSummaryCards() {
            const c = document.getElementById('dashSummaryCards');
            if(!c) return;
            const colors = ['#3b82f6','#10b981','#f59e0b','#8b5cf6','#ef4444','#06b6d4'];
            const cards = warehouseList.map((zone, zi) => {
                const prods = allProducts.filter(p => (zoneProductMap[zone]||[]).includes(p.id));
                const totalItems = prods.length;
                const lastUpdate = prods.map(p => countData[p.id]?.lastUpdate||'').filter(Boolean).sort().reverse()[0] || '-';
                const color = colors[zi % colors.length];
                return `<div style="background:white;border-radius:14px;padding:20px;border:1px solid #e2e8f0;border-top:4px solid ${color};cursor:pointer;transition:box-shadow 0.2s;" onmouseover="this.style.boxShadow='0 8px 24px rgba(0,0,0,0.08)'" onmouseout="this.style.boxShadow='none'">
                    <div style="font-size:12px;color:#64748b;font-weight:bold;margin-bottom:8px;">üì¶ ${zone}</div>
                    <div style="font-size:28px;font-weight:bold;color:${color};">${totalItems}</div>
                    <div style="font-size:11px;color:#94a3b8;margin-top:4px;">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</div>
                    <div style="font-size:10px;color:#cbd5e1;margin-top:8px;border-top:1px solid #f1f5f9;padding-top:8px;">‡∏ô‡∏±‡∏ö‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: ${lastUpdate}</div>
                </div>`;
            });
            // total card
            const totalProds = allProducts.length;
            cards.unshift(`<div style="background:linear-gradient(135deg,var(--primary-dark),#334155);border-radius:14px;padding:20px;color:white;">
                <div style="font-size:12px;color:#94a3b8;font-weight:bold;margin-bottom:8px;">üè≠ ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
                <div style="font-size:28px;font-weight:bold;">${totalProds}</div>
                <div style="font-size:11px;color:#94a3b8;margin-top:4px;">‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
                <div style="font-size:10px;color:#64748b;margin-top:8px;border-top:1px solid #475569;padding-top:8px;">${warehouseList.length} ‡∏Ñ‡∏•‡∏±‡∏á</div>
            </div>`);
            c.innerHTML = cards.join('');
        }

        async function loadDashHistory() {
            try {
                const snap = await getDocs(collection(db,'stockHistory'));
                let sessions = [];
                snap.forEach(d => sessions.push({id:d.id,...d.data()}));
                sessions.sort((a,b) => b.timestamp - a.timestamp);

                // recent 5
                renderRecentSessions(sessions.slice(0,5));

                // trend chart: ‡∏ô‡∏±‡∏ö session ‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á 7 ‡∏ß‡∏±‡∏ô
                renderTrendChart(sessions);
            } catch(e) { console.error(e); }
        }

        function renderRecentSessions(sessions) {
            const c = document.getElementById('dashRecentList');
            if(!c) return;
            if(!sessions.length){c.innerHTML='<p style="color:#94a3b8;font-size:13px;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡∏ö</p>';return;}
            c.innerHTML = sessions.map(s => {
                const itemCount = (s.items||[]).length;
                return `<div style="display:flex;align-items:center;gap:12px;padding:10px 0;border-bottom:1px solid #f1f5f9;">
                    <div style="width:36px;height:36px;border-radius:50%;background:#f1f5f9;display:flex;align-items:center;justify-content:center;font-size:16px;flex-shrink:0;">üì¶</div>
                    <div style="flex:1;min-width:0;">
                        <div style="font-weight:bold;font-size:13px;color:var(--primary-dark);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${s.zone}</div>
                        <div style="font-size:11px;color:#64748b;">${s.date} ‚Ä¢ ${s.countedBy||'-'} ‚Ä¢ ${itemCount} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div>
                    </div>
                </div>`;
            }).join('');
        }

        function renderTrendChart(sessions) {
            const canvas = document.getElementById('trendChart');
            if(!canvas) return;

            // ‡∏™‡∏£‡πâ‡∏≤‡∏á label 7 ‡∏ß‡∏±‡∏ô‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á
            const days = [];
            const counts = [];
            for(let i=6;i>=0;i--) {
                const d = new Date();
                d.setDate(d.getDate()-i);
                const label = d.toLocaleDateString('th-TH',{day:'numeric',month:'short'});
                // ‡πÅ‡∏õ‡∏•‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô dd/mm/yyyy format ‡πÄ‡∏û‡∏∑‡πà‡∏≠ match ‡∏Å‡∏±‡∏ö s.date
                const dy = String(d.getDate()).padStart(2,'0');
                const mo = String(d.getMonth()+1).padStart(2,'0');
                const yr = d.getFullYear()+543;
                const dateKey = `${dy}/${mo}/${yr}`;
                const sessCount = sessions.filter(s => s.date === dateKey).length;
                days.push(label);
                counts.push(sessCount);
            }

            if(trendChartInstance) trendChartInstance.destroy();
            trendChartInstance = new Chart(canvas, {
                type: 'bar',
                data: {
                    labels: days,
                    datasets: [{
                        label: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô session ‡∏ó‡∏µ‡πà‡∏ô‡∏±‡∏ö',
                        data: counts,
                        backgroundColor: 'rgba(59,130,246,0.15)',
                        borderColor: '#3b82f6',
                        borderWidth: 2,
                        borderRadius: 8,
                        borderSkipped: false,
                    }]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { beginAtZero:true, ticks:{ stepSize:1 }, grid:{ color:'#f1f5f9' } },
                        x: { grid:{ display:false } }
                    }
                }
            });
        }

        // ---- ONLINE PRESENCE ----
        function initPresence() {
            const uid = currentUser.username;
            const name = currentUser.name;
            const presenceRef = ref(rtdb, `presence/${uid}`);
            // ‡πÄ‡∏°‡∏∑‡πà‡∏≠ disconnect ‡πÉ‡∏´‡πâ‡∏•‡∏ö‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á‡∏≠‡∏≠‡∏Å
            onDisconnect(presenceRef).remove();
            // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ß‡πà‡∏≤ online
            set(presenceRef, { name, username: uid, online: true, lastSeen: serverTimestamp() });
            // ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤/‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö
            window.addEventListener('beforeunload', () => set(presenceRef, null).catch(()=>{}));
        }

        function listenOnlineUsers() {
            const onlineRef = ref(rtdb, 'presence');
            onValue(onlineRef, (snapshot) => {
                const data = snapshot.val() || {};
                const users = Object.values(data).filter(u => u.online);
                renderOnlineList(users);
            });
        }

        function renderOnlineList(users) {
            const container = document.getElementById('onlineListSidebar');
            if (!container) return;
            if (users.length === 0) { container.innerHTML = ''; return; }
            container.innerHTML = `
                <div style="padding:8px 15px 4px;font-size:10px;color:#64748b;font-weight:bold;letter-spacing:1px;">
                    üü¢ ‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå (${users.length})
                </div>
                ${users.map(u => `
                <div class="online-item">
                    <span class="online-dot"></span>
                    <span style="${u.username===currentUser.username?'color:var(--accent-gold);font-weight:bold;':''}">${u.name}${u.username===currentUser.username?' (‡∏Ñ‡∏∏‡∏ì)':''}</span>
                </div>`).join('')}
                <div style="height:1px;background:rgba(255,255,255,0.05);margin:6px 15px;"></div>`;
        }

        // ---- PERMISSIONS ----
        window.applyPermissions = function() {
            const role       = currentUser.role || 'guest';
            const perms      = roleSettings[role]?.menus || [];
            const isViewOnly = roleSettings[role]?.viewOnly || false;
            // requisition menu visibility
            const reqMenu = document.getElementById('requisitionMenu');
            if(reqMenu) reqMenu.classList.toggle('hidden', !perms.includes('requisition'));
            // approve/all tabs only for warehouse/admin
            const canApprove = ['admin','warehouse'].includes(role);
            const reqApprove = document.getElementById('reqApproveMenu');
            const reqAll = document.getElementById('reqAllMenu');
            if(reqApprove) reqApprove.classList.toggle('hidden', !canApprove);
            if(reqAll) reqAll.classList.toggle('hidden', !canApprove);
            const effectivePerms = isViewOnly ? ["warehouse","tools","admin"] : perms;

            document.getElementById('warehouseMenu').classList.toggle('hidden', !effectivePerms.includes('warehouse'));
            document.getElementById('toolsMenu').classList.toggle('hidden', !effectivePerms.includes('tools'));
            document.getElementById('adminMenu').classList.toggle('hidden', !effectivePerms.includes('admin'));
            document.getElementById('bannerAdminSection').classList.toggle('hidden', !effectivePerms.includes('admin'));
            document.getElementById('viewOnlyAlert').classList.toggle('hidden', !isViewOnly);

            let existingStyle = document.getElementById("viewOnlyStyle");
            if (isViewOnly) {
                if (!existingStyle) {
                    const st = document.createElement('style');
                    st.id = "viewOnlyStyle";
                    st.innerHTML = `
                        button[onclick*="finalSaveStock"], button[onclick*="addNewUser"],
                        button[onclick*="addWh"], button[onclick*="addPd"],
                        button[onclick*="grantAccess"], button[onclick*="revokeAccess"],
                        button[onclick*="unbanUser"], button[onclick*="requestDelete"],
                        button[onclick*="cancelDelete"], button[onclick*="adminResetPassword"],
                        button[onclick*="uploadBanner"], button[onclick*="delBanner"],
                        button[onclick*="updateStockTemp"], button[onclick*="saveEdit"],
                        button[onclick*="saveAssignedZones"], .btn-action { display: none !important; }
                        .viewonly-input { pointer-events: none !important; opacity: 0.7 !important; }
                    `;
                    document.head.appendChild(st);
                }
            } else if (existingStyle) { existingStyle.remove(); }

            document.getElementById('roleStatusText').innerText = "‡∏ê‡∏≤‡∏ô‡∏∞: " + role.toUpperCase() + (isViewOnly ? " (‡∏î‡∏π‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß)" : "");
        };

        window.checkToolExpiry = async function() {
            const now=new Date().getTime(), role=currentUser.role||'guest';
            const perms=roleSettings[role]?.menus||[], isVO=roleSettings[role]?.viewOnly||false;
            const effP = isVO ? ["warehouse","tools","admin"] : perms;
            const menu = document.getElementById('toolsMenu');
            if (!effP.includes('tools')) { menu.classList.add('hidden'); return; }
            if (role==='admin') { menu.classList.remove('hidden'); document.getElementById('timerDisplay').innerText="‚è≥ ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå: ‡∏ñ‡∏≤‡∏ß‡∏£"; return; }
            try {
                const snap=await getDoc(doc(db,'users',currentUser.username));
                if (!snap.exists()) { menu.classList.add('hidden'); return; }
                const expiry=snap.data().toolExpiry||0;
                if (now<expiry) {
                    menu.classList.remove('hidden');
                    if (expiry>4000000000000) { document.getElementById('timerDisplay').innerText="‚è≥ ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå: ‡∏ñ‡∏≤‡∏ß‡∏£"; }
                    else { const d=Math.floor((expiry-now)/60000); document.getElementById('timerDisplay').innerText=`‚è≥ ‡πÄ‡∏´‡∏•‡∏∑‡∏≠: ${Math.floor(d/60)}‡∏ä‡∏°. ${d%60}‡∏ô.`; }
                } else { menu.classList.add('hidden'); }
            } catch(e) {}
        };

        window.checkHardBanStatus = async function() {
            if (!currentUser||currentUser.username==='admin') return;
            try {
                const snap=await getDoc(doc(db,'users',currentUser.username));
                if (snap.exists()&&snap.data().status==='suspended') { alert('üö´ ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ñ‡∏π‡∏Å‡∏£‡∏∞‡∏á‡∏±‡∏ö!'); logout(); }
            } catch(e) {}
        };

        // ---- BANNER ----
        window.renderBanners = async function() {
            const urls=await loadBanners();
            const defUrl="https://images.unsplash.com/photo-1504674900247-0877df9cc836?auto=format&fit=crop&w=1200&q=80";
            const show=urls.length>0?urls:[defUrl];
            const wrapper=document.getElementById('bannerWrapper');
            if (wrapper) {
                wrapper.innerHTML=show.map(u=>`<div class="swiper-slide"><img src="${u}" style="width:100%;height:100%;object-fit:cover;"></div>`).join('');
                if (window._sw) { try{window._sw.destroy(true,true);}catch(e){} }
                window._sw=new Swiper(".mySwiper",{pagination:{el:".swiper-pagination"},autoplay:{delay:3500},loop:show.length>1});
            }
            const tl=document.getElementById("thumbList");
            if (tl) tl.innerHTML=urls.map((u,i)=>`<div style="position:relative;"><img src="${u}" style="width:100px;height:60px;object-fit:cover;border-radius:8px;border:1px solid #ddd;"><button onclick="delBanner(${i})" style="position:absolute;top:-5px;right:-5px;background:red;color:white;border:none;border-radius:50%;width:22px;height:22px;cursor:pointer;font-size:10px;">‚úï</button></div>`).join('');
        };

        window.uploadBanner = async function() {
            const file=document.getElementById('bannerFile').files[0];
            if (!file) { toast('‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡∏Å‡πà‡∏≠‡∏ô','#c2410c'); return; }
            const prog=document.getElementById('uploadProgress'), bar=document.getElementById('uploadProgressBar');
            prog.style.display='block'; bar.style.width='30%';
            try {
                const fd=new FormData(); fd.append('file',file); fd.append('upload_preset',CLOUDINARY_PRESET);
                bar.style.width='60%';
                const res=await fetch(`https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD}/image/upload`,{method:'POST',body:fd});
                const data=await res.json();
                if (!data.secure_url) throw new Error('Upload failed');
                bar.style.width='90%';
                const cur=await loadBanners(); cur.push(data.secure_url);
                await saveBanners(cur); bar.style.width='100%';
                toast('‚úÖ ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏ö‡∏ô‡πÄ‡∏ô‡∏≠‡∏£‡πå‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!','#059669');
                document.getElementById('bannerFile').value='';
                setTimeout(()=>{prog.style.display='none';bar.style.width='0%';},1000);
                await renderBanners();
            } catch(e) { prog.style.display='none'; bar.style.width='0%'; toast('‚ùå ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à','#c2410c'); }
        };

        window.delBanner = async function(i) {
            if (!confirm('‡∏•‡∏ö‡πÅ‡∏ö‡∏ô‡πÄ‡∏ô‡∏≠‡∏£‡πå‡∏ô‡∏µ‡πâ?')) return;
            const urls=await loadBanners(); urls.splice(i,1);
            await saveBanners(urls); toast('üóëÔ∏è ‡∏•‡∏ö‡πÅ‡∏ö‡∏ô‡πÄ‡∏ô‡∏≠‡∏£‡πå‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢','#059669');
            await renderBanners();
        };

        // ---- CHANGE PASSWORD ----
        window.openChangePasswordModal = function() {
            if (currentUser.username==='admin'&&currentUser.role==='admin') { toast('‚ö†Ô∏è ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ Admin ‡∏´‡∏•‡∏±‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô Password ‡πÑ‡∏î‡πâ','#c2410c'); return; }
            const modal=document.createElement('div'); modal.className='modal-overlay'; modal.id='changePassModal';
            modal.innerHTML=`<div class="modal-box"><h3>üîë ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô Password</h3>
                <input type="password" id="oldPassInput" placeholder="Password ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô">
                <input type="password" id="newPassInput" placeholder="Password ‡πÉ‡∏´‡∏°‡πà">
                <input type="password" id="confirmPassInput" placeholder="‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô Password ‡πÉ‡∏´‡∏°‡πà">
                <div class="modal-error" id="passModalError"></div>
                <div style="display:flex;gap:10px;margin-top:8px;">
                    <button onclick="submitChangePassword()" style="flex:1;background:var(--info);color:white;border:none;padding:12px;border-radius:10px;cursor:pointer;font-weight:bold;">‚úÖ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</button>
                    <button onclick="closeModal()" style="flex:1;background:#f1f5f9;color:#475569;border:none;padding:12px;border-radius:10px;cursor:pointer;">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                </div></div>`;
            document.body.appendChild(modal);
        };

        window.submitChangePassword = async function() {
            const op=document.getElementById('oldPassInput').value, np=document.getElementById('newPassInput').value, cp=document.getElementById('confirmPassInput').value;
            const err=document.getElementById('passModalError'); err.style.display='none';
            if (!op||!np||!cp){err.innerText='‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö';err.style.display='block';return;}
            if (np!==cp){err.innerText='‚ùå Password ‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô';err.style.display='block';return;}
            if (np.length<4){err.innerText='‚ùå ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 4 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£';err.style.display='block';return;}
            try {
                const snap=await getDoc(doc(db,'users',currentUser.username));
                if (!snap.exists()){err.innerText='‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ';err.style.display='block';return;}
                const ho=await hashPassword(op), st=snap.data().password||await hashPassword('1234');
                if (ho!==st){err.innerText='‚ùå Password ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á';err.style.display='block';return;}
                await setDoc(doc(db,'users',currentUser.username),{password:await hashPassword(np)},{merge:true});
                closeModal(); toast('‚úÖ ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô Password ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!','#059669');
            } catch(e){err.innerText='‚ö†Ô∏è ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î';err.style.display='block';}
        };

        window.closeModal = function() { const m=document.getElementById('changePassModal'); if(m) m.remove(); };

        // ---- USER MANAGEMENT ----
        window.openUserManagement = function() {
            document.getElementById('dashboardView').classList.add('hidden');
            const c=document.getElementById('toolAppContainer'); c.classList.remove('hidden');
            c.innerHTML=`<div class="tool-header no-print"><h2>üë§ ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô & ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå Role</h2><button onclick="closeTool()">‚úï ‡∏õ‡∏¥‡∏î</button></div>
            <div style="display:grid;grid-template-columns:1fr 1.5fr;gap:25px;">
                <div style="background:white;padding:20px;border-radius:15px;border:1px solid #e2e8f0;">
                    <h4 style="margin-top:0;">üé≠ ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Role & ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå</h4>
                    <div style="display:flex;gap:8px;margin-bottom:15px;">
                        <input type="text" id="newRoleName" placeholder="‡∏ä‡∏∑‡πà‡∏≠ Role ‡πÉ‡∏´‡∏°‡πà" style="flex:1;padding:10px;border-radius:8px;border:1px solid #ddd;">
                        <button onclick="addNewRole()" style="background:var(--success);color:white;border:none;padding:10px;border-radius:8px;cursor:pointer;">‡πÄ‡∏û‡∏¥‡πà‡∏° Role</button>
                    </div>
                    <div id="rolePermissionsList"></div>
                </div>
                <div>
                    <div style="background:white;padding:20px;border-radius:15px;margin-bottom:20px;display:flex;gap:10px;flex-wrap:wrap;" class="no-print">
                        <input type="text" id="newUserName" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô" style="padding:10px;border-radius:8px;border:1px solid #ddd;flex:1;min-width:120px;">
                        <input type="text" id="newUserKey" placeholder="Username" style="padding:10px;border-radius:8px;border:1px solid #ddd;flex:1;min-width:120px;">
                        <input type="text" id="newUserPass" placeholder="Password (‡πÑ‡∏°‡πà‡∏Å‡∏£‡∏≠‡∏Å = 1234)" style="padding:10px;border-radius:8px;border:1px solid #ddd;flex:1;min-width:140px;">
                        <select id="newUserRole" style="padding:10px;border-radius:8px;flex:1;min-width:100px;"></select>
                        <button onclick="addNewUser()" style="background:var(--info);color:white;border:none;padding:10px 20px;border-radius:8px;cursor:pointer;">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</button>
                    </div>
                    <div id="userGrid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:15px;"></div>
                </div>
            </div>`;
            renderRoleSettings(); renderUserCards();
        };

        window.renderUserCards = async function() {
            const grid=document.getElementById('userGrid'); if(!grid) return;
            grid.innerHTML='<p style="color:#94a3b8;padding:20px;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</p>';
            const snap=await getDocs(collection(db,'users')), now=new Date().getTime(); let html="";
            snap.forEach(d=>{
                const k=d.id, u=d.data(), active=u.toolExpiry>now, isSusp=u.status==='suspended';
                const isPendDel=u.deleteAt!=null&&u.deleteAt!==undefined;
                const isBranch=k.toUpperCase().startsWith('BT000');
                let delInfo="";
                if(isPendDel){const dl=Math.ceil(((u.deleteAt+604800000)-now)/86400000);delInfo=`<div style="color:var(--danger);font-size:10px;margin-top:5px;font-weight:bold;">‚è≥ ‡∏•‡∏ö‡∏ñ‡∏≤‡∏ß‡∏£‡πÉ‡∏ô ${dl>0?dl:0} ‡∏ß‡∏±‡∏ô</div>`;}
                const assignedZones=u.assignedZones||[];
                const zoneInfo=isBranch?`<div style="font-size:11px;color:var(--info);margin-top:4px;">üìç ‡∏Ñ‡∏•‡∏±‡∏á: ${assignedZones.length>0?assignedZones.join(', '):'‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ú‡∏π‡∏Å‡∏Ñ‡∏•‡∏±‡∏á'}</div>`:'';
                html+=`<div class="user-card" style="${isSusp?'border:2px solid var(--danger);background:#fff5f5;':''} ${isPendDel?'opacity:0.6;':''}">
                    <div style="display:flex;justify-content:space-between;align-items:flex-start;">
                        <div>
                            <b id="uname_${k}">${u.name}</b>
                            <small style="color:#64748b;display:block;">ID: ${k}</small>
                        </div>
                        <div style="display:flex;gap:5px;align-items:center;">
                            ${isBranch?'<span style="font-size:10px;background:#dbeafe;color:#1d4ed8;padding:2px 6px;border-radius:4px;">‡∏™‡∏≤‡∏Ç‡∏≤</span>':''}
                            <span id="urole_${k}" style="font-size:10px;background:#eee;padding:2px 6px;border-radius:4px;">${u.role}</span>
                            <button onclick="openEditUserModal('${k}','${u.name}','${u.role}')" style="background:#f1f5f9;border:1px solid #e2e8f0;border-radius:5px;padding:3px 7px;cursor:pointer;font-size:11px;">‚úèÔ∏è</button>
                        </div>
                    </div>
                    ${delInfo}${zoneInfo}
                    <div style="margin:12px 0;font-size:12px;display:flex;align-items:center;gap:6px;">
                        <span id="onlineDot_${k}"></span>
                        ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ${isSusp?'<b style="color:var(--danger);">‚õî ‡∏ñ‡∏π‡∏Å‡∏£‡∏∞‡∏á‡∏±‡∏ö</b>':(active?'üü¢ ‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå':'‚ö™ ‡∏´‡∏°‡∏î‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå')}
                    </div>
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:5px;" class="no-print">
                        <button onclick="grantAccess('${k}',5)" style="background:var(--info);color:white;border:none;padding:8px;border-radius:5px;cursor:pointer;font-size:11px;">+5 ‡∏ä‡∏°.</button>
                        <button onclick="grantAccess('${k}',0)" style="background:var(--accent-gold);border:none;padding:8px;border-radius:5px;cursor:pointer;font-size:11px;">‡∏ñ‡∏≤‡∏ß‡∏£</button>
                        ${isSusp?`<button onclick="unbanUser('${k}')" style="background:#0ea5e9;color:white;border:none;padding:8px;border-radius:5px;cursor:pointer;font-size:11px;">üîì ‡∏õ‡∏•‡∏î‡∏£‡∏∞‡∏á‡∏±‡∏ö</button>`:`<button onclick="revokeAccess('${k}')" style="background:var(--danger);color:white;border:none;padding:8px;border-radius:5px;cursor:pointer;font-size:11px;">üö´ ‡∏£‡∏∞‡∏á‡∏±‡∏ö</button>`}
                        ${isPendDel?`<button onclick="cancelDelete('${k}')" style="background:#64748b;color:white;border:none;padding:8px;border-radius:5px;cursor:pointer;font-size:11px;">‚Ü©Ô∏è ‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô</button>`:`<button onclick="requestDelete('${k}')" style="background:#000;color:white;border:none;padding:8px;border-radius:5px;cursor:pointer;font-size:11px;">üóëÔ∏è ‡∏•‡∏ö</button>`}
                        <button onclick="adminResetPassword('${k}')" style="grid-column:span 2;background:#7c3aed;color:white;border:none;padding:8px;border-radius:5px;cursor:pointer;font-size:11px;margin-top:2px;">üîë Reset Password ‚Üí 1234</button>
                        ${isBranch?`<button onclick="openAssignZoneModal('${k}')" style="grid-column:span 2;background:#0891b2;color:white;border:none;padding:8px;border-radius:5px;cursor:pointer;font-size:11px;margin-top:2px;">üìç ‡∏ú‡∏π‡∏Å‡∏Ñ‡∏•‡∏±‡∏á‡∏™‡∏≤‡∏Ç‡∏≤</button>`:''}
                    </div>
                </div>`;
            });
            grid.innerHTML=html||'<p style="color:#94a3b8;padding:20px;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</p>';
            // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï online dot ‡πÉ‡∏ô user cards
            const onlineRef2=ref(rtdb,'presence');
            onValue(onlineRef2,(snapshot)=>{
                const data=snapshot.val()||{};
                document.querySelectorAll('[id^="onlineDot_"]').forEach(el=>{
                    const uid=el.id.replace('onlineDot_','');
                    el.innerHTML=data[uid]?.online?'<span class="online-dot" title="‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå‡∏≠‡∏¢‡∏π‡πà"></span>':'<span class="offline-dot" title="‡∏≠‡∏≠‡∏ü‡πÑ‡∏•‡∏ô‡πå"></span>';
                });
            },{onlyOnce:true});
        };

        window.openAssignZoneModal = async function(username) {
            const snap=await getDoc(doc(db,'users',username));
            const userData=snap.exists()?snap.data():{};
            const assigned=userData.assignedZones||[];
            const modal=document.createElement('div'); modal.className='modal-overlay'; modal.id='assignZoneModal';
            modal.innerHTML=`<div class="modal-box"><h3>üìç ‡∏ú‡∏π‡∏Å‡∏Ñ‡∏•‡∏±‡∏á‡πÉ‡∏´‡πâ ${username}</h3>
                <p style="color:#64748b;font-size:13px;margin-bottom:15px;">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏•‡∏±‡∏á‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ user ‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á</p>
                <div id="zoneCheckList" style="display:flex;flex-direction:column;gap:10px;margin-bottom:20px;">
                    ${warehouseList.map(wh=>`<label style="display:flex;align-items:center;gap:10px;padding:12px;border:1px solid #e2e8f0;border-radius:10px;cursor:pointer;">
                        <input type="checkbox" value="${wh}" ${assigned.includes(wh)?'checked':''} style="width:18px;height:18px;">
                        <span>${wh}</span></label>`).join('')}
                </div>
                <div style="display:flex;gap:10px;">
                    <button onclick="saveAssignedZones('${username}')" style="flex:1;background:var(--success);color:white;border:none;padding:12px;border-radius:10px;cursor:pointer;font-weight:bold;">‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                    <button onclick="document.getElementById('assignZoneModal').remove()" style="flex:1;background:#f1f5f9;color:#475569;border:none;padding:12px;border-radius:10px;cursor:pointer;">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                </div></div>`;
            document.body.appendChild(modal);
        };

        window.saveAssignedZones = async function(username) {
            const checks=document.querySelectorAll('#zoneCheckList input:checked');
            const zones=Array.from(checks).map(c=>c.value);
            await setDoc(doc(db,'users',username),{assignedZones:zones},{merge:true});
            if (currentUser.username===username){currentUser.assignedZones=zones;localStorage.setItem('currentUser',JSON.stringify(currentUser));}
            document.getElementById('assignZoneModal').remove();
            toast('‚úÖ ‡∏ú‡∏π‡∏Å‡∏Ñ‡∏•‡∏±‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢','#059669'); renderUserCards();
        };

        window.adminResetPassword=async function(u){if(!confirm(`Reset Password ‡∏Ç‡∏≠‡∏á ${u} ‚Üí "1234"?`))return;await setDoc(doc(db,'users',u),{password:await hashPassword('1234')},{merge:true});toast('‚úÖ Reset ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ Password ‡πÉ‡∏´‡∏°‡πà: 1234','#059669');};

        window.openEditUserModal=function(uid,uname,urole){
            const existing=document.getElementById('editUserModal');if(existing)existing.remove();
            const roleOpts=Object.keys(roleSettings).map(r=>`<option value="${r}" ${r===urole?'selected':''}>${r}</option>`).join('');
            const modal=document.createElement('div');modal.className='modal-overlay';modal.id='editUserModal';
            modal.innerHTML=`<div class="modal-box"><h3>‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</h3>
                <div style="font-size:12px;color:#64748b;margin-bottom:12px;">ID: ${uid}</div>
                <label style="font-size:12px;font-weight:bold;color:#475569;display:block;margin-bottom:4px;">‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</label>
                <input type="text" id="editUserName" value="${uname}" style="width:100%;padding:10px;border:1px solid #e2e8f0;border-radius:8px;font-size:14px;box-sizing:border-box;margin-bottom:12px;">
                <label style="font-size:12px;font-weight:bold;color:#475569;display:block;margin-bottom:4px;">Role</label>
                <select id="editUserRole" style="width:100%;padding:10px;border:1px solid #e2e8f0;border-radius:8px;font-size:14px;margin-bottom:20px;">${roleOpts}</select>
                <div style="display:flex;gap:10px;">
                    <button onclick="saveEditUser('${uid}')" style="flex:1;background:var(--success);color:white;border:none;padding:12px;border-radius:10px;cursor:pointer;font-weight:bold;">‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                    <button onclick="document.getElementById('editUserModal').remove()" style="flex:1;background:#f1f5f9;color:#475569;border:none;padding:12px;border-radius:10px;cursor:pointer;">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                </div></div>`;
            document.body.appendChild(modal);
        };

        window.saveEditUser=async function(uid){
            const newName=document.getElementById('editUserName').value.trim();
            const newRole=document.getElementById('editUserRole').value;
            if(!newName){toast('‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠','#c2410c');return;}
            await setDoc(doc(db,'users',uid),{name:newName,role:newRole},{merge:true});
            document.getElementById('editUserModal').remove();
            toast('‚úÖ ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢','#059669');
            renderUserCards();
        };
        window.unbanUser=async function(u){await setDoc(doc(db,'users',u),{status:'active'},{merge:true});toast('üîì ‡∏õ‡∏•‡∏î‡∏£‡∏∞‡∏á‡∏±‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢','#059669');renderUserCards();};
        window.requestDelete=async function(u){if(!confirm(`‡∏•‡∏ö‡∏ö‡∏±‡∏ç‡∏ä‡∏µ ${u}? (‡∏£‡∏≠‡∏•‡∏ö 7 ‡∏ß‡∏±‡∏ô)`))return;await setDoc(doc(db,'users',u),{deleteAt:new Date().getTime()},{merge:true});renderUserCards();};
        window.cancelDelete=async function(u){await setDoc(doc(db,'users',u),{deleteAt:null},{merge:true});toast('‚úÖ ‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢','#059669');renderUserCards();};
        window.grantAccess=async function(k,h){await setDoc(doc(db,'users',k),{toolExpiry:h===0?4070908800000:new Date().getTime()+(h*3600000),status:'active'},{merge:true});toast('‚úÖ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢','#059669');renderUserCards();};
        window.revokeAccess=async function(k){if(!confirm(`üö´ ‡∏£‡∏∞‡∏á‡∏±‡∏ö ${k}?`))return;await setDoc(doc(db,'users',k),{toolExpiry:0,status:'suspended'},{merge:true});toast('üîí ‡∏£‡∏∞‡∏á‡∏±‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢','#c2410c');renderUserCards();};
        window.addNewUser=async function(){
            const n=document.getElementById('newUserName').value.trim(),u=document.getElementById('newUserKey').value.trim(),r=document.getElementById('newUserRole').value,rp=document.getElementById('newUserPass').value.trim()||'1234';
            if(!n||!u)return;
            const ud={name:n,role:r,username:u,password:await hashPassword(rp),toolExpiry:0,status:'active'};
            if(u.toUpperCase().startsWith('BT000'))ud.assignedZones=[];
            await setDoc(doc(db,'users',u),ud);
            toast('‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢','#059669');
            document.getElementById('newUserName').value=document.getElementById('newUserKey').value=document.getElementById('newUserPass').value='';
            renderUserCards();
        };

        window.renderRoleSettings=function(){
            const list=document.getElementById('rolePermissionsList'),sel=document.getElementById('newUserRole');if(!list)return;
            let html='',opts='';
            Object.keys(roleSettings).forEach(role=>{
                const perms=roleSettings[role].menus,vo=roleSettings[role].viewOnly||false;
                html+=`<div style="padding:12px;border:1px solid #f1f5f9;border-radius:10px;margin-bottom:10px;background:#f8fafc;">
                    <div style="display:flex;justify-content:space-between;"><b style="text-transform:uppercase;">${role}</b>${role!=='admin'?`<small onclick="deleteRole('${role}')" style="color:red;cursor:pointer;">‡∏•‡∏ö Role</small>`:''}</div>
                    <div style="display:flex;gap:12px;font-size:11px;margin-top:8px;flex-wrap:wrap;">
                        <label><input type="checkbox" ${perms.includes('warehouse')?'checked':''} onchange="togglePerm('${role}','warehouse')"> ‡∏Ñ‡∏•‡∏±‡∏á</label>
                        <label><input type="checkbox" ${perms.includes('tools')?'checked':''} onchange="togglePerm('${role}','tools')"> ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠</label>
                        <label><input type="checkbox" ${perms.includes('admin')?'checked':''} onchange="togglePerm('${role}','admin')"> ‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô</label>
                        <label style="color:var(--info);font-weight:bold;"><input type="checkbox" ${vo?'checked':''} onchange="toggleViewOnly('${role}')"> üëÅÔ∏è ‡∏î‡∏π‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß</label>
                    </div></div>`;
                opts+=`<option value="${role}">${role}</option>`;
            });
            list.innerHTML=html;if(sel)sel.innerHTML=opts;
        };

        window.toggleViewOnly=function(r){roleSettings[r].viewOnly=!roleSettings[r].viewOnly;saveConfig();renderRoleSettings();applyPermissions();};
        window.togglePerm=function(r,m){const i=roleSettings[r].menus.indexOf(m);if(i>-1)roleSettings[r].menus.splice(i,1);else roleSettings[r].menus.push(m);saveConfig();applyPermissions();renderRoleSettings();};
        window.addNewRole=function(){const n=document.getElementById('newRoleName').value.trim().toLowerCase();if(n&&!roleSettings[n]){roleSettings[n]={menus:[],viewOnly:false};saveConfig();renderRoleSettings();}};
        window.deleteRole=function(r){if(confirm(`‡∏•‡∏ö Role: ${r}?`)){delete roleSettings[r];saveConfig();renderRoleSettings();}};

        // ---- STOCK TOOL (‡πÅ‡∏Å‡πâ bug selectedStaff) ----
        window.openCentralStock=function(){
            document.getElementById('dashboardView').classList.add('hidden');
            document.getElementById('toolAppContainer').classList.remove('hidden');
            tempCountData={};
            const visibleZones=getVisibleWarehouses();
            renderStockTool(visibleZones[0]||warehouseList[0]);
        };

        window.renderStockTool=async function(zone){
            const c=document.getElementById('toolAppContainer');
            const visibleZones=getVisibleWarehouses();
            const zoneProds=allProducts.filter(p=>(zoneProductMap[zone]||[]).includes(p.id));
            const usSnap=await getDocs(collection(db,'users')); let staffOpts='';
            usSnap.forEach(d=>{const u=d.data();if(u.status!=='suspended')staffOpts+=`<option value="${u.name}" ${selectedStaff===u.name?'selected':''}>${u.name}</option>`;});

            c.innerHTML=`<div class="tool-header no-print"><h2>üì¶ ‡∏ô‡∏±‡∏ö‡∏™‡∏ï‡πä‡∏≠‡∏Å: ${zone}</h2><button onclick="closeTool()">‚úï ‡∏õ‡∏¥‡∏î</button></div>
            <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:15px;margin-bottom:20px;" class="no-print">
                <div class="input-group"><label>üì¶ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏ã‡∏ô</label>
                    <select onchange="renderStockTool(this.value)" style="width:100%;border:none;font-weight:bold;outline:none;">
                        ${visibleZones.map(w=>`<option ${w===zone?'selected':''}>${w}</option>`).join('')}
                    </select></div>
                <div class="input-group" style="border:2px solid var(--danger);"><label>üìÖ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ô‡∏±‡∏ö (‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÄ‡∏•‡∏∑‡∏≠‡∏Å)</label>
                    <input type="date" id="countDate" value="${selectedDate}" onchange="selectedDate=this.value" style="width:100%;border:none;font-weight:bold;outline:none;font-size:14px;">
                </div>
                <div class="input-group" style="border:2px solid var(--info);"><label>üë§ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏ô‡∏ô‡∏±‡∏ö</label>
                    <select id="staffSelect" onchange="selectedStaff=this.value" style="width:100%;border:none;font-weight:bold;outline:none;">
                        <option value="">-- ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å --</option>${staffOpts}
                    </select></div>
                <div class="input-group" style="background:#f1f5f9;"><label>üìù ‡∏ú‡∏π‡πâ‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏´‡∏•‡∏±‡∏Å</label><b>${currentUser.name}</b></div>
            </div>
            <table class="stock-table">${zoneProds.map(p=>{
                const units=p.units||[{name:p.unit||'',rate:0},{name:p.subUnit||'',rate:0}].filter(u=>u.name);
                const pending=tempCountData[p.id];
                const hasPending=pending&&units.some((_,ui)=>(pending['u'+ui]||0)>0);
                const lu=countData[p.id]?.lastUpdate||'-';
                const borderColors=['var(--info)','#a78bfa','#f59e0b'];
                return `<tr class="stock-row">
                <td><b style="font-size:16px;">${p.id}</b><br><span style="color:#475569;">${p.name}</span><br><small style="color:#94a3b8;font-size:10px;">‡∏ô‡∏±‡∏ö‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: ${lu}</small></td>
                <td style="text-align:right;">
                    <div style="display:flex;align-items:center;justify-content:flex-end;gap:12px;">
                        <div style="text-align:right;min-width:140px;">
                            ${hasPending
                                ? `<div style="font-size:13px;color:var(--info);font-weight:bold;">${units.map((_,ui)=>(pending['u'+ui]||0)>0?`<span>${pending['u'+ui]} ${units[ui].name}</span>`:'').filter(Boolean).join(' + ')}</div>
                                   <div style="font-size:11px;color:#94a3b8;">‡∏£‡∏≠‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô...</div>`
                                : `<div style="font-size:12px;color:#cbd5e1;">‚Äî</div>`
                            }
                        </div>
                        <div style="display:flex;flex-direction:column;gap:5px;">
                            ${units.map((u,ui)=>`
                            <div style="display:flex;align-items:center;gap:5px;">
                                <small style="color:${borderColors[ui]||'#64748b'};width:45px;text-align:right;font-weight:bold;">${u.name}:</small>
                                <input type="number" id="input_${p.id}_${ui}" min="0" class="no-print viewonly-input"
                                    style="width:75px;padding:7px;border-radius:8px;border:2px solid ${borderColors[ui]||'#cbd5e1'};text-align:center;font-weight:bold;font-size:14px;"
                                    onkeydown="if(event.key==='Enter') addStock('${p.id}','${p.name}','${zone}',${ui})">
                            </div>`).join('')}
                        </div>
                        <button onclick="addStockAll('${p.id}','${p.name}','${zone}')" class="btn-action no-print" style="background:var(--info);font-size:20px;">Ôºã</button>
                    </div>
                </td></tr>`;}).join('')}</table>
            <p style="color:#94a3b8;font-size:12px;text-align:center;margin-top:5px;" class="no-print">üí° ‡∏Å‡∏£‡∏≠‡∏Å‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î Enter ‡πÉ‡∏ô‡∏ä‡πà‡∏≠‡∏á‡∏ô‡∏±‡πâ‡∏ô ‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏î Ôºã ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ó‡∏∏‡∏Å‡∏ä‡πà‡∏≠‡∏á‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏±‡∏ô</p>
            <div class="no-print" style="margin-bottom:12px;">
                <input type="text" id="stockSearch" placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (‡∏£‡∏´‡∏±‡∏™ / ‡∏ä‡∏∑‡πà‡∏≠)..." oninput="filterStockRows(this.value)"
                    style="width:100%;padding:10px 16px;border:1px solid #e2e8f0;border-radius:10px;font-size:14px;box-sizing:border-box;outline:none;transition:border 0.2s;"
                    onfocus="this.style.borderColor='var(--info)'" onblur="this.style.borderColor='#e2e8f0'">
            </div>
            <div style="margin-top:25px;text-align:center;" class="no-print">
                <button onclick="finalSaveStock('${zone}')" style="background:var(--success);color:white;padding:18px 60px;border:none;border-radius:15px;font-size:20px;font-weight:bold;cursor:pointer;box-shadow:0 4px 15px rgba(16,185,129,0.4);">üíæ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÅ‡∏•‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
            </div>`;
        };

        // addStock: ‡∏Å‡∏£‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î Enter ‡πÉ‡∏ô‡∏ä‡πà‡∏≠‡∏á‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏ô‡∏±‡πâ‡∏ô
        window.addStock=function(id,name,zone,unitIndex){
            const staffEl=document.getElementById('staffSelect');
            if(staffEl&&staffEl.value) selectedStaff=staffEl.value;
            const el=document.getElementById(`input_${id}_${unitIndex}`);
            const val=parseFloat(el?.value)||0;
            if(val<=0){if(el){el.style.borderColor='var(--danger)';setTimeout(()=>el.style.borderColor='',800);}return;}
            if(!tempCountData[id])tempCountData[id]={name};
            tempCountData[id]['u'+unitIndex]=(tempCountData[id]['u'+unitIndex]||0)+val;
            if(el){el.value='';el.style.borderColor='var(--success)';setTimeout(()=>el.style.borderColor='',600);}
            setTimeout(()=>renderStockTool(zone),400);
        };

        // addStockAll: ‡∏Å‡∏î Ôºã ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ó‡∏∏‡∏Å‡∏ä‡πà‡∏≠‡∏á‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏±‡∏ô
        window.addStockAll=function(id,name,zone){
            const staffEl=document.getElementById('staffSelect');
            if(staffEl&&staffEl.value) selectedStaff=staffEl.value;
            const p=allProducts.find(pd=>pd.id===id);
            const units=p?.units||[{name:p?.unit||'',rate:0}];
            let anyVal=false;
            units.forEach((_,ui)=>{
                const el=document.getElementById(`input_${id}_${ui}`);
                const val=parseFloat(el?.value)||0;
                if(val>0){
                    if(!tempCountData[id])tempCountData[id]={name};
                    tempCountData[id]['u'+ui]=(tempCountData[id]['u'+ui]||0)+val;
                    if(el){el.value='';el.style.borderColor='var(--success)';setTimeout(()=>el.style.borderColor='',600);}
                    anyVal=true;
                }
            });
            if(!anyVal){toast('‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Å‡πà‡∏≠‡∏ô','#c2410c');return;}
            setTimeout(()=>renderStockTool(zone),400);
        };

        window.finalSaveStock=async function(zone){
            const staffEl=document.getElementById('staffSelect');
            if(staffEl&&staffEl.value) selectedStaff=staffEl.value;
            const dateEl=document.getElementById('countDate');
            if(dateEl&&dateEl.value) selectedDate=dateEl.value;

            if(!selectedDate){toast('‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ô‡∏±‡∏ö‡∏Å‡πà‡∏≠‡∏ô','#c2410c');return;}
            if(!selectedStaff){toast('‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏ô‡∏ô‡∏±‡∏ö‡∏Å‡πà‡∏≠‡∏ô','#c2410c');return;}
            const hasChanges=Object.keys(tempCountData).some(id=>{
                const td=tempCountData[id];
                return Object.keys(td).filter(k=>k.startsWith('u')).some(k=>(td[k]||0)>0);
            });
            if(!hasChanges){toast('‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÅ‡∏•‡∏∞‡∏Å‡∏î Ôºã ‡∏Å‡πà‡∏≠‡∏ô','#c2410c');return;}
            if(!confirm(`‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${selectedDate} ‡πÇ‡∏î‡∏¢‡∏Ñ‡∏∏‡∏ì ${selectedStaff}?`))return;

            // ‡πÅ‡∏õ‡∏•‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏≤‡∏Å yyyy-mm-dd ‡πÄ‡∏õ‡πá‡∏ô dd/mm/yyyy (‡πÑ‡∏ó‡∏¢)
            const [yr,mo,dy]=selectedDate.split('-');
            const dateStr=`${dy}/${mo}/${parseInt(yr)+543}`;
            const now=new Date();
            const timeStr=now.toLocaleTimeString('th-TH',{hour:'2-digit',minute:'2-digit'});
            const ts=dateStr+' '+timeStr;

            // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡πÉ‡∏ô countData (‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏´‡∏•‡∏±‡∏Å‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô)
            Object.keys(tempCountData).forEach(id=>{
                const td=tempCountData[id];
                const p=allProducts.find(pd=>pd.id===id);
                const units=p?.units||[{name:p?.unit||'',rate:0}];
                // ‡πÅ‡∏õ‡∏•‡∏á‡∏ó‡∏∏‡∏Å‡∏´‡∏ô‡πà‡∏ß‡∏¢‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏´‡∏•‡∏±‡∏Å
                let totalInUnit1=td['u0']||0;
                // u1 ‡πÅ‡∏õ‡∏•‡∏á‡πÇ‡∏î‡∏¢ rate[0] ‡∏Ç‡∏≠‡∏á unit[0]
                if((td['u1']||0)>0&&units[0]?.rate>0) totalInUnit1+=((td['u1']||0)/units[0].rate);
                if((td['u2']||0)>0&&units[0]?.rate>0&&units[1]?.rate>0) totalInUnit1+=((td['u2']||0)/(units[0].rate*units[1].rate));
                if(!countData[id])countData[id]={total:0,name:td.name};
                // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡πÄ‡∏õ‡πá‡∏ô 0 ‡πÅ‡∏•‡πâ‡∏ß‡πÉ‡∏™‡πà‡∏¢‡∏≠‡∏î‡∏ó‡∏µ‡πà‡∏ô‡∏±‡∏ö‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô (‡πÑ‡∏°‡πà‡∏™‡∏∞‡∏™‡∏°)
                countData[id].total=Math.round(totalInUnit1*1000)/1000;
                countData[id].lastUpdate=ts;
                countData[id].countedBy=selectedStaff;
            });
            await saveCountData();

            // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å history ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏∏‡∏Å‡∏´‡∏ô‡πà‡∏ß‡∏¢
            const sessionItems=Object.keys(tempCountData).map(id=>{
                const td=tempCountData[id];
                const p=allProducts.find(pd=>pd.id===id);
                const units=p?.units||[{name:p?.unit||'',rate:0}];
                const amounts=units.map((_,ui)=>({amount:td['u'+ui]||0,unit:units[ui]?.name||''}));
                return {id,name:td.name,amounts,units};
            });

            await addDoc(collection(db,'stockHistory'),{
                zone,date:dateStr,timestamp:now.getTime(),
                countedBy:selectedStaff,recordedBy:currentUser.name,items:sessionItems
            });

            tempCountData={};
            toast('‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡πÅ‡∏•‡πâ‡∏ß','#059669');
            renderStockTool(zone);
        };

        // ---- STOCK SUMMARY ----
        window.openStockSummary=async function(){
            document.getElementById('dashboardView').classList.add('hidden');
            const c=document.getElementById('toolAppContainer');c.classList.remove('hidden');
            const visibleZones=getVisibleWarehouses();
            c.innerHTML=`<div class="tool-header"><h2>üìä ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ & Export ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</h2><button onclick="closeTool()">‚úï ‡∏õ‡∏¥‡∏î</button></div>
            <div class="filter-bar no-print" style="flex-wrap:wrap;gap:12px;">
                <div>
                    <label>üìã ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</label>
                    <select id="reportMode" onchange="switchReportMode()" style="padding:10px 14px;border:2px solid var(--primary-dark);border-radius:10px;font-size:14px;font-weight:bold;min-width:220px;">
                        <option value="history">üìú ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡∏ö (‡∏ó‡∏∏‡∏Å session)</option>
                        <option value="snapshot">üì¶ ‡∏¢‡∏≠‡∏î‡∏™‡∏ï‡πä‡∏≠‡∏Å‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î (‡∏û‡∏£‡πâ‡∏≠‡∏° export)</option>
                    </select>
                </div>
                <div><label>üì¶ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏•‡∏±‡∏á</label>
                    <select id="filterZone" onchange="loadCurrentReport()">
                        <option value="">‚Äî ‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏•‡∏±‡∏á ‚Äî</option>
                        ${visibleZones.map(w=>`<option value="${w}">${w}</option>`).join('')}
                    </select></div>
                <div id="dateFromWrap"><label>üìÖ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô</label><input type="date" id="filterDateFrom" onchange="loadCurrentReport()"></div>
                <div id="dateToWrap"><label>üìÖ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î</label><input type="date" id="filterDateTo" onchange="loadCurrentReport()"></div>
                <div style="display:flex;gap:8px;align-items:flex-end;">
                    <button onclick="exportCurrentReport()" style="background:var(--success);color:white;border:none;padding:12px 20px;border-radius:10px;cursor:pointer;font-weight:bold;">üì• Export Excel</button>
                    <button onclick="window.print()" style="background:var(--danger);color:white;border:none;padding:12px 20px;border-radius:10px;cursor:pointer;font-weight:bold;">üñ®Ô∏è Print PDF</button>
                </div>
            </div>
            <div id="historyContainer"><p style="color:#94a3b8;text-align:center;padding:40px;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</p></div>`;
            await loadCurrentReport();
        };

        window.switchReportMode=function(){
            const mode=document.getElementById('reportMode').value;
            document.getElementById('dateFromWrap').style.display=mode==='history'?'':'none';
            document.getElementById('dateToWrap').style.display=mode==='history'?'':'none';
            loadCurrentReport();
        };

        window.loadCurrentReport=async function(){
            const mode=document.getElementById('reportMode')?.value||'history';
            if(mode==='snapshot') await loadSnapshot();
            else await loadHistory();
        };

        window.exportCurrentReport=function(){
            const mode=document.getElementById('reportMode')?.value||'history';
            if(mode==='snapshot') exportExcelSnapshot();
            else exportExcelHistory();
        };

        // ---- SNAPSHOT: ‡∏¢‡∏≠‡∏î‡∏™‡∏ï‡πä‡∏≠‡∏Å‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ ----
        window.loadSnapshot=async function(){
            const zone=document.getElementById('filterZone')?.value||'';
            const container=document.getElementById('historyContainer');
            if(!container)return;
            container.innerHTML='<p style="color:#94a3b8;text-align:center;padding:40px;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</p>';
            try{
                await loadCountData();
                const zones=zone?[zone]:getVisibleWarehouses();
                let html='';
                zones.forEach(z=>{
                    const prods=allProducts.filter(p=>(zoneProductMap[z]||[]).includes(p.id));
                    if(!prods.length)return;
                    html+=`<div class="history-card" style="margin-bottom:20px;">
                        <div class="history-card-header"><b>üì¶ ${z}</b></div>
                        <table style="width:100%;border-collapse:collapse;">
                            <thead><tr style="background:#f8fafc;">
                                <th style="padding:10px;text-align:left;font-size:12px;color:#64748b;">‡∏£‡∏´‡∏±‡∏™</th>
                                <th style="padding:10px;text-align:left;font-size:12px;color:#64748b;">‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th>
                                <th style="padding:10px;text-align:center;font-size:12px;color:#64748b;">‡∏¢‡∏≠‡∏î‡∏™‡∏ï‡πä‡∏≠‡∏Å</th>
                                <th style="padding:10px;text-align:center;font-size:12px;color:#64748b;">‡∏´‡∏ô‡πà‡∏ß‡∏¢</th>
                                <th style="padding:10px;text-align:center;font-size:12px;color:#64748b;">‡∏ô‡∏±‡∏ö‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</th>
                                <th style="padding:10px;text-align:center;font-size:12px;color:#64748b;">‡πÇ‡∏î‡∏¢</th>
                            </tr></thead>
                            <tbody>${prods.map(p=>{
                                const cd=countData[p.id]||{total:0};
                                const units=p.units||[{name:p.unit||''}];
                                return `<tr style="border-top:1px solid #f1f5f9;">
                                    <td style="padding:10px;font-weight:bold;">${p.id}</td>
                                    <td style="padding:10px;color:#475569;">${p.name}</td>
                                    <td style="padding:10px;text-align:center;font-weight:bold;color:var(--success);font-size:16px;">${cd.total||0}</td>
                                    <td style="padding:10px;text-align:center;color:#64748b;">${units[0]?.name||''}</td>
                                    <td style="padding:10px;text-align:center;font-size:12px;color:#94a3b8;">${cd.lastUpdate||'-'}</td>
                                    <td style="padding:10px;text-align:center;font-size:12px;color:#94a3b8;">${cd.countedBy||'-'}</td>
                                    <td style="padding:8px;text-align:center;">${currentUser.role==='admin'?`<button onclick="openEditStockModal('${p.id}')" style="background:#f1f5f9;border:1px solid #e2e8f0;border-radius:6px;padding:4px 10px;cursor:pointer;font-size:11px;color:#475569;">‚úèÔ∏è ‡πÅ‡∏Å‡πâ</button>`:''}</td>
                                </tr>`;}).join('')}
                            </tbody>
                        </table>
                    </div>`;
                });
                container.innerHTML=html||'<p style="color:#94a3b8;text-align:center;padding:40px;">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p>';
            }catch(e){console.error(e);container.innerHTML='<p style="color:var(--danger);text-align:center;padding:40px;">‚ùå ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</p>';}
        };

        window.exportExcelSnapshot=function(){
            const zone=document.getElementById('filterZone')?.value||'';
            const zones=zone?[zone]:getVisibleWarehouses();
            const rows=[['‡∏Ñ‡∏•‡∏±‡∏á','‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤','‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤','‡∏¢‡∏≠‡∏î‡∏™‡∏ï‡πä‡∏≠‡∏Å','‡∏´‡∏ô‡πà‡∏ß‡∏¢','‡∏ô‡∏±‡∏ö‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î','‡πÇ‡∏î‡∏¢']];
            zones.forEach(z=>{
                const prods=allProducts.filter(p=>(zoneProductMap[z]||[]).includes(p.id));
                prods.forEach(p=>{
                    const cd=countData[p.id]||{total:0};
                    const units=p.units||[{name:p.unit||''}];
                    rows.push([z,p.id,p.name,cd.total||0,units[0]?.name||'',cd.lastUpdate||'',cd.countedBy||'']);
                });
            });
            const ws=XLSX.utils.aoa_to_sheet(rows),wb=XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb,ws,'‡∏¢‡∏≠‡∏î‡∏™‡∏ï‡πä‡∏≠‡∏Å');
            XLSX.writeFile(wb,`Stock_Snapshot_${new Date().toLocaleDateString('th-TH')}.xlsx`);
        };

        let currentHistoryData=[];

        window.loadHistory=async function(){
            const zone=document.getElementById('filterZone')?.value||'';
            const dateFrom=document.getElementById('filterDateFrom')?.value||'';
            const dateTo=document.getElementById('filterDateTo')?.value||'';
            // ‡∏ñ‡πâ‡∏≤‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô snapshot mode ‡πÉ‡∏´‡πâ‡∏Ç‡πâ‡∏≤‡∏°‡πÑ‡∏õ
            if(document.getElementById('reportMode')?.value==='snapshot'){loadSnapshot();return;}
            const container=document.getElementById('historyContainer');
            if(!container)return;
            container.innerHTML='<p style="color:#94a3b8;text-align:center;padding:40px;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</p>';
            try {
                const snap=await getDocs(collection(db,'stockHistory'));
                let sessions=[];
                snap.forEach(d=>sessions.push({id:d.id,...d.data()}));
                if(zone)sessions=sessions.filter(s=>s.zone===zone);
                if(dateFrom){const from=new Date(dateFrom).getTime();sessions=sessions.filter(s=>s.timestamp>=from);}
                if(dateTo){const to=new Date(dateTo).getTime()+86399999;sessions=sessions.filter(s=>s.timestamp<=to);}
                sessions.sort((a,b)=>b.timestamp-a.timestamp);
                currentHistoryData=sessions;
                if(sessions.length===0){container.innerHTML='<p style="color:#94a3b8;text-align:center;padding:40px;">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏°‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</p>';return;}
                container.innerHTML=sessions.map(s=>`
                <div class="history-card">
                    <div class="history-card-header">
                        <div><b style="font-size:15px;">üì¶ ${s.zone}</b>
                        <span style="margin-left:12px;color:#64748b;font-size:13px;">üìÖ ${s.date} ${s.countedBy?'‚Ä¢ üë§ '+s.countedBy:''}</span></div>
                        <div style="display:flex;align-items:center;gap:10px;">
                            <span style="font-size:11px;color:#94a3b8;">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÇ‡∏î‡∏¢: ${s.recordedBy||'-'}</span>
                            ${currentUser.role==='admin'?`<button onclick="deleteHistorySession('${s.id}')" style="background:#fee2e2;color:#ef4444;border:none;padding:4px 10px;border-radius:6px;cursor:pointer;font-size:11px;font-weight:bold;">üóëÔ∏è ‡∏•‡∏ö</button>`:''}
                        </div>
                    </div>
                    <table style="width:100%;border-collapse:collapse;">
                        <thead><tr style="background:#f8fafc;">
                            <th style="padding:10px;text-align:left;font-size:12px;color:#64748b;">‡∏£‡∏´‡∏±‡∏™</th>
                            <th style="padding:10px;text-align:left;font-size:12px;color:#64748b;">‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th>
                            <th style="padding:10px;text-align:center;font-size:12px;color:#64748b;">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th>
                            <th style="padding:10px;text-align:center;font-size:12px;color:#64748b;">‡∏´‡∏ô‡πà‡∏ß‡∏¢</th>
                            <th style="padding:10px;text-align:center;font-size:12px;color:#64748b;">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th>
                            <th style="padding:10px;text-align:center;font-size:12px;color:#64748b;">‡∏´‡∏ô‡πà‡∏ß‡∏¢</th>
                            <th style="padding:10px;text-align:center;font-size:12px;color:#64748b;">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th>
                            <th style="padding:10px;text-align:center;font-size:12px;color:#64748b;">‡∏´‡∏ô‡πà‡∏ß‡∏¢</th>
                        </tr></thead>
                        <tbody>${(s.items||[]).map(it=>{
                            // support both old and new format
                            const amounts=it.amounts||[{amount:it.amountMain||it.amount||0,unit:it.unit||''},{amount:it.amountSub||0,unit:it.subUnit||''}].filter(a=>a.unit);
                            return `<tr style="border-top:1px solid #f1f5f9;">
                            <td style="padding:10px;font-weight:bold;">${it.id}</td>
                            <td style="padding:10px;color:#475569;">${it.name}</td>
                            ${amounts.map(a=>`<td style="padding:10px;text-align:center;font-weight:bold;color:var(--success);">${a.amount>0?a.amount:'-'}</td><td style="padding:10px;text-align:center;color:#64748b;">${a.unit}</td>`).join('')}
                        </tr>`;}).join('')}</tbody>
                    </table>
                </div>`).join('');
            } catch(e){console.error(e);container.innerHTML='<p style="color:var(--danger);text-align:center;padding:40px;">‚ùå ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</p>';}
        };

        window.exportExcelHistory=function(){
            if(!currentHistoryData||currentHistoryData.length===0){toast('‚ùå ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ export','#c2410c');return;}
            const rows=[["‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà","‡∏Ñ‡∏•‡∏±‡∏á","‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤","‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤","‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏´‡∏ô‡πà‡∏ß‡∏¢1","‡∏´‡∏ô‡πà‡∏ß‡∏¢1","‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏´‡∏ô‡πà‡∏ß‡∏¢2","‡∏´‡∏ô‡πà‡∏ß‡∏¢2","‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏´‡∏ô‡πà‡∏ß‡∏¢3","‡∏´‡∏ô‡πà‡∏ß‡∏¢3","‡∏Ñ‡∏ô‡∏ô‡∏±‡∏ö","‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÇ‡∏î‡∏¢"]];
            currentHistoryData.forEach(s=>{
                (s.items||[]).forEach(it=>{
                    const amounts=it.amounts||[{amount:it.amountMain||it.amount||0,unit:it.unit||''},{amount:it.amountSub||0,unit:it.subUnit||''}].filter(a=>a.unit);
                    // pad ‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö 3 ‡∏´‡∏ô‡πà‡∏ß‡∏¢‡πÄ‡∏™‡∏°‡∏≠ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ï‡∏£‡∏á
                    const padded=Array.from({length:3},(_,i)=>amounts[i]||{amount:0,unit:''});
                    const row=[s.date,s.zone,it.id,it.name,
                        padded[0].amount||0, padded[0].unit||'',
                        padded[1].amount||0, padded[1].unit||'',
                        padded[2].amount||0, padded[2].unit||'',
                        s.countedBy||'',s.recordedBy||''];
                    rows.push(row);
                });
            });
            const ws=XLSX.utils.aoa_to_sheet(rows),wb=XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb,ws,"StockHistory");
            const zone=document.getElementById('filterZone')?.value||'all';
            XLSX.writeFile(wb,`StockHistory_${zone}_${new Date().toLocaleDateString('th-TH')}.xlsx`);
        };

        // ---- WAREHOUSE MANAGER (‡πÄ‡∏û‡∏¥‡πà‡∏° edit + subUnit) ----
        window.openWarehouseManager=function(){
            document.getElementById('dashboardView').classList.add('hidden');
            const c=document.getElementById('toolAppContainer');c.classList.remove('hidden');
            c.innerHTML=`<div class="tool-header"><h2>‚öôÔ∏è ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏•‡∏±‡∏á‡πÅ‡∏•‡∏∞‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</h2><button onclick="closeTool()">‚úï ‡∏õ‡∏¥‡∏î</button></div>
            <div style="display:flex;gap:10px;margin-bottom:20px;">
                <button onclick="backupConfig()" style="background:#0f172a;color:white;border:none;padding:10px 20px;border-radius:10px;cursor:pointer;font-weight:bold;display:flex;align-items:center;gap:8px;">üíæ Backup Config</button>
                <label style="background:#0891b2;color:white;border:none;padding:10px 20px;border-radius:10px;cursor:pointer;font-weight:bold;display:flex;align-items:center;gap:8px;">
                    üìÇ Restore Config<input type="file" accept=".json" onchange="restoreConfig(this)" style="display:none;">
                </label>
                <small style="color:#94a3b8;align-self:center;font-size:11px;">‡∏™‡∏≥‡∏£‡∏≠‡∏á/‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô ‡∏Ñ‡∏•‡∏±‡∏á, ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤, mapping ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</small>
            </div>
            <div style="display:grid;grid-template-columns:1fr 1.2fr;gap:25px;">
                <div style="background:white;padding:20px;border-radius:15px;border:1px solid #e2e8f0;">
                    <h4>üì¶ ‡∏Ñ‡∏•‡∏±‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (Zones)</h4>
                    <div style="display:flex;gap:8px;margin-bottom:15px;">
                        <input type="text" id="newWhName" placeholder="‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏•‡∏±‡∏á/‡πÇ‡∏ã‡∏ô‡πÉ‡∏´‡∏°‡πà" style="flex:1;padding:10px;border-radius:8px;border:1px solid #ddd;">
                        <button onclick="addWh()" style="background:var(--success);color:white;padding:10px 20px;border:none;border-radius:8px;cursor:pointer;">‡πÄ‡∏û‡∏¥‡πà‡∏°</button>
                    </div>
                    <div id="whListContainer"></div>
                </div>
                <div style="background:white;padding:20px;border-radius:15px;border:1px solid #e2e8f0;">
                    <h4>üçé ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</h4>
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:10px;">
                        <input type="text" id="newPdId" placeholder="‡∏£‡∏´‡∏±‡∏™ SKU" style="padding:10px;border:1px solid #ddd;border-radius:8px;">
                        <input type="text" id="newPdName" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤" style="padding:10px;border:1px solid #ddd;border-radius:8px;grid-column:span 1;">
                    </div>
                    <div style="background:#f8fafc;border-radius:8px;padding:10px;margin-bottom:10px;border:1px solid #e2e8f0;">
                        <div style="font-size:11px;color:#64748b;font-weight:bold;margin-bottom:8px;">‡∏´‡∏ô‡πà‡∏ß‡∏¢‡πÅ‡∏•‡∏∞‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡πÅ‡∏õ‡∏•‡∏á (‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 3 ‡∏´‡∏ô‡πà‡∏ß‡∏¢)</div>
                        <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:6px;align-items:center;margin-bottom:6px;">
                            <input type="text" id="newPdUnit1" placeholder="‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏ó‡∏µ‡πà 1 (‡πÉ‡∏´‡∏ç‡πà‡∏™‡∏∏‡∏î) ‡πÄ‡∏ä‡πà‡∏ô ‡∏•‡∏±‡∏á" style="padding:8px;border:1px solid #ddd;border-radius:6px;font-size:12px;">
                            <input type="number" id="newPdRate1" placeholder="1 ‡∏•‡∏±‡∏á = ? ‡∏ñ‡∏∏‡∏á" min="1" style="padding:8px;border:1px solid #ddd;border-radius:6px;font-size:12px;">
                            <small style="color:#94a3b8;">√ó ‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏ó‡∏µ‡πà 2</small>
                        </div>
                        <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:6px;align-items:center;margin-bottom:6px;">
                            <input type="text" id="newPdUnit2" placeholder="‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏ó‡∏µ‡πà 2 (‡∏Å‡∏•‡∏≤‡∏á) ‡πÄ‡∏ä‡πà‡∏ô ‡∏ñ‡∏∏‡∏á" style="padding:8px;border:1px solid #ddd;border-radius:6px;font-size:12px;">
                            <input type="number" id="newPdRate2" placeholder="1 ‡∏ñ‡∏∏‡∏á = ? ‡∏Å‡∏£‡∏±‡∏°" min="1" style="padding:8px;border:1px solid #ddd;border-radius:6px;font-size:12px;">
                            <small style="color:#94a3b8;">√ó ‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏ó‡∏µ‡πà 3</small>
                        </div>
                        <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:6px;align-items:center;">
                            <input type="text" id="newPdUnit3" placeholder="‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏ó‡∏µ‡πà 3 (‡πÄ‡∏•‡πá‡∏Å‡∏™‡∏∏‡∏î) ‡πÄ‡∏ä‡πà‡∏ô ‡∏Å‡∏£‡∏±‡∏°" style="padding:8px;border:1px solid #ddd;border-radius:6px;font-size:12px;">
                            <div></div><small style="color:#94a3b8;">‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢</small>
                        </div>
                    </div>
                    <button onclick="addPd()" style="width:100%;background:var(--info);color:white;padding:12px;border-radius:8px;border:none;cursor:pointer;font-weight:bold;">+ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</button>
                    <div id="pdMasterContainer" style="max-height:250px;overflow-y:auto;border-top:1px solid #eee;padding-top:10px;"></div>
                </div>
            </div>
            <div style="margin-top:25px;background:white;padding:25px;border-radius:15px;border:1px solid #e2e8f0;">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
                    <h4 style="margin:0;">üîó ‡∏à‡∏±‡∏ö‡∏Ñ‡∏π‡πà‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡πÇ‡∏ã‡∏ô</h4>
                    <select id="selectZoneMap" onchange="renderMapping();renderMinMaxTable()" style="padding:12px;border-radius:8px;min-width:300px;border:2px solid var(--primary-dark);font-weight:bold;"></select>
                </div>
                <div id="mappingContainer" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:12px;"></div>
            </div>
            <div style="margin-top:25px;background:white;padding:25px;border-radius:15px;border:1px solid #e2e8f0;">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
                    <div>
                        <h4 style="margin:0;">üìä ‡∏Å‡∏≥‡∏´‡∏ô‡∏î Min / Max ‡∏™‡∏ï‡πä‡∏≠‡∏Å‡∏ï‡πà‡∏≠‡∏Ñ‡∏•‡∏±‡∏á</h4>
                        <small style="color:#94a3b8;">Min = ‡∏¢‡∏≠‡∏î‡∏ï‡πà‡∏≥‡∏™‡∏∏‡∏î‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ | Max = ‡∏¢‡∏≠‡∏î‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢ | <b style="color:var(--info);">‡∏Ñ‡πà‡∏≤‡πÅ‡∏ï‡∏Å‡∏ï‡πà‡∏≤‡∏á‡∏Å‡∏±‡∏ô‡πÑ‡∏î‡πâ‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏•‡∏±‡∏á ‚Äî ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏•‡∏±‡∏á‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏£‡∏≠‡∏Å ‡∏à‡∏≤‡∏Å‡∏ô‡∏±‡πâ‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Ñ‡∏•‡∏±‡∏á</b></small>
                    </div>
                    <button onclick="saveAllMinMax()" style="background:var(--success);color:white;border:none;padding:10px 24px;border-radius:10px;cursor:pointer;font-weight:bold;">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Min/Max ‡∏Ñ‡∏•‡∏±‡∏á‡∏ô‡∏µ‡πâ</button>
                </div>
                <!-- zone tabs -->
                <div id="minMaxZoneTabs" style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:16px;padding-bottom:12px;border-bottom:1px solid #f1f5f9;"></div>
                <div id="minMaxZoneLabel" style="font-size:13px;color:#64748b;margin-bottom:10px;"></div>
                <div id="minMaxContainer"></div>
            </div>`;
            renderWhList(); renderPdList();
            document.getElementById('selectZoneMap').innerHTML=warehouseList.map(w=>`<option value="${w}">${w}</option>`).join('');
            renderMapping();
            renderMinMaxTable();
        };

        window.renderWhList=function(){
            const c=document.getElementById('whListContainer');if(!c)return;
            c.innerHTML=warehouseList.map((wh,i)=>`
            <div style="display:flex;align-items:center;gap:8px;padding:10px;border-bottom:1px solid #f1f5f9;" id="whRow_${i}">
                <span style="flex:1;font-weight:bold;" id="whLabel_${i}">${wh}</span>
                <input id="whInput_${i}" value="${wh}" style="flex:1;display:none;padding:6px 10px;border:1px solid var(--info);border-radius:6px;">
                <button class="btn-sm" style="background:var(--info);color:white;" onclick="toggleEditWh(${i})">‚úèÔ∏è</button>
                <button class="btn-sm" style="background:var(--success);color:white;display:none;" id="whSaveBtn_${i}" onclick="saveEditWh(${i})">üíæ</button>
                <button class="btn-sm" style="background:var(--danger);color:white;" onclick="deleteWh(${i})">üóëÔ∏è</button>
            </div>`).join('');
        };

        window.toggleEditWh=function(i){
            document.getElementById(`whLabel_${i}`).style.display='none';
            document.getElementById(`whInput_${i}`).style.display='block';
            document.getElementById(`whSaveBtn_${i}`).style.display='inline';
        };

        window.saveEditWh=function(i){
            const newName=document.getElementById(`whInput_${i}`).value.trim();
            if(!newName)return;
            const oldName=warehouseList[i];
            warehouseList[i]=newName;
            // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï zoneProductMap ‡∏î‡πâ‡∏ß‡∏¢
            if(oldName!==newName&&zoneProductMap[oldName]){
                zoneProductMap[newName]=zoneProductMap[oldName];
                delete zoneProductMap[oldName];
            }
            saveConfig(); renderWhList();
            document.getElementById('selectZoneMap').innerHTML=warehouseList.map(w=>`<option value="${w}">${w}</option>`).join('');
            renderMapping();
            toast('‚úÖ ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏•‡∏±‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢','#059669');
        };

        window.renderPdList=function(){
            const c=document.getElementById('pdMasterContainer');if(!c)return;
            c.innerHTML=allProducts.map((p,i)=>{
                const units=p.units||[{name:p.unit,rate:0},{name:p.subUnit||'',rate:0}].filter(u=>u.name);
                const unitsStr=units.map((u,ui)=>u.name+(ui<units.length-1&&u.rate>0?' (√ó'+u.rate+')':'')).join(' ‚Üí ');
                const isFirst=i===0, isLast=i===allProducts.length-1;
                return `<div style="padding:8px;background:#f8fafc;margin-bottom:6px;border-radius:8px;border:1px solid #edf2f7;">
                <div style="display:flex;align-items:center;gap:6px;">
                    <div style="display:flex;flex-direction:column;gap:2px;margin-right:2px;">
                        <button onclick="movePd(${i},-1)" ${isFirst?'disabled':''} style="background:${isFirst?'#e2e8f0':'#64748b'};color:white;border:none;border-radius:4px;width:22px;height:18px;cursor:${isFirst?'default':'pointer'};font-size:10px;line-height:1;">‚ñ≤</button>
                        <button onclick="movePd(${i},1)" ${isLast?'disabled':''} style="background:${isLast?'#e2e8f0':'#64748b'};color:white;border:none;border-radius:4px;width:22px;height:18px;cursor:${isLast?'default':'pointer'};font-size:10px;line-height:1;">‚ñº</button>
                    </div>
                    <span style="font-size:10px;color:#cbd5e1;min-width:18px;text-align:center;">${i+1}</span>
                    <div style="flex:1;font-size:12px;"><b>${p.id}</b> - ${p.name}<br><span style="color:#94a3b8;font-size:11px;">${unitsStr}</span></div>
                    <button class="btn-sm" style="background:var(--info);color:white;" onclick="toggleEditPd(${i})">‚úèÔ∏è</button>
                    <button class="btn-sm" style="background:var(--danger);color:white;" onclick="deletePd(${i})">‚úï</button>
                </div>
                <div id="pdEditArea_${i}" style="display:none;margin-top:8px;">
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:6px;">
                        <input id="pdEditName_${i}" value="${p.name}" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤" style="padding:6px;border:1px solid #ddd;border-radius:6px;font-size:12px;grid-column:span 2;">
                        ${units.map((u,ui)=>`
                        <input id="pdEditUnit${ui}_${i}" value="${u.name}" placeholder="‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏ó‡∏µ‡πà ${ui+1}" style="padding:6px;border:1px solid #ddd;border-radius:6px;font-size:12px;">
                        ${ui<units.length-1?`<input id="pdEditRate${ui}_${i}" value="${u.rate||''}" placeholder="‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡πÅ‡∏õ‡∏•‡∏á √ó" type="number" min="1" style="padding:6px;border:1px solid #ddd;border-radius:6px;font-size:12px;">`:'<div></div>'}`).join('')}
                        <button onclick="saveEditPd(${i})" style="grid-column:span 2;background:var(--success);color:white;border:none;padding:6px;border-radius:6px;cursor:pointer;font-size:12px;font-weight:bold;">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                    </div>
                </div>
            </div>`;}).join('');
        };

        window.movePd=function(i, dir){
            const j=i+dir;
            if(j<0||j>=allProducts.length) return;
            // ‡∏™‡∏•‡∏±‡∏ö‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á
            [allProducts[i], allProducts[j]] = [allProducts[j], allProducts[i]];
            saveConfig();
            renderPdList();
            renderMapping();
        };

        window.toggleEditPd=function(i){
            const area=document.getElementById(`pdEditArea_${i}`);
            area.style.display=area.style.display==='none'?'block':'none';
        };

        window.saveEditPd=function(i){
            const name=document.getElementById(`pdEditName_${i}`)?.value.trim();
            if(!name)return;
            const existingUnits=allProducts[i].units||[{name:allProducts[i].unit,rate:0},{name:allProducts[i].subUnit||'',rate:0}].filter(u=>u.name);
            const newUnits=[];
            for(let ui=0;ui<existingUnits.length;ui++){
                const uName=document.getElementById(`pdEditUnit${ui}_${i}`)?.value.trim()||'';
                const uRate=parseFloat(document.getElementById(`pdEditRate${ui}_${i}`)?.value)||0;
                if(uName) newUnits.push({name:uName,rate:uRate});
            }
            if(!newUnits.length)return;
            allProducts[i].name=name;
            allProducts[i].units=newUnits;
            allProducts[i].unit=newUnits[0]?.name||'';
            allProducts[i].subUnit=newUnits[1]?.name||'';
            saveConfig(); renderPdList();
            toast('‚úÖ ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢','#059669');
        };

        window.renderMapping=function(){
            const zone=document.getElementById('selectZoneMap').value,c=document.getElementById('mappingContainer');
            if(!zone||!c)return;
            const mapped=zoneProductMap[zone]||[];
            c.innerHTML=allProducts.map(p=>`<label style="display:flex;align-items:center;gap:12px;padding:15px;border:1px solid #e2e8f0;border-radius:12px;cursor:pointer;background:white;">
                <input type="checkbox" style="width:18px;height:18px;" ${mapped.includes(p.id)?'checked':''} onchange="togglePdMapping('${zone}','${p.id}')">
                <div style="font-size:13px;"><b>${p.id}</b><br><span style="color:#64748b;">${p.name}</span>
                <br><span style="color:#94a3b8;font-size:11px;">${p.unit}${p.subUnit?' / '+p.subUnit:''}</span></div>
            </label>`).join('');
        };

        window.togglePdMapping=function(z,id){if(!zoneProductMap[z])zoneProductMap[z]=[];const i=zoneProductMap[z].indexOf(id);if(i>-1)zoneProductMap[z].splice(i,1);else zoneProductMap[z].push(id);saveConfig();};
        window.addWh=function(){const n=document.getElementById('newWhName').value.trim();if(n){warehouseList.push(n);saveConfig();openWarehouseManager();}};
        window.deleteWh=function(i){if(confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡∏ö‡πÇ‡∏ã‡∏ô?')){warehouseList.splice(i,1);saveConfig();openWarehouseManager();}};

        window.addPd=function(){
            const id=document.getElementById('newPdId').value.trim();
            const name=document.getElementById('newPdName').value.trim();
            const u1=document.getElementById('newPdUnit1').value.trim();
            const u2=document.getElementById('newPdUnit2').value.trim();
            const u3=document.getElementById('newPdUnit3').value.trim();
            const r1=parseFloat(document.getElementById('newPdRate1').value)||0;
            const r2=parseFloat(document.getElementById('newPdRate2').value)||0;
            if(!id||!name||!u1){toast('‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å ‡∏£‡∏´‡∏±‡∏™, ‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ ‡πÅ‡∏•‡∏∞‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏ó‡∏µ‡πà 1 ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢','#c2410c');return;}
            // ‡∏™‡∏£‡πâ‡∏≤‡∏á units array
            const units=[];
            if(u1) units.push({name:u1,rate:r1||0}); // rate = ‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡πÅ‡∏õ‡∏•‡∏á‡πÑ‡∏õ‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏ñ‡∏±‡∏î‡πÑ‡∏õ
            if(u2) units.push({name:u2,rate:r2||0});
            if(u3) units.push({name:u3,rate:0}); // ‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢‡πÑ‡∏°‡πà‡∏°‡∏µ rate
            allProducts.push({id,name,units,
                // backward compat
                unit:u1, subUnit:u2||''
            });
            saveConfig(); renderPdList(); renderMapping();
            ['newPdId','newPdName','newPdUnit1','newPdRate1','newPdUnit2','newPdRate2','newPdUnit3'].forEach(x=>{
                const el=document.getElementById(x); if(el) el.value='';
            });
            toast('‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢','#059669');
        };

        window.deletePd=function(i){if(confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤?')){allProducts.splice(i,1);saveConfig();renderPdList();renderMapping();}};

        // ---- MISC ----
        // ======== INVENTORY CHECK SYSTEM ========
        // Firestore collection: inventoryHistory
        // ‡πÅ‡∏ï‡πà‡∏•‡∏∞ doc = { zone, date, timestamp, countedBy, recordedBy, items:[{id,name,balance,unit,note}] }

        window.openInventoryCheck=async function(){
            document.getElementById('dashboardView').classList.add('hidden');
            const c=document.getElementById('toolAppContainer');c.classList.remove('hidden');
            const visibleZones=getVisibleWarehouses();
            const today=new Date().toISOString().slice(0,10);
            const usSnap=await getDocs(collection(db,'users'));
            let staffOpts='';
            usSnap.forEach(d=>{const u=d.data();if(u.status!=='suspended')staffOpts+=`<option value="${u.name}">${u.name}</option>`;});

            c.innerHTML=`
            <div class="tool-header no-print">
                <h2>üìã ‡πÉ‡∏ö‡∏ô‡∏±‡∏ö‡∏™‡∏ï‡πä‡∏≠‡∏Å‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</h2>
                <div style="display:flex;gap:8px;">
                    <button onclick="openInventoryAnalysis()" style="background:#7c3aed;color:white;border:none;padding:8px 16px;border-radius:8px;cursor:pointer;font-weight:bold;">üìà ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå & ‡∏Å‡∏£‡∏≤‡∏ü</button>
                    <button onclick="closeTool()" style="background:#f1f5f9;color:#475569;border:none;padding:8px 16px;border-radius:8px;cursor:pointer;">‚úï ‡∏õ‡∏¥‡∏î</button>
                </div>
            </div>

            <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:15px;margin-bottom:20px;" class="no-print">
                <div class="input-group"><label>üì¶ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏•‡∏±‡∏á</label>
                    <select id="invZone" onchange="renderInventoryRows()" style="width:100%;border:none;font-weight:bold;outline:none;">
                        ${visibleZones.map(z=>`<option value="${z}">${z}</option>`).join('')}
                    </select>
                </div>
                <div class="input-group" style="border:2px solid var(--danger);"><label>üìÖ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ô‡∏±‡∏ö (‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö)</label>
                    <input type="date" id="invDate" value="${today}" style="width:100%;border:none;font-weight:bold;outline:none;font-size:14px;">
                </div>
                <div class="input-group" style="border:2px solid var(--info);"><label>üë§ ‡∏ú‡∏π‡πâ‡∏ô‡∏±‡∏ö</label>
                    <select id="invStaff" style="width:100%;border:none;font-weight:bold;outline:none;">
                        <option value="">-- ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å --</option>${staffOpts}
                    </select>
                </div>
                <div class="input-group" style="background:#f1f5f9;"><label>üìù ‡∏ú‡∏π‡πâ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</label><b>${currentUser.name}</b></div>
            </div>

            <div style="margin-bottom:12px;" class="no-print">
                <input type="text" id="invSearch" placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤..." oninput="filterInvRows(this.value)"
                    style="width:100%;padding:10px 16px;border:1px solid #e2e8f0;border-radius:10px;font-size:14px;box-sizing:border-box;outline:none;">
            </div>

            <div id="invTableContainer"></div>

            <div style="margin-top:25px;text-align:center;" class="no-print">
                <button onclick="saveInventorySheet()" style="background:var(--success);color:white;padding:18px 60px;border:none;border-radius:15px;font-size:18px;font-weight:bold;cursor:pointer;box-shadow:0 4px 15px rgba(16,185,129,0.4);">
                    üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏ö‡∏ô‡∏±‡∏ö‡∏™‡∏ï‡πä‡∏≠‡∏Å‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠
                </button>
            </div>`;

            renderInventoryRows();
        };

        window.renderInventoryRows=async function(){
            const zone=document.getElementById('invZone')?.value||'';
            const zoneProds=allProducts.filter(p=>(zoneProductMap[zone]||[]).includes(p.id));
            const c=document.getElementById('invTableContainer');
            if(!c)return;

            // ‡πÇ‡∏´‡∏•‡∏î inventory ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏•‡∏±‡∏á‡∏ô‡∏µ‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏™‡∏î‡∏á prev balance
            const invSnap=await getDocs(collection(db,'inventoryHistory'));
            let prevSheet=null; let prevTs=0;
            invSnap.forEach(d=>{
                const data=d.data();
                if(data.zone===zone && data.timestamp>prevTs){prevTs=data.timestamp;prevSheet=data;}
            });

            const borderColors=['var(--info)','#a78bfa','#f59e0b'];
            c.innerHTML=`
            <table class="stock-table" id="invTable">
                <thead><tr style="background:#f8fafc;">
                    <th style="padding:12px;text-align:left;font-size:12px;color:#64748b;width:35%;">‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th>
                    <th style="padding:12px;text-align:center;font-size:12px;color:#64748b;">‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏Å‡πà‡∏≠‡∏ô</th>
                    <th style="padding:12px;text-align:center;font-size:12px;color:#64748b;">‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏à‡∏£‡∏¥‡∏á‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</th>
                    <th style="padding:12px;text-align:center;font-size:12px;color:#64748b;">‡∏ú‡∏•‡∏ï‡πà‡∏≤‡∏á (‡πÉ‡∏ä‡πâ‡πÑ‡∏õ)</th>
                    <th style="padding:12px;text-align:left;font-size:12px;color:#64748b;">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</th>
                </tr></thead>
                <tbody>${zoneProds.map(p=>{
                    const units=p.units||[{name:p.unit||'',rate:0}].filter(u=>u.name);
                    const u0=units[0]?.name||'';
                    const prevItem=prevSheet?.items?.find(it=>it.id===p.id);
                    const prevBal=prevItem?.balance??'-';
                    return `<tr class="stock-row inv-row" data-search="${p.id.toLowerCase()} ${p.name.toLowerCase()}">
                        <td style="padding:12px;">
                            <b style="font-size:14px;">${p.id}</b><br>
                            <span style="color:#475569;font-size:13px;">${p.name}</span><br>
                            <small style="color:#94a3b8;font-size:10px;">‡∏´‡∏ô‡πà‡∏ß‡∏¢: ${u0}${prevSheet?` ‚Ä¢ ‡∏ô‡∏±‡∏ö‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: ${prevSheet.date}`:''}</small>
                        </td>
                        <td style="padding:12px;text-align:center;">
                            <span style="font-size:18px;font-weight:bold;color:#94a3b8;">${prevBal}</span>
                            ${prevBal!=='-'?`<br><small style="color:#cbd5e1;font-size:10px;">${u0}</small>`:''}
                        </td>
                        <td style="padding:12px;text-align:center;">
                            <input type="number" id="inv_${p.id}" min="0" placeholder="0"
                                oninput="calcDiff('${p.id}',${typeof prevBal==='number'?prevBal:'null'})"
                                style="width:90px;padding:8px;border-radius:8px;border:2px solid var(--info);text-align:center;font-weight:bold;font-size:16px;">
                            <br><small style="color:#64748b;font-size:10px;">${u0}</small>
                        </td>
                        <td style="padding:12px;text-align:center;" id="diff_${p.id}">
                            <span style="color:#cbd5e1;font-size:13px;">‚Äî</span>
                        </td>
                        <td style="padding:12px;">
                            <input type="text" id="note_${p.id}" placeholder="‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)"
                                style="width:100%;padding:6px 10px;border:1px solid #e2e8f0;border-radius:6px;font-size:12px;box-sizing:border-box;">
                        </td>
                    </tr>`;
                }).join('')}</tbody>
            </table>`;
        };

        window.calcDiff=function(id, prevBal){
            const val=parseFloat(document.getElementById(`inv_${id}`)?.value)||0;
            const diffEl=document.getElementById(`diff_${id}`);
            if(!diffEl)return;
            if(prevBal===null||prevBal===undefined||isNaN(prevBal)){
                diffEl.innerHTML='<span style="color:#94a3b8;font-size:12px;">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤</span>';return;
            }
            const diff=prevBal-val;
            const color=diff>0?'var(--danger)':diff<0?'var(--success)':'#64748b';
            const label=diff>0?`‡πÉ‡∏ä‡πâ‡πÑ‡∏õ ${diff}`:diff<0?`‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡∏∂‡πâ‡∏ô ${Math.abs(diff)}`:'‡∏Ñ‡∏á‡πÄ‡∏î‡∏¥‡∏°';
            diffEl.innerHTML=`<span style="font-size:15px;font-weight:bold;color:${color};">${diff>0?'-':''}${Math.abs(diff)}</span><br><small style="color:${color};font-size:10px;">${label}</small>`;
        };

        window.filterInvRows=function(q){
            q=q.toLowerCase().trim();
            document.querySelectorAll('.inv-row').forEach(row=>{
                row.style.display=(!q||row.dataset.search.includes(q))?'':'none';
            });
        };

        window.saveInventorySheet=async function(){
            const zone=document.getElementById('invZone')?.value;
            const date=document.getElementById('invDate')?.value;
            const staff=document.getElementById('invStaff')?.value;
            if(!zone||!date){toast('‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏•‡∏±‡∏á‡πÅ‡∏•‡∏∞‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà','#c2410c');return;}
            if(!staff){toast('‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ú‡∏π‡πâ‡∏ô‡∏±‡∏ö','#c2410c');return;}

            const zoneProds=allProducts.filter(p=>(zoneProductMap[zone]||[]).includes(p.id));
            const hasAny=zoneProds.some(p=>document.getElementById(`inv_${p.id}`)?.value!=='');
            if(!hasAny){toast('‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏¢‡∏≠‡∏î‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£','#c2410c');return;}

            if(!confirm(`‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏ö‡∏ô‡∏±‡∏ö‡∏™‡∏ï‡πä‡∏≠‡∏Å ${zone} ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${date}?`))return;

            const [yr,mo,dy]=date.split('-');
            const dateStr=`${dy}/${mo}/${parseInt(yr)+543}`;
            const items=zoneProds.map(p=>{
                const units=p.units||[{name:p.unit||''}];
                const val=document.getElementById(`inv_${p.id}`)?.value;
                const balance=val!==''?parseFloat(val):null;
                const note=document.getElementById(`note_${p.id}`)?.value||'';
                return {id:p.id,name:p.name,balance,unit:units[0]?.name||'',note};
            }).filter(it=>it.balance!==null);

            await addDoc(collection(db,'inventoryHistory'),{
                zone,date:dateStr,timestamp:Date.now(),
                countedBy:staff,recordedBy:currentUser.name,items
            });

            toast('‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏ö‡∏ô‡∏±‡∏ö‡∏™‡∏ï‡πä‡∏≠‡∏Å‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à','#059669');
            // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï input
            zoneProds.forEach(p=>{
                const el=document.getElementById(`inv_${p.id}`);
                const nl=document.getElementById(`note_${p.id}`);
                if(el)el.value='';
                if(nl)nl.value='';
                const diff=document.getElementById(`diff_${p.id}`);
                if(diff)diff.innerHTML='<span style="color:#cbd5e1;font-size:13px;">‚Äî</span>';
            });
            renderInventoryRows(); // reload ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏™‡∏î‡∏á prev ‡πÉ‡∏´‡∏°‡πà
        };

        // ======== INVENTORY ANALYSIS ========
        window.openInventoryAnalysis=async function(){
            document.getElementById('dashboardView').classList.add('hidden');
            const c=document.getElementById('toolAppContainer');c.classList.remove('hidden');
            const visibleZones=getVisibleWarehouses();

            c.innerHTML=`
            <div class="tool-header no-print">
                <h2>üìà ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏™‡∏ï‡πä‡∏≠‡∏Å‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</h2>
                <div style="display:flex;gap:8px;">
                    <button onclick="exportInventoryExcel()" style="background:var(--success);color:white;border:none;padding:8px 16px;border-radius:8px;cursor:pointer;font-weight:bold;">üì• Export Excel</button>
                    <button onclick="openInventoryCheck()" style="background:#7c3aed;color:white;border:none;padding:8px 16px;border-radius:8px;cursor:pointer;font-weight:bold;">üìã ‡πÉ‡∏ö‡∏ô‡∏±‡∏ö‡∏™‡∏ï‡πä‡∏≠‡∏Å</button>
                    <button onclick="closeTool()" style="background:#f1f5f9;color:#475569;border:none;padding:8px 16px;border-radius:8px;cursor:pointer;">‚úï ‡∏õ‡∏¥‡∏î</button>
                </div>
            </div>

            <div style="display:flex;gap:15px;margin-bottom:20px;flex-wrap:wrap;" class="no-print">
                <div class="input-group" style="min-width:220px;"><label>üì¶ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏•‡∏±‡∏á</label>
                    <select id="anaZone" onchange="loadInventoryAnalysis()" style="width:100%;border:none;font-weight:bold;outline:none;">
                        <option value="">‚Äî ‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏•‡∏±‡∏á ‚Äî</option>
                        ${visibleZones.map(z=>`<option value="${z}">${z}</option>`).join('')}
                    </select>
                </div>
                <div class="input-group" style="min-width:220px;"><label>üçé ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</label>
                    <select id="anaProd" onchange="loadInventoryAnalysis()" style="width:100%;border:none;font-weight:bold;outline:none;">
                        <option value="">‚Äî ‡∏ó‡∏∏‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ ‚Äî</option>
                        ${allProducts.map(p=>`<option value="${p.id}">${p.id} - ${p.name}</option>`).join('')}
                    </select>
                </div>
            </div>

            <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:24px;">
                <div style="background:white;border-radius:14px;padding:24px;border:1px solid #e2e8f0;">
                    <h4 style="margin:0 0 16px;color:var(--primary-dark);">üìä ‡∏¢‡∏≠‡∏î‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠ (Trend)</h4>
                    <canvas id="balanceChart" height="200"></canvas>
                </div>
                <div style="background:white;border-radius:14px;padding:24px;border:1px solid #e2e8f0;">
                    <h4 style="margin:0 0 16px;color:var(--primary-dark);">üìâ ‡∏¢‡∏≠‡∏î‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡πÑ‡∏õ‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏£‡∏≠‡∏ö</h4>
                    <canvas id="usageChart" height="200"></canvas>
                </div>
            </div>

            <div style="background:white;border-radius:14px;padding:24px;border:1px solid #e2e8f0;">
                <h4 style="margin:0 0 16px;color:var(--primary-dark);">üìã ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡∏ö‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</h4>
                <div id="invHistoryTable"><p style="color:#94a3b8;text-align:center;padding:20px;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</p></div>
            </div>`;

            await loadInventoryAnalysis();
        };

        let _invBalChart=null, _invUseChart=null;

        window.loadInventoryAnalysis=async function(){
            const zone=document.getElementById('anaZone')?.value||'';
            const prodId=document.getElementById('anaProd')?.value||'';

            const snap=await getDocs(collection(db,'inventoryHistory'));
            let sheets=[];
            snap.forEach(d=>sheets.push({id:d.id,...d.data()}));
            if(zone) sheets=sheets.filter(s=>s.zone===zone);
            sheets.sort((a,b)=>a.timestamp-b.timestamp);

            // ‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
            const filteredItems=[];
            sheets.forEach(s=>{
                (s.items||[]).forEach(it=>{
                    if(!prodId||it.id===prodId){
                        filteredItems.push({date:s.date,zone:s.zone,countedBy:s.countedBy,...it,sheetId:s.id});
                    }
                });
            });

            // ‡∏™‡∏£‡πâ‡∏≤‡∏á label-balance-usage arrays
            const labels=filteredItems.map(it=>`${it.date}
${it.zone}`);
            const balances=filteredItems.map(it=>it.balance||0);
            const usages=filteredItems.map((it,i)=>{
                if(i===0)return 0;
                const prev=filteredItems[i-1];
                if(prev.id!==it.id||prev.zone!==it.zone)return 0;
                return Math.max(0,(prev.balance||0)-(it.balance||0));
            });

            // render charts
            if(_invBalChart)_invBalChart.destroy();
            if(_invUseChart)_invUseChart.destroy();
            const bc=document.getElementById('balanceChart');
            const uc=document.getElementById('usageChart');
            if(bc&&labels.length){
                _invBalChart=new Chart(bc,{type:'line',data:{labels,datasets:[{
                    label:'‡∏¢‡∏≠‡∏î‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠',data:balances,
                    borderColor:'#3b82f6',backgroundColor:'rgba(59,130,246,0.08)',
                    borderWidth:2,tension:0.3,fill:true,pointRadius:4,
                }]},options:{responsive:true,plugins:{legend:{display:false}},scales:{y:{beginAtZero:true,grid:{color:'#f1f5f9'}},x:{grid:{display:false},ticks:{maxRotation:45}}}}});
            } else if(bc){bc.parentElement.innerHTML='<p style="color:#94a3b8;text-align:center;padding:40px;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p>';}

            if(uc&&labels.length){
                _invUseChart=new Chart(uc,{type:'bar',data:{labels,datasets:[{
                    label:'‡πÉ‡∏ä‡πâ‡πÑ‡∏õ',data:usages,
                    backgroundColor:'rgba(239,68,68,0.15)',borderColor:'#ef4444',
                    borderWidth:2,borderRadius:6,
                }]},options:{responsive:true,plugins:{legend:{display:false}},scales:{y:{beginAtZero:true,grid:{color:'#f1f5f9'}},x:{grid:{display:false},ticks:{maxRotation:45}}}}});
            } else if(uc){uc.parentElement.innerHTML='<p style="color:#94a3b8;text-align:center;padding:40px;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p>';}

            // render table
            const tbl=document.getElementById('invHistoryTable');
            if(!tbl)return;
            if(!filteredItems.length){tbl.innerHTML='<p style="color:#94a3b8;text-align:center;padding:40px;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‚Äî ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏ö‡∏ô‡∏±‡∏ö‡∏™‡∏ï‡πä‡∏≠‡∏Å‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏•‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö</p>';return;}
            tbl.innerHTML=`<table style="width:100%;border-collapse:collapse;">
                <thead><tr style="background:#f8fafc;">
                    <th style="padding:10px;text-align:left;font-size:12px;color:#64748b;">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
                    <th style="padding:10px;text-align:left;font-size:12px;color:#64748b;">‡∏Ñ‡∏•‡∏±‡∏á</th>
                    <th style="padding:10px;text-align:left;font-size:12px;color:#64748b;">‡∏£‡∏´‡∏±‡∏™</th>
                    <th style="padding:10px;text-align:left;font-size:12px;color:#64748b;">‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th>
                    <th style="padding:10px;text-align:center;font-size:12px;color:#64748b;">‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</th>
                    <th style="padding:10px;text-align:center;font-size:12px;color:#64748b;">‡∏´‡∏ô‡πà‡∏ß‡∏¢</th>
                    <th style="padding:10px;text-align:center;font-size:12px;color:#64748b;">‡πÉ‡∏ä‡πâ‡πÑ‡∏õ‡∏à‡∏≤‡∏Å‡∏£‡∏≠‡∏ö‡∏Å‡πà‡∏≠‡∏ô</th>
                    <th style="padding:10px;text-align:left;font-size:12px;color:#64748b;">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</th>
                    <th style="padding:10px;text-align:left;font-size:12px;color:#64748b;">‡∏ú‡∏π‡πâ‡∏ô‡∏±‡∏ö</th>
                </tr></thead>
                <tbody>${filteredItems.map((it,i)=>{
                    const usage=usages[i];
                    const usageColor=usage>0?'var(--danger)':usage<0?'var(--success)':'#94a3b8';
                    const usageText=usage>0?`-${usage}`:usage<0?`+${Math.abs(usage)}`:'‚Äî';
                    return `<tr style="border-top:1px solid #f1f5f9;">
                        <td style="padding:10px;font-size:13px;">${it.date}</td>
                        <td style="padding:10px;font-size:13px;color:#64748b;">${it.zone}</td>
                        <td style="padding:10px;font-weight:bold;">${it.id}</td>
                        <td style="padding:10px;color:#475569;font-size:13px;">${it.name}</td>
                        <td style="padding:10px;text-align:center;font-weight:bold;color:var(--success);font-size:15px;">${it.balance??'-'}</td>
                        <td style="padding:10px;text-align:center;color:#64748b;font-size:12px;">${it.unit||''}</td>
                        <td style="padding:10px;text-align:center;font-weight:bold;color:${usageColor};">${i===0?'‚Äî':usageText}</td>
                        <td style="padding:10px;color:#64748b;font-size:12px;">${it.note||'-'}</td>
                        <td style="padding:10px;color:#64748b;font-size:12px;">${it.countedBy||'-'}</td>
                    </tr>`;}).join('')}
                </tbody>
            </table>`;

            window._invExportData=filteredItems.map((it,i)=>({
                ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:it.date,‡∏Ñ‡∏•‡∏±‡∏á:it.zone,‡∏£‡∏´‡∏±‡∏™:it.id,‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤:it.name,
                ‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠:it.balance??'',‡∏´‡∏ô‡πà‡∏ß‡∏¢:it.unit||'',
                ‡πÉ‡∏ä‡πâ‡πÑ‡∏õ‡∏à‡∏≤‡∏Å‡∏£‡∏≠‡∏ö‡∏Å‡πà‡∏≠‡∏ô:i===0?'':usages[i],
                ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏:it.note||'',‡∏ú‡∏π‡πâ‡∏ô‡∏±‡∏ö:it.countedBy||'',
            }));
        };

        window.exportInventoryExcel=function(){
            if(!window._invExportData?.length){toast('‚ùå ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•','#c2410c');return;}
            const rows=[Object.keys(window._invExportData[0]),...window._invExportData.map(r=>Object.values(r))];
            const ws=XLSX.utils.aoa_to_sheet(rows),wb=XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb,ws,'InventoryHistory');
            XLSX.writeFile(wb,`Inventory_${new Date().toLocaleDateString('th-TH').replace(/\//g,'-')}.xlsx`);
        };

        // ======== MIN/MAX & PURCHASE ORDER ========

        window.renderMinMaxTable=function(forceZone){
            const zone=forceZone||document.getElementById('selectZoneMap')?.value||warehouseList[0]||'';
            const c=document.getElementById('minMaxContainer');
            const label=document.getElementById('minMaxZoneLabel');
            if(!c||!zone)return;

            // render zone tabs
            const tabs=document.getElementById('minMaxZoneTabs');
            if(tabs){
                tabs.innerHTML=warehouseList.map(z=>{
                    const hasData=allProducts.some(p=>{
                        const key=`${z}__${p.id}`;
                        const mm=productMinMax[key];
                        return mm&&(mm.min>0||mm.max>0);
                    });
                    const isActive=z===zone;
                    return `<button onclick="renderMinMaxTable('${z}')"
                        style="padding:7px 16px;border-radius:8px;border:2px solid ${isActive?'var(--primary-dark)':'#e2e8f0'};
                        background:${isActive?'var(--primary-dark)':'white'};color:${isActive?'white':'#475569'};
                        cursor:pointer;font-size:12px;font-weight:bold;position:relative;">
                        ${z}${hasData?'<span style="position:absolute;top:-4px;right:-4px;width:8px;height:8px;border-radius:50%;background:var(--success);"></span>':''}
                    </button>`;
                }).join('');
            }

            if(label) label.innerHTML=`<b style="color:var(--primary-dark);">üì¶ ${zone}</b> ‚Äî ‡∏Å‡∏£‡∏≠‡∏Å‡∏Ñ‡πà‡∏≤‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Min/Max ‡∏Ñ‡∏•‡∏±‡∏á‡∏ô‡∏µ‡πâ" ‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Ñ‡∏•‡∏±‡∏á`;

            const zoneProds=allProducts.filter(p=>(zoneProductMap[zone]||[]).includes(p.id));
            if(!zoneProds.length){c.innerHTML='<p style="color:#94a3b8;font-size:13px;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏Ñ‡∏•‡∏±‡∏á‡∏ô‡∏µ‡πâ ‚Äî ‡∏à‡∏±‡∏ö‡∏Ñ‡∏π‡πà‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡πÇ‡∏ã‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏ô‡∏∞‡∏Ñ‡∏£‡∏±‡∏ö</p>';return;}
            c.innerHTML=`<table style="width:100%;border-collapse:collapse;">
                <thead><tr style="background:#f8fafc;">
                    <th style="padding:10px;text-align:left;font-size:12px;color:#64748b;">‡∏£‡∏´‡∏±‡∏™</th>
                    <th style="padding:10px;text-align:left;font-size:12px;color:#64748b;">‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th>
                    <th style="padding:10px;text-align:left;font-size:12px;color:#64748b;">‡∏´‡∏ô‡πà‡∏ß‡∏¢</th>
                    <th style="padding:10px;text-align:center;font-size:12px;color:#ef4444;">üî¥ Min (‡∏ï‡πà‡∏≥‡∏™‡∏∏‡∏î)</th>
                    <th style="padding:10px;text-align:center;font-size:12px;color:#10b981;">üü¢ Max (‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢)</th>
                </tr></thead>
                <tbody>${zoneProds.map(p=>{
                    const key=`${zone}__${p.id}`;
                    const mm=productMinMax[key]||{min:'',max:''};
                    const u=(p.units||[{name:p.unit||''}])[0]?.name||'';
                    return `<tr style="border-top:1px solid #f1f5f9;">
                        <td style="padding:10px;font-weight:bold;font-size:13px;">${p.id}</td>
                        <td style="padding:10px;color:#475569;font-size:13px;">${p.name}</td>
                        <td style="padding:10px;color:#94a3b8;font-size:12px;">${u}</td>
                        <td style="padding:10px;text-align:center;">
                            <input type="number" id="mm_min_${p.id}" value="${mm.min||''}" min="0" placeholder="0"
                                style="width:80px;padding:8px;border:2px solid #fca5a5;border-radius:8px;text-align:center;font-weight:bold;font-size:14px;outline:none;">
                        </td>
                        <td style="padding:10px;text-align:center;">
                            <input type="number" id="mm_max_${p.id}" value="${mm.max||''}" min="0" placeholder="0"
                                style="width:80px;padding:8px;border:2px solid #6ee7b7;border-radius:8px;text-align:center;font-weight:bold;font-size:14px;outline:none;">
                        </td>
                    </tr>`;
                }).join('')}</tbody>
            </table>`;
            // store current zone for saveAllMinMax to use
            window._currentMinMaxZone=zone;
        };

        window.saveAllMinMax=function(){
            const zone=window._currentMinMaxZone||document.getElementById('selectZoneMap')?.value||'';
            if(!zone){toast('‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏•‡∏±‡∏á‡∏Å‡πà‡∏≠‡∏ô','#c2410c');return;}
            const zoneProds=allProducts.filter(p=>(zoneProductMap[zone]||[]).includes(p.id));
            let count=0;
            zoneProds.forEach(p=>{
                const minEl=document.getElementById(`mm_min_${p.id}`);
                const maxEl=document.getElementById(`mm_max_${p.id}`);
                const minV=parseFloat(minEl?.value)||0;
                const maxV=parseFloat(maxEl?.value)||0;
                if(minV>0||maxV>0){
                    const key=`${zone}__${p.id}`;
                    productMinMax[key]={min:minV,max:maxV,zone,productId:p.id};
                    count++;
                }
            });
            saveConfig();
            toast(`‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Min/Max ${count} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ (${zone}) ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à`,'#059669');
            renderMinMaxTable(zone); // refresh tabs + green dots
        };

        // ---- Purchase Order Page ----
        window.openPurchaseOrder=async function(){
            document.getElementById('dashboardView').classList.add('hidden');
            const c=document.getElementById('toolAppContainer');c.classList.remove('hidden');
            await loadCountData();
            // ‡πÇ‡∏´‡∏•‡∏î inventory ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏Ç‡∏≠‡∏á‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏Ñ‡∏•‡∏±‡∏á
            const invSnap=await getDocs(collection(db,'inventoryHistory'));
            const latestInv={};
            invSnap.forEach(d=>{
                const data=d.data();
                if(!latestInv[data.zone]||data.timestamp>latestInv[data.zone].timestamp) latestInv[data.zone]=data;
            });

            const visibleZones=getVisibleWarehouses();

            // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏™‡∏±‡πà‡∏á
            const orderItems=[];
            visibleZones.forEach(zone=>{
                const zoneProds=allProducts.filter(p=>(zoneProductMap[zone]||[]).includes(p.id));
                zoneProds.forEach(p=>{
                    const key=`${zone}__${p.id}`;
                    const mm=productMinMax[key];
                    if(!mm||(!mm.min&&!mm.max))return;
                    // ‡∏´‡∏≤‡∏¢‡∏≠‡∏î‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î (‡∏à‡∏≤‡∏Å inventoryHistory ‡∏Å‡πà‡∏≠‡∏ô ‡πÅ‡∏•‡πâ‡∏ß fallback countData)
                    const invItem=latestInv[zone]?.items?.find(it=>it.id===p.id);
                    const balance=invItem?.balance??countData[p.id]?.total??0;
                    const u=(p.units||[{name:p.unit||''}])[0]?.name||'';
                    const needOrder=mm.min>0&&balance<=mm.min;
                    const suggestQty=mm.max>0?Math.max(0,mm.max-balance):0;
                    const status=balance<=mm.min?'üî¥ ‡∏ï‡πà‡∏≥‡∏Å‡∏ß‡πà‡∏≤ Min':balance<=(mm.min*1.2)?'üü° ‡πÉ‡∏Å‡∏•‡πâ‡∏ñ‡∏∂‡∏á Min':'üü¢ ‡∏õ‡∏Å‡∏ï‡∏¥';
                    orderItems.push({zone,id:p.id,name:p.name,unit:u,balance,min:mm.min,max:mm.max,suggestQty,needOrder,status});
                });
            });

            const urgent=orderItems.filter(it=>it.needOrder);
            const warning=orderItems.filter(it=>!it.needOrder&&it.status.includes('üü°'));
            const normal=orderItems.filter(it=>it.status.includes('üü¢'));

            c.innerHTML=`
            <div class="tool-header no-print">
                <h2>üõí ‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</h2>
                <div style="display:flex;gap:8px;">
                    <button onclick="exportPurchasePDF()" style="background:#ef4444;color:white;border:none;padding:8px 16px;border-radius:8px;cursor:pointer;font-weight:bold;">üñ®Ô∏è PDF ‡πÉ‡∏ö‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</button>
                    <button onclick="exportPurchaseExcel()" style="background:var(--success);color:white;border:none;padding:8px 16px;border-radius:8px;cursor:pointer;font-weight:bold;">üì• Excel</button>
                    <button onclick="exportTRCloudFormat()" style="background:#7c3aed;color:white;border:none;padding:8px 16px;border-radius:8px;cursor:pointer;font-weight:bold;">üîó TRCloud Format</button>
                    <button onclick="closeTool()" style="background:#f1f5f9;color:#475569;border:none;padding:8px 16px;border-radius:8px;cursor:pointer;">‚úï ‡∏õ‡∏¥‡∏î</button>
                </div>
            </div>

            <!-- summary badges -->
            <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:16px;margin-bottom:24px;">
                <div style="background:#fef2f2;border:2px solid #fca5a5;border-radius:14px;padding:20px;text-align:center;">
                    <div style="font-size:32px;font-weight:bold;color:#ef4444;">${urgent.length}</div>
                    <div style="color:#ef4444;font-weight:bold;font-size:13px;">üî¥ ‡∏ï‡πâ‡∏≠‡∏á‡∏™‡∏±‡πà‡∏á‡∏î‡πà‡∏ß‡∏ô (‡∏ï‡πà‡∏≥‡∏Å‡∏ß‡πà‡∏≤ Min)</div>
                </div>
                <div style="background:#fffbeb;border:2px solid #fcd34d;border-radius:14px;padding:20px;text-align:center;">
                    <div style="font-size:32px;font-weight:bold;color:#f59e0b;">${warning.length}</div>
                    <div style="color:#f59e0b;font-weight:bold;font-size:13px;">üü° ‡πÉ‡∏Å‡∏•‡πâ‡∏ñ‡∏∂‡∏á Min (‡πÄ‡∏ù‡πâ‡∏≤‡∏£‡∏∞‡∏ß‡∏±‡∏á)</div>
                </div>
                <div style="background:#f0fdf4;border:2px solid #6ee7b7;border-radius:14px;padding:20px;text-align:center;">
                    <div style="font-size:32px;font-weight:bold;color:#10b981;">${normal.length}</div>
                    <div style="color:#10b981;font-weight:bold;font-size:13px;">üü¢ ‡∏™‡∏ï‡πä‡∏≠‡∏Å‡∏õ‡∏Å‡∏ï‡∏¥</div>
                </div>
            </div>

            <!-- order table -->
            <div style="background:white;border-radius:14px;border:1px solid #e2e8f0;overflow:hidden;">
                <div style="padding:16px 20px;border-bottom:1px solid #f1f5f9;display:flex;justify-content:space-between;align-items:center;">
                    <h4 style="margin:0;">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h4>
                    <div style="display:flex;gap:8px;">
                        <button onclick="filterOrder('all')" id="obtn_all" style="padding:6px 14px;border-radius:8px;border:2px solid var(--primary-dark);background:var(--primary-dark);color:white;cursor:pointer;font-size:12px;font-weight:bold;">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
                        <button onclick="filterOrder('urgent')" id="obtn_urgent" style="padding:6px 14px;border-radius:8px;border:2px solid #ef4444;background:white;color:#ef4444;cursor:pointer;font-size:12px;font-weight:bold;">‡∏ï‡πâ‡∏≠‡∏á‡∏™‡∏±‡πà‡∏á‡∏î‡πà‡∏ß‡∏ô</button>
                    </div>
                </div>
                <div style="overflow-x:auto;">
                    <table style="width:100%;border-collapse:collapse;" id="orderTable">
                        <thead><tr style="background:#f8fafc;">
                            <th style="padding:12px;text-align:left;font-size:12px;color:#64748b;">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                            <th style="padding:12px;text-align:left;font-size:12px;color:#64748b;">‡∏Ñ‡∏•‡∏±‡∏á</th>
                            <th style="padding:12px;text-align:left;font-size:12px;color:#64748b;">‡∏£‡∏´‡∏±‡∏™</th>
                            <th style="padding:12px;text-align:left;font-size:12px;color:#64748b;">‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th>
                            <th style="padding:12px;text-align:center;font-size:12px;color:#64748b;">‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</th>
                            <th style="padding:12px;text-align:center;font-size:12px;color:#ef4444;">Min</th>
                            <th style="padding:12px;text-align:center;font-size:12px;color:#10b981;">Max</th>
                            <th style="padding:12px;text-align:center;font-size:12px;color:#7c3aed;">‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏™‡∏±‡πà‡∏á</th>
                            <th style="padding:12px;text-align:center;font-size:12px;color:#64748b;">‡∏´‡∏ô‡πà‡∏ß‡∏¢</th>
                            <th style="padding:12px;text-align:center;font-size:12px;color:#64748b;">‡∏¢‡∏≠‡∏î‡∏™‡∏±‡πà‡∏á‡∏à‡∏£‡∏¥‡∏á</th>
                        </tr></thead>
                        <tbody>${[...urgent,...warning,...normal].map(it=>`
                        <tr class="order-row" data-urgent="${it.needOrder}" style="border-top:1px solid #f1f5f9;${it.needOrder?'background:#fff5f5;':''}">
                            <td style="padding:12px;">${it.status}</td>
                            <td style="padding:12px;font-size:12px;color:#64748b;">${it.zone}</td>
                            <td style="padding:12px;font-weight:bold;font-size:13px;">${it.id}</td>
                            <td style="padding:12px;color:#475569;font-size:13px;">${it.name}</td>
                            <td style="padding:12px;text-align:center;font-weight:bold;font-size:15px;color:${it.needOrder?'#ef4444':'var(--success)'};">${it.balance}</td>
                            <td style="padding:12px;text-align:center;color:#ef4444;font-weight:bold;">${it.min||'-'}</td>
                            <td style="padding:12px;text-align:center;color:#10b981;font-weight:bold;">${it.max||'-'}</td>
                            <td style="padding:12px;text-align:center;font-weight:bold;color:#7c3aed;font-size:15px;">${it.suggestQty||'-'}</td>
                            <td style="padding:12px;text-align:center;color:#64748b;font-size:12px;">${it.unit}</td>
                            <td style="padding:12px;text-align:center;">
                                <input type="number" id="order_${it.zone}_${it.id}" value="${it.suggestQty||''}" min="0" placeholder="0"
                                    style="width:80px;padding:7px;border:2px solid #e2e8f0;border-radius:8px;text-align:center;font-weight:bold;font-size:14px;outline:none;">
                            </td>
                        </tr>`).join('')}</tbody>
                    </table>
                </div>
            </div>`;

            window._orderItems=[...urgent,...warning,...normal];
        };

        window.filterOrder=function(mode){
            document.querySelectorAll('.order-row').forEach(r=>{
                r.style.display=(mode==='all'||r.dataset.urgent==='true')?'':'none';
            });
            document.getElementById('obtn_all').style.background=mode==='all'?'var(--primary-dark)':'white';
            document.getElementById('obtn_all').style.color=mode==='all'?'white':'var(--primary-dark)';
            document.getElementById('obtn_urgent').style.background=mode==='urgent'?'#ef4444':'white';
            document.getElementById('obtn_urgent').style.color=mode==='urgent'?'white':'#ef4444';
        };

        window.exportPurchaseExcel=function(){
            if(!window._orderItems?.length){toast('‚ùå ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•','#c2410c');return;}
            const rows=[['‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞','‡∏Ñ‡∏•‡∏±‡∏á','‡∏£‡∏´‡∏±‡∏™','‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤','‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠','Min','Max','‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏™‡∏±‡πà‡∏á','‡∏¢‡∏≠‡∏î‡∏™‡∏±‡πà‡∏á‡∏à‡∏£‡∏¥‡∏á','‡∏´‡∏ô‡πà‡∏ß‡∏¢']];
            window._orderItems.forEach(it=>{
                const actual=document.getElementById(`order_${it.zone}_${it.id}`)?.value||it.suggestQty||0;
                rows.push([it.status,it.zone,it.id,it.name,it.balance,it.min||'',it.max||'',it.suggestQty||'',actual,it.unit]);
            });
            const ws=XLSX.utils.aoa_to_sheet(rows),wb=XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb,ws,'PurchaseOrder');
            XLSX.writeFile(wb,`PurchaseOrder_${new Date().toLocaleDateString('th-TH').replace(/\//g,'-')}.xlsx`);
        };

        // ---- Dashboard alert badges ----
        window.renderStockAlerts=async function(){
            await loadCountData();
            const invSnap=await getDocs(collection(db,'inventoryHistory'));
            const latestInv={};
            invSnap.forEach(d=>{const data=d.data();if(!latestInv[data.zone]||data.timestamp>latestInv[data.zone].timestamp)latestInv[data.zone]=data;});
            let urgentCount=0;
            getVisibleWarehouses().forEach(zone=>{
                allProducts.filter(p=>(zoneProductMap[zone]||[]).includes(p.id)).forEach(p=>{
                    const key=`${zone}__${p.id}`;
                    const mm=productMinMax[key];
                    if(!mm||!mm.min)return;
                    const invItem=latestInv[zone]?.items?.find(it=>it.id===p.id);
                    const balance=invItem?.balance??countData[p.id]?.total??0;
                    if(balance<=mm.min)urgentCount++;
                });
            });
            const alertEl=document.getElementById('dashAlertBanner');
            if(!alertEl)return;
            if(urgentCount>0){
                alertEl.innerHTML=`<div style="background:#fef2f2;border:2px solid #fca5a5;border-radius:14px;padding:16px 24px;display:flex;align-items:center;justify-content:space-between;margin-bottom:20px;">
                    <div style="display:flex;align-items:center;gap:12px;">
                        <span style="font-size:24px;">üî¥</span>
                        <div><b style="color:#ef4444;font-size:15px;">‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ ${urgentCount} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ‡∏ï‡πà‡∏≥‡∏Å‡∏ß‡πà‡∏≤ Min!</b><br>
                        <span style="color:#64748b;font-size:13px;">‡∏Ñ‡∏ß‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÇ‡∏î‡∏¢‡∏î‡πà‡∏ß‡∏ô</span></div>
                    </div>
                    <button onclick="openPurchaseOrder()" style="background:#ef4444;color:white;border:none;padding:10px 20px;border-radius:10px;cursor:pointer;font-weight:bold;">üõí ‡∏î‡∏π‡πÉ‡∏ö‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</button>
                </div>`;
            } else {
                alertEl.innerHTML='';
            }
        };

        // ======== PDF PURCHASE ORDER ========
        window.exportPurchasePDF=function(){
            if(!window._orderItems?.length){toast('‚ùå ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•','#c2410c');return;}
            const urgentOnly=window._orderItems.filter(it=>it.needOrder||it.status.includes('üü°'));
            if(!urgentOnly.length){toast('‚úÖ ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏™‡∏±‡πà‡∏á','#059669');return;}

            const now=new Date();
            const dateStr=now.toLocaleDateString('th-TH',{year:'numeric',month:'long',day:'numeric'});
            const poNumber=`PO-${now.getFullYear()}${String(now.getMonth()+1).padStart(2,'0')}${String(now.getDate()).padStart(2,'0')}-${String(now.getHours()).padStart(2,'0')}${String(now.getMinutes()).padStart(2,'0')}`;

            const rows=urgentOnly.map((it,i)=>{
                const actual=document.getElementById(`order_${it.zone}_${it.id}`)?.value||it.suggestQty||0;
                return `<tr style="${i%2===0?'background:#f8fafc':''}">
                    <td style="padding:10px;text-align:center;color:#64748b;">${i+1}</td>
                    <td style="padding:10px;font-weight:bold;">${it.id}</td>
                    <td style="padding:10px;">${it.name}</td>
                    <td style="padding:10px;text-align:center;color:#64748b;">${it.zone}</td>
                    <td style="padding:10px;text-align:center;color:#ef4444;font-weight:bold;">${it.balance}</td>
                    <td style="padding:10px;text-align:center;color:#10b981;font-weight:bold;">${it.min||'-'}</td>
                    <td style="padding:10px;text-align:center;font-weight:bold;color:#7c3aed;font-size:16px;">${actual}</td>
                    <td style="padding:10px;text-align:center;color:#64748b;">${it.unit}</td>
                    <td style="padding:10px;"></td>
                </tr>`;
            }).join('');

            const html=`<!DOCTYPE html><html><head><meta charset="UTF-8">
            <style>
                body{font-family:'Sarabun',sans-serif;margin:0;padding:30px;color:#1e293b;font-size:13px;}
                .header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:30px;padding-bottom:20px;border-bottom:3px solid #1e293b;}
                .company{font-size:22px;font-weight:bold;color:#1e293b;}
                .po-badge{background:#1e293b;color:white;padding:10px 20px;border-radius:10px;text-align:right;}
                .po-badge .po-num{font-size:16px;font-weight:bold;}
                .po-badge .po-date{font-size:12px;color:#94a3b8;margin-top:4px;}
                table{width:100%;border-collapse:collapse;margin-top:20px;}
                thead tr{background:#1e293b;color:white;}
                th{padding:10px;text-align:left;font-size:12px;}
                td{border-bottom:1px solid #e2e8f0;vertical-align:middle;}
                .footer{margin-top:40px;display:grid;grid-template-columns:1fr 1fr 1fr;gap:30px;}
                .sign-box{text-align:center;padding-top:50px;border-top:1px solid #334155;}
                .sign-label{font-size:11px;color:#64748b;}
                @media print{body{padding:15px;}}
            </style>
            <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;700&display=swap" rel="stylesheet">
            </head><body>
            <div class="header">
                <div>
                    <div class="company">üè¢ TingTing Bingsu</div>
                    <div style="color:#64748b;margin-top:4px;font-size:12px;">‡πÉ‡∏ö‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (Purchase Order)</div>
                </div>
                <div class="po-badge">
                    <div class="po-num">${poNumber}</div>
                    <div class="po-date">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: ${dateStr}</div>
                    <div class="po-date">‡∏à‡∏±‡∏î‡∏ó‡∏≥‡πÇ‡∏î‡∏¢: ${window.currentUser?.name||''}</div>
                </div>
            </div>
            <table>
                <thead><tr>
                    <th style="width:40px;text-align:center;">#</th>
                    <th style="width:100px;">‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th>
                    <th>‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th>
                    <th style="width:100px;text-align:center;">‡∏Ñ‡∏•‡∏±‡∏á</th>
                    <th style="width:70px;text-align:center;">‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</th>
                    <th style="width:60px;text-align:center;">Min</th>
                    <th style="width:80px;text-align:center;">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏±‡πà‡∏á</th>
                    <th style="width:60px;text-align:center;">‡∏´‡∏ô‡πà‡∏ß‡∏¢</th>
                    <th style="width:100px;">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</th>
                </tr></thead>
                <tbody>${rows}</tbody>
            </table>
            <div style="margin-top:20px;padding:15px;background:#f8fafc;border-radius:8px;font-size:12px;color:#64748b;">
                ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: <b>${urgentOnly.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</b> &nbsp;|&nbsp; ‡∏à‡∏±‡∏î‡∏ó‡∏≥‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö TingTing Dashboard
            </div>
            <div class="footer">
                <div class="sign-box"><div class="sign-label">‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏ó‡∏≥ / Prepared by</div></div>
                <div class="sign-box"><div class="sign-label">‡∏ú‡∏π‡πâ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ / Approved by</div></div>
                <div class="sign-box"><div class="sign-label">‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ / Received by</div></div>
            </div>
            </body></html>`;

            const w=window.open('','_blank','width=900,height=700');
            w.document.write(html);
            w.document.close();
            setTimeout(()=>w.print(),800);
        };

        // ======== TRCLOUD PR FORMAT - OPEN MODAL FIRST ========
        window.exportTRCloudFormat=function(){
            if(!window._orderItems?.length){toast('‚ùå ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•','#c2410c');return;}
            const items=window._orderItems.filter(it=>it.needOrder||it.status.includes('üü°'));
            if(!items.length){toast('‚úÖ ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏™‡∏±‡πà‡∏á','#059669');return;}

            const existing=document.getElementById('trcloudModal');if(existing)existing.remove();
            const now=new Date();
            const todayISO=now.toISOString().slice(0,10);
            const modal=document.createElement('div');modal.className='modal-overlay';modal.id='trcloudModal';
            modal.innerHTML=`<div class="modal-box" style="max-width:560px;">
                <h3 style="margin-top:0;">üîó ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ PR ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö TRCloud</h3>
                <p style="color:#64748b;font-size:13px;margin-bottom:16px;">‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏±‡∏ß‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ PR ‡∏Å‡πà‡∏≠‡∏ô Export ‚Äî ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á Excel ‡∏ï‡∏£‡∏á format TRCloud</p>

                <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:12px;">
                    <div><label style="font-size:11px;font-weight:bold;color:#475569;display:block;margin-bottom:4px;">‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</label>
                        <input id="tr_cat" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö" style="width:100%;padding:8px;border:1px solid #e2e8f0;border-radius:8px;box-sizing:border-box;font-size:13px;"></div>
                    <div><label style="font-size:11px;font-weight:bold;color:#475569;display:block;margin-bottom:4px;">‡πÅ‡∏ú‡∏ô‡∏Å</label>
                        <input id="tr_dept" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏Ñ‡∏£‡∏±‡∏ß‡∏Å‡∏•‡∏≤‡∏á" style="width:100%;padding:8px;border:1px solid #e2e8f0;border-radius:8px;box-sizing:border-box;font-size:13px;"></div>
                    <div><label style="font-size:11px;font-weight:bold;color:#475569;display:block;margin-bottom:4px;">‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£</label>
                        <input id="tr_proj" placeholder="‡πÄ‡∏ä‡πà‡∏ô TingTing 2026" style="width:100%;padding:8px;border:1px solid #e2e8f0;border-radius:8px;box-sizing:border-box;font-size:13px;"></div>
                    <div><label style="font-size:11px;font-weight:bold;color:#475569;display:block;margin-bottom:4px;">‡∏Ñ‡∏•‡∏±‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (TRCloud)</label>
                        <input id="tr_wh" placeholder="‡πÄ‡∏ä‡πà‡∏ô Main Warehouse" style="width:100%;padding:8px;border:1px solid #e2e8f0;border-radius:8px;box-sizing:border-box;font-size:13px;"></div>
                    <div><label style="font-size:11px;font-weight:bold;color:#475569;display:block;margin-bottom:4px;">‡∏£‡∏´‡∏±‡∏™‡∏Ñ‡∏π‡πà‡∏Ñ‡πâ‡∏≤ (Supplier)</label>
                        <input id="tr_sup_code" placeholder="‡∏£‡∏´‡∏±‡∏™‡πÉ‡∏ô TRCloud" style="width:100%;padding:8px;border:1px solid #e2e8f0;border-radius:8px;box-sizing:border-box;font-size:13px;"></div>
                    <div><label style="font-size:11px;font-weight:bold;color:#475569;display:block;margin-bottom:4px;">‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏π‡πà‡∏Ñ‡πâ‡∏≤ / ‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó</label>
                        <input id="tr_sup_name" placeholder="‡∏ä‡∏∑‡πà‡∏≠ Supplier" style="width:100%;padding:8px;border:1px solid #e2e8f0;border-radius:8px;box-sizing:border-box;font-size:13px;"></div>
                    <div><label style="font-size:11px;font-weight:bold;color:#475569;display:block;margin-bottom:4px;">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£</label>
                        <input id="tr_doc_date" type="date" value="${todayISO}" style="width:100%;padding:8px;border:1px solid #e2e8f0;border-radius:8px;box-sizing:border-box;font-size:13px;"></div>
                    <div><label style="font-size:11px;font-weight:bold;color:#475569;display:block;margin-bottom:4px;">‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏™‡πà‡∏á‡∏Ç‡∏≠‡∏á</label>
                        <input id="tr_due_date" type="date" value="${todayISO}" style="width:100%;padding:8px;border:1px solid #e2e8f0;border-radius:8px;box-sizing:border-box;font-size:13px;"></div>
                </div>
                <div style="margin-bottom:16px;"><label style="font-size:11px;font-weight:bold;color:#475569;display:block;margin-bottom:4px;">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</label>
                    <textarea id="tr_note" placeholder="‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)" rows="2" style="width:100%;padding:8px;border:1px solid #e2e8f0;border-radius:8px;box-sizing:border-box;font-size:13px;resize:none;"></textarea>
                </div>
                <div style="background:#f0f9ff;border:1px solid #bae6fd;border-radius:8px;padding:10px 14px;margin-bottom:16px;font-size:12px;color:#0369a1;">
                    üí° ‡∏à‡∏∞ Export ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà <b>‡∏ï‡πâ‡∏≠‡∏á‡∏™‡∏±‡πà‡∏á ${items.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</b> ‚Äî ‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ PR ‡∏à‡∏∞‡∏≠‡∏≠‡∏Å AUTO ‡πÉ‡∏ô TRCloud
                </div>
                <div style="display:flex;gap:10px;">
                    <button onclick="doExportTRCloud()" style="flex:1;background:#7c3aed;color:white;border:none;padding:12px;border-radius:10px;cursor:pointer;font-weight:bold;">üì• Export TRCloud PR.xlsx</button>
                    <button onclick="document.getElementById('trcloudModal').remove()" style="flex:1;background:#f1f5f9;color:#475569;border:none;padding:12px;border-radius:10px;cursor:pointer;">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                </div>
            </div>`;
            document.body.appendChild(modal);
        };

        window.doExportTRCloud=function(){
            const items=window._orderItems.filter(it=>it.needOrder||it.status.includes('üü°'));
            const g=id=>document.getElementById(id)?.value||'';
            const docDateRaw=g('tr_doc_date');
            const dueDateRaw=g('tr_due_date');
            const fmtDate=s=>{if(!s)return '';const[y,m,d]=s.split('-');return `${d}/${m}/${parseInt(y)+543}`;};

            // Sheet 1: Header (‡∏´‡∏±‡∏ß‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ PR)
            const headerSheet=[
                ['=== TRCloud PR Import ‚Äî Header ==='],
                ['Field','Value','','Field','Value'],
                ['‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà',g('tr_cat'),'','‡∏Ñ‡∏π‡πà‡∏Ñ‡πâ‡∏≤ (‡∏£‡∏´‡∏±‡∏™)',g('tr_sup_code')],
                ['‡πÅ‡∏ú‡∏ô‡∏Å',g('tr_dept'),'','‡∏Ñ‡∏π‡πà‡∏Ñ‡πâ‡∏≤ (‡∏ä‡∏∑‡πà‡∏≠)',g('tr_sup_name')],
                ['‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£',g('tr_proj'),'','‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£',fmtDate(docDateRaw)],
                ['‡∏Ñ‡∏•‡∏±‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤',g('tr_wh'),'','‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏™‡πà‡∏á‡∏Ç‡∏≠‡∏á',fmtDate(dueDateRaw)],
                ['‡∏à‡∏±‡∏î‡∏ó‡∏≥‡πÇ‡∏î‡∏¢',window.currentUser?.name||'','','‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£','AUTO'],
                ['‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏',g('tr_note')],
            ];

            // Sheet 2: ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ PR format
            const itemHeader=[['#','‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤','‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤','‡∏à‡∏≥‡∏ô‡∏ß‡∏ô','‡∏´‡∏ô‡πà‡∏ß‡∏¢','‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡πà‡∏≠‡∏´‡∏ô‡πà‡∏ß‡∏¢','‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î(%)','VAT/GST','‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏Å‡πà‡∏≠‡∏ô‡∏†‡∏≤‡∏©‡∏µ','‡∏Ñ‡∏•‡∏±‡∏á/‡πÇ‡∏ã‡∏ô','‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏']];
            const itemRows=items.map((it,i)=>{
                const actual=parseFloat(document.getElementById(`order_${it.zone}_${it.id}`)?.value)||it.suggestQty||0;
                return [i+1, it.id, it.name, actual, it.unit, '', '0', '7%', '', it.zone, `‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠:${it.balance} Min:${it.min}`];
            });

            const wb=XLSX.utils.book_new();
            const ws1=XLSX.utils.aoa_to_sheet(headerSheet);
            const ws2=XLSX.utils.aoa_to_sheet([...itemHeader,...itemRows]);
            ws1['!cols']=[{wch:18},{wch:30},{wch:4},{wch:18},{wch:30}];
            ws2['!cols']=[{wch:4},{wch:15},{wch:35},{wch:10},{wch:10},{wch:15},{wch:12},{wch:8},{wch:18},{wch:20},{wch:30}];
            XLSX.utils.book_append_sheet(wb,ws1,'PR_Header');
            XLSX.utils.book_append_sheet(wb,ws2,'PR_Items');
            XLSX.writeFile(wb,`TRCloud_PR_${fmtDate(docDateRaw).replace(/\//g,'-')}.xlsx`);
            document.getElementById('trcloudModal').remove();
            toast('‚úÖ Export TRCloud PR ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à','#059669');
        };

        // ======== IMPORT PRODUCTS FROM EXCEL ========
        window.openImportProducts=function(){
            document.getElementById('dashboardView').classList.add('hidden');
            const c=document.getElementById('toolAppContainer');c.classList.remove('hidden');
            c.innerHTML=`
            <div class="tool-header no-print">
                <h2>üì• Import ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏à‡∏≤‡∏Å Excel</h2>
                <button onclick="closeTool()" style="background:#f1f5f9;color:#475569;border:none;padding:8px 16px;border-radius:8px;cursor:pointer;">‚úï ‡∏õ‡∏¥‡∏î</button>
            </div>

            <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:24px;">
                <!-- Step 1: Download Template -->
                <div style="background:white;border-radius:14px;padding:24px;border:2px solid #e2e8f0;">
                    <div style="font-size:18px;font-weight:bold;color:var(--primary-dark);margin-bottom:8px;">‚ë† ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î Template</div>
                    <p style="color:#64748b;font-size:13px;margin:0 0 16px;">‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î Excel template ‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ï‡∏≤‡∏°‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î</p>
                    <div style="background:#f8fafc;border-radius:8px;padding:12px;margin-bottom:16px;font-size:12px;color:#475569;">
                        <b>‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏£‡∏≠‡∏Å:</b><br>
                        <span style="color:#ef4444;">*</span> ProductCode ‚Äî ‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (‡πÄ‡∏ä‡πà‡∏ô SM000138)<br>
                        <span style="color:#ef4444;">*</span> ProductName ‚Äî ‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤<br>
                        Unit1 ‚Äî ‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏ó‡∏µ‡πà 1 (‡πÄ‡∏ä‡πà‡∏ô ‡∏•‡∏±‡∏á)<br>
                        Rate1 ‚Äî 1 ‡∏•‡∏±‡∏á = ‡∏Å‡∏µ‡πà ‡∏´‡∏ô‡πà‡∏ß‡∏¢2<br>
                        Unit2 ‚Äî ‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏ó‡∏µ‡πà 2 (‡πÄ‡∏ä‡πà‡∏ô ‡∏ñ‡∏∏‡∏á)<br>
                        Rate2 ‚Äî 1 ‡∏ñ‡∏∏‡∏á = ‡∏Å‡∏µ‡πà ‡∏´‡∏ô‡πà‡∏ß‡∏¢3<br>
                        Unit3 ‚Äî ‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏ó‡∏µ‡πà 3 (‡πÄ‡∏ä‡πà‡∏ô ‡∏Å‡∏£‡∏±‡∏°)
                    </div>
                    <button onclick="downloadImportTemplate()" style="width:100%;background:var(--primary-dark);color:white;border:none;padding:12px;border-radius:10px;cursor:pointer;font-weight:bold;">‚¨áÔ∏è ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î Template.xlsx</button>
                </div>

                <!-- Step 2: Upload -->
                <div style="background:white;border-radius:14px;padding:24px;border:2px solid #e2e8f0;">
                    <div style="font-size:18px;font-weight:bold;color:var(--primary-dark);margin-bottom:8px;">‚ë° ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î Excel</div>
                    <p style="color:#64748b;font-size:13px;margin:0 0 16px;">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå Excel ‡∏ó‡∏µ‡πà‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡πâ‡∏ß ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á Preview ‡∏Å‡πà‡∏≠‡∏ô import ‡∏à‡∏£‡∏¥‡∏á</p>
                    <div style="border:2px dashed #e2e8f0;border-radius:10px;padding:30px;text-align:center;margin-bottom:16px;cursor:pointer;transition:border 0.2s;"
                        onclick="document.getElementById('importFile').click()"
                        ondragover="event.preventDefault();this.style.borderColor='var(--info)'"
                        ondragleave="this.style.borderColor='#e2e8f0'"
                        ondrop="event.preventDefault();handleImportDrop(event)">
                        <div style="font-size:32px;margin-bottom:8px;">üìÇ</div>
                        <div style="color:#64748b;font-size:13px;">‡∏Ñ‡∏•‡∏¥‡∏Å‡∏´‡∏£‡∏∑‡∏≠‡∏•‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏°‡∏≤‡∏ß‡∏≤‡∏á‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà</div>
                        <input type="file" id="importFile" accept=".xlsx,.xls,.csv" style="display:none" onchange="handleImportFile(this)">
                    </div>
                    <div id="importFileLabel" style="font-size:12px;color:#94a3b8;text-align:center;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå</div>
                </div>
            </div>

            <!-- Preview table -->
            <div id="importPreview" style="display:none;background:white;border-radius:14px;padding:24px;border:1px solid #e2e8f0;">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
                    <h4 style="margin:0;">üîç Preview ‡∏Å‡πà‡∏≠‡∏ô Import</h4>
                    <div style="display:flex;gap:8px;">
                        <button onclick="confirmImportProducts()" id="confirmImportBtn" style="background:var(--success);color:white;border:none;padding:10px 24px;border-radius:10px;cursor:pointer;font-weight:bold;">‚úÖ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô Import</button>
                        <button onclick="document.getElementById('importPreview').style.display='none'" style="background:#f1f5f9;color:#475569;border:none;padding:10px 16px;border-radius:10px;cursor:pointer;">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                    </div>
                </div>
                <div id="importPreviewTable"></div>
            </div>`;
        };

        window.downloadImportTemplate=function(){
            const rows=[
                ['ProductCode','ProductName','Unit1','Rate1','Unit2','Rate2','Unit3'],
                ['SM000001','‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ A','‡∏•‡∏±‡∏á',12,'‡∏ñ‡∏∏‡∏á',500,'‡∏Å‡∏£‡∏±‡∏°'],
                ['SM000002','‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ B','‡∏Å‡∏•‡πà‡∏≠‡∏á',24,'‡∏ä‡∏¥‡πâ‡∏ô','',''],
                ['SM000003','‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ C (‡∏´‡∏ô‡πà‡∏ß‡∏¢‡πÄ‡∏î‡∏µ‡∏¢‡∏ß)','‡∏Å‡∏£‡∏∞‡∏õ‡πã‡∏≠‡∏á','','','',''],
            ];
            const ws=XLSX.utils.aoa_to_sheet(rows);
            ws['!cols']=[{wch:15},{wch:35},{wch:10},{wch:8},{wch:10},{wch:8},{wch:10}];
            const wb=XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb,ws,'Products');
            XLSX.writeFile(wb,'TingTing_Import_Template.xlsx');
        };

        window.handleImportDrop=function(e){
            const file=e.dataTransfer.files[0];
            if(file) processImportFile(file);
        };
        window.handleImportFile=function(input){
            if(input.files[0]) processImportFile(input.files[0]);
        };

        window._importData=[];
        window.processImportFile=function(file){
            document.getElementById('importFileLabel').innerText=`üìÑ ${file.name}`;
            const reader=new FileReader();
            reader.onload=function(e){
                const wb=XLSX.read(e.target.result,{type:'array'});
                const ws=wb.Sheets[wb.SheetNames[0]];
                const data=XLSX.utils.sheet_to_json(ws,{defval:''});
                if(!data.length){toast('‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•','#c2410c');return;}

                window._importData=data.map(row=>({
                    id:String(row.ProductCode||'').trim(),
                    name:String(row.ProductName||'').trim(),
                    units:[
                        row.Unit1?{name:String(row.Unit1).trim(),rate:parseFloat(row.Rate1)||0}:null,
                        row.Unit2?{name:String(row.Unit2).trim(),rate:parseFloat(row.Rate2)||0}:null,
                        row.Unit3?{name:String(row.Unit3).trim(),rate:0}:null,
                    ].filter(u=>u&&u.name)
                })).filter(p=>p.id&&p.name);

                renderImportPreview();
            };
            reader.readAsArrayBuffer(file);
        };

        window.renderImportPreview=function(){
            const data=window._importData;
            const existing=new Set(allProducts.map(p=>p.id));
            const preview=document.getElementById('importPreview');
            const table=document.getElementById('importPreviewTable');
            if(!preview||!table)return;

            preview.style.display='block';
            const newCount=data.filter(p=>!existing.has(p.id)).length;
            const dupCount=data.filter(p=>existing.has(p.id)).length;

            table.innerHTML=`
            <div style="display:flex;gap:12px;margin-bottom:16px;">
                <div style="background:#f0fdf4;border:1px solid #6ee7b7;border-radius:8px;padding:10px 16px;font-size:13px;color:#059669;font-weight:bold;">‚úÖ ‡πÉ‡∏´‡∏°‡πà ${newCount} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div>
                ${dupCount?`<div style="background:#fff7ed;border:1px solid #fdba74;border-radius:8px;padding:10px 16px;font-size:13px;color:#c2410c;font-weight:bold;">‚ö†Ô∏è ‡∏ã‡πâ‡∏≥ ${dupCount} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ (‡∏à‡∏∞‡∏Ç‡πâ‡∏≤‡∏°‡πÑ‡∏õ)</div>`:''}
            </div>
            <div style="max-height:300px;overflow-y:auto;">
            <table style="width:100%;border-collapse:collapse;">
                <thead><tr style="background:#f8fafc;">
                    <th style="padding:8px;font-size:11px;color:#64748b;text-align:left;">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                    <th style="padding:8px;font-size:11px;color:#64748b;text-align:left;">‡∏£‡∏´‡∏±‡∏™</th>
                    <th style="padding:8px;font-size:11px;color:#64748b;text-align:left;">‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th>
                    <th style="padding:8px;font-size:11px;color:#64748b;text-align:left;">‡∏´‡∏ô‡πà‡∏ß‡∏¢</th>
                </tr></thead>
                <tbody>${data.map(p=>{
                    const isDup=existing.has(p.id);
                    const unitStr=p.units.map(u=>u.name+(u.rate?`(√ó${u.rate})`:'') ).join(' ‚Üí ');
                    return `<tr style="border-top:1px solid #f1f5f9;${isDup?'opacity:0.5':''}">
                        <td style="padding:8px;">${isDup?'‚ö†Ô∏è ‡∏ã‡πâ‡∏≥':'üÜï ‡πÉ‡∏´‡∏°‡πà'}</td>
                        <td style="padding:8px;font-weight:bold;font-size:12px;">${p.id}</td>
                        <td style="padding:8px;font-size:12px;">${p.name}</td>
                        <td style="padding:8px;font-size:11px;color:#64748b;">${unitStr||'-'}</td>
                    </tr>`;
                }).join('')}</tbody>
            </table></div>`;
        };

        window.confirmImportProducts=async function(){
            const data=window._importData;
            if(!data?.length){toast('‚ùå ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•','#c2410c');return;}
            const existing=new Set(allProducts.map(p=>p.id));
            const toAdd=data.filter(p=>!existing.has(p.id));
            if(!toAdd.length){toast('‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏µ‡πà‡∏à‡∏∞ import','#c2410c');return;}
            if(!confirm(`‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô Import ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà ${toAdd.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£?`))return;

            allProducts.push(...toAdd);
            await saveConfig();
            toast(`‚úÖ Import ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ${toAdd.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`,'#059669');
            document.getElementById('importPreview').style.display='none';
            document.getElementById('importFileLabel').innerText='‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå';
            window._importData=[];
        };

        // ======== REQUISITION SYSTEM ========
        // Firestore: requisitions/{id} = {
        //   mrNumber, date, requestedBy, department, zone, purpose,
        //   items:[{id,name,unit,qtyRequested,qtyIssued}],
        //   status: 'pending'|'approved'|'issued'|'rejected',
        //   approvedBy, approvedAt, issuedBy, issuedAt, note,
        //   timestamp
        // }

        const MR_STATUS = {
            pending:  { label:'‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥',  color:'#f59e0b', bg:'#fffbeb' },
            approved: { label:'‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß', color:'#3b82f6', bg:'#eff6ff' },
            issued:   { label:'‡∏à‡πà‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß',   color:'#10b981', bg:'#f0fdf4' },
            rejected: { label:'‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥', color:'#ef4444', bg:'#fef2f2' },
        };

        async function genMRNumber() {
            const now = new Date();
            const prefix = `MR-${now.getFullYear()}${String(now.getMonth()+1).padStart(2,'0')}${String(now.getDate()).padStart(2,'0')}`;
            const snap = await getDocs(collection(db,'requisitions'));
            const todayDocs = [];
            snap.forEach(d=>{ if(d.id.startsWith(prefix)) todayDocs.push(d.id); });
            const seq = String(todayDocs.length+1).padStart(3,'0');
            return `${prefix}-${seq}`;
        }

        // ---- ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡πÄ‡∏ö‡∏¥‡∏Å‡πÉ‡∏´‡∏°‡πà ----
        window.openCreateRequisition = async function() {
            document.getElementById('dashboardView').classList.add('hidden');
            const c = document.getElementById('toolAppContainer'); c.classList.remove('hidden');
            const visibleZones = getVisibleWarehouses();
            const usSnap = await getDocs(collection(db,'users'));
            let staffOpts = '';
            usSnap.forEach(d=>{ const u=d.data(); if(u.status!=='suspended') staffOpts+=`<option value="${u.name}">${u.name}</option>`; });
            const today = new Date().toISOString().slice(0,10);

            c.innerHTML = `
            <div class="tool-header no-print">
                <h2>‚úèÔ∏è ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡πÄ‡∏ö‡∏¥‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (MR)</h2>
                <button onclick="closeTool()" style="background:#f1f5f9;color:#475569;border:none;padding:8px 16px;border-radius:8px;cursor:pointer;">‚úï ‡∏õ‡∏¥‡∏î</button>
            </div>

            <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:15px;margin-bottom:20px;">
                <div class="input-group" style="border:2px solid var(--danger);"><label>üìÖ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡∏≠‡πÄ‡∏ö‡∏¥‡∏Å (‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö)</label>
                    <input type="date" id="mr_date" value="${today}" style="width:100%;border:none;font-weight:bold;outline:none;font-size:14px;">
                </div>
                <div class="input-group" style="border:2px solid var(--info);"><label>üë§ ‡∏ú‡∏π‡πâ‡∏Ç‡∏≠‡πÄ‡∏ö‡∏¥‡∏Å</label>
                    <select id="mr_requester" style="width:100%;border:none;font-weight:bold;outline:none;">
                        <option value="${currentUser.name}">${currentUser.name} (‡∏Ñ‡∏∏‡∏ì)</option>${staffOpts}
                    </select>
                </div>
                <div class="input-group"><label>üè≠ ‡πÅ‡∏ú‡∏ô‡∏Å / ‡∏ù‡πà‡∏≤‡∏¢</label>
                    <input type="text" id="mr_dept" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏ù‡πà‡∏≤‡∏¢‡∏ú‡∏•‡∏¥‡∏ï" style="width:100%;border:none;font-weight:bold;outline:none;font-size:14px;">
                </div>
                <div class="input-group"><label>üì¶ ‡πÄ‡∏ö‡∏¥‡∏Å‡∏à‡∏≤‡∏Å‡∏Ñ‡∏•‡∏±‡∏á</label>
                    <select id="mr_zone" onchange="renderMRItems()" style="width:100%;border:none;font-weight:bold;outline:none;">
                        ${visibleZones.map(z=>`<option value="${z}">${z}</option>`).join('')}
                    </select>
                </div>
                <div class="input-group" style="grid-column:span 2;"><label>üìù ‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏õ‡∏£‡∏∞‡∏™‡∏á‡∏Ñ‡πå‡∏Å‡∏≤‡∏£‡πÄ‡∏ö‡∏¥‡∏Å</label>
                    <input type="text" id="mr_purpose" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏ú‡∏•‡∏¥‡∏ï‡πÄ‡∏°‡∏ô‡∏π Mochi ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà 21/02/2569" style="width:100%;border:none;font-weight:bold;outline:none;font-size:14px;">
                </div>
            </div>

            <div style="margin-bottom:12px;">
                <input type="text" id="mr_search" placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤..." oninput="filterMRRows(this.value)"
                    style="width:100%;padding:10px 16px;border:1px solid #e2e8f0;border-radius:10px;font-size:14px;box-sizing:border-box;outline:none;">
            </div>

            <div id="mrItemsContainer"></div>

            <div style="margin-top:24px;display:flex;gap:12px;justify-content:center;" class="no-print">
                <button onclick="submitRequisition()" style="background:var(--success);color:white;padding:16px 48px;border:none;border-radius:12px;font-size:17px;font-weight:bold;cursor:pointer;box-shadow:0 4px 15px rgba(16,185,129,0.3);">
                    üì§ ‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÄ‡∏ö‡∏¥‡∏Å
                </button>
            </div>`;

            renderMRItems();
        };

        window.renderMRItems = function() {
            const zone = document.getElementById('mr_zone')?.value || '';
            const zoneProds = allProducts.filter(p=>(zoneProductMap[zone]||[]).includes(p.id));
            const c = document.getElementById('mrItemsContainer'); if(!c) return;
            c.innerHTML = `
            <table class="stock-table" id="mrTable">
                <thead><tr style="background:#f8fafc;">
                    <th style="padding:12px;text-align:left;font-size:12px;color:#64748b;">‡∏£‡∏´‡∏±‡∏™ / ‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th>
                    <th style="padding:12px;text-align:center;font-size:12px;color:#64748b;">‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠ (‡∏£‡∏∞‡∏ö‡∏ö)</th>
                    <th style="padding:12px;text-align:center;font-size:12px;color:#64748b;">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡∏≠‡πÄ‡∏ö‡∏¥‡∏Å</th>
                    <th style="padding:12px;text-align:center;font-size:12px;color:#64748b;">‡∏´‡∏ô‡πà‡∏ß‡∏¢</th>
                    <th style="padding:12px;text-align:left;font-size:12px;color:#64748b;">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</th>
                </tr></thead>
                <tbody>${zoneProds.map(p=>{
                    const u = (p.units||[{name:p.unit||''}])[0]?.name||'';
                    const bal = countData[p.id]?.total??'-';
                    const balColor = typeof bal==='number'&&bal<=0?'#ef4444':typeof bal==='number'&&bal<10?'#f59e0b':'var(--success)';
                    return `<tr class="stock-row mr-row" data-id="${p.id}" data-name="${p.name.toLowerCase()} ${p.id.toLowerCase()}">
                        <td style="padding:12px;">
                            <b style="font-size:14px;">${p.id}</b><br>
                            <span style="color:#475569;font-size:13px;">${p.name}</span>
                        </td>
                        <td style="padding:12px;text-align:center;font-weight:bold;font-size:16px;color:${balColor};">${bal}</td>
                        <td style="padding:12px;text-align:center;">
                            <input type="number" id="mr_qty_${p.id}" min="0" placeholder="0"
                                style="width:80px;padding:8px;border:2px solid #e2e8f0;border-radius:8px;text-align:center;font-weight:bold;font-size:15px;outline:none;"
                                onfocus="this.style.borderColor='var(--info)'" onblur="this.style.borderColor='#e2e8f0'">
                        </td>
                        <td style="padding:12px;text-align:center;color:#64748b;">${u}</td>
                        <td style="padding:12px;">
                            <input type="text" id="mr_note_${p.id}" placeholder="‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏"
                                style="width:100%;padding:6px 10px;border:1px solid #e2e8f0;border-radius:6px;font-size:12px;box-sizing:border-box;">
                        </td>
                    </tr>`;
                }).join('')}</tbody>
            </table>`;
        };

        window.filterMRRows = function(q) {
            q = q.toLowerCase().trim();
            document.querySelectorAll('.mr-row').forEach(row=>{
                row.style.display = (!q||row.dataset.name.includes(q)) ? '' : 'none';
            });
        };

        window.submitRequisition = async function() {
            const date  = document.getElementById('mr_date')?.value;
            const by    = document.getElementById('mr_requester')?.value;
            const dept  = document.getElementById('mr_dept')?.value||'';
            const zone  = document.getElementById('mr_zone')?.value;
            const purp  = document.getElementById('mr_purpose')?.value||'';
            if(!date||!zone){toast('‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö','#c2410c');return;}

            const zoneProds = allProducts.filter(p=>(zoneProductMap[zone]||[]).includes(p.id));
            const items = zoneProds.map(p=>{
                const qty = parseFloat(document.getElementById(`mr_qty_${p.id}`)?.value)||0;
                const note = document.getElementById(`mr_note_${p.id}`)?.value||'';
                const u = (p.units||[{name:p.unit||''}])[0]?.name||'';
                return qty>0 ? {id:p.id,name:p.name,unit:u,qtyRequested:qty,qtyIssued:0,note} : null;
            }).filter(Boolean);

            if(!items.length){toast('‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£','#c2410c');return;}
            if(!confirm(`‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏™‡πà‡∏á‡πÉ‡∏ö‡πÄ‡∏ö‡∏¥‡∏Å ${items.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ‡∏à‡∏≤‡∏Å‡∏Ñ‡∏•‡∏±‡∏á ${zone}?`))return;

            const [y,m,d] = date.split('-');
            const dateStr = `${d}/${m}/${parseInt(y)+543}`;
            const mrNumber = await genMRNumber();

            await addDoc(collection(db,'requisitions'),{
                mrNumber, date:dateStr, timestamp:Date.now(),
                requestedBy:by, department:dept, zone, purpose:purp,
                items, status:'pending',
                approvedBy:'', approvedAt:'', issuedBy:'', issuedAt:'', rejectReason:''
            });

            toast(`‚úÖ ‡∏™‡πà‡∏á‡πÉ‡∏ö‡πÄ‡∏ö‡∏¥‡∏Å ${mrNumber} ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß`,'#059669');
            loadReqBadge();
            openMyRequisitions();
        };

        // ---- ‡πÉ‡∏ö‡πÄ‡∏ö‡∏¥‡∏Å‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô ----
        window.openMyRequisitions = async function() {
            document.getElementById('dashboardView').classList.add('hidden');
            const c = document.getElementById('toolAppContainer'); c.classList.remove('hidden');
            c.innerHTML = `<div class="tool-header"><h2>üìÑ ‡πÉ‡∏ö‡πÄ‡∏ö‡∏¥‡∏Å‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</h2><div style="display:flex;gap:8px;">
                <button onclick="openCreateRequisition()" style="background:#f59e0b;color:white;border:none;padding:8px 16px;border-radius:8px;cursor:pointer;font-weight:bold;">‚úèÔ∏è ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡πÄ‡∏ö‡∏¥‡∏Å‡πÉ‡∏´‡∏°‡πà</button>
                <button onclick="closeTool()" style="background:#f1f5f9;color:#475569;border:none;padding:8px 16px;border-radius:8px;cursor:pointer;">‚úï ‡∏õ‡∏¥‡∏î</button>
            </div></div>
            <div id="myReqList"><p style="text-align:center;color:#94a3b8;padding:40px;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</p></div>`;

            const snap = await getDocs(collection(db,'requisitions'));
            let docs = [];
            snap.forEach(d=>docs.push({id:d.id,...d.data()}));
            docs = docs.filter(d=>d.requestedBy===currentUser.name || currentUser.role==='admin');
            docs.sort((a,b)=>b.timestamp-a.timestamp);
            renderReqList('myReqList', docs, false);
        };

        // ---- ‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ (warehouse/admin) ----
        window.openPendingRequisitions = async function() {
            document.getElementById('dashboardView').classList.add('hidden');
            const c = document.getElementById('toolAppContainer'); c.classList.remove('hidden');
            c.innerHTML = `<div class="tool-header"><h2>üîî ‡πÉ‡∏ö‡πÄ‡∏ö‡∏¥‡∏Å‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ / ‡∏à‡πà‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á</h2>
                <button onclick="closeTool()" style="background:#f1f5f9;color:#475569;border:none;padding:8px 16px;border-radius:8px;cursor:pointer;">‚úï ‡∏õ‡∏¥‡∏î</button>
            </div>
            <div style="display:flex;gap:8px;margin-bottom:16px;">
                <button onclick="filterReqStatus('pending')" id="rsbtn_pending" style="padding:7px 16px;border-radius:8px;border:2px solid #f59e0b;background:#f59e0b;color:white;cursor:pointer;font-size:12px;font-weight:bold;">‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</button>
                <button onclick="filterReqStatus('approved')" id="rsbtn_approved" style="padding:7px 16px;border-radius:8px;border:2px solid #3b82f6;background:white;color:#3b82f6;cursor:pointer;font-size:12px;font-weight:bold;">‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß ‡∏£‡∏≠‡∏à‡πà‡∏≤‡∏¢</button>
                <button onclick="filterReqStatus('all')" id="rsbtn_all" style="padding:7px 16px;border-radius:8px;border:2px solid #64748b;background:white;color:#64748b;cursor:pointer;font-size:12px;font-weight:bold;">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
            </div>
            <div id="pendingReqList"><p style="text-align:center;color:#94a3b8;padding:40px;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</p></div>`;

            const snap = await getDocs(collection(db,'requisitions'));
            let docs = [];
            snap.forEach(d=>docs.push({id:d.id,...d.data()}));
            docs.sort((a,b)=>b.timestamp-a.timestamp);
            window._allReqDocs = docs;
            filterReqStatus('pending');
        };

        window.filterReqStatus = function(status) {
            const docs = window._allReqDocs||[];
            const filtered = status==='all' ? docs : docs.filter(d=>d.status===status);
            renderReqList('pendingReqList', filtered, true);
            ['pending','approved','all'].forEach(s=>{
                const btn = document.getElementById(`rsbtn_${s}`);
                if(!btn) return;
                const colors = {pending:'#f59e0b',approved:'#3b82f6',all:'#64748b'};
                btn.style.background = s===status ? colors[s] : 'white';
                btn.style.color = s===status ? 'white' : colors[s];
            });
        };

        window.openAllRequisitions = async function() {
            document.getElementById('dashboardView').classList.add('hidden');
            const c = document.getElementById('toolAppContainer'); c.classList.remove('hidden');
            c.innerHTML = `<div class="tool-header"><h2>üìä ‡πÉ‡∏ö‡πÄ‡∏ö‡∏¥‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h2><div style="display:flex;gap:8px;">
                <button onclick="exportReqExcel()" style="background:var(--success);color:white;border:none;padding:8px 16px;border-radius:8px;cursor:pointer;font-weight:bold;">üì• Export Excel</button>
                <button onclick="closeTool()" style="background:#f1f5f9;color:#475569;border:none;padding:8px 16px;border-radius:8px;cursor:pointer;">‚úï ‡∏õ‡∏¥‡∏î</button>
            </div></div>
            <div id="allReqList"><p style="text-align:center;color:#94a3b8;padding:40px;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</p></div>`;

            const snap = await getDocs(collection(db,'requisitions'));
            let docs = [];
            snap.forEach(d=>docs.push({id:d.id,...d.data()}));
            docs.sort((a,b)=>b.timestamp-a.timestamp);
            window._allReqDocs = docs;
            renderReqList('allReqList', docs, true);
        };

        // ---- Render ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏ö‡πÄ‡∏ö‡∏¥‡∏Å ----
        function renderReqList(containerId, docs, showActions) {
            const c = document.getElementById(containerId); if(!c) return;
            if(!docs.length){c.innerHTML='<p style="text-align:center;color:#94a3b8;padding:40px;">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</p>';return;}
            c.innerHTML = docs.map(d=>{
                const st = MR_STATUS[d.status]||MR_STATUS.pending;
                const canApprove = showActions && d.status==='pending' && ['admin','warehouse'].includes(currentUser.role);
                const canIssue   = showActions && d.status==='approved' && ['admin','warehouse'].includes(currentUser.role);
                const canReject  = showActions && d.status==='pending' && ['admin','warehouse'].includes(currentUser.role);
                return `<div class="history-card" style="margin-bottom:16px;border-left:4px solid ${st.color};background:${st.bg};">
                    <div class="history-card-header">
                        <div style="display:flex;align-items:center;gap:12px;">
                            <span style="font-weight:bold;font-size:15px;color:var(--primary-dark);">${d.mrNumber}</span>
                            <span style="background:${st.color};color:white;padding:3px 10px;border-radius:20px;font-size:11px;font-weight:bold;">${st.label}</span>
                        </div>
                        <div style="display:flex;align-items:center;gap:8px;">
                            <span style="font-size:12px;color:#64748b;">üìÖ ${d.date} ‚Ä¢ üë§ ${d.requestedBy} ‚Ä¢ üì¶ ${d.zone}</span>
                            ${canApprove?`<button onclick="approveReq('${d.id}')" style="background:#3b82f6;color:white;border:none;padding:6px 14px;border-radius:6px;cursor:pointer;font-size:12px;font-weight:bold;">‚úÖ ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</button>`:''}
                            ${canReject?`<button onclick="rejectReq('${d.id}')" style="background:#ef4444;color:white;border:none;padding:6px 14px;border-radius:6px;cursor:pointer;font-size:12px;font-weight:bold;">‚ùå ‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</button>`:''}
                            ${canIssue?`<button onclick="issueReq('${d.id}')" style="background:#10b981;color:white;border:none;padding:6px 14px;border-radius:6px;cursor:pointer;font-size:12px;font-weight:bold;">üì¶ ‡∏à‡πà‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß</button>`:''}
                            <button onclick="printReq('${d.id}')" style="background:#f1f5f9;color:#475569;border:1px solid #e2e8f0;padding:6px 12px;border-radius:6px;cursor:pointer;font-size:12px;">üñ®Ô∏è ‡∏û‡∏¥‡∏°‡∏û‡πå</button>
                        </div>
                    </div>
                    ${d.purpose?`<div style="padding:8px 0;font-size:13px;color:#475569;">üìù ${d.purpose}</div>`:''}
                    <table style="width:100%;border-collapse:collapse;margin-top:8px;">
                        <thead><tr style="background:rgba(0,0,0,0.04);">
                            <th style="padding:8px;text-align:left;font-size:11px;color:#64748b;">‡∏£‡∏´‡∏±‡∏™</th>
                            <th style="padding:8px;text-align:left;font-size:11px;color:#64748b;">‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th>
                            <th style="padding:8px;text-align:center;font-size:11px;color:#64748b;">‡∏Ç‡∏≠‡πÄ‡∏ö‡∏¥‡∏Å</th>
                            <th style="padding:8px;text-align:center;font-size:11px;color:#64748b;">‡∏à‡πà‡∏≤‡∏¢‡∏à‡∏£‡∏¥‡∏á</th>
                            <th style="padding:8px;text-align:center;font-size:11px;color:#64748b;">‡∏´‡∏ô‡πà‡∏ß‡∏¢</th>
                            <th style="padding:8px;text-align:left;font-size:11px;color:#64748b;">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</th>
                        </tr></thead>
                        <tbody>${(d.items||[]).map(it=>`
                        <tr style="border-top:1px solid rgba(0,0,0,0.06);">
                            <td style="padding:8px;font-weight:bold;font-size:12px;">${it.id}</td>
                            <td style="padding:8px;font-size:12px;">${it.name}</td>
                            <td style="padding:8px;text-align:center;font-weight:bold;color:var(--info);">${it.qtyRequested}</td>
                            <td style="padding:8px;text-align:center;font-weight:bold;color:${it.qtyIssued>0?'var(--success)':'#94a3b8'};">${it.qtyIssued||'-'}</td>
                            <td style="padding:8px;text-align:center;color:#64748b;font-size:12px;">${it.unit}</td>
                            <td style="padding:8px;color:#64748b;font-size:11px;">${it.note||'-'}</td>
                        </tr>`).join('')}</tbody>
                    </table>
                    ${d.approvedBy?`<div style="margin-top:8px;font-size:11px;color:#64748b;">‚úÖ ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÇ‡∏î‡∏¢: ${d.approvedBy} ‡πÄ‡∏°‡∏∑‡πà‡∏≠ ${d.approvedAt}</div>`:''}
                    ${d.issuedBy?`<div style="font-size:11px;color:#64748b;">üì¶ ‡∏à‡πà‡∏≤‡∏¢‡πÇ‡∏î‡∏¢: ${d.issuedBy} ‡πÄ‡∏°‡∏∑‡πà‡∏≠ ${d.issuedAt}</div>`:''}
                    ${d.rejectReason?`<div style="font-size:11px;color:#ef4444;">‚ùå ‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•: ${d.rejectReason}</div>`:''}
                </div>`;
            }).join('');
        }

        // ---- Actions ----
        window.approveReq = async function(docId) {
            if(!confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÉ‡∏ö‡πÄ‡∏ö‡∏¥‡∏Å‡∏ô‡∏µ‡πâ?'))return;
            const {updateDoc} = await import("https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js");
            const now = new Date();
            await updateDoc(doc(db,'requisitions',docId),{
                status:'approved', approvedBy:currentUser.name,
                approvedAt:`${now.toLocaleDateString('th-TH')} ${now.toLocaleTimeString('th-TH',{hour:'2-digit',minute:'2-digit'})}`
            });
            toast('‚úÖ ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß','#059669');
            loadReqBadge();
            openPendingRequisitions();
        };

        window.rejectReq = async function(docId) {
            const reason = prompt('‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥:');
            if(reason===null)return;
            const {updateDoc} = await import("https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js");
            await updateDoc(doc(db,'requisitions',docId),{
                status:'rejected', approvedBy:currentUser.name, rejectReason:reason||'‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'
            });
            toast('‚ùå ‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß','#c2410c');
            loadReqBadge();
            openPendingRequisitions();
        };

        window.issueReq = async function(docId) {
            if(!confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏à‡πà‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏£‡∏ö‡πÅ‡∏•‡πâ‡∏ß?'))return;
            const {updateDoc} = await import("https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js");
            const snap = await getDoc(doc(db,'requisitions',docId));
            const data = snap.data();
            const now = new Date();
            // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
            await updateDoc(doc(db,'requisitions',docId),{
                status:'issued', issuedBy:currentUser.name,
                issuedAt:`${now.toLocaleDateString('th-TH')} ${now.toLocaleTimeString('th-TH',{hour:'2-digit',minute:'2-digit'})}`,
                'items': data.items.map(it=>({...it, qtyIssued:it.qtyRequested}))
            });
            toast('üì¶ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏à‡πà‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß','#059669');
            loadReqBadge();
            openPendingRequisitions();
        };

        // ---- Print PDF ----
        window.printReq = async function(docId) {
            const snap = await getDoc(doc(db,'requisitions',docId));
            if(!snap.exists())return;
            const d = snap.data();
            const st = MR_STATUS[d.status]||MR_STATUS.pending;
            const rows = (d.items||[]).map((it,i)=>`<tr style="${i%2===0?'background:#f8fafc':''}">
                <td style="padding:9px;text-align:center;color:#64748b;">${i+1}</td>
                <td style="padding:9px;font-weight:bold;">${it.id}</td>
                <td style="padding:9px;">${it.name}</td>
                <td style="padding:9px;text-align:center;font-weight:bold;color:#3b82f6;">${it.qtyRequested}</td>
                <td style="padding:9px;text-align:center;font-weight:bold;color:#10b981;">${it.qtyIssued||'-'}</td>
                <td style="padding:9px;text-align:center;color:#64748b;">${it.unit}</td>
                <td style="padding:9px;color:#64748b;">${it.note||''}</td>
            </tr>`).join('');

            const html=`<!DOCTYPE html><html><head><meta charset="UTF-8">
            <style>
                body{font-family:'Sarabun',sans-serif;margin:0;padding:30px;color:#1e293b;font-size:13px;}
                .header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:20px;padding-bottom:16px;border-bottom:3px solid #1e293b;}
                .badge{padding:6px 16px;border-radius:20px;font-weight:bold;font-size:13px;background:${st.color};color:white;}
                table{width:100%;border-collapse:collapse;margin-top:16px;}
                thead tr{background:#1e293b;color:white;}
                th{padding:10px;text-align:left;font-size:12px;}
                td{border-bottom:1px solid #e2e8f0;vertical-align:middle;}
                .meta{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;margin-bottom:16px;}
                .meta-box{background:#f8fafc;border-radius:8px;padding:12px;}
                .meta-label{font-size:10px;color:#94a3b8;font-weight:bold;}
                .meta-val{font-weight:bold;margin-top:2px;}
                .footer{margin-top:40px;display:grid;grid-template-columns:1fr 1fr 1fr;gap:30px;}
                .sign-box{text-align:center;padding-top:50px;border-top:1px solid #334155;}
                @media print{body{padding:15px;}}
            </style>
            <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;700&display=swap" rel="stylesheet">
            </head><body>
            <div class="header">
                <div>
                    <div style="font-size:20px;font-weight:bold;">üè¢ TingTing Bingsu</div>
                    <div style="color:#64748b;font-size:13px;margin-top:4px;">‡πÉ‡∏ö‡∏Ç‡∏≠‡πÄ‡∏ö‡∏¥‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (Material Requisition)</div>
                </div>
                <div style="text-align:right;">
                    <div style="font-size:18px;font-weight:bold;">${d.mrNumber}</div>
                    <div class="badge">${st.label}</div>
                </div>
            </div>
            <div class="meta">
                <div class="meta-box"><div class="meta-label">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</div><div class="meta-val">${d.date}</div></div>
                <div class="meta-box"><div class="meta-label">‡∏ú‡∏π‡πâ‡∏Ç‡∏≠‡πÄ‡∏ö‡∏¥‡∏Å</div><div class="meta-val">${d.requestedBy}</div></div>
                <div class="meta-box"><div class="meta-label">‡πÅ‡∏ú‡∏ô‡∏Å</div><div class="meta-val">${d.department||'-'}</div></div>
                <div class="meta-box"><div class="meta-label">‡πÄ‡∏ö‡∏¥‡∏Å‡∏à‡∏≤‡∏Å‡∏Ñ‡∏•‡∏±‡∏á</div><div class="meta-val">${d.zone}</div></div>
                <div class="meta-box" style="grid-column:span 2;"><div class="meta-label">‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏õ‡∏£‡∏∞‡∏™‡∏á‡∏Ñ‡πå</div><div class="meta-val">${d.purpose||'-'}</div></div>
            </div>
            <table>
                <thead><tr>
                    <th style="width:35px;text-align:center;">#</th>
                    <th style="width:110px;">‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th>
                    <th>‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th>
                    <th style="width:80px;text-align:center;">‡∏Ç‡∏≠‡πÄ‡∏ö‡∏¥‡∏Å</th>
                    <th style="width:80px;text-align:center;">‡∏à‡πà‡∏≤‡∏¢‡∏à‡∏£‡∏¥‡∏á</th>
                    <th style="width:60px;text-align:center;">‡∏´‡∏ô‡πà‡∏ß‡∏¢</th>
                    <th>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</th>
                </tr></thead>
                <tbody>${rows}</tbody>
            </table>
            ${d.approvedBy?`<div style="margin-top:12px;padding:10px;background:#eff6ff;border-radius:8px;font-size:12px;">‚úÖ ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÇ‡∏î‡∏¢: <b>${d.approvedBy}</b> ‡πÄ‡∏°‡∏∑‡πà‡∏≠ ${d.approvedAt}</div>`:''}
            ${d.issuedBy?`<div style="margin-top:6px;padding:10px;background:#f0fdf4;border-radius:8px;font-size:12px;">üì¶ ‡∏à‡πà‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á‡πÇ‡∏î‡∏¢: <b>${d.issuedBy}</b> ‡πÄ‡∏°‡∏∑‡πà‡∏≠ ${d.issuedAt}</div>`:''}
            <div class="footer">
                <div class="sign-box"><div style="font-size:11px;color:#64748b;">‡∏ú‡∏π‡πâ‡∏Ç‡∏≠‡πÄ‡∏ö‡∏¥‡∏Å</div></div>
                <div class="sign-box"><div style="font-size:11px;color:#64748b;">‡∏ú‡∏π‡πâ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</div></div>
                <div class="sign-box"><div style="font-size:11px;color:#64748b;">‡∏ú‡∏π‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</div></div>
            </div>
            </body></html>`;

            const w=window.open('','_blank','width=900,height=700');
            w.document.write(html); w.document.close();
            setTimeout(()=>w.print(),800);
        };

        // ---- Export Excel ----
        window.exportReqExcel = function() {
            const docs = window._allReqDocs||[];
            if(!docs.length){toast('‚ùå ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•','#c2410c');return;}
            const rows=[['‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà MR','‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà','‡∏ú‡∏π‡πâ‡∏Ç‡∏≠‡πÄ‡∏ö‡∏¥‡∏Å','‡πÅ‡∏ú‡∏ô‡∏Å','‡∏Ñ‡∏•‡∏±‡∏á','‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏õ‡∏£‡∏∞‡∏™‡∏á‡∏Ñ‡πå','‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤','‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤','‡∏Ç‡∏≠‡πÄ‡∏ö‡∏¥‡∏Å','‡∏à‡πà‡∏≤‡∏¢‡∏à‡∏£‡∏¥‡∏á','‡∏´‡∏ô‡πà‡∏ß‡∏¢','‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞']];
            docs.forEach(d=>{
                const st=MR_STATUS[d.status]?.label||d.status;
                (d.items||[]).forEach(it=>{
                    rows.push([d.mrNumber,d.date,d.requestedBy,d.department||'',d.zone,d.purpose||'',it.id,it.name,it.qtyRequested,it.qtyIssued||0,it.unit,st]);
                });
            });
            const ws=XLSX.utils.aoa_to_sheet(rows),wb=XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb,ws,'Requisitions');
            XLSX.writeFile(wb,`MR_${new Date().toLocaleDateString('th-TH').replace(/\//g,'-')}.xlsx`);
        };

        // ---- Badge counter ----
        async function loadReqBadge() {
            try {
                const snap = await getDocs(collection(db,'requisitions'));
                let pending = 0;
                snap.forEach(d=>{ if(d.data().status==='pending') pending++; });
                const badge = document.getElementById('reqBadge');
                if(badge) { badge.innerText = pending>0?pending:''; badge.style.display=pending>0?'':'none'; }
            } catch(e){}
        }

        window.logout=function(){
            try { const uid=currentUser?.username; if(uid){ set(ref(rtdb,`presence/${uid}`),null).catch(()=>{}); } } catch(e){}
            localStorage.removeItem("currentUser");
            clearTimeout(window._sessionTimer);
            clearTimeout(window._sessionWarnTimer);
            window.location.href="login.html";
        };

        // ---- MOBILE SIDEBAR ----
        window.toggleSidebar=function(){
            document.getElementById('mainSidebar').classList.toggle('open');
            document.getElementById('sidebarOverlay').classList.toggle('open');
        };

        // ---- BACKUP & RESTORE CONFIG ----
        window.backupConfig=function(){
            const data={warehouseList,allProducts,zoneProductMap,roleSettings,_backup:{date:new Date().toISOString(),by:currentUser.name}};
            const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'});
            const a=document.createElement('a');
            a.href=URL.createObjectURL(blob);
            a.download=`tingting_config_${new Date().toLocaleDateString('th-TH').replace(/\//g,'-')}.json`;
            a.click();
            toast('‚úÖ Backup ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à','#059669');
        };

        window.restoreConfig=async function(input){
            const file=input.files[0]; if(!file)return;
            if(!confirm('‚ö†Ô∏è Restore ‡∏à‡∏∞‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏ó‡∏±‡∏ö Config ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô?'))return;
            try{
                const text=await file.text();
                const data=JSON.parse(text);
                if(data.warehouseList) warehouseList=data.warehouseList;
                if(data.allProducts)   allProducts=data.allProducts;
                if(data.zoneProductMap)zoneProductMap=data.zoneProductMap;
                if(data.roleSettings)  roleSettings=data.roleSettings;
                await saveConfig();
                toast(`‚úÖ Restore ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (Backup ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${data._backup?.date?.slice(0,10)||'?'})`, '#059669');
                openWarehouseManager();
            }catch(e){toast('‚ùå ‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á','#c2410c');console.error(e);}
            input.value='';
        };

        // ---- EDIT STOCK (‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á) ----
        window.openEditStockModal=function(productId){
            if(currentUser.role!=='admin'){toast('‚õî ‡πÄ‡∏â‡∏û‡∏≤‡∏∞ Admin','#c2410c');return;}
            const p=allProducts.find(pd=>pd.id===productId);
            const cd=countData[productId]||{total:0};
            const units=p?.units||[{name:p?.unit||''}];
            const existing=document.getElementById('editStockModal');if(existing)existing.remove();
            const modal=document.createElement('div');modal.className='modal-overlay';modal.id='editStockModal';
            modal.innerHTML=`<div class="modal-box">
                <h3>‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏¢‡∏≠‡∏î‡∏™‡∏ï‡πä‡∏≠‡∏Å</h3>
                <div style="background:#fff7ed;border:1px solid #fdba74;border-radius:8px;padding:12px;margin-bottom:16px;font-size:13px;color:#c2410c;">
                    ‚ö†Ô∏è ‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏¢‡∏≠‡∏î‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Audit Log ‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á
                </div>
                <div style="font-size:13px;color:#64748b;margin-bottom:16px;"><b>${productId}</b> ‚Äî ${p?.name||''}<br>‡∏¢‡∏≠‡∏î‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô: <b style="color:var(--success)">${cd.total||0} ${units[0]?.name||''}</b></div>
                <label style="font-size:12px;font-weight:bold;color:#475569;display:block;margin-bottom:4px;">‡∏¢‡∏≠‡∏î‡πÉ‡∏´‡∏°‡πà (${units[0]?.name||'‡∏´‡∏ô‡πà‡∏ß‡∏¢'})</label>
                <input type="number" id="editStockNewVal" value="${cd.total||0}" min="0" style="width:100%;padding:10px;border:1px solid #e2e8f0;border-radius:8px;font-size:16px;font-weight:bold;box-sizing:border-box;margin-bottom:12px;">
                <label style="font-size:12px;font-weight:bold;color:#475569;display:block;margin-bottom:4px;">‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç <span style="color:var(--danger)">*</span></label>
                <input type="text" id="editStockReason" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏ô‡∏±‡∏ö‡∏ú‡∏¥‡∏î / ‡∏õ‡∏£‡∏±‡∏ö‡∏¢‡∏≠‡∏î‡∏´‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö" style="width:100%;padding:10px;border:1px solid #e2e8f0;border-radius:8px;font-size:14px;box-sizing:border-box;margin-bottom:20px;">
                <div style="display:flex;gap:10px;">
                    <button onclick="saveEditStock('${productId}')" style="flex:1;background:var(--success);color:white;border:none;padding:12px;border-radius:10px;cursor:pointer;font-weight:bold;">‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                    <button onclick="document.getElementById('editStockModal').remove()" style="flex:1;background:#f1f5f9;color:#475569;border:none;padding:12px;border-radius:10px;cursor:pointer;">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                </div>
            </div>`;
            document.body.appendChild(modal);
        };

        window.saveEditStock=async function(productId){
            const newVal=parseFloat(document.getElementById('editStockNewVal').value);
            const reason=document.getElementById('editStockReason').value.trim();
            if(isNaN(newVal)||newVal<0){toast('‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏¢‡∏≠‡∏î‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á','#c2410c');return;}
            if(!reason){toast('‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•','#c2410c');return;}
            const oldVal=countData[productId]?.total||0;
            if(!countData[productId])countData[productId]={total:0,name:productId};
            countData[productId].total=newVal;
            countData[productId].lastUpdate=new Date().toLocaleDateString('th-TH')+' '+new Date().toLocaleTimeString('th-TH',{hour:'2-digit',minute:'2-digit'});
            countData[productId].countedBy=currentUser.name;
            await saveCountData();
            // Audit log
            await addDoc(collection(db,'auditLog'),{
                type:'editStock', productId, oldVal, newVal, reason,
                by:currentUser.name, at:new Date().toISOString()
            });
            document.getElementById('editStockModal').remove();
            toast(`‚úÖ ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏¢‡∏≠‡∏î ${productId}: ${oldVal} ‚Üí ${newVal}`, '#059669');
        };

        // ---- SEARCH IN STOCK TOOL ----
        window.filterStockRows=function(q){
            q=q.toLowerCase().trim();
            document.querySelectorAll('.stock-row').forEach(row=>{
                const text=row.innerText.toLowerCase();
                row.style.display=(!q||text.includes(q))?'':'none';
            });
        };

        // ---- DELETE HISTORY (Admin only) ----
        window.deleteHistorySession=async function(sessionId){
            if(currentUser.role!=='admin'){toast('‚õî ‡πÄ‡∏â‡∏û‡∏≤‡∏∞ Admin ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô','#c2410c');return;}
            if(!confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡∏ö‡∏ô‡∏µ‡πâ? ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡πÑ‡∏î‡πâ'))return;
            try{
                const {deleteDoc}=await import("https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js");
                await deleteDoc(doc(db,'stockHistory',sessionId));
                toast('‚úÖ ‡∏•‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢','#059669');
                loadHistory();
                loadDashHistory();
            }catch(e){toast('‚ùå ‡∏•‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à','#c2410c');console.error(e);}
        };

        // ---- SESSION TIMEOUT ----
        let _lastActivity = Date.now();
        const SESSION_TIMEOUT = 30 * 60 * 1000;  // 30 ‡∏ô‡∏≤‡∏ó‡∏µ
        const SESSION_WARN   =  2 * 60 * 1000;   // ‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏Å‡πà‡∏≠‡∏ô 2 ‡∏ô‡∏≤‡∏ó‡∏µ

        function resetSessionTimer(){
            _lastActivity = Date.now();
            clearTimeout(window._sessionTimer);
            clearTimeout(window._sessionWarnTimer);
            // ‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏Å‡πà‡∏≠‡∏ô 2 ‡∏ô‡∏≤‡∏ó‡∏µ
            window._sessionWarnTimer = setTimeout(()=>{
                const existing = document.getElementById('sessionWarnBanner');
                if(existing) return;
                const banner = document.createElement('div');
                banner.id = 'sessionWarnBanner';
                banner.innerHTML = `<div style="position:fixed;bottom:80px;right:30px;background:#f59e0b;color:white;padding:16px 24px;border-radius:14px;z-index:99999;box-shadow:0 8px 24px rgba(0,0,0,0.2);display:flex;align-items:center;gap:12px;">
                    <span style="font-size:20px;">‚ö†Ô∏è</span>
                    <div><b>‡πÉ‡∏Å‡∏•‡πâ‡∏´‡∏°‡∏î Session</b><br><span style="font-size:12px;">‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞ logout ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÉ‡∏ô 2 ‡∏ô‡∏≤‡∏ó‡∏µ</span></div>
                    <button onclick="resetSessionTimer();document.getElementById('sessionWarnBanner').remove();" style="background:white;color:#f59e0b;border:none;padding:8px 14px;border-radius:8px;cursor:pointer;font-weight:bold;margin-left:8px;">‡∏â‡∏±‡∏ô‡∏¢‡∏±‡∏á‡∏≠‡∏¢‡∏π‡πà</button>
                </div>`;
                document.body.appendChild(banner);
            }, SESSION_TIMEOUT - SESSION_WARN);
            // logout ‡∏à‡∏£‡∏¥‡∏á
            window._sessionTimer = setTimeout(()=>{
                alert('‚è∞ Session ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤ Login ‡πÉ‡∏´‡∏°‡πà');
                logout();
            }, SESSION_TIMEOUT);
        }
        // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï timer ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô
        ['click','keydown','mousemove','touchstart'].forEach(ev=>{
            document.addEventListener(ev, ()=>resetSessionTimer(), {passive:true});
        });
        window.toggleSub=function(id){const s=document.getElementById(id);s.style.display=(s.style.display==='block')?'none':'block';};
        window.closeTool=function(){if(Object.keys(tempCountData).length>0){if(!confirm("‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏õ‡∏¥‡∏î‡∏à‡∏£‡∏¥‡∏á‡πÑ‡∏´‡∏°?"))return;}document.getElementById('toolAppContainer').classList.add('hidden');document.getElementById('dashboardView').classList.remove('hidden');};
    </script>
    <script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
</body>
</html>
